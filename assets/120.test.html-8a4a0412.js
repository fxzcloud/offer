import{_ as t,V as p,W as o,X as s,Y as n,Z as c,$ as a,F as l}from"./framework-8edddef6.js";const i={},u=a(`<h1 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h1><p>对于开发者而言，良好的测试可以提前发现程序的中错误，避免后续因维护不及时产生Bug而造成的心智负担，所以写好测试非常有必要。Go在测试这一方面提供了非常简便实用的命令行工具<code>go test</code>，在标准库和许多开源框架都能看到测试的身影，该工具使用起来十分方便，目前支持以下几种测试：</p><ul><li>示例测试</li><li>单元测试</li><li>基准测试</li><li>模糊测试</li></ul><p>在Go中大部分的API都是由标准库<code>testing</code>提供。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p>在命令行中执行<code>go help testfunc</code>命令，可看Go官方对于上面四种测试类型的解释。</p></div><br><h2 id="编写规范" tabindex="-1"><a class="header-anchor" href="#编写规范" aria-hidden="true">#</a> 编写规范</h2><p>在开始编写测试之前，首先需要注意几点规范，这样在后续的学习中会更加方便。</p><ul><li>测试包：测试文件最好单独放在一个包中，这个包通常命名为<code>test</code>。</li><li>测试文件：测试文件通常以<code>_test.go</code>结尾，例如要测试某一个功能，就将其命名为<code>function_test.go</code>，如果想根据测试类型再划分的更细一些也可以将测试类型为作为文件前缀，例如<code>benchmark_marshaling_test.go</code>，或者<code>example_marshaling_test.go</code>。</li><li>测试函数：每一个测试文件中都会有若干个测试函数用于不同的测试。对于不同的测试类型，测试函数的命名的风格也不同。例如示例测试是<code>ExampleXXXX</code>，单元测试是<code>TestXXXX</code>，基准测试是<code>BenchmarkXXXX</code>，模糊测试是<code>FuzzXXXX</code>，这样一来即便不需要注释也可以知晓这是什么类型的测试。</li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>当包名为<code>testdata</code>时，该包通常是为了存储用于测试的辅助数据，在执行测试时，Go会忽略名为<code>testdata</code>的包。</p></div><p>遵循上述的规范，养成良好的测试风格，可以为日后的维护省去不少的麻烦。</p><br><h2 id="执行测试" tabindex="-1"><a class="header-anchor" href="#执行测试" aria-hidden="true">#</a> 执行测试</h2><p>执行测试主要会用到<code>go test</code>命令，下面拿实际的代码举例，现在有待测试文件<code>/say/hello.go</code>代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> say

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;bye&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>和测试文件<code>/test/example_test.go</code>代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/say&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">ExampleHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// hello</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleGoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// bye</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleSay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	say<span class="token punctuation">.</span><span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// hello</span>
	<span class="token comment">// bye</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行这些测试有多种方法，比如想要执行<code>test</code>包下所有的测试用例，就可以直接在<code>test</code>目录下执行如下命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> ./
PASS
ok      golearn/test    <span class="token number">0</span>.422s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>./</code>表示当前目录，Go会将<code>test</code>目录下的所有测试文件重新编译后，然后再将所有测试用例全都执行，从结果可以看出所有的测试用例都通过了。其后的参数也可以跟多个目录，例如下方的命令，显然项目的主目录并没有测试文件可供执行。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> ./ <span class="token punctuation">..</span>/
ok      golearn/test
?       golearn <span class="token punctuation">[</span>no <span class="token builtin class-name">test</span> files<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>当执行的参数有多个包时，Go并不会再次执行已经成功通过的测试用例，在执行时会行尾添加<code>(cached)</code>以表示输出结果是上一次的缓存。当测试的标志参数位于以下集合中时，Go就会缓存测试结果，否则就不会。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>-benchtime, -cpu,-list, -parallel, -run, -short, -timeout, -failfast, -v
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果想要禁用缓存，可以加上参数<code> -count=1</code>。</p></div><p>当然也可以单独指定某一个测试文件来执行。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> example_test.go
ok      command-line-arguments  <span class="token number">0</span>.457s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者可以单独指定某一个测试文件的某一个测试用例，例如</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span> ExampleSay
PASS
ok      golearn/test    <span class="token number">0</span>.038s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面三种情况虽然都完成了测试，但是输出结果太简介了，这时可以加上参数<code>-v</code>，来使输出结果更加详细一点，例如</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> ./ <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleHello
--- PASS: ExampleHello <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleGoodBye
--- PASS: ExampleGoodBye <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleSay
--- PASS: ExampleSay <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      golearn/test    <span class="token number">0</span>.040s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这下可以很清楚的看到每一个测试用例的执行顺序，耗时，执行情况，以及总体的耗时。</p><div class="hint-container tip"><p class="hint-container-title">提示</p><p><code>go test</code>命令默认运行所有的单元测试，示例测试，模糊测试，如果加上了<code>-bench</code>参数则会运行所有类型的测试，例如下方的命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-bench</span> <span class="token builtin class-name">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>所以需要使用<code>-run</code>参数来指定，例如只运行所有的基准测试的命令如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-bench</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-run</span> ^$
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></div><br><h3 id="常用参数" tabindex="-1"><a class="header-anchor" href="#常用参数" aria-hidden="true">#</a> 常用参数</h3><p>Go 测试有着非常多的标志参数，下面只会介绍常用的参数，想要了解更多细节建议使用<code>go help testflag</code>命令自行查阅。</p><table><thead><tr><th>参数</th><th>释义</th></tr></thead><tbody><tr><td><code>-o file</code></td><td>指定编译后的二进制文件名称</td></tr><tr><td><code>-c</code></td><td>只编译测试文件，但不运行</td></tr><tr><td><code>-json</code></td><td>以json格式输出测试日志</td></tr><tr><td><code>-exec xprog</code></td><td>使用<code>xprog</code>运行测试，等价于<code>go run</code></td></tr><tr><td><code>-bench regexp</code></td><td>选中<code>regexp</code>匹配的基准测试</td></tr><tr><td><code>-fuzz regexp</code></td><td>选中<code>regexp</code>匹配的模糊测试</td></tr><tr><td><code>-fuzztime t</code></td><td>模糊测试自动结束的时间，<code>t</code>为时间间隔，当单位为<code>x</code>时，表示次数，例如<code>200x</code></td></tr><tr><td><code>-fuzzminimizetime t</code></td><td>模式测试运行的最小时间，规则同上</td></tr><tr><td><code>-count n</code></td><td>运行测试n次，默认1次</td></tr><tr><td><code>-cover</code></td><td>开启测试覆盖率分析</td></tr><tr><td><code>-covermode set,count,atomic</code></td><td>设置覆盖率分析的模式</td></tr><tr><td><code>-cpu</code></td><td>为测试执行<code>GOMAXPROCS</code></td></tr><tr><td><code>-failfast</code></td><td>第一次测试失败后，不会开始新的测试</td></tr><tr><td><code>-list regexp</code></td><td>列出<code>regexp</code>匹配的测试用例</td></tr><tr><td><code>-parallel n</code></td><td>允许调用了<code>t.Parallel</code>的测试用例并行运行，<code>n</code>值为并行的最大数量</td></tr><tr><td><code>-run regexp</code></td><td>只运行<code>regexp</code>匹配的测试用例</td></tr><tr><td><code>-skip regexp</code></td><td>跳过<code>regexp</code>匹配的测试用例</td></tr><tr><td><code>-timeout d</code></td><td>如果单次测试执行时间超过了时间间隔<code>d</code>，就会<code>panic</code>。<code>d</code>为时间间隔，例1s,1ms,1ns等</td></tr><tr><td><code>-shuffle off,on,N</code></td><td>打乱测试的执行顺序，<code>N</code>为随机种子，默认种子为系统时间</td></tr><tr><td><code>-v</code></td><td>输出更详细的测试日志</td></tr><tr><td><code>-benchmem</code></td><td>统计基准测试的内存分配</td></tr><tr><td><code>-blockprofile block.out</code></td><td>统计测试中协程阻塞情况并写入文件</td></tr><tr><td><code>-blockprofilerate n</code></td><td>控制协程阻塞统计频率，通过命令<code>go doc runtime.SetBlockProfileRate</code>查看更多细节</td></tr><tr><td><code>-coverprofile cover.out</code></td><td>统计覆盖率测试的情况并写入文件</td></tr><tr><td><code>-cpuprofile cpu.out</code></td><td>统计cpu情况并写入文件</td></tr><tr><td><code>-memprofile mem.out</code></td><td>统计内存分配情况并写入文件</td></tr><tr><td><code>-memprofilerate n</code></td><td>控制内存分配统计的频率，通过命令<code>go doc runtime.MemProfileRate</code>查看更多细节</td></tr><tr><td><code>-mutexprofile mutex.out</code></td><td>统计锁竞争情况并写入文件</td></tr><tr><td><code> -mutexprofilefraction n</code></td><td>设置统计<code>n</code>个协程竞争一个互斥锁的情况</td></tr><tr><td><code>-trace trace.out</code></td><td>将执行追踪情况写入文件</td></tr><tr><td><code>-outputdir directory</code></td><td>指定上述的统计文件的输出目录，默认为<code>go test</code>的运行目录</td></tr></tbody></table><br><h2 id="示例测试" tabindex="-1"><a class="header-anchor" href="#示例测试" aria-hidden="true">#</a> 示例测试</h2><p>示例测试并不像其他三种测试一样是为了发现程序的问题所在，它更多的是为了展示某一个功能的使用方法，起到文档作用。示例测试并不是一个官方定义的概念，也不是一个硬性的规范，更像是一种工程上的约定俗成，是否遵守只取决于开发者。示例测试在标准库中出现的非常多，通常是官方所编写的标准库代码示例，例如标准库<code>context/example_test.go</code>中的<code>ExampleWithDeadline</code>测试函数，该函数中展现了<code>DeadlineContext</code>的基本使用方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// This example passes a context with an arbitrary deadline to tell a blocking</span>
<span class="token comment">// function that it should abandon its work as soon as it gets to it.</span>
<span class="token keyword">func</span> <span class="token function">ExampleWithDeadline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   d <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>shortDuration<span class="token punctuation">)</span>
   ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithDeadline</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span>

   <span class="token comment">// Even though ctx will be expired, it is good practice to call its</span>
   <span class="token comment">// cancellation function in any case. Failure to do so may keep the</span>
   <span class="token comment">// context and its parent alive longer than necessary.</span>
   <span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token keyword">select</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;overslept&quot;</span><span class="token punctuation">)</span>
   <span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

   <span class="token comment">// Output:</span>
   <span class="token comment">// context deadline exceeded</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>表面上看该测试函数就是一个普通的函数，不过示例测试主要是由<code>Output</code>注释来体现的，待测试函数只有一行输出时，使用<code>Output</code>注释来检测输出。首先创建一个<code>hello.go</code>的文化，写入如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> say

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;bye&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>SayHello</code>函数就是待测函数，然后创建测试文件<code>example_test.go</code>，写入如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/say&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">ExampleHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// hello</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleGoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// bye</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ExampleSay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	say<span class="token punctuation">.</span><span class="token function">Hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	say<span class="token punctuation">.</span><span class="token function">GoodBye</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Output:</span>
	<span class="token comment">// hello</span>
	<span class="token comment">// bye</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数中<code>Output</code>注释表明了检测函数输出是否为<code>hello</code>，接下来执行测试命令看看结果。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleHello
--- PASS: ExampleHello <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleGoodBye
--- PASS: ExampleGoodBye <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   ExampleSay
--- PASS: ExampleSay <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      golearn/test    <span class="token number">0</span>.448s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从结果可以看出全部测试都已经通过，关于<code>Output</code>有以下几种写法，第一种是只有一行输出，意为检测该函数的输出是不是hello</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// Output:
// hello
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>第二种是多行输出，即按顺序检测输出是否匹配</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// Output:
// hello
// bye
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第三种是无序输出，即不按照顺序多行输出匹配</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>// Unordered output:
// bye
// hello
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>需要注意的是，对于测试函数而言，仅当最后几行为<code>Output</code>注释才会被视为示例测试，否则就只是一个普通的函数，不会被Go执行。</p><br><h2 id="单元测试" tabindex="-1"><a class="header-anchor" href="#单元测试" aria-hidden="true">#</a> 单元测试</h2><p>单元测试就是对软件中的最小可测试单元进行测试，单元的大小定义取决于开发者，可能是一个结构体，或者是一个包，也可能是一个函数，或者是一个类型。下面依旧通过例子来演示，首先创建<code>/tool/math.go</code>文件，写入如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool

<span class="token keyword">type</span> Number <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	~<span class="token builtin">int8</span> <span class="token operator">|</span> ~<span class="token builtin">int16</span> <span class="token operator">|</span> ~<span class="token builtin">int32</span> <span class="token operator">|</span> ~<span class="token builtin">int64</span> <span class="token operator">|</span> ~<span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> SumInt<span class="token punctuation">[</span>T Number<span class="token punctuation">]</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b T<span class="token punctuation">)</span> T <span class="token punctuation">{</span>
	<span class="token keyword">return</span> a <span class="token operator">+</span> b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> Equal<span class="token punctuation">[</span>T Number<span class="token punctuation">]</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b T<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> a <span class="token operator">==</span> b
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后创建测试文件<code>/tool_test/unit_test.go</code>，对于单元测试而言，命名可以为<code>unit_test</code>或者是想要测试的包或者功能作为文件前缀。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> test_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token number">111</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token boolean">false</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于单元测试而言，每一个测试用例的命名风格为<code>TestXXXX</code>，且函数的入参必须是<code>t *testing.T</code>，<code>testing.T</code>是<code>testing</code>包提供的用于方便测试的结构体，提供了许多可用的方法，例子中的<code>t.Errorf</code>等同于<code>t.Logf</code>，用于格式化输出测试失败的日志信息，其他常用的还有<code>t.Fail</code>用于将当前用例标记为测试失败，功能类似的还有<code>t.FailNow</code>同样会标记为测试失败，但是前者失败后还会继续执行，后者则会直接停止执行，如下方的例子，将预期结果修改为错误的结果：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token number">110</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
        <span class="token comment">// Errorf内部使用的是t.Fail()</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token boolean">true</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
        <span class="token comment">// Fatalf内部使用的是t.FailNow()</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行上述测试输出如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> tool_test.go <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSum
    tool_test.go:14: Sum<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span> expected <span class="token number">110</span>,actual is <span class="token number">111</span>
    tool_test.go:16: <span class="token builtin class-name">test</span> finished
--- FAIL: TestSum <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestEqual
    tool_test.go:25: Sum<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span> expected true,actual is <span class="token boolean">false</span>
--- FAIL: TestEqual <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
FAIL    command-line-arguments  <span class="token number">0</span>.037s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从测试日志中可以看出<code>TestSum</code>用例尽管失败了还是输出了test finished，而<code>TestEqual</code>则没有，同样的还有<code>t.SkipNow</code>，会将当前用例标记为<code>SKIP</code>，然后停止执行，在下一轮测试中会继续执行。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;golearn/tool&quot;</span>
   <span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
   expected <span class="token operator">:=</span> <span class="token number">110</span>

   actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
   <span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">Skipf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
   expected <span class="token operator">:=</span> <span class="token boolean">true</span>

   actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
   <span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在执行测试时，修改测试次数为2</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>$ <span class="token keyword">go</span> test tool_test<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token operator">-</span>v <span class="token operator">-</span>count<span class="token operator">=</span><span class="token number">2</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSum
    tool_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span> expected <span class="token number">110</span><span class="token punctuation">,</span>actual is <span class="token number">111</span>
<span class="token operator">--</span><span class="token operator">-</span> SKIP<span class="token punctuation">:</span> TestSum <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestEqual
    tool_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span> expected <span class="token boolean">true</span><span class="token punctuation">,</span>actual is <span class="token boolean">false</span>
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> TestEqual <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestSum
    tool_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span> expected <span class="token number">110</span><span class="token punctuation">,</span>actual is <span class="token number">111</span>
<span class="token operator">--</span><span class="token operator">-</span> SKIP<span class="token punctuation">:</span> TestSum <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestEqual
    tool_test<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span><span class="token number">25</span><span class="token punctuation">:</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">101</span><span class="token punctuation">)</span> expected <span class="token boolean">true</span><span class="token punctuation">,</span>actual is <span class="token boolean">false</span>
<span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> TestEqual <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">.</span>00s<span class="token punctuation">)</span>
FAIL    command<span class="token operator">-</span>line<span class="token operator">-</span>arguments  <span class="token number">0</span><span class="token punctuation">.</span>468s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上数的例子中在最后一行输出了test finished，用于表示测试完毕，其实可以使用<code>t.Cleanup</code>来注册一个收尾函数专门做此事，该函数会在测试用例结束时执行，如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">finished</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">finished</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token number">111</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Skipf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">finished</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token boolean">false</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行测试后输出如下</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ go test tool_test.go -v
=== RUN   TestSum
    tool_test.go:9: test finished
--- PASS: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:9: test finished
--- PASS: TestEqual (0.00s)
PASS
ok      command-line-arguments  0.462s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="helper" tabindex="-1"><a class="header-anchor" href="#helper" aria-hidden="true">#</a> Helper</h3><p>通过<code>t.Helper()</code>可以将当前函数标记为帮助函数，帮助函数不会单独作为一个测试用例用于执行，在记录日志时输出的行号也是帮助函数的调用者的行号，这样可以使得分析日志时定位更准确，避免的冗杂的其他信息。比如将上述<code>t.Cleanup</code>的例子就可以修改为帮助函数，如下。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;golearn/tool&quot;</span>
   <span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   t<span class="token punctuation">.</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
   expected <span class="token operator">:=</span> <span class="token number">111</span>

   actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
   <span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">Skipf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>

   a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
   expected <span class="token operator">:=</span> <span class="token boolean">false</span>

   t<span class="token punctuation">.</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
   <span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
      t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行测试后输出信息如下，与之前的区别在于test finished的行号变成了调用者的行号。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ go test tool_test.go -v
=== RUN   TestSum
    tool_test.go:15: test finished
--- PASS: TestSum (0.00s)
=== RUN   TestEqual
    tool_test.go:30: test finished
--- PASS: TestEqual (0.00s)
PASS
ok      command-line-arguments  0.464s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>上述操作都只能在主测试中进行，即直接执行的测试用例，如果是子测试中使用将会<code>panic</code>。</p></div><h3 id="子测试" tabindex="-1"><a class="header-anchor" href="#子测试" aria-hidden="true">#</a> 子测试</h3><p>在一些情况下，会需要用到在一个测试用例中测试另外测试用例，这种嵌套的测试用例一般称为子测试，通过<code>t.Run()</code>方法，该方法签名如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Run方法会开启一个新的协程用于运行子测试，阻塞等待函数f执行完毕后才会返回</span>
<span class="token comment">// 返回值为是否通过测试</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>T<span class="token punctuation">)</span> <span class="token function">Run</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是一个例子</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestTool</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Sum(10,101)&quot;</span><span class="token punctuation">,</span> TestSum<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Equal(10,101)&quot;</span><span class="token punctuation">,</span> TestEqual<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行后结果如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span> TestTool <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestTool
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestTool/tool.Sum<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span>
    tool_test.go:15: <span class="token builtin class-name">test</span> finished
<span class="token operator">==</span><span class="token operator">=</span> RUN   TestTool/tool.Equal<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span>
    tool_test.go:30: <span class="token builtin class-name">test</span> finished
--- PASS: TestTool <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestTool/tool.Sum<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: TestTool/tool.Equal<span class="token punctuation">(</span><span class="token number">10,101</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      golearn/tool_test       <span class="token number">0</span>.449s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过输出可以很清晰的看到父子的层级结构，在上述的例子中第一个子测试未执行完毕第二个子测试是不会执行的，可以使用<code>t.Parallel()</code>将测试用例标记为可并行运行，如此一来输出的顺序将会无法确定。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;test finished&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestSum</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token number">111</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">SumInt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Skipf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %d,actual is %d&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token boolean">false</span>

	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestToolParallel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;setup&quot;</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Sum(10,101)&quot;</span><span class="token punctuation">,</span> TestSum<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Equal(10,101)&quot;</span><span class="token punctuation">,</span> TestEqual<span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;teardown&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行测试后输出如下</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ go test -run TestTool -v
=== RUN   TestToolParallel
    tool_test.go:46: setup
=== RUN   TestToolParallel/tool.Sum(10,101)
=== PAUSE TestToolParallel/tool.Sum(10,101)
=== RUN   TestToolParallel/tool.Equal(10,101)
=== PAUSE TestToolParallel/tool.Equal(10,101)
=== NAME  TestToolParallel
    tool_test.go:49: teardown
=== CONT  TestToolParallel/tool.Sum(10,101)
=== CONT  TestToolParallel/tool.Equal(10,101)
=== NAME  TestToolParallel/tool.Sum(10,101)
    tool_test.go:16: test finished
=== NAME  TestToolParallel/tool.Equal(10,101)
    tool_test.go:32: test finished
--- PASS: TestToolParallel (0.00s)
    --- PASS: TestToolParallel/tool.Sum(10,101) (0.00s)
    --- PASS: TestToolParallel/tool.Equal(10,101) (0.00s)
PASS
ok      golearn/tool_test       0.444s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从测试结果中就可以很明显的看出有一个阻塞等待的过程，在并发执行测试用例时，像上述的例子肯定是无法正常进行的，因为后续的代码无法保证同步运行，这时可以选择再嵌套一层<code>t.Run()</code>，如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestToolParallel</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;setup&quot;</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;process&quot;</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Sum(10,101)&quot;</span><span class="token punctuation">,</span> TestSum<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token string">&quot;tool.Equal(10,101)&quot;</span><span class="token punctuation">,</span> TestEqual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;teardown&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再次执行，就可以看到正常的执行结果了。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>$ go test -run TestTool -v
=== RUN   TestToolParallel
    tool_test.go:46: setup
=== RUN   TestToolParallel/process
=== RUN   TestToolParallel/process/tool.Sum(10,101)
=== PAUSE TestToolParallel/process/tool.Sum(10,101)
=== RUN   TestToolParallel/process/tool.Equal(10,101)
=== PAUSE TestToolParallel/process/tool.Equal(10,101)
=== CONT  TestToolParallel/process/tool.Sum(10,101)
=== CONT  TestToolParallel/process/tool.Equal(10,101)
=== NAME  TestToolParallel/process/tool.Sum(10,101)
    tool_test.go:16: test finished
=== NAME  TestToolParallel/process/tool.Equal(10,101)
    tool_test.go:32: test finished
=== NAME  TestToolParallel
    tool_test.go:51: teardown
--- PASS: TestToolParallel (0.00s)
    --- PASS: TestToolParallel/process (0.00s)
        --- PASS: TestToolParallel/process/tool.Sum(10,101) (0.00s)
        --- PASS: TestToolParallel/process/tool.Equal(10,101) (0.00s)
PASS
ok      golearn/tool_test       0.450s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="表格风格" tabindex="-1"><a class="header-anchor" href="#表格风格" aria-hidden="true">#</a> 表格风格</h3><p>在上述的单元测试中，测试的输入数据都是手动声明的一个个变量，当数据量小的时候无伤大雅，但如果想要测试多组数据时，就不太可能再去声明变量来创建测试数据，所以一般情况下都是尽量采用结构体切片的形式，结构体是临时声明的匿名结构体，因为这样的编码风格看起来就跟表格一样，所以称为<code>table-driven</code>，下面举个例子，这是一个手动声明多个变量来创建测试数据的例子，如果有多组数据狠起来就不是很直观，所以将其修改为表格风格</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span>
	expected <span class="token operator">:=</span> <span class="token boolean">false</span>
	actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">if</span> actual <span class="token operator">!=</span> expected <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> expected<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>修改后的代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestEqual</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t<span class="token punctuation">.</span><span class="token function">Cleanup</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">CleanupHelper</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>

	<span class="token comment">// table driven style</span>
	testData <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		a<span class="token punctuation">,</span> b <span class="token builtin">int</span>
		exp  <span class="token builtin">bool</span>
	<span class="token punctuation">}</span><span class="token punctuation">{</span>
		<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> testData <span class="token punctuation">{</span>
		<span class="token keyword">if</span> actual <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Equal</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>a<span class="token punctuation">,</span> data<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> actual <span class="token operator">!=</span> data<span class="token punctuation">.</span>exp <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">&quot;Sum(%d,%d) expected %t,actual is %t&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>a<span class="token punctuation">,</span> data<span class="token punctuation">.</span>b<span class="token punctuation">,</span> data<span class="token punctuation">.</span>exp<span class="token punctuation">,</span> actual<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样的测试数据看起来就要直观很多。</p><h2 id="基准测试" tabindex="-1"><a class="header-anchor" href="#基准测试" aria-hidden="true">#</a> 基准测试</h2><p>基准测试又称为性能测试，通常用于测试程序的内存占用，CPU使用情况，执行耗时等等性能指标。对于基准测试而言，测试文件通常以<code>bench_test.go</code>结尾，而测试用例的函数必须为<code>BenchmarkXXXX</code>格式。</p><p>下面以一个字符串拼接的例子的性能比较来当作基准测试的例子。首先创建文件<code>/tool/strConcat.go</code>文件，众所周知直接使用字符串进行<code>+</code>拼接性能是很低的，而使用<code>strings.Builder</code>则要好很多，在<code>/tool/strings.go</code>文件分别创建两个函数进行两种方式的字符串拼接。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool

<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span>


<span class="token keyword">func</span> <span class="token function">ConcatStringDirect</span><span class="token punctuation">(</span>longString <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   res <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100_000.</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
      res <span class="token operator">+=</span> longString
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ConcatStringWithBuilder</span><span class="token punctuation">(</span>longString <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> res strings<span class="token punctuation">.</span>Builder
   <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100_000.</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>longString<span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后创建测试文件<code>/tool_test/bench_tool_test.go </code>，代码如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool_test

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> longString <span class="token operator">=</span> <span class="token string">&quot;longStringlongStringlongStringlongStringlongStringlongStringlongStringlongString&quot;</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatDirect</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		tool<span class="token punctuation">.</span><span class="token function">ConcatStringDirect</span><span class="token punctuation">(</span>longString<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">BenchmarkConcatBuilder</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		tool<span class="token punctuation">.</span><span class="token function">ConcatStringWithBuilder</span><span class="token punctuation">(</span>longString<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行测试命令，命令中开启了详细日志和内存分析，指定了使用的CPU核数列表，且每个测试用例执行两轮，输出如下</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-run</span> bench_tool_test.go <span class="token parameter variable">-cpu</span><span class="token operator">=</span><span class="token number">2,4</span>,8 <span class="token parameter variable">-count</span><span class="token operator">=</span><span class="token number">2</span>
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-11800H @ <span class="token number">2</span>.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">277771375</span> ns/op        <span class="token number">4040056736</span> B/op    <span class="token number">10000</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">278500125</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1153796000</span> ns/op        <span class="token number">4040068784</span> B/op    <span class="token number">10126</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1211017600</span> ns/op        <span class="token number">4040073104</span> B/op    <span class="token number">10171</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">665460800</span> ns/op        <span class="token number">4040077760</span> B/op    <span class="token number">10219</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">679774450</span> ns/op        <span class="token number">4040080064</span> B/op    <span class="token number">10243</span> allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            <span class="token number">3428</span>            <span class="token number">344530</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">3579</span>            <span class="token number">351858</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">2448</span>            <span class="token number">736177</span> ns/op         <span class="token number">4128185</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1688</span>            <span class="token number">662993</span> ns/op         <span class="token number">4128185</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1958</span>            <span class="token number">550333</span> ns/op         <span class="token number">4128199</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">2174</span>            <span class="token number">552113</span> ns/op         <span class="token number">4128196</span> B/op         <span class="token number">29</span> allocs/op
PASS
ok      golearn/tool_test       <span class="token number">21</span>.381s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面解释一下基准测试的输出结果，<code>goos</code>代表是运行的操作系统，<code>goarh</code>代表的是CPU架构，<code>pkg</code>为测试所在的包，<code>cpu</code>是一些关于CPU的信息。下面的每一个测试用例的结果由每一个基准测试的名称分隔，第一列<code>BenchmarkConcatDirect-2</code>中的2代表了使用的CPU核数，第二列的4代表了代码中<code>b.N</code>的大小，也就是基准测试中的循环次数，第三列<code>277771375 ns/op</code>代表了每一次循环所消耗的时间，ns为纳秒，第四列<code>4040056736 B/op</code>表示每一次循环所分配内存的字节大小，第五列<code>10000 allocs/op</code>表示每一次循环内存分配的次数。</p><p>很显然，根据测试的结果看来，使用<code>strings.Builder</code>的性能要远远高于使用<code>+</code>拼接字符串，通过直观的数据对比性能正是基准测试的目的所在。</p><h3 id="benchstat" tabindex="-1"><a class="header-anchor" href="#benchstat" aria-hidden="true">#</a> benchstat</h3><p>benchstat是一个开源的性能测试分析工具，上述性能测试的样本数只有两组，一旦样本多了起来人工分析就会十分的费时费力，该工具便是为了解决性能分析问题而生。</p><p>首先需要下载该工具</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token function">install</span> golang.org/x/perf/benchstat
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>分两次执行基准测试，这次将样本数修改为5个，并且分别输出到<code>old.txt</code>和<code>new.txt</code>文件以做对比，第一次执行结果</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-run</span> bench_tool_test.go <span class="token parameter variable">-cpu</span><span class="token operator">=</span><span class="token number">2,4</span>,8 <span class="token parameter variable">-count</span><span class="token operator">=</span><span class="token number">5</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> old.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-11800H @ <span class="token number">2</span>.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">290535650</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">298974625</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">299637800</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">276487000</span> ns/op        <span class="token number">4040056784</span> B/op    <span class="token number">10001</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">356465275</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">2</span>         <span class="token number">894723200</span> ns/op        <span class="token number">4040077424</span> B/op    <span class="token number">10216</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">2</span>         <span class="token number">785830400</span> ns/op        <span class="token number">4040078288</span> B/op    <span class="token number">10225</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">2</span>         <span class="token number">743634000</span> ns/op        <span class="token number">4040077568</span> B/op    <span class="token number">10217</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">2</span>         <span class="token number">953802700</span> ns/op        <span class="token number">4040075408</span> B/op    <span class="token number">10195</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">2</span>         <span class="token number">953028750</span> ns/op        <span class="token number">4040077520</span> B/op    <span class="token number">10217</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">684023150</span> ns/op        <span class="token number">4040086784</span> B/op    <span class="token number">10313</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">634380250</span> ns/op        <span class="token number">4040090528</span> B/op    <span class="token number">10352</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">685030600</span> ns/op        <span class="token number">4040090768</span> B/op    <span class="token number">10355</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">817909650</span> ns/op        <span class="token number">4040089808</span> B/op    <span class="token number">10345</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">600078100</span> ns/op        <span class="token number">4040095664</span> B/op    <span class="token number">10406</span> allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            <span class="token number">2925</span>            <span class="token number">419651</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">2961</span>            <span class="token number">423899</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">2714</span>            <span class="token number">422275</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">2848</span>            <span class="token number">452255</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">2612</span>            <span class="token number">454452</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4             <span class="token number">974</span>           <span class="token number">1158000</span> ns/op         <span class="token number">4128189</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1098</span>           <span class="token number">1068682</span> ns/op         <span class="token number">4128192</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1042</span>           <span class="token number">1056570</span> ns/op         <span class="token number">4128194</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1280</span>            <span class="token number">978213</span> ns/op         <span class="token number">4128191</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1538</span>           <span class="token number">1162108</span> ns/op         <span class="token number">4128190</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1744</span>            <span class="token number">700824</span> ns/op         <span class="token number">4128203</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">2235</span>            <span class="token number">759537</span> ns/op         <span class="token number">4128201</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1556</span>            <span class="token number">736455</span> ns/op         <span class="token number">4128204</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1592</span>            <span class="token number">825794</span> ns/op         <span class="token number">4128201</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">2263</span>            <span class="token number">717285</span> ns/op         <span class="token number">4128203</span> B/op         <span class="token number">29</span> allocs/op
PASS
ok      golearn/tool_test       <span class="token number">56</span>.742s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二次执行结果</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-benchmem</span> <span class="token parameter variable">-bench</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-run</span> bench_tool_test.go <span class="token parameter variable">-cpu</span><span class="token operator">=</span><span class="token number">2,4</span>,8 <span class="token parameter variable">-count</span><span class="token operator">=</span><span class="token number">5</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> new.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-11800H @ <span class="token number">2</span>.30GHz
BenchmarkConcatDirect
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">285074900</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">291517150</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">281901975</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">292320625</span> ns/op        <span class="token number">4040056592</span> B/op     <span class="token number">9999</span> allocs/op
BenchmarkConcatDirect-2                <span class="token number">4</span>         <span class="token number">286723000</span> ns/op        <span class="token number">4040056952</span> B/op    <span class="token number">10002</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1188983000</span> ns/op        <span class="token number">4040071856</span> B/op    <span class="token number">10158</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1080713900</span> ns/op        <span class="token number">4040070800</span> B/op    <span class="token number">10147</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1203622300</span> ns/op        <span class="token number">4040067344</span> B/op    <span class="token number">10111</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1045291300</span> ns/op        <span class="token number">4040070224</span> B/op    <span class="token number">10141</span> allocs/op
BenchmarkConcatDirect-4                <span class="token number">1</span>        <span class="token number">1123163300</span> ns/op        <span class="token number">4040070032</span> B/op    <span class="token number">10139</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">790421300</span> ns/op        <span class="token number">4040076656</span> B/op    <span class="token number">10208</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">659047300</span> ns/op        <span class="token number">4040079488</span> B/op    <span class="token number">10237</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">712991800</span> ns/op        <span class="token number">4040077184</span> B/op    <span class="token number">10213</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">706605350</span> ns/op        <span class="token number">4040078000</span> B/op    <span class="token number">10222</span> allocs/op
BenchmarkConcatDirect-8                <span class="token number">2</span>         <span class="token number">656195700</span> ns/op        <span class="token number">4040085248</span> B/op    <span class="token number">10297</span> allocs/op
BenchmarkConcatBuilder
BenchmarkConcatBuilder-2            <span class="token number">2726</span>            <span class="token number">386412</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">3439</span>            <span class="token number">335358</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">3376</span>            <span class="token number">338957</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">3870</span>            <span class="token number">326301</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-2            <span class="token number">4285</span>            <span class="token number">339596</span> ns/op         <span class="token number">4128176</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1663</span>            <span class="token number">671535</span> ns/op         <span class="token number">4128187</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1507</span>            <span class="token number">744885</span> ns/op         <span class="token number">4128191</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1353</span>           <span class="token number">1097800</span> ns/op         <span class="token number">4128187</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1388</span>           <span class="token number">1006019</span> ns/op         <span class="token number">4128189</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-4            <span class="token number">1635</span>            <span class="token number">993764</span> ns/op         <span class="token number">4128189</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1332</span>            <span class="token number">783599</span> ns/op         <span class="token number">4128198</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1818</span>            <span class="token number">729821</span> ns/op         <span class="token number">4128202</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1398</span>            <span class="token number">780614</span> ns/op         <span class="token number">4128202</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">1526</span>            <span class="token number">750513</span> ns/op         <span class="token number">4128204</span> B/op         <span class="token number">29</span> allocs/op
BenchmarkConcatBuilder-8            <span class="token number">2164</span>            <span class="token number">704798</span> ns/op         <span class="token number">4128204</span> B/op         <span class="token number">29</span> allocs/op
PASS
ok      golearn/tool_test       <span class="token number">50</span>.387s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再使用benchstat进行对比</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ benchstat old.txt new.txt
goos: windows
goarch: amd64
pkg: golearn/tool_test
cpu: 11th Gen Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-11800H @ <span class="token number">2</span>.30GHz
                │    old.txt    │               new.txt                │
                │    sec/op     │    sec/op      vs base               │
ConcatDirect-2     <span class="token number">299</span>.0m ± ∞ ¹    <span class="token number">286</span>.7m ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.310</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-4     <span class="token number">894</span>.7m ± ∞ ¹   <span class="token number">1123</span>.2m ± ∞ ¹  +25.53% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-8     <span class="token number">684</span>.0m ± ∞ ¹    <span class="token number">706</span>.6m ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.548</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-2    <span class="token number">423.9</span>µ ± ∞ ¹    <span class="token number">339.0</span>µ ± ∞ ¹  -20.04% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-4   <span class="token number">1068.7</span>µ ± ∞ ¹    <span class="token number">993.8</span>µ ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.151</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-8    <span class="token number">736.5</span>µ ± ∞ ¹    <span class="token number">750.5</span>µ ± ∞ ¹        ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.841</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
geomean            <span class="token number">19</span>.84m          <span class="token number">19</span>.65m         -0.98%
¹ need <span class="token operator">&gt;=</span> <span class="token number">6</span> samples <span class="token keyword">for</span> confidence interval at level <span class="token number">0.95</span>

                │    old.txt    │                new.txt                │
                │     B/op      │     B/op       vs base                │
ConcatDirect-2    <span class="token number">3</span>.763Gi ± ∞ ¹   <span class="token number">3</span>.763Gi ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-4    <span class="token number">3</span>.763Gi ± ∞ ¹   <span class="token number">3</span>.763Gi ± ∞ ¹  -0.00% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-8    <span class="token number">3</span>.763Gi ± ∞ ¹   <span class="token number">3</span>.763Gi ± ∞ ¹  -0.00% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-2   <span class="token number">3</span>.937Mi ± ∞ ¹   <span class="token number">3</span>.937Mi ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> ²
ConcatBuilder-4   <span class="token number">3</span>.937Mi ± ∞ ¹   <span class="token number">3</span>.937Mi ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.079</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-8   <span class="token number">3</span>.937Mi ± ∞ ¹   <span class="token number">3</span>.937Mi ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.952</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
geomean           <span class="token number">123</span>.2Mi         <span class="token number">123</span>.2Mi        -0.00%
¹ need <span class="token operator">&gt;=</span> <span class="token number">6</span> samples <span class="token keyword">for</span> confidence interval at level <span class="token number">0.95</span>
² all samples are equal

                │   old.txt    │               new.txt                │
                │  allocs/op   │  allocs/op    vs base                │
ConcatDirect-2    <span class="token number">9</span>.999k ± ∞ ¹   <span class="token number">9</span>.999k ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-4    <span class="token number">10</span>.22k ± ∞ ¹   <span class="token number">10</span>.14k ± ∞ ¹  -0.74% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatDirect-8    <span class="token number">10</span>.35k ± ∞ ¹   <span class="token number">10</span>.22k ± ∞ ¹  -1.26% <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.008</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
ConcatBuilder-2    <span class="token number">29.00</span> ± ∞ ¹    <span class="token number">29.00</span> ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> ²
ConcatBuilder-4    <span class="token number">29.00</span> ± ∞ ¹    <span class="token number">29.00</span> ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> ²
ConcatBuilder-8    <span class="token number">29.00</span> ± ∞ ¹    <span class="token number">29.00</span> ± ∞ ¹       ~ <span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">1.000</span> <span class="token assign-left variable">n</span><span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span> ²
geomean            <span class="token number">543.6</span>          <span class="token number">541.7</span>        -0.33%
¹ need <span class="token operator">&gt;=</span> <span class="token number">6</span> samples <span class="token keyword">for</span> confidence interval at level <span class="token number">0.95</span>
² all samples are equal
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从结果中可以看出benchstat将其分为了三组，分别是耗时，内存占用和内存分配次数，其中<code>geomoean</code>为平均值，<code>p</code>为 样本的显著性水平，临界区间通常为0.05，高于0.05就不太可信，取其中一条数据如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>					│    sec/op     │    sec/op      vs base               │
ConcatDirect-4     894.7m ± ∞ ¹   1123.2m ± ∞ ¹  +25.53% (p=0.008 n=5)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到<code>old</code>执行耗时为894.7ms，<code>new</code>执行耗时1123.2ms，相比之下还增加了25.53%的耗时。</p><h2 id="模糊测试" tabindex="-1"><a class="header-anchor" href="#模糊测试" aria-hidden="true">#</a> 模糊测试</h2>`,120),r={href:"https://go.dev/security/fuzz/",target:"_blank",rel:"noopener noreferrer"},d=s("code",null,"/tool/strings.go",-1),k=a(`<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool

<span class="token keyword">func</span> <span class="token function">Reverse</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
		b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建模糊测试文件<code>/tool_test/fuzz_tool_test.go</code>，写入如下代码</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> tool

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;golearn/tool&quot;</span>
	<span class="token string">&quot;testing&quot;</span>
	<span class="token string">&quot;unicode/utf8&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">FuzzReverse</span><span class="token punctuation">(</span>f <span class="token operator">*</span>testing<span class="token punctuation">.</span>F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	testdata <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;hello world!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nice to meet you&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;good bye!&quot;</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> testdata <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	f<span class="token punctuation">.</span><span class="token function">Fuzz</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		first <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
		second <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;str:%q,first:%q,second:%q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> first<span class="token punctuation">,</span> second<span class="token punctuation">)</span>
		<span class="token keyword">if</span> str <span class="token operator">!=</span> second <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;before: %q, after: %q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> utf8<span class="token punctuation">.</span><span class="token function">ValidString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>utf8<span class="token punctuation">.</span><span class="token function">ValidString</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Reverse produced invalid UTF-8 string %q %q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> first<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在模糊测试中，首先需要给语料种子库添加数据，示例中使用<code>f.Add()</code>来添加，有助于后续生成随机的测试数据。然后使用<code>f.Fuzz(fn)</code>来进行测试，函数签名如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>F<span class="token punctuation">)</span> <span class="token function">Fuzz</span><span class="token punctuation">(</span>ff any<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>f <span class="token operator">*</span>F<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>args <span class="token operator">...</span>any<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fn</code>就类似于一个单元测试函数的逻辑，函数的第一个入参必须是<code>t *testing.T</code>，其后跟想要生成的参数。由于传入的字符串是不可预知的，这里采用反转两次的方法来进行验证。执行如下命令</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span> Fuzz <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse/seed<span class="token comment">#0</span>
    fuzz_tool_test.go:18: str:<span class="token string">&quot;hello world!&quot;</span>,first:<span class="token string">&quot;!dlrow olleh&quot;</span>,second:<span class="token string">&quot;hello world!&quot;</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse/seed<span class="token comment">#1</span>
    fuzz_tool_test.go:18: str:<span class="token string">&quot;nice to meet you&quot;</span>,first:<span class="token string">&quot;uoy teem ot ecin&quot;</span>,second:<span class="token string">&quot;nice to meet you&quot;</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse/seed<span class="token comment">#2</span>
    fuzz_tool_test.go:18: str:<span class="token string">&quot;good bye!&quot;</span>,first:<span class="token string">&quot;!eyb doog&quot;</span>,second:<span class="token string">&quot;good bye!&quot;</span>
--- PASS: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: FuzzReverse/seed<span class="token comment">#0 (0.00s)</span>
    --- PASS: FuzzReverse/seed<span class="token comment">#1 (0.00s)</span>
    --- PASS: FuzzReverse/seed<span class="token comment">#2 (0.00s)</span>
PASS
ok      golearn/tool_test       <span class="token number">0</span>.539s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当参数不带<code>-fuzz</code>时，将不会生成随机的测试数据，只会给测试函数传入语料库中的数据，可以从结果中看到测试全部通过了，这样使用就等同于单元测试，但其实是有问题的，下面加上<code>-fuzz</code>参数再次执行。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-fuzz</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-fuzztime</span> 30s <span class="token parameter variable">-run</span> Fuzz <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">0</span>/217 completed
fuzz: minimizing <span class="token number">91</span>-byte failing input <span class="token function">file</span>
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">15</span>/217 completed
--- FAIL: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.13s<span class="token punctuation">)</span>
    --- FAIL: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
        fuzz_tool_test.go:18: str:<span class="token string">&quot;𐑄&quot;</span>,first:<span class="token string">&quot;<span class="token entity" title="\\x84">\\x84</span><span class="token entity" title="\\x91">\\x91</span><span class="token entity" title="\\x90">\\x90</span><span class="token entity" title="\\xf0">\\xf0</span>&quot;</span>,second:<span class="token string">&quot;𐑄&quot;</span>
        fuzz_tool_test.go:23: Reverse produced invalid UTF-8 string <span class="token string">&quot;𐑄&quot;</span> <span class="token string">&quot;<span class="token entity" title="\\x84">\\x84</span><span class="token entity" title="\\x91">\\x91</span><span class="token entity" title="\\x90">\\x90</span><span class="token entity" title="\\xf0">\\xf0</span>&quot;</span>

    Failing input written to testdata<span class="token punctuation">\\</span>fuzz<span class="token punctuation">\\</span>FuzzReverse<span class="token punctuation">\\</span>d856c981b6266ba2
    To re-run:
    go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span><span class="token operator">=</span>FuzzReverse/d856c981b6266ba2
<span class="token operator">==</span><span class="token operator">=</span> NAME
FAIL
<span class="token builtin class-name">exit</span> status <span class="token number">1</span>
FAIL    golearn/tool_test       <span class="token number">0</span>.697s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">提示</p><p>模糊测试中失败的用例会输出到当前测试文件夹下的<code>testdata</code>目录下的某个语料文件中，例如上述例子中的</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Failing input written to testdata\\fuzz\\FuzzReverse\\d856c981b6266ba2
To re-run:
go test -run=FuzzReverse/d856c981b6266ba2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>testdata\\fuzz\\FuzzReverse\\d856c981b6266ba2</code>便是输出的语料文件路径，文件的内容如下</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>go test fuzz v1
string(&quot;𐑄&quot;)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></div><p>可以看到这一次并没有通过，原因是字符串反转后变成了非<code>utf8</code>格式，所以通过模糊测试就发现了这个问题所在。由于一些字符占用并不止一个字节，如果将其以字节为单位反转后肯定是乱码，所以将待测试的源代码修改为如下，将字符串转换为<code>[]rune</code>，这样就可以避免出现上述问题。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Reverse</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来直接运行根据上次模糊测试失败的用例</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-run</span><span class="token operator">=</span>FuzzReverse/d856c981b6266ba2 <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse/d856c981b6266ba2
    fuzz_tool_test.go:18: str:<span class="token string">&quot;𐑄&quot;</span>,first:<span class="token string">&quot;𐑄&quot;</span>,second:<span class="token string">&quot;𐑄&quot;</span>
--- PASS: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
    --- PASS: FuzzReverse/d856c981b6266ba2 <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
PASS
ok      golearn/tool_test       <span class="token number">0</span>.033s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到这一次通过了测试，再次执行模糊测试看看还有没有问题</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-fuzz</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-fuzztime</span> 30s <span class="token parameter variable">-run</span> Fuzz <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">0</span>/219 completed
fuzz: minimizing <span class="token number">70</span>-byte failing input <span class="token function">file</span>
failure <span class="token keyword">while</span> testing seed corpus entry: FuzzReverse/d97214ce235bfcf5
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">2</span>/219 completed
--- FAIL: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.15s<span class="token punctuation">)</span>
    --- FAIL: FuzzReverse <span class="token punctuation">(</span><span class="token number">0</span>.00s<span class="token punctuation">)</span>
        fuzz_tool_test.go:18: str:<span class="token string">&quot;<span class="token entity" title="\\xe4">\\xe4</span>&quot;</span>,first:<span class="token string">&quot;�&quot;</span>,second:<span class="token string">&quot;�&quot;</span>
        fuzz_tool_test.go:20: before: <span class="token string">&quot;<span class="token entity" title="\\xe4">\\xe4</span>&quot;</span>, after: <span class="token string">&quot;�&quot;</span>

<span class="token operator">==</span><span class="token operator">=</span> NAME
FAIL
<span class="token builtin class-name">exit</span> status <span class="token number">1</span>
FAIL    golearn/tool_test       <span class="token number">0</span>.184s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以发现又出错了，这次的问题是对字符串做了两次反转后不相等，原字符为<code>\\xe4</code>，期望的结果是<code>4ex\\</code> ，但结果是乱码，如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;\\xe4&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;\\xe4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span><span class="token string">&quot;\\xe4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%q\\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\xe4&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x\\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;\\xe4&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它的执行结果是</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>�
[65533]
&quot;\\xe4&quot; 
e4   
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>究其原因在于Go在字符串单位是字节，而不是字符。所以再次修改待测源代码，如果传入的是非utf8字符串，直接返回错误。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Reverse</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>utf8<span class="token punctuation">.</span><span class="token function">ValidString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> s<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;input is not valid UTF-8&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    r <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">rune</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
        r<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> r<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试代码也需要稍作修改</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FuzzReverse</span><span class="token punctuation">(</span>f <span class="token operator">*</span>testing<span class="token punctuation">.</span>F<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	testdata <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;hello world!&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;nice to meet you&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;good bye!&quot;</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> testdata <span class="token punctuation">{</span>
		f<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	f<span class="token punctuation">.</span><span class="token function">Fuzz</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		first<span class="token punctuation">,</span> err <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		second<span class="token punctuation">,</span> err <span class="token operator">:=</span> tool<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Skip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		t<span class="token punctuation">.</span><span class="token function">Logf</span><span class="token punctuation">(</span><span class="token string">&quot;str:%q,first:%q,second:%q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> first<span class="token punctuation">,</span> second<span class="token punctuation">)</span>
		<span class="token keyword">if</span> str <span class="token operator">!=</span> second <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;before: %q, after: %q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> utf8<span class="token punctuation">.</span><span class="token function">ValidString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>utf8<span class="token punctuation">.</span><span class="token function">ValidString</span><span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;Reverse produced invalid UTF-8 string %q %q&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> first<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当反转函数返回<code>error</code>时，就跳过测试，再来进行模糊测试</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ go <span class="token builtin class-name">test</span> <span class="token parameter variable">-fuzz</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-fuzztime</span> 30s <span class="token parameter variable">-run</span> Fuzz <span class="token parameter variable">-v</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN   FuzzReverse
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">0</span>/219 completed
fuzz: elapsed: 0s, gathering baseline coverage: <span class="token number">219</span>/219 completed, now fuzzing with <span class="token number">16</span> workers
fuzz: elapsed: 3s, execs: <span class="token number">895571</span> <span class="token punctuation">(</span><span class="token number">297796</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">32</span> <span class="token punctuation">(</span>total: <span class="token number">251</span><span class="token punctuation">)</span>
fuzz: elapsed: 6s, execs: <span class="token number">1985543</span> <span class="token punctuation">(</span><span class="token number">363120</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">37</span> <span class="token punctuation">(</span>total: <span class="token number">256</span><span class="token punctuation">)</span>
fuzz: elapsed: 9s, execs: <span class="token number">3087837</span> <span class="token punctuation">(</span><span class="token number">367225</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">38</span> <span class="token punctuation">(</span>total: <span class="token number">257</span><span class="token punctuation">)</span>
fuzz: elapsed: 12s, execs: <span class="token number">4090817</span> <span class="token punctuation">(</span><span class="token number">335167</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">40</span> <span class="token punctuation">(</span>total: <span class="token number">259</span><span class="token punctuation">)</span>
fuzz: elapsed: 15s, execs: <span class="token number">5132580</span> <span class="token punctuation">(</span><span class="token number">346408</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">44</span> <span class="token punctuation">(</span>total: <span class="token number">263</span><span class="token punctuation">)</span>
fuzz: elapsed: 18s, execs: <span class="token number">6248486</span> <span class="token punctuation">(</span><span class="token number">372185</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">45</span> <span class="token punctuation">(</span>total: <span class="token number">264</span><span class="token punctuation">)</span>
fuzz: elapsed: 21s, execs: <span class="token number">7366827</span> <span class="token punctuation">(</span><span class="token number">373305</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">46</span> <span class="token punctuation">(</span>total: <span class="token number">265</span><span class="token punctuation">)</span>
fuzz: elapsed: 24s, execs: <span class="token number">8439803</span> <span class="token punctuation">(</span><span class="token number">358059</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">47</span> <span class="token punctuation">(</span>total: <span class="token number">266</span><span class="token punctuation">)</span>
fuzz: elapsed: 27s, execs: <span class="token number">9527671</span> <span class="token punctuation">(</span><span class="token number">361408</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">47</span> <span class="token punctuation">(</span>total: <span class="token number">266</span><span class="token punctuation">)</span>
fuzz: elapsed: 30s, execs: <span class="token number">10569473</span> <span class="token punctuation">(</span><span class="token number">348056</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">48</span> <span class="token punctuation">(</span>total: <span class="token number">267</span><span class="token punctuation">)</span>
fuzz: elapsed: 30s, execs: <span class="token number">10569473</span> <span class="token punctuation">(</span><span class="token number">0</span>/sec<span class="token punctuation">)</span>, new interesting: <span class="token number">48</span> <span class="token punctuation">(</span>total: <span class="token number">267</span><span class="token punctuation">)</span>
--- PASS: FuzzReverse <span class="token punctuation">(</span><span class="token number">30</span>.16s<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">=</span> NAME
PASS
ok      golearn/tool_test       <span class="token number">30</span>.789s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后这次就可以得到一个比较完整的模糊测试输出日志，其中一些概念的解释如下：</p><ul><li>elapsed: 一个轮次完成后已经流逝的时间</li><li>execs: 运行的输入总数，297796/sec表示多少个输入每秒</li><li>new interesting: 在测试中，已经添加语料库中的”有趣“输入的总数。（有趣的输入指的是该输入能够将代码覆盖率扩大到现有语料库所能覆盖的范围之外，随着覆盖范围的不断扩大，它的增长趋势总体上而言会持续变缓）</li></ul><div class="hint-container tip"><p class="hint-container-title">提示</p><p>如果没有<code>-fuzztime</code>参数限制时间，模糊测试将会永远的运行下去。</p></div><h3 id="类型支持" tabindex="-1"><a class="header-anchor" href="#类型支持" aria-hidden="true">#</a> 类型支持</h3><p>Go Fuzz中的支持的类型如下：</p><ul><li><code>string</code>, <code>[]byte</code></li><li><code>int</code>, <code>int8</code>, <code>int16</code>, <code>int32</code>/<code>rune</code>, <code>int64</code></li><li><code>uint</code>, <code>uint8</code>/<code>byte</code>, <code>uint16</code>, <code>uint32</code>, <code>uint64</code></li><li><code>float32</code>, <code>float64</code></li><li><code>bool</code></li></ul>`,32);function v(m,b){const e=l("ExternalLinkIcon");return p(),o("div",null,[u,s("p",null,[n("模糊测试是GO1.18推出的一个新功能，属于是单元测试和基准测试的一种增强，区别在于前两者的测试数据都需要开发者手动编写，而模糊测试可以通过语料库来生成随机的测试数据，关于Go中的模糊测试可以前往"),s("a",r,[n("Go Fuzzing"),c(e)]),n("来了解更多概念。模糊测试的好处在于，相比于固定的测试数据，随机数据可以更好的测试程序的边界条件。下面拿官方教程的例子来讲解，这次需要测试的是一个反转字符串的函数，首先创建文件"),d,n("，写入如下代码")]),k])}const f=t(i,[["render",v],["__file","120.test.html.vue"]]);export{f as default};
