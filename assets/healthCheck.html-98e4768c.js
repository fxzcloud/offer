import{_ as t,V as p,W as e,X as n,Y as c,Z as o,$ as s,F as l}from"./framework-8edddef6.js";const i={},u=s('<h1 id="nacos健康检查机制" tabindex="-1"><a class="header-anchor" href="#nacos健康检查机制" aria-hidden="true">#</a> nacos健康检查机制</h1><h2 id="概述" tabindex="-1"><a class="header-anchor" href="#概述" aria-hidden="true">#</a> 概述</h2><p>想象一下这么一个场景，你所在的地区突然发生地质灾害，你被掩盖在废墟下面，搜救队必须要知道你在废墟里面那么才能对你进行施救。那么有什么方法可以让救援队知道你在废墟下面？</p><p>第一种，你在废墟里面大喊help! help! I am here! ，让搜救队知道你的位置和健康状态。</p><p>第二种，搜救队使用了他们的专业检查设备，探测到你正埋在废墟下面。 这两种检查方式其实也可以类比到我们对于服务的探测，我们需要知道一个服务是否还健康。那么第一种方式是<strong>客户端主动上报</strong>，告诉服务端自己健康状态，如果在一段时间没有上报，那么我们就认为服务已经不健康。第二种，则是<strong>服务端主动向客户端进行探测</strong>，检查客户端是否还被能探测到。 <img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/Z2nFJV.png" alt="image.png" loading="lazy"> 再回到前面的场景中，如果是你在废墟中大声呼叫救援队并且提供你的位置和健康信息，那么相比于搜救队用探测设备挨着废墟探测会使探测队的工作量减轻很多，那么他可以专注于尽快将你救出。这也好比于注册中心对于服务健康状态的检测，<strong>如果所有服务都需要注册中心去主动探测，由于服务的数量远大于注册中心的数量，那么注册中心的任务量将会比较巨大。所以我们自然而然会想到，那就都采用服务主动上报的方式进行健康检查。那如果在废墟之下的我们因为身体状况无法呼救，那么搜救队就会放弃搜救了吗？当然不是，搜救队肯定也会对废墟进行全面探测将你救出。类比到服务健康检查，如果服务本身就没法主动进行健康上报，那么这个时候注册中心主动检查健康状态就有用武之地了。</strong><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/Sspmeb.png" alt="image.png" loading="lazy"> 在当前主流的注册中心，对于健康检查机制主要都采用了 TTL（Time To Live)机制，即客户端在一定时间没有向注册中心发送心跳，那么注册中心会认为此服务不健康，进而触发后续的剔除逻辑。对于主动探测的方式那么根据不同的场景，需要采用的方式可能会有不同。</p><p>既然以上两种健康检查机制都有应用的场景，且适用场景不一致，那么 Nacos 对于健康检查的机制又是如何抉择的呢？ 在介绍 Nacos 的健康检查机制之前，我们先回顾一下 Nacos 服务有什么特点。Nacos 提供了两种服务类型供用户注册实例时选择，<strong>分为非持久化实例（又称临时实例）和持久化实例（又称永久实例）。</strong> 临时实例只是临时存在于注册中心中，会在服务下线或不可用时被注册中心剔除，临时实例会与注册中心保持心跳，注册中心会在一段时间没有收到来自客户端的心跳后会将实例设置为不健康，然后在一段时间后进行剔除。 永久实例在被删除之前会永久的存在于注册中心，且有可能并不知道注册中心存在，不会主动向注册中心上报心跳，那么这个时候就需要注册中心主动进行探活。 从上面的介绍我们可以看出，Nacos 中两种健康探测方式均有被使用，Nacos 中健康检查的整体交互如下如所示。下面我们会详细介绍 Nacos 中对于两种实例的健康检查机制。 <img src="https://cdn.nlark.com/yuque/0/2020/png/1465210/1598000047612-f1ea83bb-67c4-4c92-83ef-1e29f9f3370c.png#from=url&amp;height=352&amp;id=p6ETm&amp;originHeight=368&amp;originWidth=564&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;status=done&amp;style=none&amp;title=Nacos两种实例健康检查机制&amp;width=539" alt="Nacos两种实例健康检查机制" loading="lazy"></p><h3 id="临时实例健康检查机制" tabindex="-1"><a class="header-anchor" href="#临时实例健康检查机制" aria-hidden="true">#</a> 临时实例健康检查机制</h3><p>在 Nacos 中，用户可以通过两种方式进行临时实例的注册，通过 Nacos 的 OpenAPI 进行服务注册或通过 Nacos 提供的 SDK 进行服务注册。 OpenAPI 的注册方式实际是用户根据自身需求调用 Http 接口对服务进行注册，然后通过 Http 接口发送心跳到注册中心。在注册服务的同时会注册一个全局的客户端心跳检测的任务。在服务一段时间没有收到来自客户端的心跳后，该任务会将其标记为不健康，如果在间隔的时间内还未收到心跳，那么该任务会将其剔除。 SDK 的注册方式实际是通过 RPC 与注册中心保持连接（Nacos 2.x 版本中，旧版的还是仍然通过 OpenAPI 的方式），<strong>客户端会定时的通过 RPC 连接向 Nacos 注册中心发送心跳，保持连接的存活</strong>。<strong>如果客户端和注册中心的连接断开，那么注册中心会主动剔除该 client 所注册的服务，达到下线的效果。同时 Nacos 注册中心还会在注册中心启动时，注册一个过期客户端清除的定时任务，用于删除那些健康状态超过一段时间的客户端。</strong> 从上面的特点我们可以发现，对于不同类型的使用方式，Nacos 对于健康检查的特点实际都是相同的，都是由客户端向注册中心发送心跳，注册中心会在连接断开或是心跳过期后将不健康的实例移除。 <img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/52br3x.png" alt="image.png" loading="lazy"></p><h3 id="永久实例健康检查机制" tabindex="-1"><a class="header-anchor" href="#永久实例健康检查机制" aria-hidden="true">#</a> 永久实例健康检查机制</h3><p>Nacos 中使用 SDK 对于永久实例的注册实际<strong>也是使用 OpenAPI 的方式进行注册</strong>，这样可以保证即使是客户端下线后也不会影响永久实例的健康检查。 对于永久实例的的健康检查，Nacos 采用的是<strong>注册中心探测机制</strong>，注册中心会在持久化服务初始化时根据客户端选择的协议类型注册探活的定时任务。Nacos 现在内置提供了三种探测的协议，即 Http、TCP 以及 MySQL 。一般而言 Http 和 TCP 已经可以涵盖绝大多数的健康检查场景。MySQL 主要用于特殊的业务场景，例如数据库的主备需要通过服务名对外提供访问，需要确定当前访问数据库是否为主库时，那么我们此时的健康检查接口，是一个检查数据库是否为主库的 MySQL 命令。 <img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/nHGUtL.png" alt="image.png" loading="lazy"> 由于持久化服务的实例的在被主动删除前一直存在的特性，探活的定时任务会不断探测服务的健康状态，并且将无法探测成功的实例标记为不健康。但是有些时候会有这样的场景，有些服务不希望去校验其健康状态，Nacos也是提供了对应的白名单配置，用户可以将服务配置到该白名单，那么 Nacos 会放弃对其进行健康检查，实例的健康状态也始终为用户传入的健康状态。</p><h3 id="集群模式下的健康检查机制" tabindex="-1"><a class="header-anchor" href="#集群模式下的健康检查机制" aria-hidden="true">#</a> 集群模式下的健康检查机制</h3><p>一个完整的注册中心，是应该具备高可用的特性，即我们的注册中心是可以集群部署作为一个整体对外提供服务，当然 Nacos 也支持这样的特性。不同于单机部署，集群部署中我们的客户端只和其中一个注册中心服务保持链接和请求，但是我们的服务信息需要注册到所有的服务节点上，在其他客户端从任意一个注册中心服务获取服务列表时始终是所有的服务列表。在这种情况下，那么 Nacos 在集群模式下又是如何对不是和自己保持心跳连接的服务进行健康检查的呢？ <img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/5Wu1fD.png" alt="image.png" loading="lazy"> 对于集群下的服务，<strong>Nacos 一个服务只会被 Nacos 集群中的一个注册中心所负责，其余节点的服务信息只是集群副本，用于订阅者在查询服务列表时，始终可以获取到全部的服务列表。临时实例只会对其被负责的注册中心节点发送心跳信息，注册中心服务节点会对其负责的永久实例进行健康探测，在获取到健康状态后由当前负责的注册中心节点将健康信息同步到集群中的其他的注册中心。</strong> 在Nacos中，服务的注册我们从注册方式维度实际可以分为两大类。第一类通过 SDK RPC 连接进行注册，客户端会和注册中心保持链接。第二类，通过 OpenAPI 进行 IP 和端口注册。 对于第一类，如何寻找到对其负责的注册中心节点呢？聪明的你肯定想到了，只需要和注册中心集群中的任意一台节点建立联系，那么由这个节点负责这个客户端就可以了。<strong>注册中心会在启动时注册一个全局的同步任务，用于将其当前负责的所有节点信息同步到集群中的其他节点，其他非负责的节点也会创建该客户端的信息，在非负责的节点上，连接类型的客户端，会有一个续约时间的概念，在收到其他节点的同步信息时，更新续约时间为当前时间，如果在集群中的其他节点在一段时间内没有收到不是自己的负责的节点的同步信息，那么认为此节点已经不健康，从而达到对不是自己负责的节点健康状态检查。</strong><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/CwRWtG.png" alt="image.png" loading="lazy"> 对于第二类，方式其实也基本和第一类一致，OpenAPI 注册的临时实例也是通过同步自身负责的节点到其他节点来更新其他节点的对应的临时实例的心跳时间，保证其他节点不会删除或者修改此实例的健康状态。前面我们特别特别指明了是临时实例而没有说所有实例，你应该也可能会想到这种方式对于持久化节点的会显得多余，永久实例会在被主动删除前一直存在于注册中心，那么我们健康检查并不会去删除实例，所以我们只需要在负责的节点永久实例健康状态变更的时候通知到其余的节点即可。 <img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/Dfsoja.png" alt="image.png" loading="lazy"></p><h2 id="临时实例健康检测" tabindex="-1"><a class="header-anchor" href="#临时实例健康检测" aria-hidden="true">#</a> 临时实例健康检测</h2><ul><li>1.x：临时实例客户端每隔5s定时向服务端发送心跳，确保Instance存活。超过15s会标记为不健康，30s剔除。</li><li>2.x：临时实例客户端与服务端建立长连接，通过双向健康检查确保Client存活。服务端检测20s空闲连接，向客户端发起探测请求，如果客户端1s内响应，认为健康检查通过；客户端检测5s空闲连接，向服务端发起健康检查请求，如果服务端3s内响应，认为健康检查通过。</li><li>2.x服务端如果发现Client不健康，会从ClientManager移除Client，进而触发各种事件（集群/客户端数据同步）。</li></ul>',14),k={href:"https://github.com/alibaba/nacos/pull/10509",target:"_blank",rel:"noopener noreferrer"},r=s(`<p>客户端在NamingGrpcClientProxy创建时,就会进行探活以及补偿处理</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RpcClient</span>#start
  
        clientEventExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">ReconnectContext</span> reconnectContext <span class="token operator">=</span> reconnectionSignal
                            <span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>rpcClientConfig<span class="token punctuation">.</span><span class="token function">connectionKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>reconnectContext <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 检查活动时间。</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastActiveTimeStamp <span class="token operator">&gt;=</span> rpcClientConfig<span class="token punctuation">.</span><span class="token function">connectionKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">boolean</span> isHealthy <span class="token operator">=</span> <span class="token function">healthCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isHealthy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentConnection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token class-name">LoggerUtils</span><span class="token punctuation">.</span><span class="token function">printIfInfoEnabled</span><span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">,</span>
                                        <span class="token string">&quot;[{}] Server healthy check fail, currentConnection = {}&quot;</span><span class="token punctuation">,</span>
                                        rpcClientConfig<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentConnection<span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                
                                <span class="token class-name">RpcClientStatus</span> rpcClientStatus <span class="token operator">=</span> <span class="token class-name">RpcClient</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcClientStatus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RpcClientStatus</span><span class="token punctuation">.</span><span class="token constant">SHUTDOWN</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>rpcClientStatus<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                
                                <span class="token keyword">boolean</span> statusFLowSuccess <span class="token operator">=</span> <span class="token class-name">RpcClient</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcClientStatus
                                        <span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>rpcClientStatus<span class="token punctuation">,</span> <span class="token class-name">RpcClientStatus</span><span class="token punctuation">.</span><span class="token constant">UNHEALTHY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>statusFLowSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    reconnectContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReconnectContext</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                lastActiveTimeStamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        
                    <span class="token punctuation">}</span>
                    
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>reconnectContext<span class="token punctuation">.</span>serverInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// clear recommend server if server is not in server list.</span>
                        <span class="token keyword">boolean</span> serverExist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> server <span class="token operator">:</span> <span class="token function">getServerListFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ServerInfo</span> serverInfo <span class="token operator">=</span> <span class="token function">resolveServerInfo</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>serverInfo<span class="token punctuation">.</span><span class="token function">getServerIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>reconnectContext<span class="token punctuation">.</span>serverInfo<span class="token punctuation">.</span><span class="token function">getServerIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                serverExist <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                reconnectContext<span class="token punctuation">.</span>serverInfo<span class="token punctuation">.</span>serverPort <span class="token operator">=</span> serverInfo<span class="token punctuation">.</span>serverPort<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverExist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">LoggerUtils</span><span class="token punctuation">.</span><span class="token function">printIfInfoEnabled</span><span class="token punctuation">(</span><span class="token constant">LOGGER</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;[{}] Recommend server is not in server list, ignore recommend server {}&quot;</span><span class="token punctuation">,</span>
                                    rpcClientConfig<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reconnectContext<span class="token punctuation">.</span>serverInfo<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            
                            reconnectContext<span class="token punctuation">.</span>serverInfo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                            
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token function">reconnect</span><span class="token punctuation">(</span>reconnectContext<span class="token punctuation">.</span>serverInfo<span class="token punctuation">,</span> reconnectContext<span class="token punctuation">.</span>onRequestFail<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Do nothing</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        
        
        
        
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果客户端持续与服务端通讯，服务端是不需要主动探活的。见GrpcRequestAcceptor会调用ConnectionManager的refreshActiveTime刷新连接的lastActivetime。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// GrpcRequestAcceptor</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token class-name">Payload</span> grpcRequest<span class="token punctuation">,</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Payload</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> type <span class="token operator">=</span> grpcRequest<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 请求处理器</span>
    <span class="token class-name">RequestHandler</span> requestHandler <span class="token operator">=</span> requestHandlerRegistry<span class="token punctuation">.</span><span class="token function">getByRequestType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解析请求参数</span>
    <span class="token class-name">Object</span> parseObj <span class="token operator">=</span> <span class="token class-name">GrpcUtils</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>grpcRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// ..</span>
    <span class="token class-name">Request</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Request</span><span class="token punctuation">)</span> parseObj<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token constant">CONTEXT_KEY_CONN_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RequestMeta</span> requestMeta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestMeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMeta<span class="token punctuation">.</span><span class="token function">setClientIp</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMeta<span class="token punctuation">.</span><span class="token function">setConnectionId</span><span class="token punctuation">(</span><span class="token constant">CONTEXT_KEY_CONN_ID</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMeta<span class="token punctuation">.</span><span class="token function">setClientVersion</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestMeta<span class="token punctuation">.</span><span class="token function">setLabels</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLabels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 刷新长连接active time</span>
        connectionManager<span class="token punctuation">.</span><span class="token function">refreshActiveTime</span><span class="token punctuation">(</span>requestMeta<span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Response</span> response <span class="token operator">=</span> requestHandler<span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> requestMeta<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Payload</span> payloadResponse <span class="token operator">=</span> <span class="token class-name">GrpcUtils</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">traceIfNecessary</span><span class="token punctuation">(</span>payloadResponse<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>payloadResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务端定时任务每隔3s检测20s没有通信的链接进行探活 不成功则剔除。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">NacosRuntimeConnectionEjector</span>#ejectOutdatedConnection


  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">ejectOutdatedConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Connection check task start&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> connections <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span>connections<span class="token punctuation">;</span>
            <span class="token keyword">int</span> totalCount <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MetricsMonitor</span><span class="token punctuation">.</span><span class="token function">getLongConnectionMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>totalCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> currentSdkClientCount <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span><span class="token function">currentSdkClientCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Long connection metrics detail ,Total count ={}, sdkCount={},clusterCount={}&quot;</span><span class="token punctuation">,</span>
                    totalCount<span class="token punctuation">,</span> currentSdkClientCount<span class="token punctuation">,</span> <span class="token punctuation">(</span>totalCount <span class="token operator">-</span> currentSdkClientCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> outDatedConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//outdated connections collect.</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Connection</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> connections<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Connection</span> client <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastActiveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token constant">KEEP_ALIVE_TIME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    outDatedConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 检查日期连接</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Out dated connection ,size={}&quot;</span><span class="token punctuation">,</span> outDatedConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>outDatedConnections<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> successConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>outDatedConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> outDateConnectionId <span class="token operator">:</span> outDatedConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Connection</span> connection <span class="token operator">=</span> connectionManager<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">ClientDetectionRequest</span> clientDetectionRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientDetectionRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            connection<span class="token punctuation">.</span><span class="token function">asyncRequest</span><span class="token punctuation">(</span>clientDetectionRequest<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RequestCallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">return</span> <span class="token number">5000L</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>

                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponse</span><span class="token punctuation">(</span><span class="token class-name">Response</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        connection<span class="token punctuation">.</span><span class="token function">freshActiveTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        successConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>

                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]send connection active request &quot;</span><span class="token punctuation">,</span> outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionAlreadyClosedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Error occurs when check client active detection ,error={}&quot;</span><span class="token punctuation">,</span>
                                outDateConnectionId<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">5000L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Out dated connection check successCount={}&quot;</span><span class="token punctuation">,</span> successConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> outDateConnectionId <span class="token operator">:</span> outDatedConnections<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>successConnections<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Unregister Out dated connection....&quot;</span><span class="token punctuation">,</span> outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        connectionManager<span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span>outDateConnectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Connection check task end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">CONNECTION</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error occurs during connection check... &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注销链接。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConnectionManager</span>#unregister<span class="token operator">:</span>

<span class="token comment">// 链接注销</span>
<span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">unregister</span><span class="token punctuation">(</span><span class="token class-name">String</span> connectionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Connection</span> remove <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>remove <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> clientIp <span class="token operator">=</span> remove<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clientIp<span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> connectionForClientIp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>atomicInteger <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> atomicInteger<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                connectionForClientIp<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        remove<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[{}]Connection unregistered successfully. &quot;</span><span class="token punctuation">,</span> connectionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientConnectionEventListenerRegistry<span class="token punctuation">.</span><span class="token function">notifyClientDisConnected</span><span class="token punctuation">(</span>remove<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通知监听器，回调注销链接逻辑。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ClientConnectionEventListenerRegistry</span>#notifyClientDisConnected
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyClientDisConnected</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Connection</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ClientConnectionEventListener</span> clientConnectionEventListener <span class="token operator">:</span> clientConnectionEventListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            clientConnectionEventListener<span class="token punctuation">.</span><span class="token function">clientDisConnected</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">REMOTE</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[NotifyClientDisConnected] failed for listener {}&quot;</span><span class="token punctuation">,</span>
                    clientConnectionEventListener<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>删除客户端信息，发布事件，触发删除索引、集群同步。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConnectionBasedClientManager</span>#clientDisConnected
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clientDisConnected</span><span class="token punctuation">(</span><span class="token class-name">Connection</span> connect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clientDisconnected</span><span class="token punctuation">(</span>connect<span class="token punctuation">.</span><span class="token function">getMetaInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnectionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">clientDisconnected</span><span class="token punctuation">(</span><span class="token class-name">String</span> clientId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Client connection {} disconnect, remove instances and subscribers&quot;</span><span class="token punctuation">,</span> clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
 		<span class="token comment">// 先删客户端  </span>
 	 	<span class="token class-name">ConnectionBasedClient</span> client <span class="token operator">=</span> clients<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    client<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> isResponsible <span class="token operator">=</span> <span class="token function">isResponsibleClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 后删索引</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientReleaseEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> isResponsible<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 集群同步</span>
    <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientDisconnectEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> isResponsible<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ClientServiceIndexesManager</span><span class="token operator">:</span>


<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientReleaseEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleClientDisconnect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientReleaseEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientOperationEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleClientOperation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent</span><span class="token punctuation">)</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除客户端相关的索引</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleClientDisconnect</span><span class="token punctuation">(</span><span class="token class-name">ClientOperationEvent<span class="token punctuation">.</span>ClientReleaseEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Service</span> each <span class="token operator">:</span> client<span class="token punctuation">.</span><span class="token function">getAllSubscribeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeSubscriberIndexes</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DeregisterInstanceReason</span> reason <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">isNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token class-name">DeregisterInstanceReason</span><span class="token punctuation">.</span><span class="token constant">NATIVE_DISCONNECTED</span> <span class="token operator">:</span> <span class="token class-name">DeregisterInstanceReason</span><span class="token punctuation">.</span><span class="token constant">SYNCED_DISCONNECTED</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Service</span> each <span class="token operator">:</span> client<span class="token punctuation">.</span><span class="token function">getAllPublishedService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removePublisherIndexes</span><span class="token punctuation">(</span>each<span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InstancePublishInfo</span> instance <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getInstancePublishInfo</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">NotifyCenter</span><span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeregisterInstanceTraceEvent</span><span class="token punctuation">(</span>currentTimeMillis<span class="token punctuation">,</span>
                <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> reason<span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> each<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                instance<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DistroClientDataProcessor</span><span class="token operator">:</span>

<span class="token comment">// 集群同步</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">syncToAllServer</span><span class="token punctuation">(</span><span class="token class-name">ClientEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Client</span> client <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInvalidClient</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientDisconnectEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DistroKey</span> distroKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distroProtocol<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span><span class="token punctuation">.</span><span class="token constant">DELETE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ClientEvent<span class="token punctuation">.</span>ClientChangedEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DistroKey</span> distroKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DistroKey</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        distroProtocol<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span>distroKey<span class="token punctuation">,</span> <span class="token class-name">DataOperation</span><span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ConnectionBasedClientManager的ExpiredClientCleaner会清理<strong>非本节点负责的</strong>客户端信息，本节点负责的由上述NacosRuntimeConnectionEjector#ejectOutdatedConnection剔除</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConnectionBasedClientManager</span>：
  
<span class="token comment">// nacos集群清理非本节点负责的客户端信息</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExpiredClientCleaner</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConnectionBasedClientManager</span> clientManager<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">ExpiredClientCleaner</span><span class="token punctuation">(</span><span class="token class-name">ConnectionBasedClientManager</span> clientManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientManager <span class="token operator">=</span> clientManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> each <span class="token operator">:</span> clientManager<span class="token punctuation">.</span><span class="token function">allClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ConnectionBasedClient</span> client <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ConnectionBasedClient</span><span class="token punctuation">)</span> clientManager<span class="token punctuation">.</span><span class="token function">getClient</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!=</span> client <span class="token operator">&amp;&amp;</span> client<span class="token punctuation">.</span><span class="token function">isExpire</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                clientManager<span class="token punctuation">.</span><span class="token function">clientDisconnected</span><span class="token punctuation">(</span>each<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="持久实例健康检测" tabindex="-1"><a class="header-anchor" href="#持久实例健康检测" aria-hidden="true">#</a> 持久实例健康检测</h2><p>客户端管理器 ClientManagerDelegate 实现 ClientManager 接口，持有 EphemeralIpPortClientManager、 PersistentIpPortClientManage 客户端管理器。PersistentIpPortClientManage对应的是基于Ip、端口的永久节点客户端管理器。</p><p>在注册实例，根据客户端Id获取连接时，会设置心跳检测的定时任务：</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/M2LGNu.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>最终执行到 PersistentIpPortClientManager 的 clientConnected 方法：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token number">1</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">clientConnected</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Client</span> client<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token number">2</span>     clients<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
 <span class="token number">3</span>         <span class="token class-name">Loggers</span><span class="token punctuation">.</span><span class="token constant">SRV_LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Client connection {} connect&quot;</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">4</span>         <span class="token class-name">IpPortBasedClient</span> ipPortBasedClient <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IpPortBasedClient</span><span class="token punctuation">)</span> client<span class="token punctuation">;</span>
 <span class="token number">5</span>         <span class="token comment">// 设置心跳检查定时任务</span>
 <span class="token number">6</span>         ipPortBasedClient<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">7</span>         <span class="token keyword">return</span> ipPortBasedClient<span class="token punctuation">;</span>
 <span class="token number">8</span>     <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">9</span>     <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>IpPortBasedClient#init() 心跳检查定时任务如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token number">1</span> <span class="token doc-comment comment">/**
 2  * 初始化client，设置心跳检测定时任务
 3  * Init client.
 4  */</span>
 <span class="token number">5</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token number">6</span>     <span class="token comment">// 临时节点</span>
 <span class="token number">7</span>     <span class="token keyword">if</span> <span class="token punctuation">(</span>ephemeral<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token number">8</span>         <span class="token comment">// ClientBeatCheckTaskV2 作为心跳检测的任务</span>
 <span class="token number">9</span>         beatCheckTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientBeatCheckTaskV2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>         <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>beatCheckTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span>     <span class="token comment">// 永久节点</span>
<span class="token number">12</span>     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token number">13</span>         <span class="token comment">// HealthCheckTaskV2 作为心跳检测的任务</span>
<span class="token number">14</span>         healthCheckTaskV2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HealthCheckTaskV2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span>         <span class="token class-name">HealthCheckReactor</span><span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>healthCheckTaskV2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>     <span class="token punctuation">}</span>
<span class="token number">17</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>前提是不是grpc的客户端：</p><p>​ 临时实例：使用 ClientBeatCheckTaskV2 处理健康检查。</p><p>永久实例：使用 HealthCheckTaskV2 处理健康检查。</p><p>永久节点的健康检查是由服务端定时与客户端建立tcp连接做健康检查，是服务端主动发起的探测，服定时请求客户端判断是否健康。</p><p>永久实例使用 HealthCheckTaskV2 处理健康检查，HealthCheckTaskV2类图如下：</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/JcfGSx.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>通过实现的run()方法得知，执行 HealthCheckTaskV2#doHealthCheck() 完成发起永久实例的健康检测。</p><p>最终执行 HealthCheckProcessorV2Delegate#process()，HealthCheckProcessorV2Delegate是一个代理类，具体的健康检查由内部维护的healthCheckProcessorMap中的具体实现类完成。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token number">1</span> <span class="token doc-comment comment">/**
 2  * 健康检查处理代理类
 3  */</span>
 <span class="token number">4</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HealthCheckProcessorV2Delegate</span> <span class="token keyword">implements</span> <span class="token class-name">HealthCheckProcessorV2</span> <span class="token punctuation">{</span>
 <span class="token number">5</span> 
 <span class="token number">6</span>     <span class="token comment">// 健康检查实现类 容器</span>
 <span class="token number">7</span>     <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">HealthCheckProcessorV2</span><span class="token punctuation">&gt;</span></span> healthCheckProcessorMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">8</span> 
 <span class="token number">9</span>     <span class="token annotation punctuation">@Override</span>
<span class="token number">10</span>     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">HealthCheckTaskV2</span> task<span class="token punctuation">,</span> <span class="token class-name">Service</span> service<span class="token punctuation">,</span> <span class="token class-name">ClusterMetadata</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>         <span class="token comment">// 从元数据中获取当前客户端的健康检查类型，默认TCP (HTTP、TCP、MYSQL、NONE) =&gt; HealthCheckType 枚举类</span>
<span class="token number">12</span>         <span class="token class-name">String</span> type <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getHealthyCheckType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>         <span class="token comment">// 根据类型从缓存中获取 健康检查具体处理类</span>
<span class="token number">14</span>         <span class="token class-name">HealthCheckProcessorV2</span> processor <span class="token operator">=</span> healthCheckProcessorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span>         <span class="token comment">// 找不到处理类 使用 NoneHealthCheckProcessor 做健康检查，及什么都不做</span>
<span class="token number">16</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">17</span>             processor <span class="token operator">=</span> healthCheckProcessorMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">NoneHealthCheckProcessor</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span>         <span class="token punctuation">}</span>
<span class="token number">19</span>         processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> service<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span>     <span class="token punctuation">}</span>
<span class="token number">21</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HealthCheckProcessorV2类图如下:</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/Vcao9W.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>子类实现与 HealthCheckType 枚举中的健康检查类型一一对应，下面来看下具体实现：</p><p><strong>HttpHealthCheckProcessor</strong></p><p>HttpHealthCheckProcessor的process是通过 RestTemplate 完成健康检测请求。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/W3LwNT.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p><strong>MysqlHealthCheckProcessor</strong></p><p>MysqlHealthCheckProcessor的process是执行配置中的sql，完成健康检测。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/lkmrYB.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>健康检测任务 MysqlCheckTask#run()，通过执行SQL来完成健康检测，执行过程不报异常，证明实例健康。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/cI8L0p.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p><strong>TcpHealthCheckProcessor</strong></p><p>TcpHealthCheckProcessor是通过构建Socket，然后对连接或读入事件进行监听，完成健康检测。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/4h9BTq.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>需要进行健康检测的实例添加到队列后，是在哪里执行的呢？</p><p>TcpHealthCheckProcessor实现了Runables接口，在TcpHealthCheckProcessor构造函数中启动了该任务。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/M4lE3n.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>在run方法中，执行了 processTask处理任务：</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/Hoj9DN.png" alt="0" tabindex="0" loading="lazy"><figcaption>0</figcaption></figure><p>TcpHealthCheckProcessor#processTask() 详情如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token number">1</span> <span class="token doc-comment comment">/**
 2  * 处理任务
 3  * @throws <span class="token reference"><span class="token class-name">Exception</span></span>
 4  */</span>
 <span class="token number">5</span> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
 <span class="token number">6</span>     <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Callable</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> tasks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token number">7</span>     <span class="token keyword">do</span> <span class="token punctuation">{</span>
 <span class="token number">8</span>         <span class="token comment">// 获取队列中需要进行心跳检测的实例</span>
 <span class="token number">9</span>         <span class="token class-name">Beat</span> beat <span class="token operator">=</span> taskQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token constant">CONNECT_TIMEOUT_MS</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span>beat <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">11</span>             <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token number">12</span>         <span class="token punctuation">}</span>
<span class="token number">13</span> 
<span class="token number">14</span>         <span class="token comment">// 添加到任务队列</span>
<span class="token number">15</span>         tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskProcessor</span><span class="token punctuation">(</span>beat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>taskQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token constant">NIO_THREAD_COUNT</span> <span class="token operator">*</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span> 
<span class="token number">18</span>     <span class="token comment">// 调用队列中任务，并获取执行结果</span>
<span class="token number">19</span>     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">:</span> <span class="token class-name">GlobalExecutor</span><span class="token punctuation">.</span><span class="token function">invokeAllTcpSuperSenseTask</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token number">20</span>         f<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span>     <span class="token punctuation">}</span>
<span class="token number">22</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NoneHealthCheckProcessor</strong></p><p>NoneHealthCheckProcessor什么都不做，不对示例进行健康检测。</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/02/26/rx3R7b.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure>`,57);function d(v,m){const a=l("ExternalLinkIcon");return p(),e("div",null,[u,n("p",null,[n("a",k,[c("add out date connection active detection,expel it when client no response. #10509"),o(a)])]),r])}const g=t(i,[["render",d],["__file","healthCheck.html.vue"]]);export{g as default};
