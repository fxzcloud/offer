<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>springäº‹åŠ¡ | æ€¨ç§å­¦java</title><meta name="description" content="ã€Œæµæ°´ä¸äº‰å…ˆ äº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/offer/assets/style-1e9048c3.css" as="style"><link rel="stylesheet" href="/offer/assets/style-1e9048c3.css">
    <link rel="modulepreload" href="/offer/assets/app-fdefc158.js"><link rel="modulepreload" href="/offer/assets/framework-8edddef6.js"><link rel="modulepreload" href="/offer/assets/SpringTransaction.html-1ddfa699.js"><link rel="modulepreload" href="/offer/assets/SpringTransaction.html-c6431cca.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/offer/" class="brand"><img class="logo" src="/offer/logo.png" alt="æ€¨ç§å­¦java"><!----><span class="site-name hide-in-pad">æ€¨ç§å­¦java</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link" aria-label="ç¬”è®°"><span class="font-icon icon iconfont icon-activity" style=""></span>ç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/offer/offer-started.html" class="nav-link" aria-label="å…«è‚¡"><span class="font-icon icon iconfont icon-shell" style=""></span>å…«è‚¡<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/link.html" class="nav-link" aria-label="å¤–éƒ¨é“¾æ¥"><span class="font-icon icon iconfont icon-share" style=""></span>å¤–éƒ¨é“¾æ¥<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/about.html" class="nav-link" aria-label="å…³äºä½œè€…"><span class="font-icon icon iconfont icon-alias" style=""></span>å…³äºä½œè€…<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/springboot4" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">nacos</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé›†ç¾¤åŒæ­¥"><!---->nacosé›†ç¾¤åŒæ­¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/config.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé…ç½®ä¸­å¿ƒ"><!---->nacosé…ç½®ä¸­å¿ƒ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/discoverAndSubscribe.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶"><!---->nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/healthCheck.html" class="nav-link sidebar-link sidebar-page" aria-label="nacoså¥åº·æ£€æŸ¥æœºåˆ¶"><!---->nacoså¥åº·æ£€æŸ¥æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/register.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡æ³¨å†Œ"><!---->nacosæœåŠ¡æ³¨å†Œ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">spring</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/spring/SpingInject.html" class="nav-link sidebar-link sidebar-page" aria-label="spingä¾èµ–æ³¨å…¥"><!---->spingä¾èµ–æ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/Spring@Async.html" class="nav-link sidebar-link sidebar-page" aria-label="springå¼‚æ­¥@Async"><!---->springå¼‚æ­¥@Async<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringAop.html" class="nav-link sidebar-link sidebar-page" aria-label="spring aop"><!---->spring aop<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringBeanLIfeCycle.html" class="nav-link sidebar-link sidebar-page" aria-label="spring beançš„ç”Ÿå‘½å‘¨æœŸ"><!---->spring beançš„ç”Ÿå‘½å‘¨æœŸ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringConfig.html" class="nav-link sidebar-link sidebar-page" aria-label="springé…ç½®æ–‡ä»¶"><!---->springé…ç½®æ–‡ä»¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="springäº‹åŠ¡"><!---->springäº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#å…³é”®ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å…³é”®ç±»"><!---->å…³é”®ç±»<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#platformtransactionmanager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PlatformTransactionManager"><!---->PlatformTransactionManager<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#abstractplatformtransactionmanager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AbstractPlatformTransactionManager"><!---->AbstractPlatformTransactionManager<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactiondefinition" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionDefinition"><!---->TransactionDefinition<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionstatus" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionStatus"><!---->TransactionStatus<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionsynchronizationmanager" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionSynchronizationManager"><!---->TransactionSynchronizationManager<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionsynchronization" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionSynchronization"><!---->TransactionSynchronization<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#enabletransactionmanagement" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="@EnableTransactionManagement"><!---->@EnableTransactionManagement<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#autoproxyregistrar" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AutoProxyRegistrar"><!---->AutoProxyRegistrar<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#proxytransactionmanagementconfiguration" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ProxyTransactionManagementConfiguration"><!---->ProxyTransactionManagementConfiguration<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#beanfactorytransactionattributesourceadvisor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="BeanFactoryTransactionAttributeSourceAdvisor"><!---->BeanFactoryTransactionAttributeSourceAdvisor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionattributesourcepointcut" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionAttributeSourcePointcut"><!---->TransactionAttributeSourcePointcut<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactioninterceptor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionInterceptor"><!---->TransactionInterceptor<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionaleventlistenerfactory" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="TransactionalEventListenerFactory"><!---->TransactionalEventListenerFactory<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-template" style=""></span><span class="title">spring boot</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringBoot/config.html" class="nav-link sidebar-link sidebar-page" aria-label="spring booté…ç½®åŠ è½½"><!---->spring booté…ç½®åŠ è½½<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringBoot/start.html" class="nav-link sidebar-link sidebar-page" aria-label="spring bootå¯åŠ¨æµç¨‹"><!---->spring bootå¯åŠ¨æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-module" style=""></span><span class="title">spring cloud</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringCloudCommon/configRefresh.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudé…ç½®åŠ¨æ€åˆ·æ–°"><!---->spring cloudé…ç½®åŠ¨æ€åˆ·æ–°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/loadBalancing.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloud loadBalanced"><!---->spring cloud loadBalanced<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/registerAndDiscover.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°"><!---->spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->springäº‹åŠ¡</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://fxzcloud.gitee.io/offer/" target="_blank" rel="noopener noreferrer">fxz</a></span><span property="author" content="fxz"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-02-29T07:03:48.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 89 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT89M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#å…³é”®ç±»" class="router-link-active router-link-exact-active toc-link level2">å…³é”®ç±»</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#platformtransactionmanager" class="router-link-active router-link-exact-active toc-link level3">PlatformTransactionManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#abstractplatformtransactionmanager" class="router-link-active router-link-exact-active toc-link level3">AbstractPlatformTransactionManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactiondefinition" class="router-link-active router-link-exact-active toc-link level3">TransactionDefinition</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionstatus" class="router-link-active router-link-exact-active toc-link level3">TransactionStatus</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionsynchronizationmanager" class="router-link-active router-link-exact-active toc-link level3">TransactionSynchronizationManager</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionsynchronization" class="router-link-active router-link-exact-active toc-link level3">TransactionSynchronization</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#enabletransactionmanagement" class="router-link-active router-link-exact-active toc-link level2">@EnableTransactionManagement</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#autoproxyregistrar" class="router-link-active router-link-exact-active toc-link level2">AutoProxyRegistrar</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#proxytransactionmanagementconfiguration" class="router-link-active router-link-exact-active toc-link level2">ProxyTransactionManagementConfiguration</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#beanfactorytransactionattributesourceadvisor" class="router-link-active router-link-exact-active toc-link level3">BeanFactoryTransactionAttributeSourceAdvisor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionattributesourcepointcut" class="router-link-active router-link-exact-active toc-link level3">TransactionAttributeSourcePointcut</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactioninterceptor" class="router-link-active router-link-exact-active toc-link level3">TransactionInterceptor</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringTransaction.html#transactionaleventlistenerfactory" class="router-link-active router-link-exact-active toc-link level3">TransactionalEventListenerFactory</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="springäº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#springäº‹åŠ¡" aria-hidden="true">#</a> springäº‹åŠ¡</h1><h2 id="å…³é”®ç±»" tabindex="-1"><a class="header-anchor" href="#å…³é”®ç±»" aria-hidden="true">#</a> å…³é”®ç±»</h2><h3 id="platformtransactionmanager" tabindex="-1"><a class="header-anchor" href="#platformtransactionmanager" aria-hidden="true">#</a> PlatformTransactionManager</h3><p>äº‹åŠ¡ç®¡ç†å™¨ï¼Œå®šä¹‰äº†å®ç°äº‹åŠ¡çš„è§„èŒƒã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionManager</span> <span class="token punctuation">{</span>
  
		<span class="token comment">// å¼€å¯äº‹åŠ¡</span>
    <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span>
          <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
  
		<span class="token comment">// æäº¤äº‹åŠ¡</span>
    <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
  
		<span class="token comment">// å›æ»šäº‹åŠ¡</span>
    <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="abstractplatformtransactionmanager" tabindex="-1"><a class="header-anchor" href="#abstractplatformtransactionmanager" aria-hidden="true">#</a> AbstractPlatformTransactionManager</h3><ol><li>åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡</li><li>åº”ç”¨åˆé€‚çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸º</li><li>åœ¨å¿…è¦çš„æ—¶å€™æŒ‚èµ·/æ¢å¤äº‹åŠ¡</li><li>æäº¤æ—¶æ£€æŸ¥äº‹åŠ¡æ˜¯å¦è¢«æ ‡è®°æˆä¸º<code>rollback-only</code></li><li>åœ¨å›æ»šæ—¶åšé€‚å½“çš„ä¿®æ”¹ï¼ˆæ˜¯æ‰§è¡ŒçœŸå®çš„å›æ»š/è¿˜æ˜¯å°†äº‹åŠ¡æ ‡è®°æˆ<code>rollback-only</code>ï¼‰</li><li>è§¦å‘æ³¨å†Œçš„åŒæ­¥å›è°ƒ</li></ol><h3 id="transactiondefinition" tabindex="-1"><a class="header-anchor" href="#transactiondefinition" aria-hidden="true">#</a> TransactionDefinition</h3><p>å¯¹äº‹åŠ¡å®šä¹‰çš„æŠ½è±¡ï¼Œè¿™äº›å®šä¹‰æœ‰äº›æ˜¯æ•°æ®åº“å±‚é¢æœ¬èº«å°±æœ‰çš„ï¼Œä¾‹å¦‚<code>éš”ç¦»çº§åˆ«ã€æ˜¯å¦åªè¯»ã€è¶…æ—¶æ—¶é—´ã€åç§°</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionDefinition</span> <span class="token punctuation">{</span>
<span class="token comment">// å®šä¹‰äº†7ä¸­äº‹åŠ¡çš„ä¼ æ’­æœºåˆ¶</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_REQUIRED</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_SUPPORTS</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_MANDATORY</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_REQUIRES_NEW</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_NOT_SUPPORTED</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_NEVER</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">PROPAGATION_NESTED</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

<span class="token comment">// 4ç§éš”ç¦»çº§åˆ«ï¼Œ-1ä»£è¡¨çš„æ˜¯ä½¿ç”¨æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«</span>
<span class="token comment">// æ¯”å¦‚åœ¨MySQLä¸‹ï¼Œä½¿ç”¨çš„å°±æ˜¯ISOLATION_REPEATABLE_READï¼ˆå¯é‡å¤è¯»ï¼‰</span>
<span class="token keyword">int</span> <span class="token constant">ISOLATION_DEFAULT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token constant">ISOLATION_READ_UNCOMMITTED</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token keyword">int</span> <span class="token constant">ISOLATION_READ_COMMITTED</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> <span class="token constant">ISOLATION_REPEATABLE_READ</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> <span class="token constant">ISOLATION_SERIALIZABLE</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>  

<span class="token comment">// äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸é™åˆ¶æ—¶é—´</span>
<span class="token keyword">int</span> <span class="token constant">TIMEOUT_DEFAULT</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// æä¾›äº†å¯¹ä¸Šé¢ä¸‰ä¸ªå±æ€§çš„getæ–¹æ³•</span>
<span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token constant">ISOLATION_DEFAULT</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">default</span> <span class="token keyword">int</span> <span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// äº‹åŠ¡æ˜¯å¦æ˜¯åªè¯»çš„ï¼Œé»˜è®¤ä¸æ˜¯</span>
<span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// äº‹åŠ¡çš„åç§°</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">default</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿”å›ä¸€ä¸ªåªè¯»çš„TransactionDefinition</span>
<span class="token comment">// åªå¯¹å±æ€§æä¾›äº†getteræ–¹æ³•ï¼Œæ‰€æœ‰å±æ€§éƒ½æ˜¯æ¥å£ä¸­å®šä¹‰çš„é»˜è®¤å€¼</span>
<span class="token keyword">static</span> <span class="token class-name">TransactionDefinition</span> <span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token class-name">StaticTransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultTransactionDefinition</span> <span class="token keyword">implements</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_PROPAGATION</span> <span class="token operator">=</span> <span class="token string">&quot;PROPAGATION_&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_ISOLATION</span> <span class="token operator">=</span> <span class="token string">&quot;ISOLATION_&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX_TIMEOUT</span> <span class="token operator">=</span> <span class="token string">&quot;timeout_&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">READ_ONLY_MARKER</span> <span class="token operator">=</span> <span class="token string">&quot;readOnly&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Constants</span> constants <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constants</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> propagationBehavior <span class="token operator">=</span> <span class="token constant">PROPAGATION_REQUIRED</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> isolationLevel <span class="token operator">=</span> <span class="token constant">ISOLATION_DEFAULT</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionAttribute</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionDefinition</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä¸æ­¤äº‹åŠ¡å±æ€§å…³è”çš„é™å®šç¬¦å€¼ã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è¿™å¯ç”¨äºé€‰æ‹©ç›¸åº”çš„äº‹åŠ¡ç®¡ç†å™¨
     * å¤„ç†æ­¤ç‰¹å®šäº¤æ˜“ã€‚
     * <span class="token keyword">@since</span> 3.0
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token class-name">String</span> <span class="token function">getQualifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿”å›ä¸æ­¤äº¤æ˜“å±æ€§å…³è”çš„æ ‡ç­¾ã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è¿™å¯ç”¨äºåº”ç”¨ç‰¹å®šçš„äº‹åŠ¡è¡Œä¸º
     * æˆ–éµå¾ªçº¯ç²¹çš„æè¿°æ€§ã€‚
     * <span class="token keyword">@since</span> 5.3
     */</span>
    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getLabels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æˆ‘ä»¬æ˜¯å¦åº”è¯¥å›æ»šç»™å®šçš„å¼‚å¸¸ï¼Ÿ
     * <span class="token keyword">@param</span> <span class="token parameter">ex</span> the exception to evaluate
     * <span class="token keyword">@return</span> whether to perform a rollback or not
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DefaultTransactionAttribute</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token comment">// é»˜è®¤åªä¼šæ»šRuntimeExceptionå’ŒErrorç±»å‹</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span> <span class="token operator">||</span> ex <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">RuleBasedTransactionAttribute</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RollbackRuleAttribute</span> winner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> deepest <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rollbackRules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * è§„åˆ™æ˜¯å•¥çœ‹è¿™é‡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SpringTransactionAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RollbackRuleAttribute</span> rule <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rollbackRules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * depth = -1 è¡¨ç¤ºæ²¡åŒ¹é…åˆ°
             * */</span>
            <span class="token keyword">int</span> depth <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getDepth</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> depth <span class="token operator">&lt;</span> deepest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                deepest <span class="token operator">=</span> depth<span class="token punctuation">;</span>
                <span class="token comment">// è®°å½•åŒ¹é…çš„è§„åˆ™</span>
                winner <span class="token operator">=</span> rule<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// User superclass behavior (rollback on unchecked) if no rule matches.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>winner <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * ä½¿ç”¨çˆ¶ç±»åŒ¹é…è§„åˆ™ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">#</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *  å¾ˆç®€å• `return (ex instanceof RuntimeException || ex instanceof Error);`
         * */</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¸æ˜¯ NoRollbackRuleAttribute å°±å›æ»š</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>winner <span class="token keyword">instanceof</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactionstatus" tabindex="-1"><a class="header-anchor" href="#transactionstatus" aria-hidden="true">#</a> TransactionStatus</h3><p>æè¿°åˆ›å»ºåçš„äº‹åŠ¡çš„çŠ¶æ€</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/01/02/SAwBDa.tif" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionStatus</span> <span class="token keyword">extends</span> <span class="token class-name">TransactionExecution</span><span class="token punctuation">,</span> <span class="token class-name">SavepointManager</span><span class="token punctuation">,</span> <span class="token class-name">Flushable</span> <span class="token punctuation">{</span>

    <span class="token comment">// äºåˆ¤æ–­å½“å‰äº‹åŠ¡æ˜¯å¦è®¾ç½®äº†ä¿å­˜ç‚¹</span>
    <span class="token keyword">boolean</span> <span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   	<span class="token comment">// å¤å†™äº†çˆ¶æ¥å£Flushableä¸­çš„æ–¹æ³•</span>
		<span class="token comment">// ä¸»è¦ç”¨äºåˆ·æ–°ä¼šè¯</span>
		<span class="token comment">// å¯¹äºHibernate/jpaè€Œè¨€å°±æ˜¯è°ƒç”¨äº†å…¶session/entityManagerçš„flushæ–¹æ³•</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ¤æ–­å½“å‰äº‹åŠ¡æ˜¯å¦æ˜¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡</span>
<span class="token comment">// ä¸æ˜¯ä¸€ä¸ªæ–°äº‹åŠ¡çš„è¯ï¼Œé‚£ä¹ˆéœ€è¦åŠ å…¥åˆ°å·²ç»å­˜åœ¨çš„äº‹åŠ¡ä¸­</span>
<span class="token keyword">boolean</span> <span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// äº‹åŠ¡æ˜¯å¦è¢«æ ‡è®°æˆRollbackOnly</span>
<span class="token comment">// å¦‚æœè¢«æ ‡è®°æˆäº†RollbackOnlyï¼Œæ„å‘³ç€äº‹åŠ¡åªèƒ½è¢«å›æ»š</span>
<span class="token keyword">void</span> <span class="token function">setRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">boolean</span> <span class="token function">isRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// æ˜¯å¦äº‹åŠ¡å®Œæˆï¼Œå›æ»šæˆ–æäº¤éƒ½æ„å‘³ç€äº‹åŠ¡å®Œæˆäº†</span>
<span class="token keyword">boolean</span> <span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ›å»ºä¿å­˜ç‚¹</span>
<span class="token class-name">Object</span> <span class="token function">createSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

<span class="token comment">// å›æ»šåˆ°æŒ‡å®šä¿å­˜ç‚¹</span>
<span class="token keyword">void</span> <span class="token function">rollbackToSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

<span class="token comment">// ç§»é™¤å›æ»šç‚¹</span>
<span class="token keyword">void</span> <span class="token function">releaseSavepoint</span><span class="token punctuation">(</span><span class="token class-name">Object</span> savepoint<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactionsynchronizationmanager" tabindex="-1"><a class="header-anchor" href="#transactionsynchronizationmanager" aria-hidden="true">#</a> TransactionSynchronizationManager</h3><p>ç®¡ç†èµ„æºåŒæ­¥å’Œè¡Œä¸ºåŒæ­¥ã€‚</p><p>èµ„æºåŒæ­¥ï¼šæ•°æ®åº“è¿æ¥å°±æ˜¯è·Ÿè¿™ä¸ªäº‹åŠ¡åŒæ­¥çš„ä¸€ä¸ªèµ„æºã€‚</p><p>è¡Œä¸ºåŒæ­¥ï¼šåœ¨äº‹åŠ¡å¼€å¯ä¹‹å‰æˆ‘ä»¬éœ€è¦å…ˆè·å–ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼ŒåŒæ ·çš„åœ¨äº‹åŠ¡æäº¤æ—¶æˆ‘ä»¬éœ€è¦å°†è¿æ¥å…³é—­ï¼ˆä¸ä¸€å®šæ˜¯çœŸæ­£çš„å…³é—­ï¼Œå¦‚æœæ˜¯è¿æ¥æ± åªæ˜¯å½’è¿˜åˆ°è¿æ¥æ± ä¸­ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™å…³é—­è¿æ¥è¿™ä¸ªè¡Œä¸ºä¹Ÿéœ€è¦è·Ÿäº‹åŠ¡è¿›è¡ŒåŒæ­¥ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TransactionSynchronizationManager</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * äº‹åŠ¡èµ„æºï¼Œå°±æ˜¯å½“å‰äº‹ç‰©å†…æ¶‰åŠåˆ°çš„æ‰€æœ‰èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ï¼‰
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p?</span><span class="token punctuation">&gt;</span></span>
     * æ¯”å¦‚æ•°æ®åº“è¿æ¥ï¼š
     *      Keyï¼šDataSource å¯¹è±¡
     *      Valueï¼šConnectionHolder
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     * ä»€ä¹ˆæ—¶å€™ä¼šè®¾ç½®å€¼ï¼š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     *      1. å¼€å¯æ–°äº‹åŠ¡æ—¶ï¼Œä¼šé€šè¿‡ DataSource è·å–è¿æ¥ï¼Œå¹¶å°†è¿æ¥å­˜åˆ°è¿™é‡Œ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     *      2. æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">#</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è·å–è¿æ¥ï¼Œä½¿ç”¨ DataSource åšä¸ºkeyä» resourcesä¸­æ‰¾ä¸åˆ°è¿æ¥ï¼Œ
     *          å°±ä¼šä½¿ç”¨ DataSourceè·å–è¿æ¥ï¼Œå­˜åˆ° synchronizations å’Œ è¿™é‡Œ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     *      æ³¨ï¼šå‰ææ˜¯åœ¨äº‹åŠ¡å†…æ‰§è¡Œã€‚ç®€å•æ¥è¯´å°±æ˜¯Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•(å°±æ˜¯æœ‰<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionInterceptor</span><span class="token punctuation">#</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>)
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     * ä»€ä¹ˆæ—¶å€™ç§»é™¤keyå¯¹åº”å±æ€§å€¼ï¼š
     *      - æš‚åœå½“å‰äº‹åŠ¡
     *      - å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     *      Tipsï¼š<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token function">doUnbindResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Transactional resources&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * äº‹åŠ¡åŒæ­¥èµ„æºï¼Œå°±æ˜¯åœ¨äº‹åŠ¡ä¸­äº§ç”Ÿçš„ éäº‹åŠ¡ç®¡ç†å™¨æ•°æ®æºç”Ÿæˆçš„è¿æ¥æˆ–è€…æ˜¯ç”¨äºåœ¨äº‹åŠ¡å®Œæˆæ—¶(rollbackæˆ–è€…commit)è¦è§¦å‘äº‹ä»¶ï¼Œéƒ½ç®—æ˜¯äº‹åŠ¡åŒæ­¥èµ„æº
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     * æ¯”å¦‚ï¼š
     *      - ConnectionSynchronization
     *          ä½¿ç”¨å·¥å…·ç±»è·å–è¿æ¥ä¼šè®¾ç½® <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">#</span><span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *          è¿™ç§è¿æ¥å’Œäº‹åŠ¡è¿æ¥ä¸ä¸€æ ·ï¼Œæ˜¯ç›´æ¥é€šè¿‡æ•°æ®æºè·å–çš„è¿æ¥ï¼Œä¸ä¼šé…ç½®è‡ªåŠ¨æäº¤ã€è¶…æ—¶æ—¶é—´ã€éš”ç¦»çº§åˆ«ï¼Œé»˜è®¤æ˜¯å•¥å°±æ˜¯å•¥ï¼Œ
     *          å”¯ä¸€çš„ä½œç”¨å°±æ˜¯åœ¨äº‹åŠ¡å®Œæˆæ—¶(rollbackæˆ–è€…commit) é‡Šæ”¾æ‰è¿™äº›è¿æ¥
     *          æ¯”å¦‚ï¼šè·å–è¿æ¥ç”¨çš„æ•°æ®æº(d1)å’Œäº‹åŠ¡ç®¡ç†çš„æ•°æ®æº(d2)ä¸æ˜¯åŒä¸€ä¸ªæ—¶ï¼Œå°±ä¼šå°†d1åˆ›å»ºçš„è¿æ¥è£…é¥°æˆ ConnectionSynchronizationï¼Œ
     *              å¹¶å°†è¯¥å¯¹è±¡å­˜åˆ° synchronizations å±æ€§ä¸­ï¼Œç„¶åå¯¹åº”çš„è¿æ¥ä¹Ÿä¼šå­˜åˆ°æ³¨å†Œåˆ° resources ä¸­
     *
     *      - TransactionalApplicationListenerSynchronization
     *          å‘å¸ƒäº‹åŠ¡äº‹ä»¶æ—¶ä¼šè®¾ç½® <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionalApplicationListenerMethodAdapter</span><span class="token punctuation">#</span><span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *          ä½œç”¨å°±æ˜¯åœ¨äº‹åŠ¡å®Œæˆæ—¶(rollbackæˆ–è€…commit) å›è°ƒå…¶ TransactionalApplicationListenerã€SynchronizationCallback
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     * ä»€ä¹ˆæ—¶å€™ä¼šè®¾ç½®å€¼ï¼šç®€å•æ¥è¯´å°±æ˜¯Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•(å°±æ˜¯æœ‰<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionInterceptor</span><span class="token punctuation">#</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>)
     *      å…·ä½“ä¸€ç‚¹å°±æ˜¯æ‰§è¡Œå®Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">PlatformTransactionManager</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAttribute</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *      è¯¥å±æ€§å°±ä¼šè¢«åˆå§‹åŒ–ï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šæ ¹æ® `synchronizations.get() != null ` æ¥åˆ¤æ–­æ˜¯æ¿€æ´»äº†äº‹åŠ¡åŒæ­¥ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>
     * ä»€ä¹ˆæ—¶å€™æ¸…ç©ºè¯¥å±æ€§å€¼ï¼š
     *      1. æš‚åœå½“å‰äº‹åŠ¡
     *      2. å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     *      Tipsï¼š<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> synchronizations <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Transaction synchronizations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> currentTransactionName <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Current transaction name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> currentTransactionReadOnly <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Current transaction read-only status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> currentTransactionIsolationLevel <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Current transaction isolation level&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å®é™…æ¿€æ´»çš„äº‹åŠ¡ã€‚
     *  - å½“å‰çº¿ç¨‹çš„äº‹åŠ¡ä¸æ˜¯ç©ºäº‹åŠ¡ å°±æ˜¯ true
     *  - ç©ºäº‹åŠ¡ æˆ–è€… æ‰§è¡Œéäº‹åŠ¡æ–¹æ³•å°±æ˜¯ false
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> actualTransactionActive <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">NamedThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;Actual transaction active&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactionsynchronization" tabindex="-1"><a class="header-anchor" href="#transactionsynchronization" aria-hidden="true">#</a> TransactionSynchronization</h3><p>è¡Œä¸ºçš„åŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TransactionSynchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Flushable</span> <span class="token punctuation">{</span>
	<span class="token comment">// äº‹åŠ¡å®Œæˆçš„çŠ¶æ€</span>
    <span class="token comment">// 0 æäº¤</span>
    <span class="token comment">// 1 å›æ»š</span>
    <span class="token comment">// 2 å¼‚å¸¸çŠ¶æ€ï¼Œä¾‹å¦‚åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶å‡ºç°å¼‚å¸¸ï¼Œç„¶åå›æ»šï¼Œå›æ»šæ—¶åˆå‡ºç°å¼‚å¸¸</span>
    <span class="token comment">// å°±ä¼šè¢«æ ‡è®°æˆçŠ¶æ€2</span>
	<span class="token keyword">int</span> <span class="token constant">STATUS_COMMITTED</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token constant">STATUS_ROLLED_BACK</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> <span class="token constant">STATUS_UNKNOWN</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">// æˆ‘ä»¬ç»‘å®šçš„è¿™äº›TransactionSynchronizationéœ€è¦è·Ÿäº‹åŠ¡åŒæ­¥</span>
    <span class="token comment">// 1.å¦‚æœäº‹åŠ¡æŒ‚èµ·ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æŒ‚èµ·</span>
    <span class="token comment">// 2.å¦‚æœäº‹åŠ¡æ¢å¤ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ¢å¤</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	
  <span class="token comment">// åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæä¾›çš„ä¸€äº›å›è°ƒæ–¹æ³•</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> readOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">beforeCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">afterCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="enabletransactionmanagement" tabindex="-1"><a class="header-anchor" href="#enabletransactionmanagement" aria-hidden="true">#</a> @EnableTransactionManagement</h2><p>@EnableTransactionManagementæ³¨è§£ç”¨äºå¯ç”¨Springçš„äº‹åŠ¡ç®¡ç†åŠŸèƒ½ã€‚</p><ol><li><p><strong>@EnableTransactionManagementï¼š</strong></p><ul><li>ä½¿ç”¨<code>@EnableTransactionManagement</code>ä¼šå¯¼å…¥<code>@Import(TransactionManagementConfigurationSelector.class)</code>ã€‚</li><li>è§£æé…ç½®ç±»æ—¶ï¼Œå› ä¸º<code>TransactionManagementConfigurationSelector</code>çš„çˆ¶ç±»<code>AdviceModeImportSelector</code>å®ç°äº†<code>ImportSelector</code>ï¼Œæ‰€ä»¥ä¼šå›è°ƒ<code>AdviceModeImportSelector#selectImports(AnnotationMetadata)</code>æ–¹æ³•ã€‚</li><li>åœ¨è¿™ä¸ªå›è°ƒæ–¹æ³•ä¸­ï¼Œè·å–<code>@EnableTransactionManagement(mode = AdviceMode.PROXY)</code>æ³¨è§£çš„modeå±æ€§å€¼ï¼Œå›è°ƒå­ç±»æ–¹æ³•<code>TransactionManagementConfigurationSelector#selectImports(AdviceMode)</code>ã€‚</li></ul></li><li><p><strong>TransactionManagementConfigurationSelectorçš„å·¥ä½œæµç¨‹ï¼š</strong></p><ul><li><code>TransactionManagementConfigurationSelector#selectImports(AdviceMode)</code>æ–¹æ³•è¿”å›ä¸¤ä¸ªç±»ï¼š<code>AutoProxyRegistrar</code>å’Œ<code>ProxyTransactionManagementConfiguration</code>ï¼Œå°†å®ƒä»¬æ·»åŠ åˆ°BeanDefinitionMapä¸­ã€‚</li></ul></li><li><p><strong>AutoProxyRegistrarï¼š</strong></p><ul><li>ç»§æ‰¿<code>ImportBeanDefinitionRegistrar</code>ï¼Œæ‰€ä»¥è§£æ<code>@Import</code>æ—¶ä¼šå›è°ƒ<code>AutoProxyRegistrar#registerBeanDefinitions(AnnotationMetadata, BeanDefinitionRegistry)</code>æ–¹æ³•ã€‚</li><li>è¯¥æ–¹æ³•ä¼šæ‰§è¡Œ<code>AopConfigUtils#registerAutoProxyCreatorIfNecessary(BeanDefinitionRegistry)</code>ï¼Œæ³¨å†Œ<code>InfrastructureAdvisorAutoProxyCreator</code>åˆ°å®¹å™¨ä¸­ã€‚</li><li><code>InfrastructureAdvisorAutoProxyCreator</code>æ˜¯BeanPostProcessorï¼Œåœ¨å®ä¾‹åŒ–å‰ã€æå‰AOPã€åˆå§‹ååˆ¤æ–­beanæ˜¯å¦è¦è¿›è¡Œä»£ç†ã€‚</li></ul></li><li><p><strong>ProxyTransactionManagementConfigurationï¼š</strong></p><ul><li>ç»§æ‰¿<code>AbstractTransactionManagementConfiguration</code>ã€‚</li><li>é€šè¿‡@Beanæ³¨å†Œ<code>TransactionalEventListenerFactory</code>ï¼Œç”¨äºå¤„ç†<code>@TransactionalEventListener</code>æ ‡æ³¨çš„æ–¹æ³•ï¼Œå°†æ–¹æ³•æ„é€ æˆäº‹ä»¶ç›‘å¬å™¨ï¼Œæ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­ã€‚</li><li>é€šè¿‡@Beanæ³¨å†ŒAdvisorã€Advisorçš„Adviceå’ŒAnnotationTransactionAttributeSourceã€‚</li><li><code>BeanFactoryTransactionAttributeSourceAdvisor</code>å®ç°PointcutAdvisoræ¥å£ï¼Œå†³å®šæ˜¯å¦è¿›è¡Œä»£ç†çš„ä¾æ®æ˜¯<code>PointcutAdvisor#getPointcut()</code>ï¼Œå…¶Pointcutæ˜¯<code>TransactionAttributeSourcePointcut</code>ã€‚</li><li><code>TransactionInterceptor</code>æ˜¯Adviceï¼Œå®ç°äº†äº‹åŠ¡å¢å¼ºé€»è¾‘ã€‚</li><li>Advisorå’ŒAdviceéƒ½ä¾èµ–<code>AnnotationTransactionAttributeSource</code>è¿™ä¸ªbeanï¼Œç”¨æ¥æŸ¥æ‰¾ã€è§£æ@Transactionalã€‚åœ¨æ–¹æ³•ä¸Šæ‰¾ã€ç±»ä¸Šæ‰¾ã€‚</li></ul></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">TransactionManagementConfigurationSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableTransactionManagement</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * æŒ‡ç¤ºæ˜¯å¦è¦åˆ›å»ºåŸºäºå­ç±»çš„ ï¼ˆCGLIBï¼‰ ä»£ç† ï¼ˆ<span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">true</span></span></span><span class="token punctuation">}</span>ï¼‰ ä¸º
     * ä¸åŸºäºæ ‡å‡† Java æ¥å£çš„ä»£ç†ç›¸å ï¼ˆ<span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">false</span></span></span><span class="token punctuation">}</span>ï¼‰ã€‚é»˜è®¤å€¼ä¸º
     * <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">false</span></span></span><span class="token punctuation">}</span>ã€‚<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>ä»…å½“ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">mode</span></span>ï¼ˆï¼‰<span class="token punctuation">}</span> è®¾ç½®ä¸º
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdviceMode</span><span class="token punctuation">#</span><span class="token field">PROXY</span></span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>ã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>è¯·æ³¨æ„ï¼Œå°†æ­¤å±æ€§è®¾ç½®ä¸º <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">true</span></span></span><span class="token punctuation">}</span> å°†å½±å“<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>em</span><span class="token punctuation">&gt;</span></span>æ‰€æœ‰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>em</span><span class="token punctuation">&gt;</span></span>
     * Spring ç®¡ç†çš„ Bean éœ€è¦ä»£ç†ï¼Œè€Œä¸ä»…ä»…æ˜¯é‚£äº›æ ‡æœ‰
     * <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token annotation punctuation">@Transactional</span></span></span><span class="token punctuation">}</span>ã€‚ä¾‹å¦‚ï¼Œæ ‡æœ‰ Spring çš„å…¶ä»–è±†å­
     * <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token annotation punctuation">@Async</span></span></span><span class="token punctuation">}</span> æ³¨è§£å°†åŒæ—¶å‡çº§ä¸ºå­ç±»ä»£ç†
     *æ—¶é—´ã€‚è¿™ç§æ–¹æ³•åœ¨å®è·µä¸­æ²¡æœ‰è´Ÿé¢å½±å“ï¼Œé™¤éæ˜ç¡®
     * æœŸæœ›ä¸€ç§ç±»å‹çš„ä»£ç†ä¸å¦ä¸€ç§ç±»å‹çš„ä»£ç†ï¼Œä¾‹å¦‚åœ¨æµ‹è¯•ä¸­ã€‚
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Indicate how transactional advice should be applied.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>b</span><span class="token punctuation">&gt;</span></span>The default is <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdviceMode</span><span class="token punctuation">#</span><span class="token field">PROXY</span></span><span class="token punctuation">}</span>.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>b</span><span class="token punctuation">&gt;</span></span>
     * Please note that proxy mode allows for interception of calls through the proxy
     * only. Local calls within the same class cannot get intercepted that way; an
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Transactional</span></span><span class="token punctuation">}</span> annotation on such a method within a local call will be
     * ignored since Spring&#39;s interceptor does not even kick in for such a runtime
     * scenario. For a more advanced mode of interception, consider switching this to
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdviceMode</span><span class="token punctuation">#</span><span class="token field">ASPECTJ</span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token class-name">AdviceMode</span> <span class="token function">mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span><span class="token constant">PROXY</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Indicate the ordering of the execution of the transaction advisor
     * when multiple advices are applied at a specific joinpoint.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The default is <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Ordered</span><span class="token punctuation">#</span><span class="token field">LOWEST_PRECEDENCE</span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token keyword">int</span> <span class="token function">order</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">LOWEST_PRECEDENCE</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="autoproxyregistrar" tabindex="-1"><a class="header-anchor" href="#autoproxyregistrar" aria-hidden="true">#</a> AutoProxyRegistrar</h2><p>å‘å®¹å™¨ä¸­æ³¨å†ŒInfrastructureAdvisorAutoProxyCreatorï¼ŒæŸ¥æ‰¾å®¹å™¨ä¸­ç‰¹å®šç±»å‹çš„Advisorã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 	AnnotationMetadataï¼Œä»£è¡¨çš„æ˜¯AutoProxyRegistrarçš„å¯¼å…¥ç±»çš„å…ƒä¿¡æ¯</span>
<span class="token comment">// æ—¢åŒ…å«äº†ç±»å…ƒä¿¡æ¯ï¼Œä¹ŸåŒ…å«äº†æ³¨è§£å…ƒä¿¡æ¯</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> candidateFound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–@EnableTransactionManagementæ‰€åœ¨é…ç½®ç±»ä¸Šçš„æ³¨è§£å…ƒä¿¡æ¯</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> annTypes <span class="token operator">=</span> importingClassMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†æ³¨è§£</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> annType <span class="token operator">:</span> annTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯ä»¥ç†è§£ä¸ºå°†æ³¨è§£ä¸­çš„å±æ€§è½¬æ¢æˆä¸€ä¸ªmap</span>
        <span class="token class-name">AnnotationAttributes</span> candidate <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> annType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ç›´æ¥ä»mapä¸­è·å–å¯¹åº”çš„å±æ€§</span>
        <span class="token class-name">Object</span> mode <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> proxyTargetClass <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;proxyTargetClass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// modeï¼Œä»£ç†æ¨¡å‹ï¼Œä¸€èˆ¬éƒ½æ˜¯SpringAOP</span>
        <span class="token comment">// proxyTargetClass,æ˜¯å¦ä½¿ç”¨cglibä»£ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> proxyTargetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> mode<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> proxyTargetClass<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// æ³¨è§£ä¸­å­˜åœ¨è¿™ä¸¤ä¸ªå±æ€§ï¼Œå¹¶ä¸”å±æ€§ç±»å‹ç¬¦åˆè¦æ±‚ï¼Œè¡¨ç¤ºæ‰¾åˆ°äº†åˆé€‚çš„æ³¨è§£</span>
            candidateFound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// å®é™…ä¸Šä¼šå¾€å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ªInfrastructureAdvisorAutoProxyCreator</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token class-name">AdviceMode</span><span class="token punctuation">.</span><span class="token constant">PROXY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AopConfigUtils</span><span class="token punctuation">.</span><span class="token function">registerAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">)</span> proxyTargetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">AopConfigUtils</span><span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ......</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>@EnableAspectJAutoProxyæ³¨è§£ä¹Ÿå‘å®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ªèƒ½å®ç°è‡ªåŠ¨ä»£ç†çš„bdï¼Œé‚£ä¹ˆå½“@EnableAspectJAutoProxyè·Ÿ@EnableTransactionManagementåŒæ—¶ä½¿ç”¨ï¼Œä¼š<strong>æ ¹æ®ä¼˜å…ˆçº§ä»…ç”Ÿæ•ˆä¸€ä¸ª</strong>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">BeanDefinition</span> <span class="token function">registerOrEscalateApcAsRequired</span><span class="token punctuation">(</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> cls<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTO_PROXY_CREATOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinition</span> apcDefinition <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTO_PROXY_CREATOR_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apcDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“å‰å·²ç»æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„Beançš„ä¼˜å…ˆçº§</span>
            <span class="token keyword">int</span> currentPriority <span class="token operator">=</span> <span class="token function">findPriorityForClass</span><span class="token punctuation">(</span>apcDefinition<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// å½“å‰å‡†å¤‡æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„Beançš„ä¼˜å…ˆçº§</span>
            <span class="token keyword">int</span> requiredPriority <span class="token operator">=</span> <span class="token function">findPriorityForClass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è°çš„ä¼˜å…ˆçº§å¤§å°±æ³¨å†Œè°ï¼ŒAnnotationAwareAspectJAutoProxyCreatoræ˜¯æœ€å¤§çš„</span>
            <span class="token comment">// æ‰€ä»¥AnnotationAwareAspectJAutoProxyCreatorä¼šè¦†ç›–åˆ«çš„Bean</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPriority <span class="token operator">&lt;</span> requiredPriority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                apcDefinition<span class="token punctuation">.</span><span class="token function">setBeanClassName</span><span class="token punctuation">(</span>cls<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ³¨å†Œbd</span>
    <span class="token class-name">RootBeanDefinition</span> beanDefinition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">getPropertyValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span><span class="token constant">HIGHEST_PRECEDENCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    beanDefinition<span class="token punctuation">.</span><span class="token function">setRole</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span><span class="token constant">AUTO_PROXY_CREATOR_BEAN_NAME</span><span class="token punctuation">,</span> beanDefinition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> beanDefinition<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="proxytransactionmanagementconfiguration" tabindex="-1"><a class="header-anchor" href="#proxytransactionmanagementconfiguration" aria-hidden="true">#</a> ProxyTransactionManagementConfiguration</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyTransactionManagementConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTransactionManagementConfiguration</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * transactionAdvisor å°±æ˜¯ @EnableTransactionManagement çš„å¢å¼ºå™¨ï¼Œè€Œ @Role(BeanDefinition.ROLE_INFRASTRUCTURE) ä¹Ÿæ˜¯æœ‰ç”¨çš„
     * å› ä¸º InfrastructureAdvisorAutoProxyCreator åªä¼šä½¿ç”¨Roleçš„å€¼æ˜¯ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token class-name">ROLE_INFRASTRUCTURE</span></span><span class="token punctuation">}</span> çš„ Advisor æ¥åˆ¤æ–­åç½®å¤„ç†çš„beanæ˜¯å¦éœ€è¦ä»£ç†
     *        <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanFactoryAdvisorRetrievalHelper</span><span class="token punctuation">#</span><span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">TransactionManagementConfigUtils</span><span class="token punctuation">.</span><span class="token constant">TRANSACTION_ADVISOR_BEAN_NAME</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="token function">transactionAdvisor</span><span class="token punctuation">(</span>
            <span class="token class-name">TransactionAttributeSource</span> transactionAttributeSource<span class="token punctuation">,</span> <span class="token class-name">TransactionInterceptor</span> transactionInterceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * å®ç° PointcutAdvisor æ¥å£ï¼Œæ‰€ä»¥æ˜¯å¦è¦è¿›è¡Œä»£ç†å¾—çœ‹ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">PointcutAdvisor</span><span class="token punctuation">#</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * è€Œ BeanFactoryTransactionAttributeSourceAdvisor çš„ Pointcutæ˜¯è¿™ä¸ª <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSourcePointcut</span></span><span class="token punctuation">}</span>
         * è€Œ TransactionAttributeSourcePointcut ç±»åŒ¹é…å’Œæ–¹æ³•åŒ¹é…æ˜¯ä½¿ç”¨ transactionAttributeSource æ¥è§£ææ³¨è§£çš„
         *      - ClassFilter <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSourcePointcut</span><span class="token punctuation">.</span><span class="token class-name">TransactionAttributeSourceClassFilter</span></span><span class="token punctuation">}</span>
         *          ç±»ä¸æ˜¯javaåŒ…ä¸‹çš„ ä¸æ˜¯ Orderedç±» å°±æ˜¯åŒ¹é…
         *
         *      - MethodMatcher <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSourcePointcut</span><span class="token punctuation">#</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *          æŸ¥æ‰¾ æ–¹æ³•-&gt;æ–¹æ³•å£°æ˜çš„ç±» æœ‰@Transactional å°±æ˜¯åŒ¹é…
         * */</span>
        <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> advisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// é»˜è®¤æ˜¯æ³¨å†Œçš„è¿™ä¸ªç±»å‹ AnnotationTransactionAttributeSource</span>
        advisor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span>transactionAttributeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * Advice, ä¹Ÿå°±æ˜¯å…·ä½“çš„å¢å¼ºé€»è¾‘
         * */</span>
        advisor<span class="token punctuation">.</span><span class="token function">setAdvice</span><span class="token punctuation">(</span>transactionInterceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * è®¾ç½®æ’åºå€¼
             * */</span>
            advisor<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionAttributeSource</span> <span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * Advisor å’Œ Advice éƒ½ä¾èµ–äº†è¿™ä¸ªbeanã€‚
         * TransactionAttributeSource è¯¥å¯¹è±¡å¾ˆç®€å•ï¼Œå°±æ˜¯è§£æ @Transactional æ³¨è§£ï¼Œè§£ææˆ RuleBasedTransactionAttribute å¯¹è±¡
         * */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionInterceptor</span> <span class="token function">transactionInterceptor</span><span class="token punctuation">(</span><span class="token class-name">TransactionAttributeSource</span> transactionAttributeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * å°±æ˜¯ BeanFactoryTransactionAttributeSourceAdvisor çš„ advice
         * */</span>
        <span class="token class-name">TransactionInterceptor</span> interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * ä¾èµ–äº† transactionAttributeSourceï¼Œè¿™ä¸œè¥¿æ˜¯ç”¨æ¥æ‹¿åˆ°æ–¹æ³•ã€ç±»ä¸Šçš„ @Transactionalæ³¨è§£ï¼Œè§£ææˆ RuleBasedTransactionAttribute å¯¹è±¡
         * */</span>
        interceptor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span>transactionAttributeSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * è®¾ç½®äº‹åŠ¡ç®¡ç†å™¨ï¼Œè¯¥å±æ€§å€¼æ˜¯çˆ¶ç±»ä¾èµ–æ³¨å…¥ TransactionManagementConfigurer ç±»å‹çš„beanè®¾ç½®çš„
             * */</span>
            interceptor<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>



<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractTransactionManagementConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ImportAware</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * å°±æ˜¯ @EnableTransactionManagement çš„å…ƒæ•°æ®
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">AnnotationAttributes</span> enableTx<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Default transaction manager, as configured through a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionManagementConfigurer</span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">TransactionManager</span> txManager<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setImportMetadata</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>enableTx <span class="token operator">=</span> <span class="token class-name">AnnotationAttributes</span><span class="token punctuation">.</span><span class="token function">fromMap</span><span class="token punctuation">(</span>
                importMetadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">EnableTransactionManagement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;@EnableTransactionManagement is not present on importing class &quot;</span> <span class="token operator">+</span> importMetadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">setConfigurers</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionManagementConfigurer</span><span class="token punctuation">&gt;</span></span> configurers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * é…ç½®äº‹åŠ¡ç®¡ç†å™¨ã€‚äº‹åŠ¡ç®¡ç†å™¨æ˜¯ç”¨äºäº‹åŠ¡çš„å¼€å¯ã€å›æ»šã€æäº¤ å°±æ˜¯é€šè¿‡è¿™ä¸ªæ¥å£ç»Ÿä¸€è°ƒç”¨çš„ï¼Œ
         * å…¶ä¾èµ– TransactionSynchronizationManager ç®¡ç†äº‹åŠ¡çš„çŠ¶æ€
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>configurers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configurers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Only one TransactionManagementConfigurer may exist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TransactionManagementConfigurer</span> configurer <span class="token operator">=</span> configurers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>txManager <span class="token operator">=</span> configurer<span class="token punctuation">.</span><span class="token function">annotationDrivenTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token class-name">TransactionManagementConfigUtils</span><span class="token punctuation">.</span><span class="token constant">TRANSACTIONAL_EVENT_LISTENER_FACTORY_BEAN_NAME</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">.</span><span class="token constant">ROLE_INFRASTRUCTURE</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">TransactionalEventListenerFactory</span> <span class="token function">transactionalEventListenerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">EventListenerMethodProcessor</span></span><span class="token punctuation">}</span> åç½®å¤„ç†å™¨ä¼šç”¨åˆ° EventListenerFactoryï¼Œ
         * è€Œ TransactionalEventListenerFactory ç”¨äºå¤„ç† @TransactionalEventListener æ ‡æ³¨çš„æ–¹æ³•ï¼Œå°†æ–¹æ³•æ„é€ æˆäº‹ä»¶ç›‘å¬å™¨ï¼Œæ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­
         * */</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionalEventListenerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="beanfactorytransactionattributesourceadvisor" tabindex="-1"><a class="header-anchor" href="#beanfactorytransactionattributesourceadvisor" aria-hidden="true">#</a> BeanFactoryTransactionAttributeSourceAdvisor</h3><p>åˆ‡é¢ï¼Œçœ‹åˆ‡ç‚¹åŒ¹é…é€»è¾‘ä»¥åŠé€šçŸ¥å¢å¼ºé€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token doc-comment comment">/**
 * ç”± <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSource</span></span><span class="token punctuation">}</span> é©±åŠ¨çš„é¡¾é—®ç¨‹åºï¼Œç”¨äºåŒ…æ‹¬
 * äº‹åŠ¡æ€§æ–¹æ³•çš„äº‹åŠ¡å»ºè®® Beanã€‚
 *
 * <span class="token keyword">@author</span> Juergen Hoeller
 * <span class="token keyword">@since</span> 2.5.5
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">setAdviceBeanName</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">TransactionInterceptor</span></span>
 * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">TransactionAttributeSourceAdvisor</span></span>
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;serial&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanFactoryPointcutAdvisor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionAttributeSource</span> transactionAttributeSource<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionAttributeSourcePointcut</span> pointcut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionAttributeSourcePointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">protected</span> <span class="token class-name">TransactionAttributeSource</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> transactionAttributeSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * Set the transaction attribute source which is used to find transaction
     * attributes. This should usually be identical to the source reference
     * set on the transaction interceptor itself.
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">TransactionInterceptor</span><span class="token punctuation">#</span><span class="token field">setTransactionAttributeSource</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token class-name">TransactionAttributeSource</span> transactionAttributeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transactionAttributeSource <span class="token operator">=</span> transactionAttributeSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Set the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ClassFilter</span></span><span class="token punctuation">}</span> to use for this pointcut.
     * Default is <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ClassFilter</span><span class="token punctuation">#</span><span class="token field">TRUE</span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClassFilter</span><span class="token punctuation">(</span><span class="token class-name">ClassFilter</span> classFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">.</span><span class="token function">setClassFilter</span><span class="token punctuation">(</span>classFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Pointcut</span> <span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactionattributesourcepointcut" tabindex="-1"><a class="header-anchor" href="#transactionattributesourcepointcut" aria-hidden="true">#</a> TransactionAttributeSourcePointcut</h3><p>åˆ‡ç‚¹ï¼Œç±»ä»¥åŠæ–¹æ³•åŒ¹é…ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TransactionAttributeSourcePointcut</span> <span class="token keyword">extends</span> <span class="token class-name">StaticMethodMatcherPointcut</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">protected</span> <span class="token class-name">TransactionAttributeSourcePointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * TransactionAttributeSourceClassFilter ä¼šæ‰§è¡ŒæŠ½è±¡æ–¹æ³• `getTransactionAttributeSource` ç„¶åæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSource</span><span class="token punctuation">#</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * åˆ¤æ–­ç±»æ˜¯å¦åŒ¹é…ã€‚
         *
         * æ³¨ï¼šè¿‡æ»¤è§„åˆ™å¾ˆç®€å•ï¼Œåªè¦ç±»ä¸æ˜¯javaåŒ…ä¸‹çš„ ä¸æ˜¯ Orderedæ¥å£ å°±æ˜¯åŒ¹é…
         * */</span>
        <span class="token function">setClassFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TransactionAttributeSourceClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * TransactionAttributeSourcePointcut å®ç°äº† MethodMatcherï¼Œæ‰€ä»¥åˆ¤æ–­æ–¹æ³•åŒ¹é…çš„æ—¶å€™ä¼šæ‰§è¡Œå½“å‰æ–¹æ³•ã€‚
         * ä¼šæ‰§è¡ŒæŠ½è±¡æ–¹æ³• `getTransactionAttributeSource` ç„¶åæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSource</span><span class="token punctuation">#</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractFallbackTransactionAttributeSource</span><span class="token punctuation">#</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * æ³¨ï¼š
         *  1. è¿‡æ»¤è§„åˆ™å¾ˆç®€å•ï¼Œæ–¹æ³• -&gt; æ–¹æ³•å£°æ˜çš„ç±» å…ˆæ‰¾åˆ°@Transactionalå°±è¿”å›ã€‚ä¹Ÿå°±æ˜¯æœ‰æ³¨è§£å°±æ˜¯åŒ¹é…
         *  2. å¦‚æœæ–¹æ³•ä¸æ˜¯publicçš„ï¼Œç›´æ¥è¿”å›null ä¸è§£æä¸Šé¢çš„@Transactionalæ³¨è§£ï¼Œä¹Ÿå°±æ˜¯ä¸ä»£ç†
         * */</span>
        <span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>tas <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * è·å–åŸºç¡€ TransactionAttributeSourceï¼ˆå¯èƒ½ä¸º <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>ï¼‰ã€‚
     * ç”±å­ç±»å®ç°ã€‚
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">TransactionAttributeSource</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ClassFilter</span></span><span class="token punctuation">}</span> that delegates to <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAttributeSource</span><span class="token punctuation">#</span><span class="token field">isCandidateClass</span></span><span class="token punctuation">}</span>
     * for filtering classes whose methods are not worth searching to begin with.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TransactionAttributeSourceClassFilter</span> <span class="token keyword">implements</span> <span class="token class-name">ClassFilter</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionalProxy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">||</span>
                    <span class="token class-name">TransactionManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">||</span>
                    <span class="token class-name">PersistenceExceptionTranslator</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>tas <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> tas<span class="token punctuation">.</span><span class="token function">isCandidateClass</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractFallbackTransactionAttributeSource</span>
        <span class="token keyword">implements</span> <span class="token class-name">TransactionAttributeSource</span><span class="token punctuation">,</span> <span class="token class-name">EmbeddedValueResolverAware</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">StringValueResolver</span> embeddedValueResolver<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Cache of TransactionAttributes, keyed by method on a specific target class.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>As this base class is not marked Serializable, the cache will be recreated
     * after serialization - provided that the concrete subclass is Serializable.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAttribute</span><span class="token punctuation">&gt;</span></span> attributeCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setEmbeddedValueResolver</span><span class="token punctuation">(</span><span class="token class-name">StringValueResolver</span> resolver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>embeddedValueResolver <span class="token operator">=</span> resolver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    

    <span class="token doc-comment comment">/**
     * Determine a cache key for the given method and target class.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Must not produce same key for overloaded methods.
     * Must produce same key for different instances of the same method.
     * <span class="token keyword">@param</span> <span class="token parameter">method</span> the method (never <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>)
     * <span class="token keyword">@param</span> <span class="token parameter">targetClass</span> the target class (may be <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>)
     * <span class="token keyword">@return</span> the cache key (never <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>)
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MethodClassKey</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * Subclasses need to implement this to return the transaction attribute for the
     * given class, if any.
     * <span class="token keyword">@param</span> <span class="token parameter">clazz</span> the class to retrieve the attribute for
     * <span class="token keyword">@return</span> all transaction attribute associated with this class, or <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span> if none
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Subclasses need to implement this to return the transaction attribute for the
     * given method, if any.
     * <span class="token keyword">@param</span> <span class="token parameter">method</span> the method to retrieve the attribute for
     * <span class="token keyword">@return</span> all transaction attribute associated with this method, or <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span> if none
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * Should only public methods be allowed to have transactional semantics?
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>The default implementation returns <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">false</span></span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactioninterceptor" tabindex="-1"><a class="header-anchor" href="#transactioninterceptor" aria-hidden="true">#</a> TransactionInterceptor</h3><p>è¿™ä¸ªnbäº†ï¼Œå¢å¼ºé€»è¾‘ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿åˆ°è¢«ä»£ç†ç±»ã€‚</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‰§è¡Œå¢å¼ºé€»è¾‘ã€‚</span>
        <span class="token keyword">return</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CoroutinesInvocationCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token annotation punctuation">@Nullable</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionAspectSupport</span><span class="token operator">:</span>

<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span>
                                          <span class="token keyword">final</span> <span class="token class-name">InvocationCallback</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

     <span class="token comment">// ç”¨æ¥è§£æ æ–¹æ³•ã€ç±»ä¸Šæ˜¯å¦æœ‰@Transactional</span>
     <span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// 1.1 æ‹¿åˆ°@Transactionalæ³¨è§£ï¼Œè§£æåçš„å±æ€§å€¼</span>
     <span class="token keyword">final</span> <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token punctuation">(</span>tas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token doc-comment comment">/**
      * 1.2 æ¨æ–­å‡ºè¦ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨ï¼š@Transactional(&quot;tm1&quot;)
* é»˜è®¤çš„(<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">AbstractTransactionManagementConfiguration</span><span class="token punctuation">#</span><span class="token field">setConfigurers</span></span>)<span class="token punctuation">}</span>) -&gt; BeanFactoryä¸­æ‰¾TransactionManager
      * */</span>
     <span class="token keyword">final</span> <span class="token class-name">TransactionManager</span> tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

     
     <span class="token doc-comment comment">/**
      * å¼ºè½¬ï¼Œtm å¿…é¡»æ˜¯ PlatformTransactionManager ç±»å‹çš„ç»„
      * */</span>
     <span class="token class-name">PlatformTransactionManager</span> ptm <span class="token operator">=</span> <span class="token function">asPlatformTransactionManager</span><span class="token punctuation">(</span>tm<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// å°±æ˜¯ä¸€ä¸ªmethodçš„æ ‡è¯†</span>
     <span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification <span class="token operator">=</span> <span class="token function">methodIdentification</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token doc-comment comment">/**
      * æ²¡æœ‰@Transactionalæ³¨è§£  æˆ–è€… äº‹åŠ¡ç®¡ç†å™¨ä¸æ˜¯CallbackPreferringPlatformTransactionManagerç±»å‹
      * */</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>ptm <span class="token keyword">instanceof</span> <span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token doc-comment comment">/**
          * 1.3 å¦‚æœéœ€è¦å°±åˆ›å»ºäº‹åŠ¡(ä¸»è¦æ˜¯æ ¹æ®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ¥åˆ¤æ–­çš„)
          * å°±æ˜¯ä½¿ç”¨DataSourceåˆ›å»ºConnectionï¼Œç„¶åè®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤ `Connection.setAutoCommit(false)`
          * */</span>
         <span class="token comment">// Standard transaction demarcation with getTransaction and commit/rollback calls.</span>
         <span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>ptm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token class-name">Object</span> retVal<span class="token punctuation">;</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token comment">// æ”¾è¡Œæ–¹æ³•</span>
             <span class="token comment">// This is an around advice: Invoke the next interceptor in the chain.</span>
             <span class="token comment">// This will normally result in a target object being invoked.</span>
             retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token doc-comment comment">/**
              * 1.4 å‡ºç°å¼‚å¸¸çš„å¤„ç†ï¼Œçœ‹çœ‹æ˜¯å›æ»šè¿˜æ˜¯æäº¤äº‹åŠ¡ã€‚
              * çœ‹çœ‹å¼‚å¸¸ç±»å‹æ˜¯ä¸æ˜¯è¦å›æ»šçš„ç±»å‹ï¼Œæ˜¯å°±å›æ»šï¼Œå¦åˆ™å°±æäº¤äº‹åŠ¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">#</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
              *
              * è€Œå…·ä½“çš„å›æ»šç±»å‹æ˜¯æ ¹æ® @Transactional(rollbackFor = RuntimeException.class, rollbackForClassName = &quot;a&quot;,
              *             noRollbackFor = Throwable.class, noRollbackForClassName = &quot;b&quot;) çš„å€¼è§£æçš„
              *
              *
              * æ— è®ºæ˜¯å›æ»šï¼Œè¿˜æ˜¯æäº¤äº‹åŠ¡ æœ€ç»ˆéƒ½ä¼šæ‰§è¡Œè¿™ä¸ªï¼Œæ¢å¤ä¸Šä¸€ä¸ªäº‹åŠ¡çš„å†…å®¹åˆ°ThreadLocalä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
              * */</span>
             <span class="token comment">// target invocation exception</span>
             <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
             <span class="token doc-comment comment">/**
              * 1.5 æ¸…é™¤å½“å‰äº‹åŠ¡ä¿¡æ¯ã€‚å°±æ˜¯å°†å½“å‰txInfoä¹‹å‰çš„txInfoæ¢å¤åˆ°ThreadLocalä¸­
              * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token field">transactionInfoHolder</span></span><span class="token punctuation">}</span>
              * */</span>
             <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> vavrPresent <span class="token operator">&amp;&amp;</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">isVavrTry</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
             <span class="token class-name">TransactionStatus</span> status <span class="token operator">=</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 retVal <span class="token operator">=</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">evaluateTryFailure</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>

         <span class="token doc-comment comment">/**
          * 1.6 æäº¤äº‹åŠ¡ã€‚
          *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span><span class="token class-name">TransactionInfo</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
          *
          * æœ€ç»ˆä¼šæ‰§è¡Œè¿™ä¸ªï¼Œæ¢å¤ä¸Šä¸€ä¸ªäº‹åŠ¡çš„å†…å®¹åˆ°ThreadLocalä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
          * */</span>
         <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token class-name">Object</span> result<span class="token punctuation">;</span>
         <span class="token keyword">final</span> <span class="token class-name">ThrowableHolder</span> throwableHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

         <span class="token comment">// It&#39;s a CallbackPreferringPlatformTransactionManager: pass a TransactionCallback in.</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
             result <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span> ptm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">,</span> status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                 <span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>ptm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">try</span> <span class="token punctuation">{</span>
                     <span class="token class-name">Object</span> retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> vavrPresent <span class="token operator">&amp;&amp;</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">isVavrTry</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token comment">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
                         retVal <span class="token operator">=</span> <span class="token class-name">VavrDelegate</span><span class="token punctuation">.</span><span class="token function">evaluateTryFailure</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                     <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                         <span class="token comment">// A RuntimeException: will lead to a rollback.</span>
                         <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                             <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span><span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
                         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                             <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ThrowableHolderException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                         <span class="token punctuation">}</span>
                     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                         <span class="token comment">// A normal return value: will lead to a commit.</span>
                         throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">=</span> ex<span class="token punctuation">;</span>
                         <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                     <span class="token punctuation">}</span>
                 <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                     <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ThrowableHolderException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">throw</span> ex<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>

         <span class="token comment">// Check result state: It might indicate a Throwable to rethrow.</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>throwableHolder<span class="token punctuation">.</span>throwable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">throw</span> throwableHolder<span class="token punctuation">.</span>throwable<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">return</span> result<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>



 <span class="token keyword">protected</span> <span class="token class-name">TransactionInfo</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PlatformTransactionManager</span> tm<span class="token punctuation">,</span>
                                                     <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">,</span> <span class="token class-name">String</span> joinpointIdentification<span class="token punctuation">,</span>
                                                     <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We need a transaction for this method...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Getting transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è®¾ç½®äº‹åŠ¡çŠ¶æ€</span>
            <span class="token comment">// The transaction manager will flag an error if an incompatible tx already exists.</span>
            txInfo<span class="token punctuation">.</span><span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// The TransactionInfo.hasTransaction() method will return false. We created it only</span>
            <span class="token comment">// to preserve the integrity of the ThreadLocal stack maintained in this class.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;No need to create transaction for [&quot;</span> <span class="token operator">+</span> joinpointIdentification <span class="token operator">+</span>
                        <span class="token string">&quot;]: This method is not transactional.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * ç»‘å®šåˆ°è¿™ä¸ªå±æ€§ä¸Š <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token field">transactionInfoHolder</span></span><span class="token punctuation">}</span>
         * å¹¶ä¸”ä¼šè®°å½•åŸæ¥ThreadLocalçš„å€¼ï¼Œå½“äº‹åŠ¡ç»“æŸäº†è¦æ¢å¤å›å» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span><span class="token class-name">TransactionInfo</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token comment">// We always bind the TransactionInfo to the thread, even if we didn&#39;t create</span>
        <span class="token comment">// a new transaction here. This guarantees that the TransactionInfo stack</span>
        <span class="token comment">// will be managed correctly even if no transaction was created by this aspect.</span>
        txInfo<span class="token punctuation">.</span><span class="token function">bindToThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> txInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token doc-comment comment">/**
     * å¤„ç†Throwableï¼Œå®Œæˆäº‹åŠ¡ã€‚
     * æˆ‘ä»¬å¯èƒ½ä¼šæäº¤æˆ–å›æ»šï¼Œå…·ä½“å–å†³äºé…ç½®ã€‚
     * <span class="token keyword">@param</span> <span class="token parameter">txInfo</span> information about the current transaction
     * <span class="token keyword">@param</span> <span class="token parameter">ex</span> throwable encountered
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Completing transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                        <span class="token string">&quot;] after exception: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * å¼‚å¸¸æ˜¯éœ€è¦å›æ»š <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">#</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *
             * - ä½¿ç”¨ @Transactional é…ç½®çš„rollbackè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…å°±è¿”å›ç»“æœ
             * - æ²¡æœ‰åŒ¹é…rollbackï¼Œå°±åˆ¤æ–­å¼‚å¸¸æ˜¯ä¸æ˜¯  RuntimeException ã€Error æ˜¯å°±å›æ»š
             * */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span>transactionAttribute <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span>transactionAttribute<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token doc-comment comment">/**
                     * å›æ»š
                     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                     * */</span>
                    txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by rollback exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by rollback exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * æäº¤äº‹åŠ¡
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 * */</span>
                <span class="token comment">// We don&#39;t roll back on this exception.</span>
                <span class="token comment">// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Completing transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-1-è§£ætransactionalæ³¨è§£å±æ€§" tabindex="-1"><a class="header-anchor" href="#_1-1-è§£ætransactionalæ³¨è§£å±æ€§" aria-hidden="true">#</a> 1.1 è§£æTransactionalæ³¨è§£å±æ€§</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token class-name">AbstractFallbackTransactionAttributeSource</span>ï¼š 
      
		<span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


      	<span class="token comment">// ä»ç¼“å­˜å– é¿å…é‡å¤è§£æ</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransactionAttribute</span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">==</span> <span class="token constant">NULL_TRANSACTION_ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> cached<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¡ç®—äº‹åŠ¡å±æ€§ æ–¹æ³•å¿…é¡»æ˜¯publicçš„ ä¾æ¬¡ä»æ–¹æ³•ã€ç±»ä¸Šè·å–ã€‚</span>
            <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token constant">NULL_TRANSACTION_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> methodIdentification <span class="token operator">=</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getQualifiedMethodName</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token keyword">instanceof</span> <span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DefaultTransactionAttribute</span> dta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionAttribute</span><span class="token punctuation">)</span> txAttr<span class="token punctuation">;</span>
                    dta<span class="token punctuation">.</span><span class="token function">setDescriptor</span><span class="token punctuation">(</span>methodIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    dta<span class="token punctuation">.</span><span class="token function">resolveAttributeStrings</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>embeddedValueResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Adding transactional method &#39;&quot;</span> <span class="token operator">+</span> methodIdentification <span class="token operator">+</span> <span class="token string">&quot;&#39; with attribute: &quot;</span> <span class="token operator">+</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>attributeCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>



	<span class="token comment">// è®¡ç®—äº‹åŠ¡å±æ€§ æ–¹æ³•å¿…é¡»æ˜¯publicçš„ ä¾æ¬¡ä»æ–¹æ³•ã€ç±»ä¸Šè·å–ã€‚</span>
   <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ–¹æ³•ä¸æ˜¯public å°±ç›´æ¥è¿”å›nullï¼Œ ä¹Ÿå°±æ˜¯è¯´@Transactional å¾—æ ‡æ³¨åœ¨publicæ–¹æ³•ä¸Šæ‰æœ‰ç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å°±æ˜¯targetClassæ˜¯ä»£ç†å¯¹è±¡çš„æƒ…å†µ,è¿”å›çš„æ˜¯å…¶è¢«ä»£ç†ç±»çš„æ–¹æ³•ã€‚</span>
        <span class="token class-name">Method</span> specificMethod <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getMostSpecificMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1.1.1 æ–¹æ³•æœ‰@Transactionalå°±è§£ææ³¨è§£å€¼ï¼Œç„¶åè¿”å›</span>
        <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 1.1.2 å°è¯•ä»æ–¹æ³•å£°æ˜ç±»ä¸Šæ‰¾ï¼Œæœ‰@Transactionalå°±è§£ææ³¨è§£å€¼ï¼Œç„¶åè¿”å›</span>
        txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * ä¸ç›¸ç­‰ï¼Œè¯´æ˜methodæ˜¯ä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œ ä¸Šé¢è§£æè¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•æ‰¾ä¸åˆ°æ³¨è§£ä¿¡æ¯ï¼Œå°è¯•ä» ä»£ç†å¯¹è±¡çš„æ–¹æ³•ã€ä»£ç†å¯¹è±¡æ‰¾ @Transactionalï¼Œ
         * æ‰¾åˆ°å°±è¿”å›
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specificMethod <span class="token operator">!=</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Fallback is to look at the original method.</span>
            txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// Last fallback is the class of the original method.</span>
            txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-1-è§£ææ–¹æ³•ä¸Šäº‹åŠ¡æ³¨è§£å±æ€§" tabindex="-1"><a class="header-anchor" href="#_1-1-1-è§£ææ–¹æ³•ä¸Šäº‹åŠ¡æ³¨è§£å±æ€§" aria-hidden="true">#</a> 1.1.1 è§£ææ–¹æ³•ä¸Šäº‹åŠ¡æ³¨è§£å±æ€§</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AnnotationTransactionAttributeSource</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * éå† annotationParsersï¼Œæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è¿”å›æ³¨è§£å¯¹åº”çš„å±æ€§ä¿¡æ¯ï¼Œ
     * è§£æçš„å¯¹è±¡æ˜¯ methodï¼Œè¯´ç™½äº†å°±æ˜¯çœ‹çœ‹ method æ˜¯å¦æœ‰æ³¨è§£
     * æ²¡å¾—å°±è¿”å›null
     *
     * æ³¨ï¼šé»˜è®¤æœ‰è¿™ä¸ª SpringTransactionAnnotationParserï¼Œå°±æ˜¯æ˜¯å¦æœ‰ @Transactional
     * */</span>
    <span class="token keyword">return</span> <span class="token function">determineTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-1-2-è§£æç±»ä¸Šäº‹åŠ¡æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#_1-1-2-è§£æç±»ä¸Šäº‹åŠ¡æ³¨è§£" aria-hidden="true">#</a> 1.1.2 è§£æç±»ä¸Šäº‹åŠ¡æ³¨è§£</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AnnotationTransactionAttributeSource</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * éå† annotationParsersï¼Œæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è¿”å›æ³¨è§£å¯¹åº”çš„å±æ€§ä¿¡æ¯ï¼Œ
     * è§£æçš„å¯¹è±¡æ˜¯ clazz ï¼Œè¯´ç™½äº†å°±æ˜¯çœ‹çœ‹ clazzæ˜¯å¦æœ‰æ³¨è§£
     * æ²¡å¾—å°±è¿”å›null
     *
     * æ³¨ï¼šé»˜è®¤æœ‰è¿™ä¸ª SpringTransactionAnnotationParserï¼Œå°±æ˜¯æ˜¯å¦æœ‰ @Transactional
     * */</span>
    <span class="token keyword">return</span> <span class="token function">determineTransactionAttribute</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>éå†æ³¨è§£è§£æå™¨è§£ææ³¨è§£å±æ€§</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">determineTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionAnnotationParser</span> parser <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>annotationParsers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransactionAttribute</span> attr <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> attr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§£æå‡ºäº‹åŠ¡å±æ€§</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedElement</span> element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä» AnnotatedElement æ‰¾åˆ°  @Transactional æ³¨è§£ä¿¡æ¯</span>
    <span class="token class-name">AnnotationAttributes</span> attributes <span class="token operator">=</span> <span class="token class-name">AnnotatedElementUtils</span><span class="token punctuation">.</span><span class="token function">findMergedAnnotationAttributes</span><span class="token punctuation">(</span>
            element<span class="token punctuation">,</span> <span class="token class-name">Transactional</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°±æ˜¯å°†æ³¨è§£çš„å€¼ è®¾ç½®åˆ° TransactionAttribute å¯¹è±¡ä¸­</span>
        <span class="token keyword">return</span> <span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">// è§£ææ³¨è§£å±æ€§ äº‹åŠ¡å›æ»šè§„åˆ™ç”¨çš„æ˜¯RollbackRuleAttribute</span>
 <span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RuleBasedTransactionAttribute</span> rbta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Propagation</span> propagation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;propagation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rbta<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span>propagation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Isolation</span> isolation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;isolation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rbta<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span>isolation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        rbta<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> timeoutString <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;timeoutString&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>timeoutString<span class="token punctuation">)</span> <span class="token operator">||</span> rbta<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Specify &#39;timeout&#39; or &#39;timeoutString&#39;, not both&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rbta<span class="token punctuation">.</span><span class="token function">setTimeoutString</span><span class="token punctuation">(</span>timeoutString<span class="token punctuation">)</span><span class="token punctuation">;</span>

        rbta<span class="token punctuation">.</span><span class="token function">setReadOnly</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;readOnly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿™ä¸ªå±æ€§æ˜¯æŒ‡å®š äº‹åŠ¡ç®¡ç†çš„</span>
        rbta<span class="token punctuation">.</span><span class="token function">setQualifier</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rbta<span class="token punctuation">.</span><span class="token function">setLabels</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;label&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * å›æ»šè§„åˆ™ï¼Œä¸¤ç§ç±»å‹ï¼š
         *      - RollbackRuleAttribute è¡¨ç¤ºè¦å›æ»š
         *      - NoRollbackRuleAttribute è¡¨ç¤ºä¸å›æ»š
         *
         * åœ¨è¿™é‡Œä¼šç”¨åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">#</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">&gt;</span></span> rollbackRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rbta<span class="token punctuation">.</span><span class="token function">setRollbackRules</span><span class="token punctuation">(</span>rollbackRules<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> rbta<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-2æ¨æ–­äº‹åŠ¡ç®¡ç†å™¨" tabindex="-1"><a class="header-anchor" href="#_1-2æ¨æ–­äº‹åŠ¡ç®¡ç†å™¨" aria-hidden="true">#</a> 1.2æ¨æ–­äº‹åŠ¡ç®¡ç†å™¨</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionAspectSupport</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">TransactionManager</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæœªè®¾ç½® tx å±æ€§ï¼Œè¯·å‹¿å°è¯•æŸ¥æ‰¾ tx ç®¡ç†å™¨</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token doc-comment comment">/**
     * é€šè¿‡é™å®šç¬¦æŸ¥æ‰¾ @Transactional(&quot;tm1&quot;) <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SpringTransactionAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token class-name">String</span> qualifier <span class="token operator">=</span> txAttr<span class="token punctuation">.</span><span class="token function">getQualifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ³¨è§£ valueå€¼ä¸ä¸ºç©ºï¼Œå°±æ ¹æ®valueä»BeanFactoryæ‹¿åˆ°äº‹åŠ¡ç®¡ç†å™¨ã€‚æ‰¾ä¸åˆ°å°±æŠ¥é”™
         * */</span>
        <span class="token keyword">return</span> <span class="token function">determineQualifiedTransactionManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> qualifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è®¾ç½®äº† transactionManagerBeanNameï¼Œå°±ä½¿ç”¨è¿™ä¸ªnameæ‰¾</span>
        <span class="token keyword">return</span> <span class="token function">determineQualifiedTransactionManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransactionManager</span> defaultTransactionManager <span class="token operator">=</span> <span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultTransactionManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            defaultTransactionManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_TRANSACTION_MANAGER_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultTransactionManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * é€šè¿‡ TransactionManager ç±»å‹ä» BeanFactoryæ‹¿åˆ°äº‹åŠ¡ç®¡ç†å™¨ï¼Œ
                 * ç±»å‹åŒ¹é…åˆ°å¤šä¸ªbeanï¼Œä¼šé€šè¿‡ @Primaryã€@Priorityç¡®å®šå”¯ä¸€ä¸€ä¸ªï¼Œç¡®å®šä¸èƒ½å°±æŠ¥é”™äº†
                 * */</span>
                defaultTransactionManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">TransactionManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerCache<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>
                        <span class="token constant">DEFAULT_TRANSACTION_MANAGER_KEY</span><span class="token punctuation">,</span> defaultTransactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> defaultTransactionManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



   <span class="token keyword">private</span> <span class="token class-name">TransactionManager</span> <span class="token function">determineQualifiedTransactionManager</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">String</span> qualifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransactionManager</span> txManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txManager <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txManager <span class="token operator">=</span> <span class="token class-name">BeanFactoryAnnotationUtils</span><span class="token punctuation">.</span><span class="token function">qualifiedBeanOfType</span><span class="token punctuation">(</span>
                    beanFactory<span class="token punctuation">,</span> <span class="token class-name">TransactionManager</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> qualifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transactionManagerCache<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>qualifier<span class="token punctuation">,</span> txManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> txManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-3-createtransactionifnecessary" tabindex="-1"><a class="header-anchor" href="#_1-3-createtransactionifnecessary" aria-hidden="true">#</a> 1.3 createTransactionIfNecessary</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token operator">:</span>

<span class="token doc-comment comment">/**
 * å¦‚æœ‰å¿…è¦ï¼Œæ ¹æ®ç»™å®šçš„ TransactionAttribute åˆ›å»ºäº‹åŠ¡ã€‚
 */</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;serial&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token class-name">TransactionInfo</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PlatformTransactionManager</span> tm<span class="token punctuation">,</span>
                                                       <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * ä½¿ç”¨ @Transactionalï¼Œé»˜è®¤çš„parseræ˜¯æ— æ³•è®¾ç½®nameå€¼çš„ï¼Œæ‰€ä»¥éƒ½ä¼šè£…é¥°ä¸€ä¸‹
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SpringTransactionAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token comment">// If no name specified, apply method identification as transaction name.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txAttr<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        txAttr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingTransactionAttribute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> joinpointIdentification<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">TransactionStatus</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * 1.3.1 è·å–äº‹åŠ¡çŠ¶æ€ã€‚
             *
             * ä½¿ç”¨ txAttr é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨ è·å–äº‹åŠ¡çŠ¶æ€
             *
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *      - ä¼šæ ¹æ®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ¥å†³å®šï¼Œæ˜¯æ–°åˆ›å»ºäº‹åŠ¡ã€æš‚åœäº‹åŠ¡ã€savepoint ç­‰æ“ä½œ
             *      - æ˜¯æ–°å»ºäº‹åŠ¡ï¼Œå°±ä¼šä½¿ç”¨DataSourceè·å–Connectionï¼Œç„¶åå°†Connectionè®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤
             *
             * DefaultTransactionStatus äº‹åŠ¡çŠ¶æ€ï¼Œç”±è¿™ä¸‰ä¸ªä¸œè¥¿ç»„æˆï¼š
             *      - RuleBasedTransactionAttribute(äº‹åŠ¡å±æ€§)ï¼šå°±æ˜¯æè¿°@Transactionalæ³¨è§£çš„å¯¹è±¡
             *      - DataSourceTransactionObject(äº‹åŠ¡å¯¹è±¡)ï¼šè®°å½•äº‹åŠ¡çš„ConnectionHolder
             *      - SuspendedResourcesHolder(æš‚åœèµ„æºæŒæœ‰è€…)ï¼šè®°å½•ä¸Šä¸€ä¸ªäº‹åŠ¡çš„ConnectionHolderå’ŒTransactionSynchronization
             *      æ³¨ï¼šäº‹åŠ¡è¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªæ•°æ®åº“è¿æ¥
             * */</span>
            status <span class="token operator">=</span> tm<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping transactional joinpoint [&quot;</span> <span class="token operator">+</span> joinpointIdentification <span class="token operator">+</span>
                        <span class="token string">&quot;] because no transaction manager has been configured&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token doc-comment comment">/**
     * 1.3.2 å°†äº‹åŠ¡ç®¡ç†å™¨ã€äº‹åŠ¡å±æ€§ã€æ–¹æ³•æ ‡è¯†å’Œäº‹åŠ¡çŠ¶æ€ è£…é¥°æˆ TransactionInfo è¿”å›ï¼Œ
     * */</span>
    <span class="token keyword">return</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-1-è·å–äº‹åŠ¡çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_1-3-1-è·å–äº‹åŠ¡çŠ¶æ€" aria-hidden="true">#</a> 1.3.1 è·å–äº‹åŠ¡çŠ¶æ€</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * definition å°±æ˜¯æè¿°@Transactionalæ³¨è§£çš„å¯¹è±¡ï¼Œ
     * definition æ˜¯ç©ºå°±ç»™ä¸€ä¸ªé»˜è®¤å€¼
     * */</span>
    <span class="token class-name">TransactionDefinition</span> def <span class="token operator">=</span> <span class="token punctuation">(</span>definition <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> definition <span class="token operator">:</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 1.3.1.1 åˆ›å»ºäº‹åŠ¡å¯¹è±¡ã€‚ä» resources ä¸­æ‹¿åˆ°èµ„æºè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡
     * è¿™ä¸ªèµ„æºå¹¶ä¸ä¸€å®šæ˜¯å¼€å¯äº‹åŠ¡æ—¶åˆ›å»ºçš„è¿æ¥ï¼Œæ¯”å¦‚ç©ºäº‹åŠ¡æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">#</span><span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è·å–è¿æ¥
     * è¿™ä¸ªè¿æ¥ä¹Ÿä¼šå­˜åˆ° resources ä¸­ï¼Œç›®çš„æ˜¯åœ¨äº‹åŠ¡æ–¹æ³•å†…èƒ½é‡å¤ä½¿ç”¨
     *
     * æ¯”å¦‚ï¼š<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *      ä¼šåˆ›å»ºè¿™ä¸ªå¯¹è±¡ DataSourceTransactionObject
     *      1. ä»ThreadLocalä¸­æ‹¿åˆ° Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource,ConnectionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
     *      2. DataSource ä½œä¸ºkeyï¼Œä» resources æ‹¿åˆ° ConnectionHolder è®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡
     *      Tipsï¼šåˆ›å»ºçš„æ˜¯è¿™ä¸ªå¯¹è±¡DataSourceTransactionObjectï¼Œäº‹åŠ¡å¯¹è±¡è¯´ç™½äº†å°±æ˜¯ ä¸€ä¸ªæ•°æ®åº“è¿æ¥çš„åŒ…è£…å¯¹è±¡
     * */</span>
    <span class="token class-name">Object</span> transaction <span class="token operator">=</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> debugEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 1.3.1.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨äº‹åŠ¡ã€‚å°±æ˜¯å‡ºç°äº†äº‹åŠ¡æ–¹æ³•åµŒå¥—è°ƒç”¨çš„æƒ…å†µ
     *
     * æ¯”å¦‚è¿™ä¸ªäº‹åŠ¡ç®¡ç†å™¨ï¼š
     *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *      `txObject.hasConnectionHolder() &amp;&amp; txObject.getConnectionHolder().isTransactionActive()`
     *      å°±æ˜¯äº‹åŠ¡å¯¹è±¡æœ‰è¿æ¥ ä¸” è¿æ¥æ˜¯æ´»åŠ¨çš„äº‹åŠ¡ æ‰æ˜¯true
     *
     * ç©ºäº‹åŠ¡ä¸ç®—å­˜åœ¨äº‹åŠ¡ï¼Œå› ä¸ºå…¶ isTransactionActive æ˜¯false
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 1.3.1.3 å­˜åœ¨äº‹åŠ¡çš„å¤„ç†ï¼Œå°±æ˜¯æ ¹æ®ä¼ æ’­è¡Œä¸ºçœ‹çœ‹æ˜¯ï¼šæš‚åœå½“å‰äº‹åŠ¡ï¼Œæ–°å»ºäº‹åŠ¡ï¼Œè®¾ç½®ä¿å­˜ç‚¹
         * */</span>
        <span class="token keyword">return</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// èƒ½å¾€ä¸‹æ‰§è¡Œï¼Œè¯´æ˜è¿˜æ²¡æœ‰äº‹åŠ¡</span>
  
    <span class="token doc-comment comment">/**
     * æ ¡éªŒ @Transactional() è®¾ç½®çš„å€¼ æ˜¯å¦åˆæ³•
     * */</span>
    <span class="token comment">// Check definition settings for new transaction.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid transaction timeout&quot;</span><span class="token punctuation">,</span> def<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token doc-comment comment">/**
     * æ ¡éªŒäº‹åŠ¡éš”ç¦»çº§åˆ«å‚æ•°ï¼Œä¸å­˜åœ¨äº‹åŠ¡å°±æŠ›å‡ºå¼‚å¸¸
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_MANDATORY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;No existing transaction found for transaction marked with propagation &#39;mandatory&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRED</span> <span class="token operator">||</span>
            def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRES_NEW</span> <span class="token operator">||</span>
            def<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NESTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 1.3.1.4 æš‚åœäº‹åŠ¡ã€‚å…¥å‚å°±æ˜¯è¦æš‚åœçš„äº‹åŠ¡ã€‚å…¶å®å°±æ˜¯ä»ThreadLocalä¸­å–å‡ºè¿™ä¸¤ä¸ªå±æ€§å†…å®¹ï¼Œè®°å½•åˆ° SuspendedResourcesHolder ä¸­
         *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span>
         *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating new transaction with name [&quot;</span> <span class="token operator">+</span> def<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * 1.3.1.5 å¼€å¯äº‹åŠ¡ï¼ˆæ ¡éªŒäº‹åŠ¡éš”ç¦»çº§åˆ«å‚æ•°ï¼Œåˆ›å»ºæ–°äº‹åŠ¡ï¼‰ï¼š
             *  1. äº‹åŠ¡å¯¹è±¡ï¼Œæ²¡æœ‰è¿æ¥æˆ–è€…è¿æ¥isSynchronizedWithTransaction å°±é€šè¿‡æ•°æ®æºåˆ›å»ºè¿æ¥ç„¶åè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡
             *  2. å°† @Transactional çš„ä¿¡æ¯è®¾ç½®åˆ°è¿æ¥å’Œäº‹åŠ¡å¯¹è±¡ä¸­ï¼ˆè‡ªåŠ¨æäº¤ã€æ˜¯å¦åªè¯»ã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ï¼‰
             *  3. æ˜¯æ–°åˆ›å»ºçš„è¿æ¥ï¼Œå°±ä½¿ç”¨æ•°æ®æºä½œä¸ºkeyï¼Œå°†è¿æ¥ç»‘å®šæ˜¯äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
             *  4. è®¾ç½® ConnectionHolder å±æ€§ isSynchronizedWithTransaction ä¸ºtrue
             *  5. è®°å½•ä¿¡æ¯åˆ° TransactionSynchronizationManager
             * */</span>
            <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1.3.1.6 å‡ºç°å¼‚å¸¸ï¼Œå°±æ¢å¤ä¹‹å‰çš„äº‹åŠ¡çŠ¶æ€åˆ°ThreadLocalä¸­</span>
            <span class="token function">resume</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * åˆ›å»ºç©ºäº‹åŠ¡ï¼Œå…¶å®å°±æ˜¯æ²¡æœ‰äº‹åŠ¡
         * */</span>
        <span class="token comment">// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>def<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_DEFAULT</span> <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Custom isolation level specified but no actual transaction initiated; &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;isolation level will effectively be ignored: &quot;</span> <span class="token operator">+</span> def<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      
        <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SYNCHRONIZATION_ALWAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 1.3.1.7 åˆ›å»ºäº‹åŠ¡çŠ¶æ€</span>
        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-1-åˆ›å»ºäº‹åŠ¡å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#_1-3-1-1-åˆ›å»ºäº‹åŠ¡å¯¹è±¡" aria-hidden="true">#</a> 1.3.1.1 åˆ›å»ºäº‹åŠ¡å¯¹è±¡</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    txObject<span class="token punctuation">.</span><span class="token function">setSavepointAllowed</span><span class="token punctuation">(</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * ä½¿ç”¨ DataSource ä½œä¸ºkeyä» ThreadLocalä¸­æ‹¿ ConnectionHolder,
     * æ²¡æœ‰å°±æ˜¯ nullï¼Œç¬¬ä¸€æ¬¡å¼€å¯äº‹åŠ¡ è¿™ä¸ªå€¼å°±æ˜¯nullå’¯
     * */</span>
    <span class="token class-name">ConnectionHolder</span> conHolder <span class="token operator">=</span>
            <span class="token punctuation">(</span><span class="token class-name">ConnectionHolder</span><span class="token punctuation">)</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span>conHolder<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> txObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-2-åˆ¤æ–­æ˜¯å¦å­˜åœ¨äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_1-3-1-2-åˆ¤æ–­æ˜¯å¦å­˜åœ¨äº‹åŠ¡" aria-hidden="true">#</a> 1.3.1.2 åˆ¤æ–­æ˜¯å¦å­˜åœ¨äº‹åŠ¡</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DataSourceTransactionManager</span><span class="token operator">:</span>

<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isExistingTransaction</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åœ¨å¼€å§‹äº‹åŠ¡æ—¶ä¼šå°† isTransactionActive è®¾ç½®ä¸ºtrue
     * åªæœ‰åœ¨äº‹åŠ¡å®Œæˆæ—¶ï¼Œæ‰ä¼šå°†äº‹åŠ¡çš„æŒæœ‰çš„ getConnectionHolder().isTransactionActive() è®¾ç½®ä¸ºfalse
     * æ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ä¸ªåˆ¤æ–­ æ˜¯å¦å­˜åœ¨äº‹åŠ¡
     *
     * ç©ºäº‹åŠ¡ä¸ç®—å­˜åœ¨äº‹åŠ¡ï¼Œå› ä¸ºç©ºäº‹åŠ¡ä¸ä¼šå¼€å¯äº‹åŠ¡(ä¸ä¼šç»™äº‹åŠ¡å¯¹è±¡åˆ›å»ºæ•°æ®åº“è¿æ¥)ï¼Œä¹Ÿå°±ä¸ä¼šå°† isTransactionActive è®¾ç½®ä¸ºtrue
     *
     * åœ¨ç©ºäº‹åŠ¡ä¸‹ï¼Œä½¿ç”¨<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSourceUtils</span><span class="token punctuation">#</span><span class="token function">doGetConnection</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>è·å–è¿æ¥ï¼Œä¹Ÿä¸ä¼šè®¾ç½® isTransactionActive ä¸ºtrueï¼Œ
     * åªæ˜¯å­˜åˆ°äº† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">hasConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-3-å­˜åœ¨äº‹åŠ¡çš„å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_1-3-1-3-å­˜åœ¨äº‹åŠ¡çš„å¤„ç†" aria-hidden="true">#</a> 1.3.1.3 å­˜åœ¨äº‹åŠ¡çš„å¤„ç†</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * å­˜åœ¨çš„äº‹åŠ¡åˆ›å»ºäº‹åŠ¡çŠ¶æ€(ä¸»è¦æ˜¯æ ¹æ®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ¥åˆ¤æ–­)
 */</span>
<span class="token keyword">private</span> <span class="token class-name">TransactionStatus</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>
        <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * ä¼ æ’­è¡Œä¸ºï¼šå­˜åœ¨äº‹åŠ¡å°±æŠ¥é”™
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NEVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Existing transaction found for transaction marked with propagation &#39;never&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * ä¼ æ’­è¡Œä¸ºï¼šå­˜åœ¨äº‹åŠ¡å°±æŒ‚èµ·
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NOT_SUPPORTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Suspending current transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * 1.3.1.3.1 æš‚åœäº‹åŠ¡ã€‚è¿”å› SuspendedResourcesHolderï¼Œè¿™é‡Œé¢è®°å½•äº†è¢«ç§»é™¤çš„èµ„æºï¼Œå’Œæ‰€æš‚åœäº‹åŠ¡çš„çŠ¶æ€ä¿¡æ¯
         *
         * å°±æ˜¯ä» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ç§»é™¤èµ„æºï¼Œç§»é™¤çš„èµ„æºä¼šå­˜åˆ° SuspendedResourcesHolder ä¸­
         * */</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SYNCHRONIZATION_ALWAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1.3.1.3.2 å¤„ç†äº‹åŠ¡çŠ¶æ€</span>
        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>
                definition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * ä¼ æ’­è¡Œä¸ºï¼šåˆ›å»ºæ–°çš„äº‹ç‰©ï¼Œå·²ç»å­˜åœ¨äº‹ç‰©å°±æŒ‚èµ·
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRES_NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Suspending current transaction, creating new transaction with name [&quot;</span> <span class="token operator">+</span>
                    definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * 1.3.1.3.1 æš‚åœäº‹åŠ¡ï¼Œè¿”å›çš„æ˜¯æš‚åœäº‹åŠ¡çš„èµ„æº
         * */</span>
        <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * 1.3.1.3.3 å¼€å¯æ–°äº‹ç‰©ï¼Œä¼šè®°å½•æš‚åœäº‹åŠ¡çš„ä¿¡æ¯
             * */</span>
            <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> beginEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resumeAfterBeginException</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">,</span> beginEx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> beginEx<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * ä¼ æ’­è¡Œä¸ºï¼šå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨å°±åˆ›å»ºåµŒå¥—äº‹åŠ¡ï¼Œå¦åˆ™å°±åƒ PROPAGATION_REQUIRED ä¸€æ ·å¤„ç†
     *
     * é€šè¿‡è¿™é‡Œèƒ½ä½“ç°ï¼Œæ²¡æœ‰äº‹åŠ¡çš„æ—¶å€™å°±å’ŒPROPAGATION_REQUIREDä¸€æ · åˆ›å»ºæ–°çš„äº‹åŠ¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span><span class="token punctuation">)</span></span> <span class="token punctuation">}</span>
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NESTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡ å°±æŠ¥é”™ï¼Œ<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ˜¯æ”¯æŒçš„
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedTransactionNotSupportedException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Transaction manager does not allow nested transactions by default - &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;specify &#39;nestedTransactionAllowed&#39; property with value &#39;true&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Creating nested transaction with name [&quot;</span> <span class="token operator">+</span> definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * ä½¿ç”¨ä¿å­˜ç‚¹æ¥å®ç° åµŒå¥—äº‹åŠ¡
         * DataSourceTransactionManager å°±æ˜¯true
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useSavepointForNestedTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Create savepoint within existing Spring-managed transaction,</span>
            <span class="token comment">// through the SavepointManager API implemented by TransactionStatus.</span>
            <span class="token comment">// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span>
            <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span>
                    <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‰§è¡Œsqlåˆ›å»ºä¿å­˜ç‚¹</span>
            status<span class="token punctuation">.</span><span class="token function">createAndHoldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          	<span class="token comment">// 1.3.1.3.3 å¼€å¯äº‹åŠ¡</span>
            <span class="token keyword">return</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>debugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Participating in existing transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isValidateExistingTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Integer</span> currentIsolationLevel <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentIsolationLevel <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> currentIsolationLevel <span class="token operator">!=</span> definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Constants</span> isoConstants <span class="token operator">=</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">.</span>constants<span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction with definition [&quot;</span> <span class="token operator">+</span>
                        definition
                        <span class="token operator">+</span> <span class="token string">&quot;] specifies isolation level which is incompatible with existing transaction: &quot;</span>
                        <span class="token operator">+</span>
                        <span class="token punctuation">(</span>currentIsolationLevel <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span>
                                isoConstants<span class="token punctuation">.</span><span class="token function">toCode</span><span class="token punctuation">(</span>currentIsolationLevel<span class="token punctuation">,</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PREFIX_ISOLATION</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                                <span class="token string">&quot;(unknown)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction with definition [&quot;</span> <span class="token operator">+</span>
                        definition
                        <span class="token operator">+</span> <span class="token string">&quot;] is not marked as read-only but existing transaction is&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SYNCHRONIZATION_NEVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 1.3.1.3.2 å¤„ç†äº‹åŠ¡çŠ¶æ€</span>
    <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æš‚åœäº‹åŠ¡</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SuspendedResourcesHolder</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * æ˜¯æ´»åŠ¨çš„äº‹åŠ¡ã€‚
     * å¯ä»¥è¿™é‡Œç†è§£ï¼Œåªè¦Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•ï¼Œè¿™ä¸ªåˆ¤æ–­å°±æ˜¯true
     *      1. æš‚åœå½“å‰äº‹åŠ¡
     *      2. å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 1ï¸âƒ£ æš‚åœäº‹åŠ¡çš„è¡Œä¸ºåŒæ­¥ã€‚æš‚åœäº† TransactionSynchronizationManager.isSynchronizationActive() å°±æ˜¯ falseäº†
         *
         * å°±æ˜¯æ‹¿åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span>ï¼Œéå†æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">#</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// å­˜åœ¨äº‹åŠ¡å¯¹è±¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * 2ï¸âƒ£ æš‚åœäº‹åŠ¡èµ„æºåŒæ­¥ã€‚
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 *      1. å–æ¶ˆäº‹åŠ¡å¯¹è±¡ç»‘å®šçš„è¿æ¥ä¿¡æ¯ txObject.setConnectionHolder(null);
                 *      2. ä»äº‹åŠ¡èµ„æºä¸­ç§»é™¤äº‹åŠ¡å¯¹è±¡å¯¹åº”çš„èµ„æº(å°±æ˜¯ç§»é™¤DataSourceä½œä¸ºkeyçš„èµ„æº) <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token function">unbindResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 *
                 *      Tipsï¼šè¿”å›å€¼ï¼Œå°±æ˜¯äº‹åŠ¡èµ„æºä¸­ç§»é™¤çš„èµ„æº
                 * */</span>
                suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          
            <span class="token comment">// æ‹¿åˆ°åŸæ¥çš„å€¼</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> readOnly <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> isolationLevel <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> wasActive <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
            <span class="token doc-comment comment">/**
             * è£…é¥°ä¸€ä¸‹ï¼Œå°±æ˜¯è®°å½•ç°åœ¨å¾—å€¼ï¼Œåé¢æ¢å¤äº‹åŠ¡éœ€è¦é‡æ–°è®¾ç½®åˆ° TransactionSynchronizationManager
             * */</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>
                    suspendedResources<span class="token punctuation">,</span> suspendedSynchronizations<span class="token punctuation">,</span> name<span class="token punctuation">,</span> readOnly<span class="token punctuation">,</span> isolationLevel<span class="token punctuation">,</span> wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// doSuspend failed - original transaction is still active...</span>
            <span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span>suspendedSynchronizations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *  2ï¸âƒ£ æš‚åœäº‹åŠ¡èµ„æºåŒæ­¥ã€‚
         * */</span>
        <span class="token comment">// Transaction active but no synchronization active.</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Neither transaction nor synchronization active.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1ï¸âƒ£ æš‚åœè¡Œä¸ºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token operator">:</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getSynchronizations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†ï¼Œç„¶åæŒ‚èµ·</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronization</span> synchronization <span class="token operator">:</span> suspendedSynchronizations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * å¯¹äºæ•°æ®åº“è¿æ¥ï¼š
         *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token class-name">ConnectionSynchronization</span><span class="token punctuation">#</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *       å¦‚æœè¯¥Connectionå­˜åœ¨äº‹åŠ¡èµ„æºä¸­ï¼Œå°±å–æ¶ˆäº‹åŠ¡èµ„æºå¯¹è¯¥Connectionçš„å¼•ç”¨;
         *       å¦åˆ™å°±å…³é—­è¿æ¥
         * */</span>
        synchronization<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç©ºçº¿ç¨‹äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">clearSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å› äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token keyword">return</span> suspendedSynchronizations<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¸âƒ£ æš‚åœèµ„æºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DataSourceTransactionManager</span><span class="token operator">:</span> 
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
    txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">unbindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¤„ç†äº‹åŠ¡çŠ¶æ€</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">DefaultTransactionStatus</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>
          <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTransaction<span class="token punctuation">,</span>
          <span class="token keyword">boolean</span> newSynchronization<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// äº‹åŠ¡çŠ¶æ€</span>
      <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
              definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> newTransaction<span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// åˆå§‹åŒ–è¡Œä¸ºåŒæ­¥</span>
      <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>



<span class="token comment">// åˆ›å»ºäº‹åŠ¡çŠ¶æ€</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultTransactionStatus</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
        <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTransaction<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> newSynchronization<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * newSynchronization ä¸” ä¸æ˜¯åŒæ­¥æ¿€æ´»çŠ¶æ€  å°±æ˜¯ çœŸçš„æ–°åŒæ­¥
     *
     * åŒæ­¥æ¿€æ´»çŠ¶æ€ï¼š
     *      - trueï¼šç®€å•æ¥è¯´å°±æ˜¯Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•
     *      - falseï¼šæš‚åœå½“å‰äº‹åŠ¡ã€å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     *
     * ç»“è®ºï¼šå½“å‰çº¿ç¨‹åœ¨ TransactionSynchronizationManager æ²¡æœ‰è®°å½•ä¿¡æ¯ï¼Œ actualNewSynchronization å°±æ˜¯true
     * */</span>
    <span class="token keyword">boolean</span> actualNewSynchronization <span class="token operator">=</span> newSynchronization <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">(</span>
            transaction<span class="token punctuation">,</span> newTransaction<span class="token punctuation">,</span> actualNewSynchronization<span class="token punctuation">,</span>
            definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é€‚å½“åœ°åˆå§‹åŒ–äº‹åŠ¡åŒæ­¥ã€‚
     * Initialize transaction synchronization as appropriate.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ˜¯æ–°çš„åŒæ­¥ï¼Œæ‰è®°å½•è¿™äº›ä¿¡æ¯ï¼ˆæ³¨ï¼šç©ºäº‹åŠ¡ä¹Ÿç®—çš„ï¼‰
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * çœŸçš„æ´»åŠ¨çš„äº‹åŠ¡ã€‚å°±æ˜¯å¾—æœ‰äº‹åŠ¡ï¼Œä¸”äº‹åŠ¡æ˜¯æ–°çš„æ‰æ˜¯true
             * */</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®°å½•äº‹åŠ¡éš”ç¦»çº§åˆ«</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span>
                    definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_DEFAULT</span> <span class="token operator">?</span>
                            definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ˜¯å¦åªè¯»</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// äº‹åŠ¡çš„name</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åŒæ­¥å±æ€§åˆå§‹åŒ–ï¼Œä¼šæ ¹æ®è¿™ä¸ªå±æ€§æ˜¯å¦ä¸ºnullåˆ¤æ–­ æ˜¯ä¸æ˜¯ isNewSynchronization</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">initSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>å¼€å¯äº‹åŠ¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransactionStatus</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * ä¸æ˜¯ä»ä¸åŒæ­¥ã€‚è¿™ä¸ªå€¼æ˜¯çœ‹ä½ ç”¨çš„å•¥äº‹åŠ¡ç®¡ç†ï¼Œæ˜¯äº‹åŠ¡ç®¡ç†å™¨çš„å±æ€§
     * */</span>
    <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SYNCHRONIZATION_NEVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// new DefaultTransactionStatus å¯¹è±¡</span>
    <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
            definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doBegin</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *      1. äº‹åŠ¡å¯¹è±¡æ²¡æœ‰è¿æ¥æˆ–è€…è¿æ¥isSynchronizedWithTransaction å°±é€šè¿‡æ•°æ®æºåˆ›å»ºè¿æ¥ç„¶åè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡
     *      2. å°† @Transactional çš„ä¿¡æ¯è®¾ç½®åˆ°è¿æ¥å’Œäº‹åŠ¡å¯¹è±¡ä¸­ï¼ˆè®¾ç½®çš„å†…å®¹ï¼šè‡ªåŠ¨æäº¤ã€æ˜¯å¦åªè¯»ã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ï¼‰
     *      3. æ˜¯æ–°åˆ›å»ºçš„è¿æ¥ï¼Œå°±ä½¿ç”¨æ•°æ®æºä½œä¸ºkeyï¼Œå°†è¿æ¥ç»‘å®šæ˜¯äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
     *      4. è®¾ç½® ConnectionHolder å±æ€§ isSynchronizedWithTransaction ä¸ºtrue
     * */</span>
    <span class="token function">doBegin</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * status.isNewSynchronization() å°±è®¾ç½® TransactionSynchronizationManagerï¼š
     *  - è®°å½•äº‹åŠ¡éš”ç¦»çº§åˆ«
     *  - æ˜¯å¦åªè¯»
     *  - äº‹åŠ¡çš„name
     *  - <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span> å±æ€§åˆå§‹åŒ–ï¼Œä¼šæ ¹æ®è¿™ä¸ªå±æ€§æ˜¯å¦ä¸ºnullåˆ¤æ–­ æ˜¯ä¸æ˜¯ isNewSynchronization
     * */</span>
    <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>doBegin</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1. äº‹åŠ¡å¯¹è±¡ï¼Œæ²¡æœ‰è¿æ¥æˆ–è€…è¿æ¥isSynchronizedWithTransaction å°±é€šè¿‡æ•°æ®æºåˆ›å»ºè¿æ¥ç„¶åè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 2. å°† @Transactional çš„ä¿¡æ¯è®¾ç½®åˆ°è¿æ¥å’Œäº‹åŠ¡å¯¹è±¡ä¸­ï¼ˆè‡ªåŠ¨æäº¤ã€æ˜¯å¦åªè¯»ã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ï¼‰ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 3. æ˜¯æ–°åˆ›å»ºçš„è¿æ¥ï¼Œå°±ä½¿ç”¨æ•°æ®æºä½œä¸ºkeyï¼Œå°†è¿æ¥ç»‘å®šæ˜¯äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 4. è®¾ç½® ConnectionHolder å±æ€§ isSynchronizedWithTransaction ä¸ºtrue
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBegin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
    <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ²¡æœ‰è¿æ¥ æˆ–è€… è¿æ¥æ˜¯äº‹åŠ¡åŒæ­¥ é‚£å°±åº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥
         *
         * å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå½“å‰æ–¹æ³•å« doBegin ï¼Œä¹Ÿå°±æ˜¯è¦ç»™äº‹åŠ¡å¯¹è±¡ç»‘å®šè¿æ¥ã€‚è¿æ¥æ²¡æœ‰é‚£å°±åˆ›å»ºä¸€ä¸ªåœ¨ç»‘å®šåˆæƒ…åˆç†ï¼Œ
         * è€Œè¿æ¥æœ‰äº†ï¼Œä½†æ˜¯è¿æ¥æ˜¯äº‹åŠ¡åŒæ­¥ è¯´æ˜ä¸Šä¸€ä¸ªäº‹åŠ¡è¿˜æœªå®Œæˆï¼Œä½ è¿˜è¦ç»‘å®š é‚£ä¹Ÿç»™ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œè¿™ç§å±äºéæ³•æ“ä½œäº†ï¼Œå¦‚æœä½ è€è€å®å®ç”¨Spring åˆ«æå•¥è‡ªå®šä¹‰ï¼Œæ˜¯ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µçš„
         *
         * å› ä¸º doBegin æ˜¯åœ¨ startTransaction çš„æ—¶å€™ä¼šæ‰§è¡Œï¼Œè€Œ startTransaction ä¹‹å‰ä¼šå…ˆæš‚åœå½“å‰çº¿ç¨‹çš„äº‹ç‰©èµ„æºï¼Œåœ¨å¼€å¯äº‹ç‰©ï¼Œ
         * è€Œæš‚åœå°±æ˜¯
         *      1. ç§»é™¤äº‹ç‰©å¯¹è±¡çš„å¼•ç”¨ `txObject.setConnectionHolder(null);`
         *      2. ä» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ç§»é™¤ ConnectionHolder å­˜èµ·æ¥ã€‚è¿™ä¸ªConnectionHolder å…¶å®å°±æ˜¯ä¸Šé¢ç½®ç©ºçš„å±æ€§
         *          Tips: æš‚åœäº‹åŠ¡çš„ä»£ç  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      è®°ä½ä»£ç æ˜¯æ­»çš„ï¼ŒSpringçš„äº‹ç‰©ä»£ç éƒ½è¿™ä¹ˆå†™äº†ï¼Œæ‰€ä»¥åŸºæœ¬ä¸å¯èƒ½å‡ºç° isSynchronizedWithTransaction çš„æƒ…å†µï¼Œé™¤éå¼€å‘äººå‘˜ç©èŠ±æ´»
         *
         * æ³¨ï¼šåœ¨ä¸€ä¸ªSpringäº‹åŠ¡(å•ä¸€äº‹åŠ¡ã€åµŒå¥—äº‹åŠ¡)
         *      äº‹åŠ¡æš‚åœï¼š`txObject.setConnectionHolder(null)`
         *      äº‹åŠ¡å®Œæˆï¼š` txObject.getConnectionHolder().setSynchronizedWithTransaction(false);`
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txObject<span class="token punctuation">.</span><span class="token function">hasConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * æ‹¿åˆ°è¿æ¥ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSource</span><span class="token punctuation">#</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *
             * è¿™é‡Œå°±æ˜¯åŠ¨æ€æ•°æ®æºçš„åŸç†äº† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractRoutingDataSource</span><span class="token punctuation">#</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token class-name">Connection</span> newCon <span class="token operator">=</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Acquired Connection [&quot;</span> <span class="token operator">+</span> newCon <span class="token operator">+</span> <span class="token string">&quot;] for JDBC transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è£…é¥° Connection å¹¶è®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡</span>
            txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionHolder</span><span class="token punctuation">(</span>newCon<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * è¡¨ç¤º è¿™ä¸ªäº‹åŠ¡å¯¹è±¡çš„è¿æ¥ æ˜¯äº‹åŠ¡åŒæ­¥
         *
         * åœ¨äº‹ç‰©å®Œæˆæ—¶ ä¼šå°†è¯¥å±æ€§è®¾ç½®ä¸º false
         *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doCleanupAfterCompletion</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConnectionHolder</span><span class="token punctuation">#</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        con <span class="token operator">=</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * å°±æ˜¯æ ¹æ® @Transactional æ³¨è§£å€¼ï¼Œç»™Connectionè®¾ç½® åªè¯»å±æ€§ã€éš”ç¦»çº§åˆ«å±æ€§ã€‚
         * è¿”å›çš„æ˜¯ Connection ä¹‹å‰çš„éš”ç¦»é¥¥çº§åˆ«ä¿¡æ¯
         * */</span>
        <span class="token class-name">Integer</span> previousIsolationLevel <span class="token operator">=</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">prepareConnectionForTransaction</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// éš”ç¦»çº§åˆ«</span>
        txObject<span class="token punctuation">.</span><span class="token function">setPreviousIsolationLevel</span><span class="token punctuation">(</span>previousIsolationLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ˜¯å¦åªè¯»</span>
        txObject<span class="token punctuation">.</span><span class="token function">setReadOnly</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¦‚æœè¿æ¥æ˜¯è‡ªåŠ¨æäº¤ï¼Œå°±è®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤</span>
        <span class="token comment">// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span>
        <span class="token comment">// so we don&#39;t want to do it unnecessarily (for example if we&#39;ve explicitly</span>
        <span class="token comment">// configured the connection pool to set it already).</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txObject<span class="token punctuation">.</span><span class="token function">setMustRestoreAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Switching JDBC Connection [&quot;</span> <span class="token operator">+</span> con <span class="token operator">+</span> <span class="token string">&quot;] to manual commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤</span>
            con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * å°±æ¯”å¦‚ `@Transactional(readOnly = true)` å°±è®¾ç½®äº‹åŠ¡ä¸ºåªè¯»çš„
         * å¦‚æœæ˜¯åªè¯»çš„å°±æ‰§è¡Œsqlè®¾ç½®ä¸ºåªè¯»äº‹åŠ¡  `SET TRANSACTION READ ONLY`
         * */</span>
        <span class="token function">prepareTransactionalConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ´»åŠ¨çš„äº‹åŠ¡ã€‚
         * åœ¨äº‹åŠ¡å®Œæˆæ—¶æ‰ä¼šå°†è¯¥å±æ€§è®¾ç½®ä¸ºfalseï¼Œæš‚åœäº‹åŠ¡å¹¶ä¸ä¼š
         * */</span>
        txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * `@Transactional(timeout = -1)` ä¸æ˜¯-1æ‰æ‹¿æ³¨è§£å€¼ï¼Œæ²¡æœ‰å°±è¿”å›é»˜è®¤å€¼ -1
         * */</span>
        <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">determineTimeout</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½®è¶…æ—¶æ—¶é—´</span>
            txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTimeoutInSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * æ˜¯æ–°åˆ›å»ºçš„connectçš„ï¼Œå°±ç»‘å®šåˆ°ThreadLocalä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
         * ç¼“å­˜çš„Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource,ConnectionHolder</span><span class="token punctuation">&gt;</span></span>ã€‚ä½¿ç”¨DataSourceä½œä¸ºkeyï¼Œæ˜¯å› ä¸ºä¸€ä¸ªçº¿ç¨‹å¯èƒ½æœ‰æ¥å›åˆ‡æ¢æ•°æ®æºçš„æƒ…å†µ(åŠ¨æ€æ•°æ®æº)
         * */</span>
        <span class="token comment">// Bind the connection holder to the thread.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * ç»‘å®šåˆ°äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * ä»äº‹åŠ¡èµ„æº <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ä¸­ç§»é™¤è¯¥è¿æ¥ï¼Œæˆ–è€…æ˜¯å…³é—­è¿æ¥
             *
             * */</span>
            <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¸…é™¤ txObject çš„è¿æ¥ä¿¡æ¯</span>
            txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CannotCreateTransactionException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not open JDBC Connection for transaction&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-4-æš‚åœäº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_1-3-1-4-æš‚åœäº‹åŠ¡" aria-hidden="true">#</a> 1.3.1.4 æš‚åœäº‹åŠ¡</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SuspendedResourcesHolder</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * æ˜¯æ´»åŠ¨çš„äº‹åŠ¡ã€‚
     * å¯ä»¥è¿™é‡Œç†è§£ï¼Œåªè¦Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•ï¼Œè¿™ä¸ªåˆ¤æ–­å°±æ˜¯true
     *      1. æš‚åœå½“å‰äº‹åŠ¡
     *      2. å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 1ï¸âƒ£ æš‚åœäº‹åŠ¡çš„è¡Œä¸ºåŒæ­¥ã€‚æš‚åœäº† TransactionSynchronizationManager.isSynchronizationActive() å°±æ˜¯ falseäº†
         *
         * å°±æ˜¯æ‹¿åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span>ï¼Œéå†æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">#</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// å­˜åœ¨äº‹åŠ¡å¯¹è±¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * 2ï¸âƒ£ æš‚åœäº‹åŠ¡èµ„æºåŒæ­¥ã€‚
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 *      1. å–æ¶ˆäº‹åŠ¡å¯¹è±¡ç»‘å®šçš„è¿æ¥ä¿¡æ¯ txObject.setConnectionHolder(null);
                 *      2. ä»äº‹åŠ¡èµ„æºä¸­ç§»é™¤äº‹åŠ¡å¯¹è±¡å¯¹åº”çš„èµ„æº(å°±æ˜¯ç§»é™¤DataSourceä½œä¸ºkeyçš„èµ„æº) <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token function">unbindResource</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 *
                 *      Tipsï¼šè¿”å›å€¼ï¼Œå°±æ˜¯äº‹åŠ¡èµ„æºä¸­ç§»é™¤çš„èµ„æº
                 * */</span>
                suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          
            <span class="token comment">// æ‹¿åˆ°åŸæ¥çš„å€¼</span>
            <span class="token class-name">String</span> name <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> readOnly <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Integer</span> isolationLevel <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> wasActive <span class="token operator">=</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          
            <span class="token doc-comment comment">/**
             * è£…é¥°ä¸€ä¸‹ï¼Œå°±æ˜¯è®°å½•ç°åœ¨å¾—å€¼ï¼Œåé¢æ¢å¤äº‹åŠ¡éœ€è¦é‡æ–°è®¾ç½®åˆ° TransactionSynchronizationManager
             * */</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>
                    suspendedResources<span class="token punctuation">,</span> suspendedSynchronizations<span class="token punctuation">,</span> name<span class="token punctuation">,</span> readOnly<span class="token punctuation">,</span> isolationLevel<span class="token punctuation">,</span> wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// doSuspend failed - original transaction is still active...</span>
            <span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span>suspendedSynchronizations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *  2ï¸âƒ£ æš‚åœäº‹åŠ¡èµ„æºåŒæ­¥ã€‚
         * */</span>
        <span class="token comment">// Transaction active but no synchronization active.</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Neither transaction nor synchronization active.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1ï¸âƒ£ æš‚åœè¡Œä¸ºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token operator">:</span>

<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ°äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">getSynchronizations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†ï¼Œç„¶åæŒ‚èµ·</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronization</span> synchronization <span class="token operator">:</span> suspendedSynchronizations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * å¯¹äºæ•°æ®åº“è¿æ¥ï¼š
         *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token class-name">ConnectionSynchronization</span><span class="token punctuation">#</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *       å¦‚æœè¯¥Connectionå­˜åœ¨äº‹åŠ¡èµ„æºä¸­ï¼Œå°±å–æ¶ˆäº‹åŠ¡èµ„æºå¯¹è¯¥Connectionçš„å¼•ç”¨;
         *       å¦åˆ™å°±å…³é—­è¿æ¥
         * */</span>
        synchronization<span class="token punctuation">.</span><span class="token function">suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç©ºçº¿ç¨‹äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">clearSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å› äº‹åŠ¡åŒæ­¥èµ„æº</span>
    <span class="token keyword">return</span> suspendedSynchronizations<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¸âƒ£ æš‚åœèµ„æºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DataSourceTransactionManager</span><span class="token operator">:</span> 
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
    txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">unbindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-5-å¼€å¯äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_1-3-1-5-å¼€å¯äº‹åŠ¡" aria-hidden="true">#</a> 1.3.1.5 å¼€å¯äº‹åŠ¡</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransactionStatus</span> <span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span>
                                           <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * ä¸æ˜¯ä»ä¸åŒæ­¥ã€‚è¿™ä¸ªå€¼æ˜¯çœ‹ä½ ç”¨çš„å•¥äº‹åŠ¡ç®¡ç†ï¼Œæ˜¯äº‹åŠ¡ç®¡ç†å™¨çš„å±æ€§
     * */</span>
    <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SYNCHRONIZATION_NEVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// new DefaultTransactionStatus å¯¹è±¡</span>
    <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
            definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doBegin</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *      1. äº‹åŠ¡å¯¹è±¡æ²¡æœ‰è¿æ¥æˆ–è€…è¿æ¥isSynchronizedWithTransaction å°±é€šè¿‡æ•°æ®æºåˆ›å»ºè¿æ¥ç„¶åè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡
     *      2. å°† @Transactional çš„ä¿¡æ¯è®¾ç½®åˆ°è¿æ¥å’Œäº‹åŠ¡å¯¹è±¡ä¸­ï¼ˆè®¾ç½®çš„å†…å®¹ï¼šè‡ªåŠ¨æäº¤ã€æ˜¯å¦åªè¯»ã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ï¼‰
     *      3. æ˜¯æ–°åˆ›å»ºçš„è¿æ¥ï¼Œå°±ä½¿ç”¨æ•°æ®æºä½œä¸ºkeyï¼Œå°†è¿æ¥ç»‘å®šæ˜¯äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
     *      4. è®¾ç½® ConnectionHolder å±æ€§ isSynchronizedWithTransaction ä¸ºtrue
     * */</span>
    <span class="token function">doBegin</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * status.isNewSynchronization() å°±è®¾ç½® TransactionSynchronizationManagerï¼š
     *  - è®°å½•äº‹åŠ¡éš”ç¦»çº§åˆ«
     *  - æ˜¯å¦åªè¯»
     *  - äº‹åŠ¡çš„name
     *  - <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span> å±æ€§åˆå§‹åŒ–ï¼Œä¼šæ ¹æ®è¿™ä¸ªå±æ€§æ˜¯å¦ä¸ºnullåˆ¤æ–­ æ˜¯ä¸æ˜¯ isNewSynchronization
     * */</span>
    <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>doBegin</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 1. äº‹åŠ¡å¯¹è±¡ï¼Œæ²¡æœ‰è¿æ¥æˆ–è€…è¿æ¥isSynchronizedWithTransaction å°±é€šè¿‡æ•°æ®æºåˆ›å»ºè¿æ¥ç„¶åè®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 2. å°† @Transactional çš„ä¿¡æ¯è®¾ç½®åˆ°è¿æ¥å’Œäº‹åŠ¡å¯¹è±¡ä¸­ï¼ˆè‡ªåŠ¨æäº¤ã€æ˜¯å¦åªè¯»ã€éš”ç¦»çº§åˆ«ã€è¶…æ—¶æ—¶é—´ï¼‰ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 3. æ˜¯æ–°åˆ›å»ºçš„è¿æ¥ï¼Œå°±ä½¿ç”¨æ•°æ®æºä½œä¸ºkeyï¼Œå°†è¿æ¥ç»‘å®šæ˜¯äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * 4. è®¾ç½® ConnectionHolder å±æ€§ isSynchronizedWithTransaction ä¸ºtrue
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doBegin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
    <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ²¡æœ‰è¿æ¥ æˆ–è€… è¿æ¥æ˜¯äº‹åŠ¡åŒæ­¥ é‚£å°±åº”è¯¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥
         *
         * å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œå½“å‰æ–¹æ³•å« doBegin ï¼Œä¹Ÿå°±æ˜¯è¦ç»™äº‹åŠ¡å¯¹è±¡ç»‘å®šè¿æ¥ã€‚è¿æ¥æ²¡æœ‰é‚£å°±åˆ›å»ºä¸€ä¸ªåœ¨ç»‘å®šåˆæƒ…åˆç†ï¼Œ
         * è€Œè¿æ¥æœ‰äº†ï¼Œä½†æ˜¯è¿æ¥æ˜¯äº‹åŠ¡åŒæ­¥ è¯´æ˜ä¸Šä¸€ä¸ªäº‹åŠ¡è¿˜æœªå®Œæˆï¼Œä½ è¿˜è¦ç»‘å®š é‚£ä¹Ÿç»™ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„è¿æ¥ï¼Œè¿™ç§å±äºéæ³•æ“ä½œäº†ï¼Œå¦‚æœä½ è€è€å®å®ç”¨Spring åˆ«æå•¥è‡ªå®šä¹‰ï¼Œæ˜¯ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µçš„
         *
         * å› ä¸º doBegin æ˜¯åœ¨ startTransaction çš„æ—¶å€™ä¼šæ‰§è¡Œï¼Œè€Œ startTransaction ä¹‹å‰ä¼šå…ˆæš‚åœå½“å‰çº¿ç¨‹çš„äº‹ç‰©èµ„æºï¼Œåœ¨å¼€å¯äº‹ç‰©ï¼Œ
         * è€Œæš‚åœå°±æ˜¯
         *      1. ç§»é™¤äº‹ç‰©å¯¹è±¡çš„å¼•ç”¨ `txObject.setConnectionHolder(null);`
         *      2. ä» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ç§»é™¤ ConnectionHolder å­˜èµ·æ¥ã€‚è¿™ä¸ªConnectionHolder å…¶å®å°±æ˜¯ä¸Šé¢ç½®ç©ºçš„å±æ€§
         *          Tips: æš‚åœäº‹åŠ¡çš„ä»£ç  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      è®°ä½ä»£ç æ˜¯æ­»çš„ï¼ŒSpringçš„äº‹ç‰©ä»£ç éƒ½è¿™ä¹ˆå†™äº†ï¼Œæ‰€ä»¥åŸºæœ¬ä¸å¯èƒ½å‡ºç° isSynchronizedWithTransaction çš„æƒ…å†µï¼Œé™¤éå¼€å‘äººå‘˜ç©èŠ±æ´»
         *
         * æ³¨ï¼šåœ¨ä¸€ä¸ªSpringäº‹åŠ¡(å•ä¸€äº‹åŠ¡ã€åµŒå¥—äº‹åŠ¡)
         *      äº‹åŠ¡æš‚åœï¼š`txObject.setConnectionHolder(null)`
         *      äº‹åŠ¡å®Œæˆï¼š` txObject.getConnectionHolder().setSynchronizedWithTransaction(false);`
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>txObject<span class="token punctuation">.</span><span class="token function">hasConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * æ‹¿åˆ°è¿æ¥ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSource</span><span class="token punctuation">#</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *
             * è¿™é‡Œå°±æ˜¯åŠ¨æ€æ•°æ®æºçš„åŸç†äº† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractRoutingDataSource</span><span class="token punctuation">#</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token class-name">Connection</span> newCon <span class="token operator">=</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Acquired Connection [&quot;</span> <span class="token operator">+</span> newCon <span class="token operator">+</span> <span class="token string">&quot;] for JDBC transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è£…é¥° Connection å¹¶è®¾ç½®ç»™äº‹åŠ¡å¯¹è±¡</span>
            txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionHolder</span><span class="token punctuation">(</span>newCon<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * è¡¨ç¤º è¿™ä¸ªäº‹åŠ¡å¯¹è±¡çš„è¿æ¥ æ˜¯äº‹åŠ¡åŒæ­¥
         *
         * åœ¨äº‹ç‰©å®Œæˆæ—¶ ä¼šå°†è¯¥å±æ€§è®¾ç½®ä¸º false
         *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doCleanupAfterCompletion</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConnectionHolder</span><span class="token punctuation">#</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSynchronizedWithTransaction</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        con <span class="token operator">=</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * å°±æ˜¯æ ¹æ® @Transactional æ³¨è§£å€¼ï¼Œç»™Connectionè®¾ç½® åªè¯»å±æ€§ã€éš”ç¦»çº§åˆ«å±æ€§ã€‚
         * è¿”å›çš„æ˜¯ Connection ä¹‹å‰çš„éš”ç¦»é¥¥çº§åˆ«ä¿¡æ¯
         * */</span>
        <span class="token class-name">Integer</span> previousIsolationLevel <span class="token operator">=</span> <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">prepareConnectionForTransaction</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// éš”ç¦»çº§åˆ«</span>
        txObject<span class="token punctuation">.</span><span class="token function">setPreviousIsolationLevel</span><span class="token punctuation">(</span>previousIsolationLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ˜¯å¦åªè¯»</span>
        txObject<span class="token punctuation">.</span><span class="token function">setReadOnly</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¦‚æœè¿æ¥æ˜¯è‡ªåŠ¨æäº¤ï¼Œå°±è®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤</span>
        <span class="token comment">// Switch to manual commit if necessary. This is very expensive in some JDBC drivers,</span>
        <span class="token comment">// so we don&#39;t want to do it unnecessarily (for example if we&#39;ve explicitly</span>
        <span class="token comment">// configured the connection pool to set it already).</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>con<span class="token punctuation">.</span><span class="token function">getAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txObject<span class="token punctuation">.</span><span class="token function">setMustRestoreAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Switching JDBC Connection [&quot;</span> <span class="token operator">+</span> con <span class="token operator">+</span> <span class="token string">&quot;] to manual commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è®¾ç½®ä¸ºéè‡ªåŠ¨æäº¤</span>
            con<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * å°±æ¯”å¦‚ `@Transactional(readOnly = true)` å°±è®¾ç½®äº‹åŠ¡ä¸ºåªè¯»çš„
         * å¦‚æœæ˜¯åªè¯»çš„å°±æ‰§è¡Œsqlè®¾ç½®ä¸ºåªè¯»äº‹åŠ¡  `SET TRANSACTION READ ONLY`
         * */</span>
        <span class="token function">prepareTransactionalConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ´»åŠ¨çš„äº‹åŠ¡ã€‚
         * åœ¨äº‹åŠ¡å®Œæˆæ—¶æ‰ä¼šå°†è¯¥å±æ€§è®¾ç½®ä¸ºfalseï¼Œæš‚åœäº‹åŠ¡å¹¶ä¸ä¼š
         * */</span>
        txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTransactionActive</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * `@Transactional(timeout = -1)` ä¸æ˜¯-1æ‰æ‹¿æ³¨è§£å€¼ï¼Œæ²¡æœ‰å°±è¿”å›é»˜è®¤å€¼ -1
         * */</span>
        <span class="token keyword">int</span> timeout <span class="token operator">=</span> <span class="token function">determineTimeout</span><span class="token punctuation">(</span>definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è®¾ç½®è¶…æ—¶æ—¶é—´</span>
            txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTimeoutInSeconds</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * æ˜¯æ–°åˆ›å»ºçš„connectçš„ï¼Œå°±ç»‘å®šåˆ°ThreadLocalä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
         * ç¼“å­˜çš„Map<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>DataSource,ConnectionHolder</span><span class="token punctuation">&gt;</span></span>ã€‚ä½¿ç”¨DataSourceä½œä¸ºkeyï¼Œæ˜¯å› ä¸ºä¸€ä¸ªçº¿ç¨‹å¯èƒ½æœ‰æ¥å›åˆ‡æ¢æ•°æ®æºçš„æƒ…å†µ(åŠ¨æ€æ•°æ®æº)
         * */</span>
        <span class="token comment">// Bind the connection holder to the thread.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * ç»‘å®šåˆ°äº‹åŠ¡èµ„æºä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> txObject<span class="token punctuation">.</span><span class="token function">getConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txObject<span class="token punctuation">.</span><span class="token function">isNewConnectionHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * ä»äº‹åŠ¡èµ„æº <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ä¸­ç§»é™¤è¯¥è¿æ¥ï¼Œæˆ–è€…æ˜¯å…³é—­è¿æ¥
             *
             * */</span>
            <span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token function">releaseConnection</span><span class="token punctuation">(</span>con<span class="token punctuation">,</span> <span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ¸…é™¤ txObject çš„è¿æ¥ä¿¡æ¯</span>
            txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CannotCreateTransactionException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not open JDBC Connection for transaction&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-6-æ¢å¤äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_1-3-1-6-æ¢å¤äº‹åŠ¡" aria-hidden="true">#</a> 1.3.1.6 æ¢å¤äº‹åŠ¡</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">SuspendedResourcesHolder</span> resourcesHolder<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŒ‚èµ·çš„èµ„æº æ¯”å¦‚æ•°æ®åº“è¿æ¥</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> resourcesHolder<span class="token punctuation">.</span>suspendedResources<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>suspendedResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * 1ï¸âƒ£æ¢å¤äº‹åŠ¡èµ„æºã€‚
             * å°±æ˜¯é‡æ–°è®¾ç½®å›äº‹åŠ¡èµ„æºThreadLocalä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token function">doResume</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> resourcesHolder<span class="token punctuation">.</span>suspendedSynchronizations<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>suspendedSynchronizations <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span>resourcesHolder<span class="token punctuation">.</span>wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span>resourcesHolder<span class="token punctuation">.</span>isolationLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span>resourcesHolder<span class="token punctuation">.</span>readOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span>resourcesHolder<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2ï¸âƒ£æ¢å¤äº‹åŠ¡åŒæ­¥èµ„æº</span>
            <span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span>suspendedSynchronizations<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1ï¸âƒ£æ¢å¤èµ„æºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doResume</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¸âƒ£æ¢å¤è¡Œä¸ºåŒæ­¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">initSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronization</span> synchronization <span class="token operator">:</span> suspendedSynchronizations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceUtils</span><span class="token punctuation">.</span><span class="token class-name">ConnectionSynchronization</span><span class="token punctuation">#</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * å°±æ˜¯å°†å…¶Connectioné‡æ–°è®¾ç½®åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">resources</span></span><span class="token punctuation">}</span> ä¸­
         * */</span>
        synchronization<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * é‡æ–°æ³¨å†Œå› <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span>synchronization<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="_1-3-1-7-åˆ›å»ºäº‹åŠ¡çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_1-3-1-7-åˆ›å»ºäº‹åŠ¡çŠ¶æ€" aria-hidden="true">#</a> 1.3.1.7 åˆ›å»ºäº‹åŠ¡çŠ¶æ€</h6><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">DefaultTransactionStatus</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>
          <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTransaction<span class="token punctuation">,</span>
          <span class="token keyword">boolean</span> newSynchronization<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// äº‹åŠ¡çŠ¶æ€</span>
      <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
              definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> newTransaction<span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debug<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// åˆå§‹åŒ–è¡Œä¸ºåŒæ­¥</span>
      <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> status<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>



<span class="token comment">// åˆ›å»ºäº‹åŠ¡çŠ¶æ€</span>
<span class="token keyword">protected</span> <span class="token class-name">DefaultTransactionStatus</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
        <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> newTransaction<span class="token punctuation">,</span>
        <span class="token keyword">boolean</span> newSynchronization<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debug<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * newSynchronization ä¸” ä¸æ˜¯åŒæ­¥æ¿€æ´»çŠ¶æ€  å°±æ˜¯ çœŸçš„æ–°åŒæ­¥
     *
     * åŒæ­¥æ¿€æ´»çŠ¶æ€ï¼š
     *      - trueï¼šç®€å•æ¥è¯´å°±æ˜¯Javaè™šæ‹Ÿæœºæ ˆä¸­å­˜åœ¨@Transactionalçš„æ–¹æ³•
     *      - falseï¼šæš‚åœå½“å‰äº‹åŠ¡ã€å®Œæˆå½“å‰äº‹åŠ¡(rollbackæˆ–è€…commit)
     *
     * ç»“è®ºï¼šå½“å‰çº¿ç¨‹åœ¨ TransactionSynchronizationManager æ²¡æœ‰è®°å½•ä¿¡æ¯ï¼Œ actualNewSynchronization å°±æ˜¯true
     * */</span>
    <span class="token keyword">boolean</span> actualNewSynchronization <span class="token operator">=</span> newSynchronization <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">(</span>
            transaction<span class="token punctuation">,</span> newTransaction<span class="token punctuation">,</span> actualNewSynchronization<span class="token punctuation">,</span>
            definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> debug<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é€‚å½“åœ°åˆå§‹åŒ–äº‹åŠ¡åŒæ­¥ã€‚
     * Initialize transaction synchronization as appropriate.
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">,</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ˜¯æ–°çš„åŒæ­¥ï¼Œæ‰è®°å½•è¿™äº›ä¿¡æ¯ï¼ˆæ³¨ï¼šç©ºäº‹åŠ¡ä¹Ÿç®—çš„ï¼‰
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * çœŸçš„æ´»åŠ¨çš„äº‹åŠ¡ã€‚å°±æ˜¯å¾—æœ‰äº‹åŠ¡ï¼Œä¸”äº‹åŠ¡æ˜¯æ–°çš„æ‰æ˜¯true
             * */</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setActualTransactionActive</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®°å½•äº‹åŠ¡éš”ç¦»çº§åˆ«</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionIsolationLevel</span><span class="token punctuation">(</span>
                    definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">ISOLATION_DEFAULT</span> <span class="token operator">?</span>
                            definition<span class="token punctuation">.</span><span class="token function">getIsolationLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ˜¯å¦åªè¯»</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionReadOnly</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">isReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// äº‹åŠ¡çš„name</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">setCurrentTransactionName</span><span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åŒæ­¥å±æ€§åˆå§‹åŒ–ï¼Œä¼šæ ¹æ®è¿™ä¸ªå±æ€§æ˜¯å¦ä¸ºnullåˆ¤æ–­ æ˜¯ä¸æ˜¯ isNewSynchronization</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">initSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_1-3-2-åˆ›å»ºäº‹åŠ¡ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#_1-3-2-åˆ›å»ºäº‹åŠ¡ä¿¡æ¯" aria-hidden="true">#</a> 1.3.2 åˆ›å»ºäº‹åŠ¡ä¿¡æ¯</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionAspectSupport</span><span class="token operator">:</span>

<span class="token keyword">protected</span> <span class="token class-name">TransactionInfo</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PlatformTransactionManager</span> tm<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">,</span> <span class="token class-name">String</span> joinpointIdentification<span class="token punctuation">,</span>
                                                 <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We need a transaction for this method...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Getting transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®¾ç½®äº‹åŠ¡çŠ¶æ€</span>
        <span class="token comment">// The transaction manager will flag an error if an incompatible tx already exists.</span>
        txInfo<span class="token punctuation">.</span><span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// The TransactionInfo.hasTransaction() method will return false. We created it only</span>
        <span class="token comment">// to preserve the integrity of the ThreadLocal stack maintained in this class.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;No need to create transaction for [&quot;</span> <span class="token operator">+</span> joinpointIdentification <span class="token operator">+</span>
                    <span class="token string">&quot;]: This method is not transactional.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * ç»‘å®šåˆ°è¿™ä¸ªå±æ€§ä¸Š <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token field">transactionInfoHolder</span></span><span class="token punctuation">}</span>
     * å¹¶ä¸”ä¼šè®°å½•åŸæ¥ThreadLocalçš„å€¼ï¼Œå½“äº‹åŠ¡ç»“æŸäº†è¦æ¢å¤å›å» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionAspectSupport</span><span class="token punctuation">#</span><span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span><span class="token class-name">TransactionInfo</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token comment">// We always bind the TransactionInfo to the thread, even if we didn&#39;t create</span>
    <span class="token comment">// a new transaction here. This guarantees that the TransactionInfo stack</span>
    <span class="token comment">// will be managed correctly even if no transaction was created by this aspect.</span>
    txInfo<span class="token punctuation">.</span><span class="token function">bindToThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> txInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-4-å‡ºç°å¼‚å¸¸çš„å¤„ç†" tabindex="-1"><a class="header-anchor" href="#_1-4-å‡ºç°å¼‚å¸¸çš„å¤„ç†" aria-hidden="true">#</a> 1.4 å‡ºç°å¼‚å¸¸çš„å¤„ç†</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Completing transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                    <span class="token string">&quot;] after exception: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * å¼‚å¸¸æ˜¯éœ€è¦å›æ»š <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">#</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * - ä½¿ç”¨ @Transactional é…ç½®çš„rollbackè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…å°±è¿”å›ç»“æœ
         * - æ²¡æœ‰åŒ¹é…rollbackï¼Œå°±åˆ¤æ–­å¼‚å¸¸æ˜¯ä¸æ˜¯  RuntimeException ã€Error æ˜¯å°±å›æ»š
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span>transactionAttribute <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span>transactionAttribute<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * 1ï¸âƒ£å›æ»š
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 * */</span>
                txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by rollback exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by rollback exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * 2ï¸âƒ£æäº¤äº‹åŠ¡
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token comment">// We don&#39;t roll back on this exception.</span>
            <span class="token comment">// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ex2<span class="token punctuation">.</span><span class="token function">initApplicationException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Application exception overridden by commit exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex2<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1ï¸âƒ£å›æ»š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">DefaultTransactionStatus</span> defStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span> status<span class="token punctuation">;</span>
    <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processRollback</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">,</span> <span class="token keyword">boolean</span> unexpected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> unexpectedRollback <span class="token operator">=</span> unexpected<span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * å›è°ƒ TransactionSynchronization
                 * å°±æ˜¯éå† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">#</span><span class="token field">synchronizations</span></span><span class="token punctuation">}</span> å±æ€§
				 * å®Œæˆäº‹åŠ¡å‰å›è°ƒ
                 * */</span>
                <span class="token function">triggerBeforeCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Rolling back transaction to savepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token doc-comment comment">/**
                     * å›æ»šåˆ°æœ€å‰çš„ä¿å­˜ç‚¹
                     * */</span>
                    status<span class="token punctuation">.</span><span class="token function">rollbackToHeldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Initiating transaction rollback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token doc-comment comment">/**
                     * å›æ»š
                     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span></span><span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">#</span><span class="token function">doRollback</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                     * */</span>
                    <span class="token function">doRollback</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Participating in larger transaction</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isLocalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isGlobalRollbackOnParticipationFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token function">doSetRollbackOnly</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Should roll back transaction but cannot - no transaction available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// Unexpected rollback only matters here if we&#39;re asked to fail early</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFailEarlyOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        unexpectedRollback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization å®Œæˆäº‹åŠ¡åå›è°ƒ</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// å›è°ƒ TransactionSynchronization  å®Œæˆäº‹åŠ¡åå›è°ƒ</span>
            <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_ROLLED_BACK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Raise UnexpectedRollbackException if we had a global rollback-only marker</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedRollback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnexpectedRollbackException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Transaction rolled back because it has been marked as rollback-only&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¢å¤ä¸Šä¸ªäº‹åŠ¡çš„èµ„æº</span>
            <span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2ï¸âƒ£æäº¤</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">DefaultTransactionStatus</span> defStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span> status<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isLocalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Transactional code has requested rollback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å›æ»š</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldCommitOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> defStatus<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å›æ»š</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// commit</span>
    <span class="token function">processCommit</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processCommit</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> beforeCompletionInvoked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> unexpectedRollback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token function">prepareForCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization æäº¤å‰å›è°ƒ</span>
                <span class="token function">triggerBeforeCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization å®Œæˆå‰å›è°ƒ</span>
                <span class="token function">triggerBeforeCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                beforeCompletionInvoked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Releasing transaction savepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    status<span class="token punctuation">.</span><span class="token function">releaseHeldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Initiating transaction commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æäº¤äº‹åŠ¡</span>
                    <span class="token function">doCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFailEarlyOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Throw UnexpectedRollbackException if we have a global rollback-only</span>
                <span class="token comment">// marker but still didn&#39;t get a corresponding exception from commit.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedRollback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnexpectedRollbackException</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;Transaction silently rolled back because it has been marked as rollback-only&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnexpectedRollbackException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// can only be caused by doCommit</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_ROLLED_BACK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// can only be caused by doCommit</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRollbackOnCommitFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doRollbackOnCommitException</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beforeCompletionInvoked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">triggerBeforeCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">doRollbackOnCommitException</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Trigger afterCommit callbacks, with an exception thrown there</span>
            <span class="token comment">// propagated to callers but the transaction still considered as committed.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization æäº¤åå›è°ƒ</span>
                <span class="token function">triggerAfterCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_COMMITTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°±æ˜¯æ¢å¤æš‚åœçš„äº‹åŠ¡èµ„æº</span>
            <span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-5-æ¸…ç©ºäº‹åŠ¡ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#_1-5-æ¸…ç©ºäº‹åŠ¡ä¿¡æ¯" aria-hidden="true">#</a> 1.5 æ¸…ç©ºäº‹åŠ¡ä¿¡æ¯</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionAspectSupport</span><span class="token operator">:</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        txInfo<span class="token punctuation">.</span><span class="token function">restoreThreadLocalStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">TransactionInfo</span><span class="token operator">:</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">restoreThreadLocalStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Use stack to restore old transaction TransactionInfo.</span>
            <span class="token comment">// Will be null if none was set.</span>
            transactionInfoHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldTransactionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_1-6-æäº¤äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#_1-6-æäº¤äº‹åŠ¡" aria-hidden="true">#</a> 1.6 æäº¤äº‹åŠ¡</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Completing transaction for [&quot;</span> <span class="token operator">+</span> txInfo<span class="token punctuation">.</span><span class="token function">getJoinpointIdentification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token punctuation">#</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractPlatformTransactionManager</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Transaction is already completed - do not call commit or rollback more than once per transaction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">DefaultTransactionStatus</span> defStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span> status<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isLocalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Transactional code has requested rollback&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å›æ»š</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldCommitOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> defStatus<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Global transaction is marked as rollback-only but transactional code requested commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å›æ»š</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// commit</span>
    <span class="token function">processCommit</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processCommit</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> beforeCompletionInvoked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> unexpectedRollback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token function">prepareForCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization æäº¤å‰å›è°ƒ</span>
                <span class="token function">triggerBeforeCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization å®Œæˆå‰å›è°ƒ</span>
                <span class="token function">triggerBeforeCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                beforeCompletionInvoked <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Releasing transaction savepoint&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    status<span class="token punctuation">.</span><span class="token function">releaseHeldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Initiating transaction commit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æäº¤äº‹åŠ¡</span>
                    <span class="token function">doCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFailEarlyOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    unexpectedRollback <span class="token operator">=</span> status<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Throw UnexpectedRollbackException if we have a global rollback-only</span>
                <span class="token comment">// marker but still didn&#39;t get a corresponding exception from commit.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>unexpectedRollback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnexpectedRollbackException</span><span class="token punctuation">(</span>
                            <span class="token string">&quot;Transaction silently rolled back because it has been marked as rollback-only&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnexpectedRollbackException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// can only be caused by doCommit</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_ROLLED_BACK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// can only be caused by doCommit</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRollbackOnCommitFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">doRollbackOnCommitException</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_UNKNOWN</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>beforeCompletionInvoked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">triggerBeforeCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">doRollbackOnCommitException</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Trigger afterCommit callbacks, with an exception thrown there</span>
            <span class="token comment">// propagated to callers but the transaction still considered as committed.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization æäº¤åå›è°ƒ</span>
                <span class="token function">triggerAfterCommit</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// å›è°ƒ TransactionSynchronization</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">TransactionSynchronization</span><span class="token punctuation">.</span><span class="token constant">STATUS_COMMITTED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°±æ˜¯æ¢å¤æš‚åœçš„äº‹åŠ¡èµ„æº</span>
            <span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="transactionaleventlistenerfactory" tabindex="-1"><a class="header-anchor" href="#transactionaleventlistenerfactory" aria-hidden="true">#</a> TransactionalEventListenerFactory</h3><p>äº‹åŠ¡äº‹ä»¶ç›‘å¬</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2024/01/02/7LiYWx.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li><p><strong>@EnableTransactionManagementå¯¼å…¥ProxyTransactionManagementConfigurationï¼š</strong></p><ul><li>é¦–å…ˆï¼Œ<code>@EnableTransactionManagement</code>ä¼šå¯¼å…¥<code>ProxyTransactionManagementConfiguration</code>ã€‚</li><li><code>ProxyTransactionManagementConfiguration</code>çš„çˆ¶ç±»æ˜¯<code>AbstractTransactionManagementConfiguration</code>ï¼Œå®ƒä½¿ç”¨<code>@Bean</code>æ³¨å…¥<code>TransactionalEventListenerFactory</code>ã€‚</li></ul></li><li><p><strong>TransactionalEventListenerFactoryè§£æ@TransactionalEventListenerï¼š</strong></p><ul><li><code>TransactionalEventListenerFactory</code>ç”¨äºè§£æ<code>@TransactionalEventListener</code>ï¼Œå°†å…¶è½¬æ¢ä¸º<code>TransactionalApplicationListenerMethodAdapter</code>å¹¶æ³¨å†Œåˆ°äº‹ä»¶å¹¿æ’­å™¨ä¸­ã€‚</li></ul></li><li><p><strong>TransactionalApplicationListenerMethodAdapterçš„äº‹ä»¶æ¥æ”¶é€»è¾‘ï¼š</strong></p><ul><li><code>TransactionalApplicationListenerMethodAdapter#onApplicationEvent(ApplicationEvent)</code>æ–¹æ³•ç”¨äºæ¥æ”¶äº‹ä»¶ã€‚</li><li>å¦‚æœæ˜¯æ´»åŠ¨çš„äº‹åŠ¡ä¸”å®é™…æ¿€æ´»çš„äº‹åŠ¡ä¸ä¸ºç©ºï¼Œä¼šæ³¨å†Œäº‹åŠ¡åŒæ­¥èµ„æºï¼Œè¿™åœ¨äº‹åŠ¡å®Œæˆæ—¶ï¼ˆrollbackæˆ–commitï¼‰æ—¶ä¼šè°ƒç”¨å…¶listenerå’Œcallbacksï¼Œå®ç°å»¶æ—¶äº‹ä»¶çš„å‘å¸ƒã€‚</li><li>è¦æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œå¿…é¡»åœ¨äº‹åŠ¡æ–¹æ³•å†…å‘å¸ƒäº‹ä»¶ï¼Œå¦åˆ™æ¡ä»¶ä¸æˆç«‹ã€‚</li><li>å¦åˆ™ï¼Œå¦‚æœ<code>annotation.fallbackExecution()</code>ä¸ºtrueï¼Œåˆ™è°ƒç”¨<code>processEvent(event)</code>å¤„ç†äº‹ä»¶ï¼Œå³å›è°ƒ<code>@TransactionalEventListener</code>æ ‡æ³¨çš„æ–¹æ³•ã€‚</li><li>å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œã€‚</li></ul></li></ol><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionalApplicationListenerMethodAdapter</span><span class="token operator">:</span> 

<span class="token doc-comment comment">/**
 * è§¦å‘æ¡ä»¶ä½¿ç”¨äº‹ä»¶å¹¿æ’­å™¨å‘å¸ƒäº‹ä»¶ã€‚
 * è¦æƒ³æ”¶åˆ°äº‹åŠ¡è¡Œä¸ºçš„äº‹ä»¶ï¼šå¾—åœ¨äº‹åŠ¡æ–¹æ³•å†…ä½¿ç”¨äº‹ä»¶å¹¿æ’­å™¨å‘å¸ƒäº‹ä»¶
 * <span class="token keyword">@param</span> <span class="token parameter">event</span> the event to respond to
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * æ˜¯æ´»åŠ¨çš„äº‹åŠ¡(åªè¦è¿›å…¥äº‹åŠ¡æ–¹æ³•å°±æ˜¯true)  ä¸” å®é™…æ¿€æ´»çš„äº‹åŠ¡(å¿…é¡»ä¸æ˜¯ç©ºäº‹åŠ¡)
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isActualTransactionActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ³¨å†Œäº‹åŠ¡åŒæ­¥èµ„æºï¼Œåœ¨äº‹åŠ¡å®Œæˆæ—¶(rollbackæˆ–è€…commit)ä¼šè°ƒç”¨å…¶ listenerã€callbacks</span>
        <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">registerSynchronization</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">TransactionalApplicationListenerSynchronization</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotation<span class="token punctuation">.</span><span class="token function">fallbackExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å…œåº•æ‰§è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>annotation<span class="token punctuation">.</span><span class="token function">phase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionPhase</span><span class="token punctuation">.</span><span class="token constant">AFTER_ROLLBACK</span> <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Processing &quot;</span> <span class="token operator">+</span> event <span class="token operator">+</span> <span class="token string">&quot; as a fallback execution on AFTER_ROLLBACK phase&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">processEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// No transactional event execution at all</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;No transaction is active - skipping &quot;</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">TransactionalApplicationListenerSynchronization</span><span class="token operator">:</span>

<span class="token keyword">class</span> <span class="token class-name">TransactionalApplicationListenerSynchronization</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">TransactionSynchronization</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">E</span> event<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionalApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> listener<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionalApplicationListener<span class="token punctuation">.</span>SynchronizationCallback</span><span class="token punctuation">&gt;</span></span> callbacks<span class="token punctuation">;</span>


    <span class="token keyword">public</span> <span class="token class-name">TransactionalApplicationListenerSynchronization</span><span class="token punctuation">(</span><span class="token class-name">E</span> event<span class="token punctuation">,</span> <span class="token class-name">TransactionalApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> listener<span class="token punctuation">,</span>
                                                           <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionalApplicationListener<span class="token punctuation">.</span>SynchronizationCallback</span><span class="token punctuation">&gt;</span></span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>event <span class="token operator">=</span> event<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>listener <span class="token operator">=</span> listener<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks <span class="token operator">=</span> callbacks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeCommit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> readOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">getTransactionPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionPhase</span><span class="token punctuation">.</span><span class="token constant">BEFORE_COMMIT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processEventWithCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TransactionPhase</span> phase <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">getTransactionPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">==</span> <span class="token class-name">TransactionPhase</span><span class="token punctuation">.</span><span class="token constant">AFTER_COMMIT</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">==</span> <span class="token constant">STATUS_COMMITTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processEventWithCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">==</span> <span class="token class-name">TransactionPhase</span><span class="token punctuation">.</span><span class="token constant">AFTER_ROLLBACK</span> <span class="token operator">&amp;&amp;</span> status <span class="token operator">==</span> <span class="token constant">STATUS_ROLLED_BACK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processEventWithCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>phase <span class="token operator">==</span> <span class="token class-name">TransactionPhase</span><span class="token punctuation">.</span><span class="token constant">AFTER_COMPLETION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">processEventWithCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processEventWithCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›è°ƒ SynchronizationCallback å‰ç½®æ–¹æ³•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback <span class="token operator">-&gt;</span> callback<span class="token punctuation">.</span><span class="token function">preProcessEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å›è°ƒç›‘å¬å™¨
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ApplicationListenerMethodAdapter</span><span class="token punctuation">#</span><span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>listener<span class="token punctuation">.</span><span class="token function">processEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å›è°ƒ SynchronizationCallback åç½®æ–¹æ³•</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback <span class="token operator">-&gt;</span> callback<span class="token punctuation">.</span><span class="token function">postProcessEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å›è°ƒ SynchronizationCallback åç½®æ–¹æ³•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback <span class="token operator">-&gt;</span> callback<span class="token punctuation">.</span><span class="token function">postProcessEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>event<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/springboot4/edit/main/src/source-code/spring/SpringTransaction.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2235602974@qq.com">ä»˜ç»ªå£®</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/offer/source-code/spring/SpringConfig.html" class="nav-link prev" aria-label="springé…ç½®æ–‡ä»¶"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->springé…ç½®æ–‡ä»¶</div></a><!----></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/offer/assets/app-fdefc158.js" defer></script>
  </body>
</html>
