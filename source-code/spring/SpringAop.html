<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>spring aop | æ€¨ç§å­¦java</title><meta name="description" content="ã€Œæµæ°´ä¸äº‰å…ˆ äº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/offer/assets/style-1e9048c3.css" as="style"><link rel="stylesheet" href="/offer/assets/style-1e9048c3.css">
    <link rel="modulepreload" href="/offer/assets/app-fdefc158.js"><link rel="modulepreload" href="/offer/assets/framework-8edddef6.js"><link rel="modulepreload" href="/offer/assets/SpringAop.html-3c37f8b4.js"><link rel="modulepreload" href="/offer/assets/SpringAop.html-fb4693f1.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/offer/" class="brand"><img class="logo" src="/offer/logo.png" alt="æ€¨ç§å­¦java"><!----><span class="site-name hide-in-pad">æ€¨ç§å­¦java</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link" aria-label="ç¬”è®°"><span class="font-icon icon iconfont icon-activity" style=""></span>ç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/offer/offer-started.html" class="nav-link" aria-label="å…«è‚¡"><span class="font-icon icon iconfont icon-shell" style=""></span>å…«è‚¡<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/link.html" class="nav-link" aria-label="å¤–éƒ¨é“¾æ¥"><span class="font-icon icon iconfont icon-share" style=""></span>å¤–éƒ¨é“¾æ¥<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/about.html" class="nav-link" aria-label="å…³äºä½œè€…"><span class="font-icon icon iconfont icon-alias" style=""></span>å…³äºä½œè€…<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/springboot4" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">nacos</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé›†ç¾¤åŒæ­¥"><!---->nacosé›†ç¾¤åŒæ­¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/config.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé…ç½®ä¸­å¿ƒ"><!---->nacosé…ç½®ä¸­å¿ƒ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/discoverAndSubscribe.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶"><!---->nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/healthCheck.html" class="nav-link sidebar-link sidebar-page" aria-label="nacoså¥åº·æ£€æŸ¥æœºåˆ¶"><!---->nacoså¥åº·æ£€æŸ¥æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/register.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡æ³¨å†Œ"><!---->nacosæœåŠ¡æ³¨å†Œ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">spring</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/spring/SpingInject.html" class="nav-link sidebar-link sidebar-page" aria-label="spingä¾èµ–æ³¨å…¥"><!---->spingä¾èµ–æ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/Spring@Async.html" class="nav-link sidebar-link sidebar-page" aria-label="springå¼‚æ­¥@Async"><!---->springå¼‚æ­¥@Async<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/offer/source-code/spring/SpringAop.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="spring aop"><!---->spring aop<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ¦‚è¿°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#advisoræ˜¯å•¥" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Advisoræ˜¯å•¥"><!---->Advisoræ˜¯å•¥<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#pointcutadvisor-å’Œ-introductionadvisor-çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="PointcutAdvisor å’Œ IntroductionAdvisor çš„åŒºåˆ«"><!---->PointcutAdvisor å’Œ IntroductionAdvisor çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#enableaspectjautoproxy" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="@EnableAspectJAutoProxy"><!---->@EnableAspectJAutoProxy<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#annotationawareaspectjautoproxycreatorçš„å®ä¾‹åŒ–" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AnnotationAwareAspectJAutoProxyCreatorçš„å®ä¾‹åŒ–"><!---->AnnotationAwareAspectJAutoProxyCreatorçš„å®ä¾‹åŒ–<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#annotationawareaspectjautoproxycreator-åç½®å¤„ç†å™¨å›è°ƒ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AnnotationAwareAspectJAutoProxyCreator åç½®å¤„ç†å™¨å›è°ƒ"><!---->AnnotationAwareAspectJAutoProxyCreator åç½®å¤„ç†å™¨å›è°ƒ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#aopåˆ‡é¢çš„è§£æ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="AOPåˆ‡é¢çš„è§£æ"><!---->AOPåˆ‡é¢çš„è§£æ<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#å®ä¾‹åŒ–å‰åç½®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å®ä¾‹åŒ–å‰åç½®"><!---->å®ä¾‹åŒ–å‰åç½®<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#åˆ›å»ºä»£ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åˆ›å»ºä»£ç†"><!---->åˆ›å»ºä»£ç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#å®ä¾‹åŒ–å‰åç½®-1" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="å®ä¾‹åŒ–å‰åç½®"><!---->å®ä¾‹åŒ–å‰åç½®<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#åˆå§‹åŒ–å‰åç½®" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="åˆå§‹åŒ–å‰åç½®"><!---->åˆå§‹åŒ–å‰åç½®<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#è·å–æ—©æœŸbeanå¼•ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è·å–æ—©æœŸbeanå¼•ç”¨"><!---->è·å–æ—©æœŸbeanå¼•ç”¨<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ‰§è¡Œä»£ç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ‰§è¡Œä»£ç†"><!---->æ‰§è¡Œä»£ç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#è§£ææ‹¦æˆªå™¨é“¾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="è§£ææ‹¦æˆªå™¨é“¾"><!---->è§£ææ‹¦æˆªå™¨é“¾<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ‰§è¡Œæ‹¦æˆªå™¨é“¾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ‰§è¡Œæ‹¦æˆªå™¨é“¾"><!---->æ‰§è¡Œæ‹¦æˆªå™¨é“¾<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringBeanLIfeCycle.html" class="nav-link sidebar-link sidebar-page" aria-label="spring beançš„ç”Ÿå‘½å‘¨æœŸ"><!---->spring beançš„ç”Ÿå‘½å‘¨æœŸ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringConfig.html" class="nav-link sidebar-link sidebar-page" aria-label="springé…ç½®æ–‡ä»¶"><!---->springé…ç½®æ–‡ä»¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringTransaction.html" class="nav-link sidebar-link sidebar-page" aria-label="springäº‹åŠ¡"><!---->springäº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-template" style=""></span><span class="title">spring boot</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringBoot/config.html" class="nav-link sidebar-link sidebar-page" aria-label="spring booté…ç½®åŠ è½½"><!---->spring booté…ç½®åŠ è½½<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringBoot/start.html" class="nav-link sidebar-link sidebar-page" aria-label="spring bootå¯åŠ¨æµç¨‹"><!---->spring bootå¯åŠ¨æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-module" style=""></span><span class="title">spring cloud</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringCloudCommon/configRefresh.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudé…ç½®åŠ¨æ€åˆ·æ–°"><!---->spring cloudé…ç½®åŠ¨æ€åˆ·æ–°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/loadBalancing.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloud loadBalanced"><!---->spring cloud loadBalanced<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/registerAndDiscover.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°"><!---->spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->spring aop</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://fxzcloud.gitee.io/offer/" target="_blank" rel="noopener noreferrer">fxz</a></span><span property="author" content="fxz"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-02-29T07:03:48.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 64 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT64M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ¦‚è¿°" class="router-link-active router-link-exact-active toc-link level2">æ¦‚è¿°</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#advisoræ˜¯å•¥" class="router-link-active router-link-exact-active toc-link level3">Advisoræ˜¯å•¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#pointcutadvisor-å’Œ-introductionadvisor-çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">PointcutAdvisor å’Œ IntroductionAdvisor çš„åŒºåˆ«</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#enableaspectjautoproxy" class="router-link-active router-link-exact-active toc-link level3">@EnableAspectJAutoProxy</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#annotationawareaspectjautoproxycreatorçš„å®ä¾‹åŒ–" class="router-link-active router-link-exact-active toc-link level3">AnnotationAwareAspectJAutoProxyCreatorçš„å®ä¾‹åŒ–</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#annotationawareaspectjautoproxycreator-åç½®å¤„ç†å™¨å›è°ƒ" class="router-link-active router-link-exact-active toc-link level3">AnnotationAwareAspectJAutoProxyCreator åç½®å¤„ç†å™¨å›è°ƒ</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#aopåˆ‡é¢çš„è§£æ" class="router-link-active router-link-exact-active toc-link level2">AOPåˆ‡é¢çš„è§£æ</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#å®ä¾‹åŒ–å‰åç½®" class="router-link-active router-link-exact-active toc-link level3">å®ä¾‹åŒ–å‰åç½®</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#åˆ›å»ºä»£ç†" class="router-link-active router-link-exact-active toc-link level2">åˆ›å»ºä»£ç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#å®ä¾‹åŒ–å‰åç½®-1" class="router-link-active router-link-exact-active toc-link level3">å®ä¾‹åŒ–å‰åç½®</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#åˆå§‹åŒ–å‰åç½®" class="router-link-active router-link-exact-active toc-link level3">åˆå§‹åŒ–å‰åç½®</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#è·å–æ—©æœŸbeanå¼•ç”¨" class="router-link-active router-link-exact-active toc-link level3">è·å–æ—©æœŸbeanå¼•ç”¨</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ‰§è¡Œä»£ç†" class="router-link-active router-link-exact-active toc-link level2">æ‰§è¡Œä»£ç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#è§£ææ‹¦æˆªå™¨é“¾" class="router-link-active router-link-exact-active toc-link level3">è§£ææ‹¦æˆªå™¨é“¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringAop.html#æ‰§è¡Œæ‹¦æˆªå™¨é“¾" class="router-link-active router-link-exact-active toc-link level3">æ‰§è¡Œæ‹¦æˆªå™¨é“¾</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="spring-aop" tabindex="-1"><a class="header-anchor" href="#spring-aop" aria-hidden="true">#</a> spring aop</h1><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h2><h3 id="advisoræ˜¯å•¥" tabindex="-1"><a class="header-anchor" href="#advisoræ˜¯å•¥" aria-hidden="true">#</a> Advisoræ˜¯å•¥</h3><p>åœ¨Springæ¡†æ¶ä¸­ï¼Œ<code>Advisor</code>ï¼ˆé¡¾é—®ï¼‰æ˜¯ç”¨äºå®šä¹‰åˆ‡é¢ï¼ˆAspectï¼‰çš„ä¸€ç§æœºåˆ¶ã€‚<code>Advisor</code>åŒ…å«åˆ‡ç‚¹ï¼ˆPointcutï¼‰å’Œå¢å¼ºï¼ˆAdviceï¼‰ï¼Œå®ƒå¯ä»¥æŒ‡å¯¼åœ¨ä½•å¤„ä»¥åŠå¦‚ä½•åº”ç”¨ç‰¹å®šçš„è¡Œä¸ºã€‚åœ¨AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ä¸­ï¼Œ<code>Advisor</code>å¸®åŠ©å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆcross-cutting concernsï¼‰ä»ä¸»è¦ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚</p><p>å…·ä½“è€Œè¨€ï¼Œ<code>Advisor</code>é€šå¸¸æœ‰ä¸¤ä¸ªä¸»è¦å®ç°ï¼š</p><ol><li><strong>Pointcut Advisorï¼ˆåˆ‡ç‚¹é¡¾é—®ï¼‰ï¼š</strong> å®šä¹‰äº†åˆ‡ç‚¹ï¼Œå³æŒ‡å®šåœ¨ä½•å¤„åº”ç”¨å¢å¼ºçš„è§„åˆ™ã€‚</li><li><strong>Introduction Advisorï¼ˆå¼•ä»‹é¡¾é—®ï¼‰ï¼š</strong> å…è®¸å‘ç°æœ‰çš„ç±»å¼•ä»‹æ–°çš„æ¥å£å’Œå±æ€§ã€‚</li></ol><p><code>Advisor</code>çš„ç›®æ ‡æ˜¯é€šè¿‡æä¾›ä¸€ç§éä¾µå…¥æ€§çš„æ–¹å¼ï¼Œå°†æ¨ªåˆ‡å…³æ³¨ç‚¹é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå¹¶å°†å…¶åº”ç”¨äºåº”ç”¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†ã€‚è¿™æœ‰åŠ©äºæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚</p><p><code>@Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing</code> ä¼šè¢«è§£ææˆ <code>PointcutAdvisor</code></p><p><code>DeclareParents</code> ä¼šè¢«è§£ææˆ <code>IntroductionAdvisor</code></p><h3 id="pointcutadvisor-å’Œ-introductionadvisor-çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#pointcutadvisor-å’Œ-introductionadvisor-çš„åŒºåˆ«" aria-hidden="true">#</a> PointcutAdvisor å’Œ IntroductionAdvisor çš„åŒºåˆ«</h3><p><strong>åœ¨è¿›è¡Œåˆ‡å…¥ç‚¹åŒ¹é…æ—¶ï¼š</strong></p><ul><li>PointcutAdvisorï¼šä½¿ç”¨å…¶Poincutå±æ€§ï¼Œè¿›è¡ŒClassFilter+MethodMatcher</li><li>IntroductionAdvisorï¼šè¿›è¡ŒClassFilter</li></ul><p><strong>åœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶ï¼š</strong></p><ul><li>PointcutAdvisorï¼šä¼šè·å–å…¶Adviceå±æ€§ï¼Œè½¬æ¢æˆMethodInterceptorå¯¹è±¡ï¼Œç»„æˆInterceptorChainï¼Œåœ¨æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œä¸æ–¹æ³•åŒ¹é…çš„Interceptors</li><li>IntroductionAdvisorï¼š <ol><li>ä¼šæ‹¿åˆ°å…¶ interfaces è®¾ç½®ä¸ºä»£ç†å¯¹è±¡çš„æ¥å£ï¼Œç„¶ååˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ‰€ä»¥åˆ›å»ºå‡ºæ¥çš„ä»£ç†å¯¹è±¡å¯ä»¥å¼ºè½¬æˆå¯¹åº”çš„æ¥å£ï¼Œä»è€Œå®ç° ä¸ä¿®æ”¹è¢«ä»£ç†çš„æƒ…å†µä¸‹æ–°å¢æ–¹æ³•ã€‚</li><li>å’ŒPointcutAdvisorä¸€æ ·ã€‚ä¼šè·å–å…¶Adviceå±æ€§ï¼Œè½¬æ¢æˆMethodInterceptorå¯¹è±¡ï¼Œç»„æˆInterceptorChainï¼Œåœ¨æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼Œä¼šæ‰§è¡Œä¸æ–¹æ³•åŒ¹é…çš„Interceptors</li></ol></li></ul><h3 id="enableaspectjautoproxy" tabindex="-1"><a class="header-anchor" href="#enableaspectjautoproxy" aria-hidden="true">#</a> @EnableAspectJAutoProxy</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * 1. ä½¿ç”¨æ³¨è§£ <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">EnableAspectJAutoProxy</span></span><span class="token punctuation">}</span>
 *      è¯¥æ³¨è§£ä¼šå¯¼å…¥ <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AspectJAutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span></span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJAutoProxyRegistrar</span></span><span class="token punctuation">}</span>
 *
 * 2. æ‰€ä»¥ä¼šåœ¨è§£æé…ç½®ç±»é˜¶æ®µï¼Œå›è°ƒ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJAutoProxyRegistrar</span><span class="token punctuation">#</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ¥æ³¨å†Œbean
 *
 * 3. ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AopConfigUtils</span><span class="token punctuation">#</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ³¨å†Œbean
 *      å°±æ˜¯æ³¨å†Œè¿™ä¸ª <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span></span><span class="token punctuation">}</span>
 *
 * 4. å°†æ³¨è§£çš„å±æ€§å€¼ï¼Œè®¾ç½®åˆ°BeanDefinitionä¸­ï¼Œå½“beanè¿›è¡Œå±æ€§å¡«å……çš„è®¾ç½®ä¼šè®¾ç½®åˆ°beançš„å±æ€§å±æ€§ä¸­ã€‚
 *      proxyTargetClassï¼Œå†³å®šæ˜¯å¦ä½¿ç”¨cglibä»£ç† -&gt; <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AopConfigUtils</span><span class="token punctuation">#</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *      exposeProxyï¼Œåœ¨æ‰§è¡Œ MethodInterceptoræ—¶æ˜¯å¦å°†ä»£ç†å¯¹è±¡å­˜åˆ°ThreadLocalä¸­ -&gt; <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AopConfigUtils</span><span class="token punctuation">#</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AspectJAutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * è¿™ä¸ªå‚æ•°æ˜¯ç”¨æ¥çº¦æŸæ˜¯cglibä»£ç†æˆ–è€…jdkä»£ç†çš„ï¼Œä½†ä¸æ˜¯å¼ºæ‰§çº¦æŸï¼Œä¼šä¼˜å…ˆåˆ¤æ–­æ˜¯å¦ç¬¦åˆcglibä»£ç†çš„æ¡ä»¶ã€‚
     * trueï¼šå»ºè®®cglibä»£ç†ã€‚
     * falseï¼šå»ºè®®jdkä»£ç†ã€‚
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAopProxyFactory</span><span class="token punctuation">#</span><span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed
     * to standard Java interface-based proxies. The default is <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token boolean">false</span></span></span><span class="token punctuation">}</span>.
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åœ¨æ‰§è¡Œ ä»£ç†å¯¹è±¡çš„æ–¹æ³•å‰ï¼Œæ˜¯å¦å°†ä»£ç†å¯¹è±¡ç¼“å­˜åˆ° ThreadLocal ä¸­ã€‚
     * trueï¼šç¼“å­˜
     * falseï¼šä¸ç¼“å­˜
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">.</span><span class="token class-name">DynamicAdvisedInterceptor</span><span class="token punctuation">#</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">#</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AopContext</span><span class="token punctuation">#</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * Indicate that the proxy should be exposed by the AOP framework as a <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">ThreadLocal</span></span></span><span class="token punctuation">}</span>
     * for retrieval via the <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">AopContext</span></span><span class="token punctuation">}</span> class.
     * Off by default, i.e. no guarantees that <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token class-name">AopContext</span></span></span><span class="token punctuation">}</span> access will work.
     *
     * <span class="token keyword">@since</span> 4.3.1
     */</span>
    <span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="annotationawareaspectjautoproxycreatorçš„å®ä¾‹åŒ–" tabindex="-1"><a class="header-anchor" href="#annotationawareaspectjautoproxycreatorçš„å®ä¾‹åŒ–" aria-hidden="true">#</a> AnnotationAwareAspectJAutoProxyCreatorçš„å®ä¾‹åŒ–</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 * AnnotationAwareAspectJAutoProxyCreator å®ç°äº† SmartInstantiationAwareBeanPostProcessorã€BeanFactoryAware
 *
 * 1. åˆ·æ–°IOCå®¹å™¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">#</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * 2. æ³¨å†Œ BeanPostProcessor <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">#</span><span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *     æ‰€ä»¥ è¿™é‡Œä¼š åˆ›å»º AnnotationAwareAspectJAutoProxyCreator
 *
 * 3. åˆ›å»º AnnotationAwareAspectJAutoProxyCreator <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanFactory</span><span class="token punctuation">#</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *
 * 4. åœ¨å®ä¾‹åŒ–å,åˆå§‹åŒ–å‰ä¼šå›è°ƒ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanFactoryAware</span><span class="token punctuation">#</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *
 * 5. ä¹Ÿå°±æ˜¯ä¼šå›è°ƒ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *      å°±æ˜¯å¯¹å±æ€§èµ‹å€¼è¿›è¡Œåˆå§‹åŒ–ï¼Œæ–¹æ³•ä½“ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">initBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *          <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">initBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *              // è¿™æ˜¯ç”¨æ¥æ£€ç´¢ BeanFactory ä¸­æ‰€æœ‰ Advisor ç±»å‹çš„bean
 *              this.advisorRetrievalHelper = new BeanFactoryAdvisorRetrievalHelperAdapter(beanFactory);
 *
 *          // è¿™æ˜¯ç”¨æ¥å°† @Aspect æ ‡æ³¨çš„beanï¼Œå°†æ ‡æ³¨äº†[@Pointcut,@Around,@Before,@After,@AfterReturning,@AfterThrowing]çš„æ–¹æ³• è§£ææˆ Advisor
 *          this.aspectJAdvisorFactory = new ReflectiveAspectJAdvisorFactory(beanFactory);
 *
 *          // ä¾èµ– aspectJAdvisorFactoryã€‚éå†BeanFactoryæ‰€æœ‰çš„beanï¼Œç„¶åä½¿ç”¨ aspectJAdvisorFactory æ¥ç”Ÿæˆ Advisorï¼Œå°†ç»“æœç¼“å­˜
 *          this.aspectJAdvisorsBuilder = new BeanFactoryAspectJAdvisorsBuilderAdapter(beanFactory, this.aspectJAdvisorFactory);
 * */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="annotationawareaspectjautoproxycreator-åç½®å¤„ç†å™¨å›è°ƒ" tabindex="-1"><a class="header-anchor" href="#annotationawareaspectjautoproxycreator-åç½®å¤„ç†å™¨å›è°ƒ" aria-hidden="true">#</a> AnnotationAwareAspectJAutoProxyCreator åç½®å¤„ç†å™¨å›è°ƒ</h3><h4 id="å®ä¾‹åŒ–å‰é˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹åŒ–å‰é˜¶æ®µ" aria-hidden="true">#</a> å®ä¾‹åŒ–å‰é˜¶æ®µ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * AnnotationAwareAspectJAutoProxyCreator æ²¡æœ‰é‡å†™æ–¹æ³•ï¼Œæ‰€ä»¥æ‰§è¡Œçˆ¶ç±»çš„<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *
 * 1. beanNameæ˜¯ç©º æˆ–è€… targetSourcedBeans(å·²AOPä»£ç†å¯¹è±¡é›†åˆ)å±æ€§æ²¡æœ‰è®°å½•è¿‡è¯¥beanName
 *      - advisedBeans(å¢å¼ºbeané›†åˆ) ä¸­è®°å½•äº†ï¼Œå°± return null
 *      - æ˜¯åŸºç¡€bean <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æˆ–è€… åº”è¯¥è·³è¿‡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJAwareAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *          è®°å½•ä¸€ä¸‹ `this.advisedBeans.put(cacheKey, Boolean.FALSE);`
 *          return null
 *
 *  2. ç”Ÿæˆ TargetSource <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getCustomTargetSource</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *      éœ€è¦è®¾ç½® TargetSourceCreator å±æ€§ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">setCustomTargetSourceCreators</span><span class="token punctuation">(</span><span class="token class-name">TargetSourceCreator</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ‰ä¼šæœ‰ç”¨ï¼Œ
 *      ä½†æ˜¯çœ‹æºç æ²¡æœ‰ç”¨åˆ°ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•ä¸€ç›´è¿”å›null
 *
 *  3. TargetSource ä¸ä¸ºnull
 *      - è®°å½•targetSourcedBeans(è¢«ä»£ç†å¯¹è±¡é›†åˆ) `this.targetSourcedBeans.add(beanName);`
 *      - å¾—åˆ°è¿™ä¸ªbeanåŒ¹é…çš„adviceå’Œadvisoré›†åˆ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TargetSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *      - åˆ›å»ºä»£ç†å¯¹è±¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">TargetSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *      - è®°å½•AOPä»£ç†å¯¹è±¡  `this.proxyTypes.put(cacheKey, proxy.getClass());`
 *      - è¿”å›ç”Ÿæˆçš„ä»£ç†å¯¹è±¡
 * */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æå‰aopé˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#æå‰aopé˜¶æ®µ" aria-hidden="true">#</a> æå‰AOPé˜¶æ®µ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 *
 *  AnnotationAwareAspectJAutoProxyCreator æ²¡æœ‰é‡å†™æ–¹æ³•ï¼Œæ‰€ä»¥æ‰§è¡Œçˆ¶ç±»çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *
 *  1. è®°å½•æå‰ä»£ç†å¼•ç”¨é›†åˆ `this.earlyProxyReferences.put(cacheKey, bean);`
 *  2. éœ€è¦å°±åˆ›å»ºä»£ç†å¯¹è±¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆå§‹åŒ–åé˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–åé˜¶æ®µ" aria-hidden="true">#</a> åˆå§‹åŒ–åé˜¶æ®µ</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * AnnotationAwareAspectJAutoProxyCreator æ²¡æœ‰é‡å†™æ–¹æ³•ï¼Œæ‰€ä»¥æ‰§è¡Œçˆ¶ç±»çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 *
 * 1. earlyProxyReferences(æå‰ä»£ç†å¼•ç”¨é›†åˆ) ä¸­æ²¡æœ‰è¿™ä¸ª bean
 * 2. éœ€è¦å°±åˆ›å»ºä»£ç†å¯¹è±¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * */</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="aopåˆ‡é¢çš„è§£æ" tabindex="-1"><a class="header-anchor" href="#aopåˆ‡é¢çš„è§£æ" aria-hidden="true">#</a> AOPåˆ‡é¢çš„è§£æ</h2><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/12/19/A9JhUK.tif" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="å®ä¾‹åŒ–å‰åç½®" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹åŒ–å‰åç½®" aria-hidden="true">#</a> å®ä¾‹åŒ–å‰åç½®</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
    <span class="token doc-comment comment">/**
     * åœ¨Beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œå¦‚æœè¿”å›å€¼ä¸æ˜¯nullï¼Œ
     * ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">#</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * ç„¶åç›´æ¥è¿”å›beanï¼Œä¸ä¼šè¿›è¡Œåç»­beanç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œ
     *
     * <span class="token keyword">@param</span> <span class="token parameter">beanClass</span> è¦å®ä¾‹åŒ–çš„ Bean çš„ç±»
     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span>  Bean çš„åç§°
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–key</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// beanNameæ˜¯ç©º æˆ–è€… targetSourcedBeans(å·²AOPä»£ç†å¯¹è±¡é›†åˆ)ä¸­æ²¡æœ‰è®°å½•beanName</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// advisedBeans(å¢å¼ºbeané›†åˆ) ä¸­è®°å½•äº†ï¼Œå°±è¿”å›null</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token doc-comment comment">/**
             * æ˜¯åŸºç¡€è®¾ç½®ç±» æˆ–è€… åº”è¯¥è·³è¿‡ å°±è¿”å›null
             *
             * isInfrastructureClassï¼šæ˜¯è¿™äº› Adviceã€Pointcutã€Advisorã€AopInfrastructureBean ç±»å‹çš„å­ç±»
             * shouldSkip <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AutoProxyUtils</span><span class="token punctuation">#</span><span class="token function">isOriginalInstance</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *  beanNameæ˜¯ç©º æˆ–è€… beanNameçš„é•¿åº¦ä¸ç­‰äº ç±»å…¨å+.ORIGINAL  ---&gt; false
             *  ç±»å…¨åå¼€å¤´ ä¸” ç»“å°¾æ˜¯.ORIGINAL    ---&gt; true
             *
             *  ä»€ä¹ˆæƒ…å†µä¼šè®¾ç½®è¿™ä¸ª .ORIGINAL ???
             * */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è®°å½•åœ¨ advisedBeans(å¢å¼ºbeané›†åˆ) ä¸­</span>
                <span class="token doc-comment comment">/**
                 * false è¡¨ç¤ºè¿™ä¸ªbean æ˜¯ advisor ç›¸å…³çš„bean
                 * */</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token field">customTargetSourceCreators</span></span><span class="token punctuation">}</span> å±æ€§ä¸ä¸ºnullï¼Œå°±éå† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSourceCreator</span></span><span class="token punctuation">}</span>
         * æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSourceCreator</span><span class="token punctuation">#</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> åˆ›å»º TargetSourceï¼Œè¿”å›å€¼æ˜¯nullå°±ç›´æ¥returnã€‚
         *
         * åœ¨è¿™é‡Œä½¿ç”¨ TargetSourceCreator æ¥åˆ›å»ºä»£ç†å¯¹è±¡ä¹Ÿå¯ä»¥å®ç°@Lazyçš„æ•ˆæœï¼Œå³å»¶æ—¶beançš„åˆ›å»ºï¼Œ
         * å› ä¸ºè¿™é‡Œç›´æ¥è¿”å›äº† ä»£ç†å¯¹è±¡ï¼Œè€Œæ‰§è¡Œä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œæ–¹æ³•æ—¶ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSource</span><span class="token punctuation">#</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ‹¿åˆ°è¢«ä»£ç†å¯¹è±¡,ä¸€èˆ¬åœ¨è¿™ä¸ªæ–¹æ³•å°±æ˜¯ getBean ä»è€Œ
         * å¯ä»¥å®ç°å»¶æ—¶beançš„å®ä¾‹åŒ–
         *
         * æ³¨ï¼šTargetSource å°è£…äº†è¢«ä»£ç†å¯¹è±¡ï¼Œç„¶åaopæ˜¯å¯¹TargetSourceè¿›è¡Œä»£ç†
         * */</span>
        <span class="token comment">// å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„ TargetSourceï¼Œè¯·åœ¨æ­¤å¤„åˆ›å»ºä»£ç†ã€‚</span>
		<span class="token comment">// ç¦æ­¢å¯¹ç›®æ ‡ Bean è¿›è¡Œä¸å¿…è¦çš„ç¼ºçœå®ä¾‹åŒ–ï¼šTargetSource å°†ä»¥è‡ªå®šä¹‰æ–¹å¼å¤„ç†ç›®æ ‡å®ä¾‹ã€‚</span>
        <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token function">getCustomTargetSource</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æœ‰beanName</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è®°å½•åœ¨ targetSourcedBeans(è¢«ä»£ç†å¯¹è±¡é›†åˆ) ä¸­</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TargetSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * 1. ä¼šå°†å®¹å™¨ä¸­æ‰€æœ‰çš„ Advisor éƒ½è¿›è¡Œå®ä¾‹åŒ–ï¼Œç¼“å­˜èµ·æ¥ã€‚
             * 2. æŒ‰ç…§ ç±»åŒ¹é… æˆ–è€… (ç±»åŒ¹é…+AspectJè¡¨è¾¾å¼åŒ¹é…)
             * 3. è¿”å›æ»¡è¶³æ¡ä»¶çš„ Advisor
             * */</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * åˆ›å»ºä»£ç†å¯¹è±¡
             * */</span>
            <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œè¿”å›å€¼ä¸æ˜¯nullï¼Œæ‰€ä»¥ä¼šä¸­æ–­åç»­Beançš„å£°æ˜å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯åé¢çš„å¡«å……beanã€åˆå§‹åŒ–ç­‰ç­‰æ“ä½œéƒ½ä¸ä¼šæ‰§è¡Œäº†</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æ˜¯åŸºç¡€ç±»å‹" tabindex="-1"><a class="header-anchor" href="#æ˜¯åŸºç¡€ç±»å‹" aria-hidden="true">#</a> æ˜¯åŸºç¡€ç±»å‹</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Previously we setProxyTargetClass(true) in the constructor, but that has too</span>
    <span class="token comment">// broad an impact. Instead we now override isInfrastructureClass to avoid proxying</span>
    <span class="token comment">// aspects. I&#39;m not entirely happy with that as there is no good reason not</span>
    <span class="token comment">// to advise aspects, except that it causes advice invocation to go through a</span>
    <span class="token comment">// proxy, and if the aspect implements e.g the Ordered interface it will be</span>
    <span class="token comment">// proxied by that interface and fail at runtime as the advice method is not</span>
    <span class="token comment">// defined on the interface. We could potentially relax the restriction about</span>
    <span class="token comment">// not advising aspects in the future.</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory <span class="token operator">!=</span> <span class="token keyword">null</span>
            <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory<span class="token punctuation">.</span><span class="token function">isAspect</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> retVal <span class="token operator">=</span> <span class="token class-name">Advice</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Pointcut</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token class-name">AopInfrastructureBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">&amp;&amp;</span> logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Did not attempt to auto-proxy infrastructure class [&quot;</span> <span class="token operator">+</span> beanClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åº”è¯¥è·³è¿‡" tabindex="-1"><a class="header-anchor" href="#åº”è¯¥è·³è¿‡" aria-hidden="true">#</a> åº”è¯¥è·³è¿‡</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// æŸ¥æ‰¾å¹¶åˆ›å»ºå®¹å™¨ä¸­æ‰€æœ‰Advisorç±»å‹çš„BeanåŒæ—¶æ‹¿åˆ°BeanFactoryä¸­æ ‡æ³¨äº†@Aspect çš„bean</span>
      <span class="token comment">// å°†æ ‡æ³¨äº† @Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å½“å‰beanNameæ˜¯advisorä¸­çš„ä¸€ä¸ª</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">AspectJPointcutAdvisor</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AspectJPointcutAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æŸ¥æ‰¾æ‰€æœ‰advisor" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾æ‰€æœ‰advisor" aria-hidden="true">#</a> æŸ¥æ‰¾æ‰€æœ‰Advisor</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
	 * æŸ¥æ‰¾å®¹å™¨ä¸­advisorç±»å‹çš„beanï¼Œ
	 * åŒæ—¶å°†BeanFactorä¸­æ ‡æ³¨äº†@Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing
	 * çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
	 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™ä¸ªé€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯æ‹¿åˆ°å®¹å™¨ä¸­ Advisor ç±»å‹çš„beanï¼Œç„¶ååˆ›å»ºï¼Œç„¶åæŠŠè¿™äº›beanè¿”å›</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Build Advisors for all AspectJ aspects in the bean factory.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ‹¿åˆ°BeanFactoryä¸­æ ‡æ³¨äº†@Aspect çš„bean
         * å°†æ ‡æ³¨äº† @Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
         * */</span>
        advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder<span class="token punctuation">.</span><span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰advisorç±»å‹çš„bean" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰advisorç±»å‹çš„bean" aria-hidden="true">#</a> æŸ¥æ‰¾å®¹å™¨ä¸­æ‰€æœ‰Advisorç±»å‹çš„Bean</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractAdvisorAutoProxyCreator</span>ï¼š
  
<span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorRetrievalHelper <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;No BeanFactoryAdvisorRetrievalHelper available&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åœ¨beanå·¥å‚ä¸­æ‰¾åˆ°æ‰€æœ‰çš„advisorç±»å‹çš„beanå¹¶åˆ›å»º</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorRetrievalHelper<span class="token punctuation">.</span><span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token class-name">BeanFactoryAdvisorRetrievalHelper</span>ï¼š
    <span class="token doc-comment comment">/**
     * åœ¨å½“å‰ bean å·¥å‚ä¸­æŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ Advisor beanï¼Œ
     * å¿½ç•¥ FactoryBeans å¹¶æ’é™¤å½“å‰æ­£åœ¨åˆ›å»ºçš„ beanã€‚
     *
     * <span class="token keyword">@return</span> the list of <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span></span><span class="token class-name">Advisor</span></span><span class="token punctuation">}</span> beans
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">isEligibleBean</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Determine list of advisor bean names, if not cached already.</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisorNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å°±æ˜¯ä» BeanFactory ä¸­æ‰¾å‡º Advisor ç±»å‹çš„beanï¼Œè¿™äº›beanä¸ä¼šæ‰§è¡Œåˆå§‹åŒ–ï¼Œè€Œæ˜¯ç›´æ¥ä»BeanDefinitionMapä¸­æ‰¾åˆ°ç„¶åè¿”å›è€Œå·²
             * */</span>
            <span class="token comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
            <span class="token comment">// uninitialized to let the auto-proxy creator apply to them!</span>
            advisorNames <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®°å½•èµ·æ¥ï¼Œæé«˜åç»­æ‰§è¡Œæ•ˆç‡</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames <span class="token operator">=</span> advisorNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æå‰åˆ›å»ºæ‰€æœ‰çš„ advisorNamesï¼Œè®°å½•åœ¨advisorsï¼Œç„¶åè¿”å›advisors</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> name <span class="token operator">:</span> advisorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * Spring AOP æ²¡æœ‰é‡å†™ä¹Ÿå°±æ˜¯è¿”å› ture AnnotationAwareAspectJAutoProxyCreator
             *
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">.</span><span class="token class-name">BeanFactoryAdvisorRetrievalHelperAdapter</span><span class="token punctuation">#</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">isEligibleAdvisorBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *
             *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">InfrastructureAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">isEligibleAdvisorBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             *      @EnableTransactionManagement ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚é€»è¾‘å°±æ˜¯ BeanDefinitionMapä¸­æœ‰BeanDefinition &amp;&amp; Roleå¾—æ˜¯è¿™ä¸ªå€¼ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanDefinition</span><span class="token punctuation">#</span><span class="token field">ROLE_INFRASTRUCTURE</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·³è¿‡çœŸæ­£åˆ›å»ºçš„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping currently created advisor &#39;&quot;</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment">// åˆ›å»ºbean</span>
                        advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">Advisor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Throwable</span> rootCause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getMostSpecificCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootCause <span class="token keyword">instanceof</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">BeanCreationException</span> bce <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span><span class="token punctuation">)</span> rootCause<span class="token punctuation">;</span>
                            <span class="token class-name">String</span> bceBeanName <span class="token operator">=</span> bce<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>bceBeanName <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>bceBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping advisor &#39;&quot;</span> <span class="token operator">+</span> name
                                            <span class="token operator">+</span> <span class="token string">&quot;&#39; with dependency on currently created bean: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">// Ignore: indicates a reference back to the bean we&#39;re trying to advise.</span>
                                <span class="token comment">// We want to find advisors other than the currently created bean itself.</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="è§£æ-aspect-çš„bean" tabindex="-1"><a class="header-anchor" href="#è§£æ-aspect-çš„bean" aria-hidden="true">#</a> è§£æ@Aspect çš„Bean</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BeanFactoryAspectJAdvisorsBuilder</span>ï¼š 
  
   <span class="token doc-comment comment">/**
     * æ‹¿åˆ°BeanFactoryä¸­æ ‡æ³¨äº†@Aspect çš„bean
     * å°†æ ‡æ³¨äº† @Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * Look for AspectJ-annotated aspect beans in the current bean factory,
     * and return to a list of Spring AOP Advisors representing them.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Creates a Spring Advisor for each AspectJ advice method.
     *
     * <span class="token keyword">@return</span> the list of <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span></span><span class="token class-name">Advisor</span></span><span class="token punctuation">}</span> beans
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">isEligibleBean</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> aspectNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames<span class="token punctuation">;</span>
      
        <span class="token comment">//ç¼“å­˜å­—æ®µaspectNamesæ²¡æœ‰å€¼ æ³¨æ„å®ä¾‹åŒ–ç¬¬ä¸€ä¸ªå•å®ä¾‹beançš„æ—¶å€™å°±ä¼šè§¦å‘è§£æåˆ‡é¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                aspectNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    aspectNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanNames <span class="token operator">=</span> <span class="token class-name">BeanFactoryUtils</span><span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token doc-comment comment">/**
                         * å°±æ˜¯ beanName æ˜¯å¦ç¬¦åˆæ­£åˆ™åŒ¹é…è§„åˆ™ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">isEligibleAspectBean</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                         * ä¼šåˆ¤æ–­è¿™ä¸ªå±æ€§ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareAspectJAutoProxyCreator</span><span class="token punctuation">#</span><span class="token field">includePatterns</span></span><span class="token punctuation">}</span> æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºå°±ç›´æ¥è¿”å›trueï¼Œä¸ä¸ºç©ºå°±éå†å±æ€§ è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼ŒåŒ¹é…äº†æ‰è¿”å›true
                         *
                         * å±æ€§é»˜è®¤å€¼å°±æ˜¯nullï¼Œæ‰€æœ‰ è¿™é‡Œä¸€ç›´è¿”å›true
                         * */</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      
                        <span class="token comment">// We must be careful not to instantiate beans eagerly as in this case they</span>
                        <span class="token comment">// would be cached by the Spring container but would not have been weaved.</span>
                        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                      
                        <span class="token comment">// è¿›è¡Œ Aspect åˆ¤æ–­</span>
                        <span class="token doc-comment comment">/**
                         * advisorFactory æ˜¯ ReflectiveAspectJAdvisorFactory
                         * æœ‰ @Aspect çš„ç±» å°±æ˜¯ true
                         * */</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">isAspect</span><span class="token punctuation">(</span>beanType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            aspectNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                          
                            <span class="token class-name">AspectMetadata</span> amd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectMetadata</span><span class="token punctuation">(</span>beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// å¦‚æœæ˜¯ @Aspect(&quot;&quot;) è¿™æ ·å­ä½¿ç”¨ï¼Œå°±æ»¡è¶³if</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>amd<span class="token punctuation">.</span><span class="token function">getAjType</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">getPerClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">getKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">PerClauseKind</span><span class="token punctuation">.</span><span class="token constant">SINGLETON</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// è¿™ä¸ªä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼Œåé¢æ’åºAdvisorçš„æ—¶å€™ æ˜¯æ ¹æ®@Aspectè¿™ä¸ªåˆ‡é¢ç±»æ¥æ’åºçš„</span>
                                <span class="token class-name">MetadataAwareAspectInstanceFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryAspectInstanceFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token doc-comment comment">/**
                                 * å¤„ç†æœ‰ @Aspect çš„ç±»
                                 * ç„¶åå°†ç±»é‡Œé¢ @Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
                                 * å¦å¤–è¿˜ä¼šæ ¹ æ®éœ€è¦ æ·»åŠ  SyntheticInstantiationAdvisorã€DeclareParentsAdvisor çš„ advisor
                                 * */</span>
                                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> classAdvisors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment">// ç¼“å­˜èµ·æ¥ã€‚è¿™ä¸ªæ˜¯å¯ä»¥ç›´æ¥è¿”å›çš„</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>advisorsCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> classAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token comment">// ç¼“å­˜èµ·æ¥ã€‚è¿™ä¸ªæ˜¯åé¢è¿˜å¾—é‡æ–°åˆ›å»º  `this.advisorFactory.getAdvisors(factory))`</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>classAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment">// Per target or per this.</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Bean with name &#39;&quot;</span> <span class="token operator">+</span> beanName
                                            <span class="token operator">+</span> <span class="token string">&quot;&#39; is a singleton, but aspect instantiation model is not singleton&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">// è¿™ä¸ªä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼Œåé¢æ’åºAdvisorçš„æ—¶å€™ æ˜¯æ ¹æ®@Aspectè¿™ä¸ªåˆ‡é¢ç±»æ¥æ’åºçš„</span>
                                <span class="token class-name">MetadataAwareAspectInstanceFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrototypeAspectInstanceFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames <span class="token operator">=</span> aspectNames<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> aspectName <span class="token operator">:</span> aspectNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> cachedAdvisors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedAdvisors <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cachedAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">MetadataAwareAspectInstanceFactory</span> factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>




  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAspect</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *  æœ‰@Aspect æ³¨è§£ ä¸”ä¸æ˜¯ AspectJ language çš„è¯­æ³•
         *
         *  è¯´äººè¯å°±æ˜¯ æœ‰@Aspectæ³¨è§£å°±è¡Œ
         * */</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token function">hasAspectAnnotation</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compiledByAjc</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



<span class="token class-name">ReflectiveAspectJAdvisorFactory</span>ï¼š 
    <span class="token doc-comment comment">/**
     * å¤„ç†æœ‰ @Aspect çš„ç±»
     * ç„¶åå°†ç±»é‡Œé¢ Aroundã€Beforeã€Afterã€AfterReturningã€AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
     * å¦å¤–è¿˜ä¼šæ ¹æ®éœ€è¦ æ·»åŠ  SyntheticInstantiationAdvisorã€DeclareParentsAdvisor çš„ advisor
     *
     * <span class="token keyword">@param</span> <span class="token parameter">aspectInstanceFactory</span> the aspect instance factory
     *                              (not the aspect instance itself in order to avoid eager instantiation)
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAdvisors</span><span class="token punctuation">(</span><span class="token class-name">MetadataAwareAspectInstanceFactory</span> aspectInstanceFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * @Aspect
         * class A<span class="token punctuation">{</span><span class="token punctuation">}</span>
         * @Component
         * class B extends A<span class="token punctuation">{</span><span class="token punctuation">}</span>
         *
         * aspectClass æ˜¯ A.class
         * aspectName æ˜¯ b
         * */</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aspectClass <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> aspectName <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAspectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ ¡éªŒä¸€ä¸‹ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç±»å¾—æœ‰ @Aspect æ³¨è§£</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>aspectClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è®°å½•å½“å‰åˆ‡é¢ç±»çš„å…ƒæ•°æ®ã€‚åé¢æ’åºAdvisorçš„æ—¶å€™ æ˜¯æ ¹æ®@Aspectè¿™ä¸ªåˆ‡é¢ç±»æ¥æ’åºçš„</span>
        <span class="token comment">// We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span>
        <span class="token comment">// so that it will only instantiate once.</span>
        <span class="token class-name">MetadataAwareAspectInstanceFactory</span> lazySingletonAspectInstanceFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingletonAspectInstanceFactoryDecorator</span><span class="token punctuation">(</span>aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ‹¿åˆ° aspectClass ä¸­ é™¤äº† @Pointcut æ³¨è§£çš„æ–¹æ³•ï¼ŒæŒ‰ç…§ Aroundã€Beforeã€Afterã€AfterReturningã€AfterThrowing è¿›è¡Œæ’åº
         * */</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> <span class="token function">getAdvisorMethods</span><span class="token punctuation">(</span>aspectClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * æ ‡æ³¨äº† Pointcutã€Aroundã€Beforeã€Afterã€AfterReturningã€AfterThrowing æ³¨è§£çš„æ–¹æ³•ä¸ä¼šè¿”å› null
             * ä½†æ˜¯å› ä¸º éå†çš„method æ˜¯ä¸åŒ…å« @Pointcut çš„ï¼Œæ‰€ä»¥åªæ˜¯å°† Aroundã€Beforeã€Afterã€AfterReturningã€AfterThrowing è§£ææˆ Advisor
             *
             * è¿”å›çš„æ˜¯æ˜¯è¿™ä¸ªå®ç°ç±» InstantiationModelAwarePointcutAdvisorImpl
             * */</span>
            <span class="token comment">// Prior to Spring Framework 5.2.7, advisors.size() was supplied as the declarationOrderInAspect</span>
            <span class="token comment">// to getAdvisor(...) to represent the &quot;current position&quot; in the declared methods list.</span>
            <span class="token comment">// However, since Java 7 the &quot;current position&quot; is not valid since the JDK no longer</span>
            <span class="token comment">// returns declared methods in the order in which they are declared in the source code.</span>
            <span class="token comment">// Thus, we now hard code the declarationOrderInAspect to 0 for all advice methods</span>
            <span class="token comment">// discovered via reflection in order to support reliable advice ordering across JVM launches.</span>
            <span class="token comment">// Specifically, a value of 0 aligns with the default value used in</span>
            <span class="token comment">// AspectJPrecedenceComparator.getAspectDeclarationOrder(Advisor).</span>
            <span class="token class-name">Advisor</span> advisor <span class="token operator">=</span> <span class="token function">getAdvisor</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> lazySingletonAspectInstanceFactory<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœæ˜¯æ¯ä¸ªç›®æ ‡æ–¹é¢ï¼Œåˆ™å‘å‡ºè™šæ‹Ÿå®ä¾‹åŒ–æ–¹é¢ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lazySingletonAspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">isLazilyInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// TODOHAITAO: 2022/10/3 è¿™æ˜¯å¹²å•¥ç”¨çš„ï¼Œä½†æ˜¯ @Aspect æ˜¯ä¸ä¼šæ»¡è¶³è¿™ä¸ªæ¡ä»¶çš„</span>
            <span class="token class-name">Advisor</span> instantiationAdvisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyntheticInstantiationAdvisor</span><span class="token punctuation">(</span>lazySingletonAspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> instantiationAdvisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æŸ¥æ‰¾å¼•å…¥çš„å­—æ®µã€‚</span>
        <span class="token comment">// Find introduction fields.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> field <span class="token operator">:</span> aspectClass<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å°±æ˜¯å­—æ®µä¸Šæœ‰è¿™ä¸ª @DeclareParents(value=&quot;&quot;,defaultImpl=A.class)  ä¼šè§£ææˆ DeclareParentsAdvisor
             * */</span>
            <span class="token class-name">Advisor</span> advisor <span class="token operator">=</span> <span class="token function">getDeclareParentsAdvisor</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAdvisorMethods</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aspectClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Method</span><span class="token punctuation">&gt;</span></span> methods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * adviceMethodFilter é€»è¾‘ï¼šmethod æ˜¯ classä¸­å®šä¹‰çš„ ä¸” method æ²¡æœ‰ @Pointcut æ³¨è§£ å°±è¿”å›true
         *
         * è¯´ç™½äº†å°±æ˜¯å°† ç±»é‡Œé¢é™¤äº†@Pointcut æ ‡æ³¨çš„æ–¹æ³•æ·»åŠ åˆ° methods é›†åˆä¸­(ä¼šé€’å½’å¤„ç†ç±»çš„çˆ¶ç±»å’Œæ¥å£é‡Œé¢çš„method)
         * */</span>
        <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">doWithMethods</span><span class="token punctuation">(</span>aspectClass<span class="token punctuation">,</span> methods<span class="token operator">::</span><span class="token function">add</span><span class="token punctuation">,</span> adviceMethodFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å‡åºæ’åºï¼šå…ˆæŒ‰ç…§ method ä¸Šé¢çš„æ³¨è§£æ’åº(Aroundã€Beforeã€Afterã€AfterReturningã€AfterThrowing)ï¼Œå¦‚æœç›¸åŒåœ¨æŒ‰ç…§ methodName æ’åºã€‚
             * æ³¨ï¼šæ²¡æœ‰è¿™äº›æ³¨è§£çš„æ–¹æ³•ï¼Œçš„æ’åºæ˜¯æœ€å¤§çš„ï¼Œæ‰€ä»¥ä¼šåœ¨æœ€åé¢
             * */</span>
            methods<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>adviceMethodComparator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> methods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * method æ˜¯ classä¸­å®šä¹‰çš„ ä¸” method æ²¡æœ‰ @Pointcut æ³¨è§£ å°±è¿”å›true
     */</span>
    <span class="token comment">// Exclude @Pointcut methods</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">MethodFilter</span> adviceMethodFilter <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token constant">USER_DECLARED_METHODS</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>method <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>
            <span class="token class-name">AnnotationUtils</span><span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token class-name">Pointcut</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Advisor</span> <span class="token function">getAdvisor</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateAdviceMethod<span class="token punctuation">,</span> <span class="token class-name">MetadataAwareAspectInstanceFactory</span> aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">int</span> declarationOrderInAspect<span class="token punctuation">,</span> <span class="token class-name">String</span> aspectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// æ ¡éªŒä¸€ä¸‹ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç±»å¾—æœ‰ @Aspect æ³¨è§£</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * æœ‰ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">#</span><span class="token field">ASPECTJ_ANNOTATION_CLASSES</span></span><span class="token punctuation">}</span> æ³¨è§£æ‰ä¸ä¼šè¿”å› null
         * */</span>
        <span class="token class-name">AspectJExpressionPointcut</span> expressionPointcut <span class="token operator">=</span> <span class="token function">getPointcut</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionPointcut <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstantiationModelAwarePointcutAdvisorImpl</span><span class="token punctuation">(</span>expressionPointcut<span class="token punctuation">,</span> candidateAdviceMethod<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">,</span> declarationOrderInAspect<span class="token punctuation">,</span> aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å°±æ˜¯æ‹¿åˆ°è¿™äº›æ³¨è§£ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">#</span><span class="token field">ASPECTJ_ANNOTATION_CLASSES</span></span><span class="token punctuation">}</span> å¯¹åº”çš„å±æ€§å€¼
     * è£…é¥°æˆ AspectJExpressionPointcut å¯¹è±¡è¿”å›
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>
     * æ²¡æœ‰ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">#</span><span class="token field">ASPECTJ_ANNOTATION_CLASSES</span></span><span class="token punctuation">}</span> ç›´æ¥ å°±è¿”å›null
     *
     * <span class="token keyword">@param</span> <span class="token parameter">candidateAdviceMethod</span>
     * <span class="token keyword">@param</span> <span class="token parameter">candidateAspectClass</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token class-name">AspectJExpressionPointcut</span> <span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateAdviceMethod<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidateAspectClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AspectJAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aspectJAnnotation <span class="token operator">=</span> <span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">.</span><span class="token function">findAspectJAnnotationOnMethod</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectJAnnotation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">AspectJExpressionPointcut</span> ajexp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">(</span>candidateAspectClass<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ajexp<span class="token punctuation">.</span><span class="token function">setExpression</span><span class="token punctuation">(</span>aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getPointcutExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ajexp<span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ajexp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">AspectJAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAspectJAnnotationOnMethod</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">:</span> <span class="token constant">ASPECTJ_ANNOTATION_CLASSES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AspectJAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> foundAnnotation <span class="token operator">=</span> <span class="token function">findAnnotation</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Annotation</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>foundAnnotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> foundAnnotation<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">ASPECTJ_ANNOTATION_CLASSES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Pointcut</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Around</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Before</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">After</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AfterReturning</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">AfterThrowing</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">;</span>



 <span class="token keyword">public</span> <span class="token class-name">InstantiationModelAwarePointcutAdvisorImpl</span><span class="token punctuation">(</span><span class="token class-name">AspectJExpressionPointcut</span> declaredPointcut<span class="token punctuation">,</span>
                                                      <span class="token class-name">Method</span> aspectJAdviceMethod<span class="token punctuation">,</span> <span class="token class-name">AspectJAdvisorFactory</span> aspectJAdvisorFactory<span class="token punctuation">,</span>
                                                      <span class="token class-name">MetadataAwareAspectInstanceFactory</span> aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">int</span> declarationOrder<span class="token punctuation">,</span> <span class="token class-name">String</span> aspectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// å½“å‰çš„åˆ‡ç‚¹è¡¨è¾¾å¼</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>declaredPointcut <span class="token operator">=</span> declaredPointcut<span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢çš„classå¯¹è±¡</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>declaringClass <span class="token operator">=</span> aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢æ–¹æ³•çš„åç§°</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>methodName <span class="token operator">=</span> aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢æ–¹æ³•çš„å‚æ•°ç±»å‹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>parameterTypes <span class="token operator">=</span> aspectJAdviceMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢æ–¹æ³•å¯¹è±¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod <span class="token operator">=</span> aspectJAdviceMethod<span class="token punctuation">;</span>
		<span class="token comment">// aspectjçš„é€šçŸ¥å·¥å‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory <span class="token operator">=</span> aspectJAdvisorFactory<span class="token punctuation">;</span>
		<span class="token comment">// aspectjåˆ‡é¢å®ä¾‹å·¥å‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspectInstanceFactory <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢çš„é¡ºåº</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>declarationOrder <span class="token operator">=</span> declarationOrder<span class="token punctuation">;</span>
		<span class="token comment">// åˆ‡é¢çš„åç§°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspectName <span class="token operator">=</span> aspectName<span class="token punctuation">;</span>

		<span class="token comment">// åˆ¤æ–­å½“å‰çš„åˆ‡é¢å¯¹è±¡æ˜¯å¦éœ€è¦å»¶æ—¶åŠ è½½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLazilyInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Static part of the pointcut is a lazy type.</span>
            <span class="token class-name">Pointcut</span> preInstantiationPointcut <span class="token operator">=</span> <span class="token class-name">Pointcuts</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>
                    aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPerClausePointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>declaredPointcut<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Make it dynamic: must mutate from pre-instantiation to post-instantiation state.</span>
            <span class="token comment">// If it&#39;s not a dynamic pointcut, it may be optimized out</span>
            <span class="token comment">// by the Spring AOP infrastructure after the first evaluation.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PerTargetInstantiationModelPointcut</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>declaredPointcut<span class="token punctuation">,</span> preInstantiationPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// @Aspect(&quot;&quot;) çš„æ—¶å€™</span>
            <span class="token comment">// A singleton aspect.</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>declaredPointcut<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lazy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
			<span class="token comment">// å°†åˆ‡é¢ä¸­çš„é€šçŸ¥æ„é€ ä¸ºadviceé€šçŸ¥å¯¹è±¡</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>instantiatedAdvice <span class="token operator">=</span> <span class="token function">instantiateAdvice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>declaredPointcut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">Advice</span> <span class="token function">instantiateAdvice</span><span class="token punctuation">(</span><span class="token class-name">AspectJExpressionPointcut</span> pointcut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Advice</span> advice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdviceMethod<span class="token punctuation">,</span> pointcut<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>declarationOrder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>advice <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> advice <span class="token operator">:</span> <span class="token constant">EMPTY_ADVICE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Advice</span> <span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateAdviceMethod<span class="token punctuation">,</span> <span class="token class-name">AspectJExpressionPointcut</span> expressionPointcut<span class="token punctuation">,</span>
            <span class="token class-name">MetadataAwareAspectInstanceFactory</span> aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">int</span> declarationOrder<span class="token punctuation">,</span> <span class="token class-name">String</span> aspectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//è·å–æˆ‘ä»¬çš„åˆ‡é¢ç±»çš„classå¯¹è±¡</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidateAspectClass <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>candidateAspectClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//è·å–åˆ‡é¢æ–¹æ³•ä¸Šçš„æ³¨è§£</span>
        <span class="token class-name">AspectJAnnotation</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> aspectJAnnotation <span class="token operator">=</span>
                <span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">.</span><span class="token function">findAspectJAnnotationOnMethod</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è§£æå‡ºæ¥çš„æ³¨è§£ä¿¡æ¯æ˜¯å¦ä¸ºnull</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectJAnnotation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å†æ¬¡åˆ¤æ–­æ˜¯å¦æ˜¯åˆ‡é¢å¯¹è±¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAspect</span><span class="token punctuation">(</span>candidateAspectClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;Advice must be declared inside an aspect type: &quot;</span> <span class="token operator">+</span>
                    <span class="token string">&quot;Offending method &#39;&quot;</span> <span class="token operator">+</span> candidateAdviceMethod <span class="token operator">+</span> <span class="token string">&quot;&#39; in class [&quot;</span> <span class="token operator">+</span>
                    candidateAspectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Found AspectJ method: &quot;</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">AbstractAspectJAdvice</span> springAdvice<span class="token punctuation">;</span>

        <span class="token comment">//åˆ¤æ–­æ ‡æ³¨åœ¨æ–¹æ³•ä¸Šçš„æ³¨è§£ç±»å‹</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ˜¯PointCutæ³¨è§£ é‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸ å› ä¸ºåœ¨å¤–é¢ä¼ é€’è¿›æ¥çš„æ–¹æ³•å·²ç»æ’é™¤äº†Pointcutçš„æ–¹æ³•</span>
            <span class="token keyword">case</span> <span class="token class-name">AtPointcut</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Processing pointcut &#39;&quot;</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">//ç¯ç»•é€šçŸ¥ æ„å»ºAspectJAroundAdvice</span>
            <span class="token keyword">case</span> <span class="token class-name">AtAround</span><span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAroundAdvice</span><span class="token punctuation">(</span>
                        candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//å‰ç½®é€šçŸ¥  æ„å»ºAspectJMethodBeforeAdvice</span>
            <span class="token keyword">case</span> <span class="token class-name">AtBefore</span><span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJMethodBeforeAdvice</span><span class="token punctuation">(</span>
                        candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//åç½®é€šçŸ¥ AspectJAfterAdvice</span>
            <span class="token keyword">case</span> <span class="token class-name">AtAfter</span><span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterAdvice</span><span class="token punctuation">(</span>
                        candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//è¿”å›é€šçŸ¥ AspectJAfterReturningAdvice</span>
            <span class="token keyword">case</span> <span class="token class-name">AtAfterReturning</span><span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterReturningAdvice</span><span class="token punctuation">(</span>
                        candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">AfterReturning</span> afterReturningAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AfterReturning</span><span class="token punctuation">)</span> aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>afterReturningAnnotation<span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    springAdvice<span class="token punctuation">.</span><span class="token function">setReturningName</span><span class="token punctuation">(</span>afterReturningAnnotation<span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">//å¼‚å¸¸é€šçŸ¥   AspectJAfterThrowingAdvice</span>
            <span class="token keyword">case</span> <span class="token class-name">AtAfterThrowing</span><span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterThrowingAdvice</span><span class="token punctuation">(</span>
                        candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">AfterThrowing</span> afterThrowingAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AfterThrowing</span><span class="token punctuation">)</span> aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>afterThrowingAnnotation<span class="token punctuation">.</span><span class="token function">throwing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    springAdvice<span class="token punctuation">.</span><span class="token function">setThrowingName</span><span class="token punctuation">(</span>afterThrowingAnnotation<span class="token punctuation">.</span><span class="token function">throwing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Unsupported advice type on method: &quot;</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//è®¾ç½®æˆ‘ä»¬æ„å»ºå‡ºæ¥çš„é€šçŸ¥å¯¹è±¡çš„ç›¸å…³å±æ€§æ¯”å¦‚DeclarationOrderï¼Œåœ¨ä»£ç†è°ƒç”¨çš„æ—¶å€™ï¼Œè´£ä»»é“¾é¡ºåºä¸Šä¼šç”¨åˆ°</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">setAspectName</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">setDeclarationOrder</span><span class="token punctuation">(</span>declarationOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterNameDiscoverer<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argNames <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            springAdvice<span class="token punctuation">.</span><span class="token function">setArgumentNamesFromStringArray</span><span class="token punctuation">(</span>argNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">calculateArgumentBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> springAdvice<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="åˆ›å»ºä»£ç†" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºä»£ç†" aria-hidden="true">#</a> åˆ›å»ºä»£ç†</h2><h3 id="å®ä¾‹åŒ–å‰åç½®-1" tabindex="-1"><a class="header-anchor" href="#å®ä¾‹åŒ–å‰åç½®-1" aria-hidden="true">#</a> å®ä¾‹åŒ–å‰åç½®</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token doc-comment comment">/**
   * åœ¨Beanåˆ›å»ºçš„ç”Ÿå‘½å‘¨æœŸä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œå¦‚æœè¿”å›å€¼ä¸æ˜¯nullï¼Œ
   * ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanPostProcessor</span><span class="token punctuation">#</span><span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
   * ç„¶åç›´æ¥è¿”å›beanï¼Œä¸ä¼šè¿›è¡Œåç»­beanç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œ
* 
   * åœ¨åˆ›å»ºBeançš„æµç¨‹ä¸­è¿˜æ²¡è°ƒç”¨æ„é€ å™¨æ¥å®ä¾‹åŒ–Beançš„æ—¶å€™è¿›è¡Œè°ƒç”¨(å®ä¾‹åŒ–å‰å)
* AOPè§£æåˆ‡é¢ä»¥åŠäº‹åŠ¡è§£æäº‹åŠ¡æ³¨è§£éƒ½æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„
   * <span class="token keyword">@param</span> <span class="token parameter">beanClass</span> è¦å®ä¾‹åŒ–çš„ Bean çš„ç±»
   * <span class="token keyword">@param</span> <span class="token parameter">beanName</span>  Bean çš„åç§°
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessBeforeInstantiation</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      <span class="token doc-comment comment">/**
       * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token field">customTargetSourceCreators</span></span><span class="token punctuation">}</span> å±æ€§ä¸ä¸ºnullï¼Œå°±éå† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSourceCreator</span></span><span class="token punctuation">}</span>
       * æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSourceCreator</span><span class="token punctuation">#</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> åˆ›å»º TargetSourceï¼Œè¿”å›å€¼æ˜¯nullå°±ç›´æ¥returnã€‚
       *
       * åœ¨è¿™é‡Œä½¿ç”¨ TargetSourceCreator æ¥åˆ›å»ºä»£ç†å¯¹è±¡ä¹Ÿå¯ä»¥å®ç°@Lazyçš„æ•ˆæœï¼Œå³å»¶æ—¶beançš„åˆ›å»ºï¼Œ
       * å› ä¸ºè¿™é‡Œç›´æ¥è¿”å›äº† ä»£ç†å¯¹è±¡ï¼Œè€Œæ‰§è¡Œä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œæ–¹æ³•æ—¶ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSource</span><span class="token punctuation">#</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ‹¿åˆ°è¢«ä»£ç†å¯¹è±¡,ä¸€èˆ¬åœ¨è¿™ä¸ªæ–¹æ³•å°±æ˜¯ getBean ä»è€Œå¯ä»¥å®ç°å»¶æ—¶beançš„å®ä¾‹åŒ–
       *
       * æ³¨ï¼šTargetSource å°è£…äº†è¢«ä»£ç†å¯¹è±¡ï¼Œç„¶åaopæ˜¯å¯¹TargetSourceè¿›è¡Œä»£ç†
       * */</span>
      <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token function">getCustomTargetSource</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>targetSource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// æœ‰beanName</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// è®°å½•åœ¨ targetSourcedBeans(è¢«ä»£ç†å¯¹è±¡é›†åˆ) ä¸­</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        
          <span class="token doc-comment comment">/**
           * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TargetSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
           * 1. ä¼šå°†å®¹å™¨ä¸­æ‰€æœ‰çš„ Advisor éƒ½è¿›è¡Œå®ä¾‹åŒ–ï¼Œç¼“å­˜èµ·æ¥ã€‚
           * 2. æŒ‰ç…§ ç±»åŒ¹é… æˆ–è€… (ç±»åŒ¹é…+AspectJè¡¨è¾¾å¼åŒ¹é…)
           * 3. è¿”å›æ»¡è¶³æ¡ä»¶çš„ Advisor
           * */</span>
          <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
          <span class="token doc-comment comment">/**
           * åˆ›å»ºä»£ç†å¯¹è±¡
           * */</span>
          <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// è¿”å›åˆ›å»ºå¥½çš„ä»£ç†å¯¹è±¡ï¼Œè¿™é‡Œè¿”å›å€¼ä¸æ˜¯nullï¼Œæ‰€ä»¥ä¼šä¸­æ–­åç»­Beançš„å£°æ˜å‘¨æœŸï¼Œä¹Ÿå°±æ˜¯åé¢çš„å¡«å……beanã€åˆå§‹åŒ–ç­‰ç­‰æ“ä½œéƒ½ä¸ä¼šæ‰§è¡Œäº†</span>
          <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="æŸ¥æ‰¾åŒ¹é…çš„advisor" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾åŒ¹é…çš„advisor" aria-hidden="true">#</a> æŸ¥æ‰¾åŒ¹é…çš„Advisor</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ Advisor
     * */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


  <span class="token doc-comment comment">/**
     * æŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„é¡¾é—®æ¥è‡ªåŠ¨ä»£ç†æ­¤ç±»ã€‚
     *
     * <span class="token keyword">@param</span> <span class="token parameter">beanClass</span> the clazz to find advisors for
     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span>  the name of the currently proxied bean
     * <span class="token keyword">@return</span> the empty List, not <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>,
     * if there are no pointcuts or interceptors
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">findCandidateAdvisors</span></span>
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">sortAdvisors</span></span>
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">extendAdvisors</span></span>
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * AnnotationAwareAspectJAutoProxyCreator å¯¹ findCandidateAdvisors è¿›è¡Œäº†é‡å†™
         *
         * æŸ¥æ‰¾å€™é€‰çš„Advisors(è¿™é‡Œæ‹¿åˆ°çš„æ˜¯å®¹å™¨ä¸­æ‰€æœ‰çš„)
         * 1. ä»BeanFactoryä¸­æ‰¾åˆ° Advisor ç±»å‹çš„bean
         * 2. ä»BeanFactoryä¸­æ‰¾åˆ°æ ‡æ³¨äº† @Aspect æ³¨è§£çš„beanï¼Œå°†æ ‡æ³¨äº† @Aroundã€@Beforeã€@Afterã€@AfterReturningã€@AfterThrowing çš„æ–¹æ³•è§£ææˆ InstantiationModelAwarePointcutAdvisorImpl
         * */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * æŸ¥è¯¢å½“å‰ç±»å¯ä»¥åº”ç”¨çš„ advisor(è¿™é‡Œæ˜¯ç­›é€‰å¯ä»¥åº”ç”¨çš„)
         *
         * åŒ¹é…è§„åˆ™ï¼šç±»åŒ¹é… + åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…
         * */</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> eligibleAdvisors <span class="token operator">=</span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ‰©å±• Advisor
         *
         * AnnotationAwareAspectJAutoProxyCreator çš„çˆ¶ç±» AspectJAwareAdvisorAutoProxyCreator å¯¹ extendAdvisors è¿›è¡Œäº†é‡å†™
         * ä¼šæ·»åŠ è¿™ä¸ªä½œç”¨ç¬¬0ä¸ªAdvisor <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ExposeInvocationInterceptor</span><span class="token punctuation">#</span><span class="token field">INSTANCE</span></span><span class="token punctuation">}</span>
         * */</span>
        <span class="token function">extendAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å‡åºæ’åº
             *
             * é»˜è®¤çš„æ’åºè§„åˆ™ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareOrderComparator</span></span>.sort(advisors);<span class="token punctuation">}</span> ï¼Œå¯ä»¥é€šè¿‡ Orderedæ¥å£ã€@Orderã€@Priority è®¾ç½®æ’åºå€¼ï¼Œ
             * å¯¹äº InstantiationModelAwarePointcutAdvisorImpl å®ä¾‹æ‹¿åˆ°çš„æ’åºå€¼å…¶å®æ˜¯å…¶@Aspectbeançš„ å€¼
             *
             * AnnotationAwareAspectJAutoProxyCreator çš„çˆ¶ç±» AspectJAwareAdvisorAutoProxyCreator å¯¹ sortAdvisors è¿›è¡Œäº†é‡å†™
             *  é‡å†™çš„æ’åºè§„åˆ™ï¼šä½¿ç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationAwareOrderComparator</span></span> <span class="token punctuation">}</span> å¾—åˆ°æ’åºå€¼ï¼Œå¦‚æœcompare è¿”å›å€¼æ˜¯0ï¼Œåœ¨åˆ¤æ–­æ˜¯åŒä¸€ä¸ª <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">#</span><span class="token field">ASPECTJ_ANNOTATION_CLASSES</span></span><span class="token punctuation">}</span> æ³¨è§£
             *  é‚£å°±è¿›è¡ŒäºŒæ¬¡æ’åºã€‚
             *
             * æ³¨ï¼šäºŒæ¬¡æ’åºçš„å‚æ•°å€¼éƒ½æ˜¯é»˜è®¤å€¼ï¼Œæˆ‘çœ‹æºç ä¹Ÿæ²¡æœ‰ç‰¹æ„ä¿®æ”¹è¯¥å€¼ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ ç¬¬ä¸€æ¬¡æ’åº å°±èƒ½è®¾ç½® advisor çš„é¡ºåº
             * */</span>
            eligibleAdvisors <span class="token operator">=</span> <span class="token function">sortAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">protected</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// é€šè¿‡ ThreadLocal è®°å½• æ­£åœ¨ä»£ç†çš„beanName</span>
        <span class="token class-name">ProxyCreationContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * å°±æ˜¯éå†æ‰€æœ‰çš„ candidateAdvisorsï¼Œèƒ½åŒ¹é… beanClass å°±æ”¶é›†åˆ°é›†åˆï¼Œç„¶åå°†é›†åˆè¿”å›
             *
             * åŒ¹é…è§„åˆ™ï¼šç±»åŒ¹é… + åˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒ¹é…
             * */</span>
            <span class="token keyword">return</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç§»é™¤ æ­£åœ¨ä»£ç†çš„beanName</span>
            <span class="token class-name">ProxyCreationContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AopUtils</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> candidateAdvisors<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> candidateAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> eligibleAdvisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * æ˜¯ IntroductionAdvisor ç±»å‹çš„ï¼Œ
         * åªéœ€è¦åˆ¤æ–­ç±»æ»¡è¶³å³å¯ `((IntroductionAdvisor) advisor).getClassFilter().matches(targetClass)`
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">boolean</span> hasIntroductions <span class="token operator">=</span> <span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// already processed</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         *
         * é€šè¿‡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAspectJAdvisorFactory</span><span class="token punctuation">#</span><span class="token field">ASPECTJ_ANNOTATION_CLASSES</span></span><span class="token punctuation">}</span> æ³¨è§£è§£ææˆçš„ Advisor æ˜¯è¿™ä¸ªç±»å‹ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">InstantiationModelAwarePointcutAdvisorImpl</span></span><span class="token punctuation">}</span>
         *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">InstantiationModelAwarePointcutAdvisorImpl</span><span class="token punctuation">#</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *          å¦‚æœåˆ‡é¢ç±»æ˜¯@Aspect(&quot;&quot;) é‚£ä¹ˆè¯¥å±æ€§çš„è¿”å›å€¼æ˜¯è¿™ä¸ªç±»å‹ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJExpressionPointcut</span></span> <span class="token punctuation">}</span>
         *
         *  canApply å°±æ˜¯æ‹¿ AspectJExpressionPointcutï¼Œå…ˆè¿›è¡Œç±»åŒ¹é…ã€åœ¨åŒ¹é…å½“å‰ clazz æ˜¯å¦æ»¡è¶³åˆ‡å…¥ç‚¹è¡¨è¾¾å¼
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



 <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç±»åŒ¹é…æ»¡è¶³ å°±è¡Œ</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">PointcutAdvisor</span> pca <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * ç±»åŒ¹é…æ»¡è¶³ åœ¨åˆ¤æ–­ ç±»é‡Œé¢çš„æ–¹æ³• æ˜¯å¦æ»¡è¶³ advisor çš„åˆ‡å…¥ç‚¹è§„åˆ™
             * */</span>
            <span class="token keyword">return</span> <span class="token function">canApply</span><span class="token punctuation">(</span>pca<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// It doesn&#39;t have a pointcut so we assume it applies.</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span><span class="token class-name">Pointcut</span> pc<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> <span class="token string">&quot;Pointcut must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç±»åŒ¹é…æ ¡éªŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">MethodMatcher</span> methodMatcher <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token operator">==</span> <span class="token class-name">MethodMatcher</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœæˆ‘ä»¬æ— è®ºå¦‚ä½•éƒ½åŒ¹é…ä»»ä½•æ–¹æ³•ï¼Œåˆ™æ— éœ€è¿­ä»£æ–¹æ³•...</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">IntroductionAwareMethodMatcher</span> introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> methodMatcher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ç”¨æ¥è®°å½• è¢«ä»£ç†ç±» å’Œ è¢«ä»£ç†çš„æ‰€æœ‰æ¥å£ çš„ç±»å‹</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸æ˜¯jdkä»£ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * æ˜¯cglibä»£ç†ç”Ÿæˆçš„ç±»ï¼Œè¿”å›å…¶çˆ¶ç±»
             * ä¸æ˜¯ï¼Œç›´æ¥è¿”å› targetClass
             * */</span>
            classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ·»åŠ æ‰€æœ‰çš„æ¥å£</span>
        classes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getAllInterfacesForClassAsSet</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‹¿åˆ°ç±»çš„æ‰€æœ‰æ–¹æ³•</span>
            <span class="token class-name">Method</span><span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getAllDeclaredMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * AspectJ è¡¨è¾¾å¼åŒ¹é…ï¼ŒåŒ¹é…å°±è¿”å›true
                 *
                 * é»˜è®¤æ˜¯è¿™ä¸ªç±»å‹çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">#</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 * */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>introductionAwareMethodMatcher
                        <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> introductionAwareMethodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span> <span class="token operator">:</span> methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ‰€æœ‰çš„æ–¹æ³•éƒ½ä¸åŒ¹é… AspectJ è¡¨è¾¾å¼å°±è¿”å›false</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="åˆ›å»ºä»£ç†-1" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºä»£ç†-1" aria-hidden="true">#</a> åˆ›å»ºä»£ç†</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token doc-comment comment">/**
  * ä¸ºç»™å®šçš„beanåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä¸»è¦æ˜¯é€šè¿‡ProxyFactoryæ¥åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä¼šæœ‰ä¸¤ä¸ªç­–ç•¥ cglibä»£ç†æˆ–è€…jdkä»£ç†ï¼Œ<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
  * Create an AOP proxy for the given bean.
  *
  * <span class="token keyword">@param</span> <span class="token parameter">beanClass</span>            the class of the bean
  * <span class="token keyword">@param</span> <span class="token parameter">beanName</span>             the name of the bean
  * <span class="token keyword">@param</span> <span class="token parameter">specificInterceptors</span> the set of interceptors that is
  *                             specific to this bean (may be empty, but not null)
  * <span class="token keyword">@param</span> <span class="token parameter">targetSource</span>         the TargetSource for the proxy,
  *                             already pre-configured to access the bean
  * <span class="token keyword">@return</span> the AOP proxy for the bean
  * <span class="token keyword">@see</span> <span class="token reference"><span class="token punctuation">#</span><span class="token field">buildAdvisors</span></span>
  */</span>
 <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors<span class="token punctuation">,</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//</span>
         <span class="token doc-comment comment">/**
          * ç»™beanNameå¯¹åº”çš„BeanDefinition <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AutoProxyUtils</span><span class="token punctuation">#</span><span class="token field">ORIGINAL_TARGET_CLASS_ATTRIBUTE</span></span><span class="token punctuation">}</span> å±æ€§,ä¸ºbeanClass
          * å°±æ˜¯è®°å½•æºå¯¹è±¡æ˜¯å•¥
          * */</span>
         <span class="token class-name">AutoProxyUtils</span><span class="token punctuation">.</span><span class="token function">exposeTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token class-name">ProxyFactory</span> proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token doc-comment comment">/**
      * å…³æ³¨è¿™ä¸¤ä¸ªå±æ€§ï¼šproxyTargetClassã€exposeProxy
      *
      * @EnableAspectJAutoProxy() å¯ä»¥è®¾ç½®è¿™ä¸¤ä¸ªå±æ€§å€¼
      *  AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);
      *  AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);
      *
      * å±æ€§ proxyTargetClass åœ¨è¿™é‡Œæœ‰ç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAopProxyFactory</span><span class="token punctuation">#</span><span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      * å±æ€§ exposeProxy åœ¨è¿™é‡Œæœ‰ç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">#</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      * */</span>
     proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyFactory<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token doc-comment comment">/**
          * æ˜¾å¼å¤„ç† JDK ä»£ç†ç›®æ ‡(ç”¨äºå¼•å…¥é€šçŸ¥åœºæ™¯)
          *
          * beanClass æ˜¯jdkä»£ç†äº§ç”Ÿçš„ç±»
          * */</span>
         <span class="token comment">// Explicit handling of JDK proxy targets (for introduction advice scenarios)</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment">// Must allow for introductions; can&#39;t just set interfaces to the proxy&#39;s interfaces only.</span>
             <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ifc <span class="token operator">:</span> beanClass<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token comment">// è®°å½•å®ç°çš„æ¥å£</span>
                 proxyFactory<span class="token punctuation">.</span><span class="token function">addInterface</span><span class="token punctuation">(</span>ifc<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token doc-comment comment">/**
          * å°±æ˜¯æ£€æŸ¥BeanDefinitionæ˜¯å¦è®¾ç½®äº†å±æ€§
          *
          * @Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)
          * @Compoent
          * class A<span class="token punctuation">{</span><span class="token punctuation">}</span>
          *
          * è¿™æ ·å­ï¼ŒshouldProxyTargetClass å°±æ˜¯ true
          * */</span>
         <span class="token comment">//</span>
         <span class="token comment">// No proxyTargetClass flag enforced, let&#39;s apply our default checks...</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyTargetClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             proxyFactory<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             <span class="token doc-comment comment">/**
              * è®°å½• beanClass å®ç°çš„è‡ªå®šä¹‰æ¥å£
              * */</span>
             <span class="token function">evaluateProxyInterfaces</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     <span class="token doc-comment comment">/**
      * ä¸»è¦æ˜¯å°† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token field">interceptorNames</span></span><span class="token punctuation">}</span> çš„beanï¼Œä½œä¸ºé€šç”¨çš„ Advisorã€‚
      * é€šç”¨çš„ Advisor çš„ä¼˜å…ˆçº§æ¯”specificInterceptors è¦å…ˆæ‰§è¡Œ
      *
      * å­ç±»å¯ä»¥å›è°ƒ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">setInterceptorNames</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è¿›è¡Œè®¾ç½®
      * */</span>
     <span class="token class-name">Advisor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">//</span>
     <span class="token doc-comment comment">/**
      * è®¾ç½® advisor
      * è¿™é‡Œéå¸¸çš„å…³é”®ï¼Œè¿™é‡Œå°±æ˜¯ IntroductionAdvisor èƒ½å®ç°ä¸ä¿®æ”¹è¢«ä»£ç†çš„æƒ…å†µä¸‹è¿˜èƒ½è¿›è¡Œç±»å‹è½¬æ¢çš„åŸå› 
      * æ·»åŠ çš„ advisor æ˜¯ IntroductionAdvisor ç±»å‹
      *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">validateIntroductionAdvisor</span><span class="token punctuation">(</span><span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">validateIntroductionAdvisor</span><span class="token punctuation">(</span><span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          å°±æ˜¯ä¼šæ‹¿åˆ°Advisorçš„æ¥å£ä¿¡æ¯<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">IntroductionInfo</span><span class="token punctuation">#</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>è®¾ç½®åˆ°proxyFactoryä¸­
      *          æ³¨æ„ï¼Œè¿™é‡Œæ˜¯ä¼šæ ¡éªŒ æ˜¯å¦æ˜¯æ¥å£çš„ï¼Œé˜²æ­¢ä½ ä¹±æ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">addInterface</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *
      * å®ä¾‹ä»£ç  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token namespace">cn<span class="token punctuation">.</span>haitaoss<span class="token punctuation">.</span>javaconfig<span class="token punctuation">.</span>aop<span class="token punctuation">.</span></span><span class="token class-name">AopTest3</span><span class="token punctuation">.</span><span class="token class-name">AspectDemo3</span></span><span class="token punctuation">}</span>
      *      ((AopTest3.MyIntroduction)(context.getBean(AopTest3.AopDemo.class))).test1();
      * */</span>
     proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span>advisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">// è¢«ä»£ç†å¯¹è±¡ã€‚æˆ‘ä»¬çš„æ™®é€šbean è¢«è£…é¥°æˆ TargetSource äº†</span>
     proxyFactory<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token comment">// é¢„ç•™æ¨¡æ¿æ–¹æ³•ã€‚ç©ºæ–¹æ³•</span>
     <span class="token function">customizeProxyFactory</span><span class="token punctuation">(</span>proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token doc-comment comment">/**
      * æ˜¯å¦å†»ç»“ä»£ç†ï¼Œå°±æ˜¯æ˜¯å¦æ”¯æŒä¿®æ”¹ advisors
      * çœ‹è¿™äº›åœ°æ–¹,éƒ½ä¼šæ ¡éªŒè¿™ä¸ªå±æ€§
      *  æ–°å¢ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *  åˆ é™¤ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">removeAdvisor</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      * */</span>
     proxyFactory<span class="token punctuation">.</span><span class="token function">setFrozen</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freezeProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">advisorsPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         proxyFactory<span class="token punctuation">.</span><span class="token function">setPreFiltered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">// Use original ClassLoader if bean class not locally loaded in overriding class loader</span>
     <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> <span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>classLoader <span class="token keyword">instanceof</span> <span class="token class-name">SmartClassLoader</span> <span class="token operator">&amp;&amp;</span> classLoader <span class="token operator">!=</span> beanClass<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         classLoader <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartClassLoader</span><span class="token punctuation">)</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginalClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token doc-comment comment">/**
      * åˆ›å»ºä»£ç†å¯¹è±¡
      *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ProxyFactory</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ProxyCreatorSupport</span><span class="token punctuation">#</span><span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *
      *
      * åˆ›å»º AopProxy <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAopProxyFactory</span><span class="token punctuation">#</span><span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      - ç®€å•æ¥è¯´ï¼Œè¢«ä»£ç†å¯¹è±¡ ä¸æ˜¯æ¥å£ ä¸” ä¸æ˜¯Proxyçš„å­ç±»
*       ä¸” <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">getProxiedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>è‡³å¤šåªæœ‰ä¸€ä¸ªSpringProxyç±»å‹çš„æ¥å£
*       å°±åˆ›å»º `new ObjenesisCglibAopProxy(config);`
      *      - å¦åˆ™åˆ›å»º `new JdkDynamicAopProxy(config);`
      *      æ³¨ï¼šconfig å‚æ•°å…¶å®å°±æ˜¯ ProxyFactoryå¯¹è±¡
      *
      * ä½¿ç”¨ AopProxy åˆ›å»ºä»£ç†å¯¹è±¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AopProxy</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *
      * ObjenesisCglibAopProxy å¢å¼ºé€»è¾‘å®ç°åŸç† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      Enhancer enhancer = new Enhancer();
      *      enhancer.setCallbacks(<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">#</span><span class="token function">getCallbacks</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>); // æ‰§è¡Œæ–¹æ³•ä¼šå›è°ƒcallback
      *          æ³¨ï¼šä¼šè®¾ç½®  `new DynamicAdvisedInterceptor(this.advised);` callbackï¼Œ
*          this å°±æ˜¯ ObjenesisCglibAopProxyï¼Œè€Œå…¶<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">#</span><span class="token field">advised</span></span><span class="token punctuation">}</span>å±æ€§
*          å…¶å®å°±æ˜¯ ProxyFactory ä»è€Œå¯ä»¥æ‹¿åˆ°Advisors
      *      enhancer.setCallbackFilter(ProxyCallbackFilter);
      *          è¿”å›è¦æ‰§è¡Œçš„ callback çš„ç´¢å¼•ã€‚åœ¨Cglibç”Ÿæˆä»£ç†å¯¹è±¡çš„å­—èŠ‚ç æ—¶ä¼šè°ƒCallbackFilterï¼Œæ¥è®¾ç½®å¥½æ¯ä¸ªæ–¹æ³•çš„Callbackæ˜¯å•¥
      *          è®¾ç½®è¿™ä¸ªå±æ€§ï¼Œç”Ÿæˆcglibç”Ÿæˆçš„ä»£ç†å¯¹è±¡å­—èŠ‚ç ï¼Œä¸€çœ‹å°±çŸ¥é“äº†ã€‚
*          `System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, &quot;C:\\Users\\RDS\\Desktop\\1&quot;);`
      *
      *      æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹å¼æ—¶ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">.</span><span class="token class-name">ProxyCallbackFilter</span><span class="token punctuation">#</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          å°±æ˜¯ é™¤äº† finalizeã€equalsã€hashcode ç­‰ï¼Œéƒ½ä¼šæ‰§è¡Œ DynamicAdvisedInterceptor è¿™ä¸ªcallback
      *      ä¹Ÿå°±æ˜¯æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">.</span><span class="token class-name">DynamicAdvisedInterceptor</span><span class="token punctuation">#</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          1. exposeProxy å±æ€§æ˜¯ trueï¼Œå¾€ ThreadLocalä¸­è®°å½•å½“å‰ä»£ç†å¯¹è±¡  `oldProxy=AopContext.setCurrentProxy(proxy)`
      *          2. è·å–è¢«ä»£ç†å¯¹è±¡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">TargetSource</span><span class="token punctuation">#</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>ã€‚è¿™é‡Œä¹Ÿæ˜¯å¾ˆç»†èŠ‚ï¼Œ
      *              æ¯”å¦‚ï¼š
      *                  - TargetSourceå®ä¾‹æ˜¯è¿™ä¸ªç±»å‹çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractBeanFactoryBasedTargetSource</span></span><span class="token punctuation">}</span>ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–targetéƒ½æ˜¯ä»IOCå®¹å™¨ä¸­æ‹¿ï¼Œä¹Ÿå°±æ˜¯è¯´ å¦‚æœbeanæ˜¯å¤šä¾‹çš„ï¼Œæ¯æ¬¡æ‰§è¡Œéƒ½ä¼šåˆ›å»ºå‡ºæ–°çš„å¯¹è±¡ã€‚(@Lazyå°±æ˜¯è¿™ä¹ˆå®ç°çš„)
      *  *               - è€Œ Spring Aopï¼Œä½¿ç”¨çš„æ˜¯SingletonTargetSourceï¼Œç‰¹ç‚¹æ˜¯å°†å®¹å™¨çš„å¯¹è±¡ç¼“å­˜äº†ï¼Œæ‰§è¡Œ `getTarget` æ‰èƒ½æ‹¿åˆ°è¢«ä»£ç†å¯¹è±¡
      *  *
      *          3. æ ¹æ®methodå¾—åˆ°å¯¹åº”çš„æ‹¦æˆªå™¨é“¾ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *              æ‹¦æˆªå™¨é“¾æ˜¯ç©ºï¼šåå°„æ‰§è¡Œ
      *              æ‹¦æˆªå™¨é“¾ä¸æ˜¯ç©ºï¼šå°†æ‹¦æˆªå™¨é“¾è£…é¥°æˆ CglibMethodInvocation ï¼Œç„¶åæ‰§è¡Œ<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CglibAopProxy</span><span class="token punctuation">.</span><span class="token class-name">CglibMethodInvocation</span><span class="token punctuation">#</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>ï¼Œå…¶å®å°±æ˜¯æ‰§è¡Œå…¶çˆ¶ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">#</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *              æ³¨ï¼šæ‹¦æˆªå™¨é“¾å°±æ˜¯ method åŒ¹é…åˆ°çš„ advisor è§£æçš„ç»“æœï¼Œå¯ä»¥çœ‹è¿™é‡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAdvisorChainFactory</span><span class="token punctuation">#</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Advised</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          4. exposeProxy å±æ€§æ˜¯ trueï¼Œæ¢å¤ä¹‹å‰çš„å€¼  `AopContext.setCurrentProxy(oldProxy);`
      *
      * JdkDynamicAopProxy å¢å¼ºé€»è¾‘çš„å®ç° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">#</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *      `Proxy.newProxyInstance(classLoader, this.proxiedInterfaces, this);` å¯ä»¥çŸ¥é“ ç¬¬ä¸‰ä¸ªå‚æ•°(InvocationHandler) æ˜¯ thisï¼Œ
*      ä¹Ÿå°±æ˜¯ JdkDynamicAopProxyï¼Œè€Œå…¶<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">#</span><span class="token field">advised</span></span><span class="token punctuation">}</span>å±æ€§ å…¶å®å°±æ˜¯ ProxyFactoryä»è€Œå¯ä»¥æ‹¿åˆ°Advisors
      *      æ‰€ä»¥æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹å¼æ—¶ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">#</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          1. æ˜¯ equals(å­ç±»æ²¡æœ‰é‡å†™çš„æƒ…å†µä¸‹)ã€hashCode(å­ç±»æ²¡æœ‰é‡å†™çš„æƒ…å†µä¸‹)ã€DecoratingProxy.class çš„æ–¹æ³•ã€Advised.class çš„æ–¹æ³•
      *              ç›´æ¥åå°„æ‰§è¡Œ
      *          2. exposeProxy å±æ€§æ˜¯ trueï¼Œå¾€ ThreadLocalä¸­è®°å½•å½“å‰ä»£ç†å¯¹è±¡  `oldProxy=AopContext.setCurrentProxy(proxy)`
      *          3. æ ¹æ®methodå¾—åˆ°å¯¹åº”çš„æ‹¦æˆªå™¨é“¾ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *              æ‹¦æˆªå™¨é“¾æ˜¯ç©ºï¼šåå°„æ‰§è¡Œ
      *              æ‹¦æˆªå™¨é“¾ä¸æ˜¯ç©ºï¼šå°†æ‹¦æˆªå™¨é“¾è£…é¥°æˆ ReflectiveMethodInvocation ï¼Œç„¶åæ‰§è¡Œ<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">#</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *              æ³¨ï¼šæ‹¦æˆªå™¨é“¾å°±æ˜¯ method åŒ¹é…åˆ°çš„ advisor è§£æçš„ç»“æœï¼Œå¯ä»¥çœ‹è¿™é‡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAdvisorChainFactory</span><span class="token punctuation">#</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Advised</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
      *          4. exposeProxy å±æ€§æ˜¯ trueï¼Œæ¢å¤ä¹‹å‰çš„å€¼  `AopContext.setCurrentProxy(oldProxy);`
      * */</span>
     <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ProxyFactory</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token class-name">DefaultProxyFacoory</span><span class="token operator">:</span>

<span class="token doc-comment comment">/**
 * ç®€å•æ¥è¯´ï¼Œè¢«ä»£ç†å¯¹è±¡ ä¸æ˜¯æ¥å£ ä¸” ä¸æ˜¯Proxyçš„å­ç±» ä¸” <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token function">getProxiedInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>è‡³å¤šåªæœ‰ä¸€ä¸ªSpringProxyç±»å‹çš„æ¥å£ å°±è¿”å› ObjenesisCglibAopProxy
 * ç®€å•æ¥è¯´ï¼Œä»£ç†å¯¹è±¡æ˜¯æ¥å£ æˆ–è€… ä»£ç†å¯¹è±¡æ˜¯JDKä»£ç†æ˜¯ç”Ÿæˆçš„å¯¹è±¡ï¼Œæ‰ä¼šä½¿ç”¨JdkDynamicAopProxy
 * <span class="token keyword">@param</span> <span class="token parameter">config</span> the AOP configuration in the form of an
 *               AdvisedSupport object
 * <span class="token keyword">@return</span>
 * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">AopConfigException</span></span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">AopProxy</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ˜¯ä¼˜åŒ– æˆ–è€… æ˜¯proxyTargetClass æˆ–è€… æ¥å£æ•°é‡ä¸º0 æˆ–è€… åªæœ‰ä¸€ä¸ªæ¥å£ä¸”æ¥å£å®ç°äº†SpringProxy</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">NativeDetector</span><span class="token punctuation">.</span><span class="token function">inNativeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿åˆ°beançš„ç±»å‹(å°±æ˜¯TargetSourceè£…é¥°çš„ç±»)</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;TargetSource cannot determine target class: &quot;</span>
                    <span class="token operator">+</span> <span class="token string">&quot;Either an interface or a target is required for proxy creation.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¢«ä»£ç†å¯¹è±¡æ˜¯æ¥å£ æˆ–è€… æ˜¯Proxyçš„å­ç±»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// jdkä»£ç†</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// cglib ä»£ç†</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="jdkåŠ¨æ€ä»£ç†" tabindex="-1"><a class="header-anchor" href="#jdkåŠ¨æ€ä»£ç†" aria-hidden="true">#</a> jdkåŠ¨æ€ä»£ç†</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">JdkDynamicAopProxy</span><span class="token operator">:</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Creating JDK dynamic proxy: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>proxiedInterfaces<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="cglibåŠ¨æ€ä»£ç†" tabindex="-1"><a class="header-anchor" href="#cglibåŠ¨æ€ä»£ç†" aria-hidden="true">#</a> cglibåŠ¨æ€ä»£ç†</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">CglibAopProxy</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Creating CGLIB proxy: &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractBeanFactoryBasedTargetSource</span><span class="token punctuation">#</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * é€šè¿‡ targetBeanName ä» BeanFactoryä¸­å¾—åˆ°ç±»å‹
         * */</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rootClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>rootClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Target class must be available for creating a CGLIB proxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> proxySuperClass <span class="token operator">=</span> rootClass<span class="token punctuation">;</span>
        <span class="token comment">// è¢«ä»£ç†ç±» æ˜¯cglibç”Ÿæˆçš„ç±»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token constant">CGLIB_CLASS_SEPARATOR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‹¿åˆ°çœŸæ­£çš„è¢«ä»£ç†ç±»çš„ç±»å‹</span>
            proxySuperClass <span class="token operator">=</span> rootClass<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ‹¿åˆ°æ¥å£åˆ—è¡¨</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> additionalInterfaces <span class="token operator">=</span> rootClass<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> additionalInterface <span class="token operator">:</span> additionalInterfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°†æ¥å£ç±»å‹è®°å½•èµ·æ¥</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">addInterface</span><span class="token punctuation">(</span>additionalInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å•¥éƒ½æ²¡å¹²ï¼Œæ‰“å°æ—¥å¿—è€Œå·²</span>
        <span class="token comment">// Validate the class, writing log messages as necessary.</span>
        <span class="token function">validateClassIfNecessary</span><span class="token punctuation">(</span>proxySuperClass<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Configure CGLIB Enhancer...</span>
        <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token function">createEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classLoader <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            enhancer<span class="token punctuation">.</span><span class="token function">setClassLoader</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>classLoader <span class="token keyword">instanceof</span> <span class="token class-name">SmartClassLoader</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SmartClassLoader</span><span class="token punctuation">)</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isClassReloadable</span><span class="token punctuation">(</span>proxySuperClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                enhancer<span class="token punctuation">.</span><span class="token function">setUseCache</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>proxySuperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœæ¥å£é‡Œé¢æ²¡æœ‰ SpringProxyã€Advisedã€DecoratingProxy çš„å­ç±»ï¼Œå°±æ·»åŠ </span>
        enhancer<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">completeProxiedInterfaces</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setNamingPolicy</span><span class="token punctuation">(</span><span class="token class-name">SpringNamingPolicy</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassLoaderAwareGeneratorStrategy</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¾ˆå…³é”®ï¼Œè®¾ç½® å¢å¼ºæ–¹æ³•çš„é€»è¾‘</span>
        <span class="token class-name">Callback</span><span class="token punctuation">[</span><span class="token punctuation">]</span> callbacks <span class="token operator">=</span> <span class="token function">getCallbacks</span><span class="token punctuation">(</span>rootClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> types<span class="token punctuation">.</span>length<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            types<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> callbacks<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * å¦‚æœè®¾ç½®äº† CallbackFilterï¼Œå°±ä¼šæ ¹æ® <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">CallbackFilter</span><span class="token punctuation">#</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è¿”å›çš„ç´¢å¼•å€¼
         * ç¡®å®šä½¿ç”¨ é‚£ä¸ª callback
         * */</span>
        <span class="token comment">// fixedInterceptorMap only populated at this point, after getCallbacks call above</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallbackFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProxyCallbackFilter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getConfigurationOnlyCopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fixedInterceptorMap<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fixedInterceptorOffset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallbackTypes</span><span class="token punctuation">(</span>types<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ç”Ÿæˆä»£ç†å¯¹è±¡</span>
        <span class="token comment">// Generate the proxy class and create a proxy instance.</span>
        <span class="token keyword">return</span> <span class="token function">createProxyClassAndInstance</span><span class="token punctuation">(</span>enhancer<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CodeGenerationException</span> <span class="token operator">|</span> <span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not generate CGLIB subclass of &quot;</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token string">&quot;: Common causes of this problem include using a final class or a non-visible class&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TargetSource.getTarget() failed</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected AOP exception&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åˆå§‹åŒ–å‰åç½®" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–å‰åç½®" aria-hidden="true">#</a> åˆå§‹åŒ–å‰åç½®</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¦‚æœéœ€è¦å°±åˆ›å»ºä»£ç†" tabindex="-1"><a class="header-anchor" href="#å¦‚æœéœ€è¦å°±åˆ›å»ºä»£ç†" aria-hidden="true">#</a> å¦‚æœéœ€è¦å°±åˆ›å»ºä»£ç†</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * åœ¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAutoProxyCreator</span><span class="token punctuation">#</span><span class="token field">postProcessBeforeInstantiation</span></span><span class="token punctuation">}</span> çš„æ—¶å€™å°±åˆ›å»ºäº†ä»£ç†å¯¹è±¡ï¼Œ
     * é‚£å°±åˆ«æäº† ç›´æ¥è¿”å›å…¥å‚bean
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¡¨ç¤º adviseBean å·²ç»åˆ›å»ºäº†ä»£ç†å¯¹è±¡ æˆ–è€…æ˜¯ infrastructureBean</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ˜¯ Adviceã€Pointcutã€Advisorã€AopInfrastructureBean ç±»å‹çš„å­ç±»</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å°±æ˜¯æ‹¿åˆ°å’Œè¿™ä¸ªbean åŒ¹é…çš„ advisors é›†åˆ ä¿¡æ¯ã€‚ä¼šè§¦å‘ Advisorç±»å‹çš„å®ä¾‹åŒ–ã€@Aspect beançš„å®ä¾‹åŒ–
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractAdvisorAutoProxyCreator</span><span class="token punctuation">#</span><span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TargetSource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token comment">// Create proxy if we have advice.</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * å“ˆå“ˆå“ˆå“ˆã€‚è®°å½•ä¸€ä¸‹è¿™ä¸ª bean æ»¡è¶³aopè§„åˆ™ï¼Œåˆ›å»ºäº†ä»£ç†å¯¹è±¡
         * */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºä»£ç†å¯¹è±¡</span>
        <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è®°å½• è™½ç„¶ä¸æ˜¯ advisor ä½†æ˜¯ä¹Ÿæ²¡æœ‰åŒ¹é… aop è§„åˆ™çš„bean</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è·å–æ—©æœŸbeanå¼•ç”¨" tabindex="-1"><a class="header-anchor" href="#è·å–æ—©æœŸbeanå¼•ç”¨" aria-hidden="true">#</a> è·å–æ—©æœŸbeanå¼•ç”¨</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="æ‰§è¡Œä»£ç†" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œä»£ç†" aria-hidden="true">#</a> æ‰§è¡Œä»£ç†</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
      <span class="token class-name">Object</span> oldProxy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">boolean</span> setProxyContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

			<span class="token comment">// è¢«ä»£ç†çš„å¯¹è±¡</span>
      <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>targetSource<span class="token punctuation">;</span>
      <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‰§è¡Œçš„æ˜¯equalsæ–¹æ³•ä¸éœ€è¦ä»£ç†</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>equalsDefined <span class="token operator">&amp;&amp;</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isEqualsMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// The target does not implement the equals(Object) method itself.</span>
              <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// æ‰§è¡Œçš„hashCodeæ–¹æ³•ä¸éœ€è¦ä»£ç†</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashCodeDefined <span class="token operator">&amp;&amp;</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isHashCodeMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// The target does not implement the hashCode() method itself.</span>
              <span class="token keyword">return</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// DecoratingProxyä¸éœ€è¦ä»£ç†</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">DecoratingProxy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// There is only getDecoratedClass() declared -&gt; dispatch to proxy config.</span>
              <span class="token keyword">return</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">ultimateTargetClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>opaque <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                             <span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">Advised</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Service invocations on ProxyConfig with the proxy config...</span>
              <span class="token keyword">return</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token class-name">Object</span> retVal<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * è¿™ä¸ªé…ç½®æ˜¯æš´éœ²æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡åˆ°çº¿ç¨‹å˜é‡ä¸­ï¼Œéœ€è¦æ­é…@EnableAspectJAutoProxy(exposeProxy = true)ä¸€èµ·ä½¿ç”¨
     * æ¯”å¦‚åœ¨ç›®æ ‡å¯¹è±¡æ–¹æ³•ä¸­å†æ¬¡è·å–ä»£ç†å¯¹è±¡å¯ä»¥ä½¿ç”¨è¿™ä¸ªAopContext.currentProxy()
     * è¿˜æœ‰çš„å°±æ˜¯äº‹åŠ¡æ–¹æ³•è°ƒç”¨äº‹åŠ¡æ–¹æ³•çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨åˆ°è¿™ä¸ª
     */</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// æŠŠæˆ‘ä»¬çš„ä»£ç†å¯¹è±¡æš´éœ²åœ¨çº¿ç¨‹å˜é‡ä¸­</span>
              oldProxy <span class="token operator">=</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
              setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Get as late as possible to minimize the time we &quot;own&quot; the target,</span>
          <span class="token comment">// in case it comes from a pool.</span>
    <span class="token comment">// è·å–è¢«ä»£ç†çš„ç›®æ ‡å¯¹è±¡</span>
          target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¢«ä»£ç†ç›®æ ‡å¯¹è±¡çš„class</span>
          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// æ ¹æ® advisors æ‰¾åˆ°æ–¹æ³•åŒ¹é…çš„advisorï¼Œç„¶åè§£ææˆ æ‹¦æˆªå™¨é“¾</span>
          <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Check whether we have any advice. If we don&#39;t, we can fallback on direct</span>
          <span class="token comment">// reflective invocation of the target, and avoid creating a MethodInvocation.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// We can skip creating a MethodInvocation: just invoke the target directly</span>
              <span class="token comment">// Note that the final invoker must be an InvokerInterceptor so we know it does</span>
              <span class="token comment">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span>
       <span class="token comment">// å¦‚æœæ‹¦æˆªå™¨é“¾ä¸ºç©º åå°„æ‰§è¡Œ</span>
              <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
              retVal <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// è£…é¥°è‡ª æ‹¦æˆªå™¨é“¾</span>
              <span class="token comment">// We need to create a method invocation...</span>
              <span class="token class-name">MethodInvocation</span> invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// Proceed to the joinpoint through the interceptor chain.</span>
       <span class="token comment">// è°ƒç”¨æ‰§è¡Œ</span>
              retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Massage return value if necessary.</span>
          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> returnType <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> retVal <span class="token operator">==</span> target <span class="token operator">&amp;&amp;</span> returnType <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span>
              <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">RawTargetAccess</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Special case: it returned &quot;this&quot; and the return type of the method</span>
              <span class="token comment">// is type-compatible. Note that we can&#39;t help if the target sets</span>
              <span class="token comment">// a reference to itself in another returned object.</span>
              retVal <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> returnType <span class="token operator">!=</span> <span class="token class-name">Void</span><span class="token punctuation">.</span><span class="token constant">TYPE</span> <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopInvocationException</span><span class="token punctuation">(</span>
                      <span class="token string">&quot;Null return value from advice does not match primitive return type for: &quot;</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Must have come from TargetSource.</span>
              targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// Restore old proxy.</span>
              <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è§£ææ‹¦æˆªå™¨é“¾" tabindex="-1"><a class="header-anchor" href="#è§£ææ‹¦æˆªå™¨é“¾" aria-hidden="true">#</a> è§£ææ‹¦æˆªå™¨é“¾</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">AdvisedSupport</span><span class="token operator">:</span>

<span class="token doc-comment comment">/**
 * å°† advisors ä¸­ method åŒ¹é…çš„ advisorï¼Œè§£ææˆ InterceptorAndDynamicMethodMatcherã€MethodInterceptor ç±»å‹çš„é›†åˆ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 *
 * é»˜è®¤ä½¿ç”¨è¿™ä¸ªå·¥å‚æ–¹æ³•æ¥ç”Ÿæˆ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisorChainFactory</span><span class="token punctuation">#</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Advised</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
 * è€Œè¿™ä¸ªå·¥å‚ä¼šä½¿ç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultAdvisorAdapterRegistry</span><span class="token punctuation">#</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token class-name">Advisor</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> æ¥è§£æ advisor <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 * æœ€ç»ˆä¼šå°† è§£æçš„ç»“æœï¼Œç¼“å­˜èµ·æ¥ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AdvisedSupport</span><span class="token punctuation">#</span><span class="token field">advisorChainFactory</span></span><span class="token punctuation">}</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">MethodCacheKey</span> cacheKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodCacheKey</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>methodCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°† advisors ä¸­ method åŒ¹é…çš„ advisorï¼Œè§£ææˆ InterceptorAndDynamicMethodMatcherã€MethodInterceptor ç±»å‹çš„é›†åˆ</span>
        cached <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorChainFactory<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>methodCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cached<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DefaultAdvisorChainFactory</span><span class="token operator">:</span>

<span class="token doc-comment comment">/**
 * å°† advisors ä¸­æ‰¾å‡º method åŒ¹é…çš„ advisorï¼Œè§£ææˆ InterceptorAndDynamicMethodMatcherã€MethodInterceptor ç±»å‹çš„é›†åˆ
 *
 * <span class="token keyword">@param</span> <span class="token parameter">config</span>      the AOP configuration in the form of an Advised object
 * <span class="token keyword">@param</span> <span class="token parameter">method</span>      the proxied method
 * <span class="token keyword">@param</span> <span class="token parameter">targetClass</span> the target class (may be <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span> to indicate a proxy without
 *                    target object, in which case the method&#39;s declaring class is the next best option)
 * <span class="token keyword">@return</span>
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span><span class="token class-name">Advised</span> config<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// This is somewhat tricky... We have to process introductions first,</span>
    <span class="token comment">// but we need to preserve order in the ultimate list.</span>
    <span class="token class-name">AdvisorAdapterRegistry</span> registry <span class="token operator">=</span> <span class="token class-name">GlobalAdvisorAdapterRegistry</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Advisor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> interceptorList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>advisors<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> actualClass <span class="token operator">=</span> <span class="token punctuation">(</span>targetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> targetClass <span class="token operator">:</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Boolean</span> hasIntroductions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor <span class="token operator">:</span> advisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Add it conditionally.</span>
            <span class="token class-name">PointcutAdvisor</span> pointcutAdvisor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> pointcutAdvisor<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>actualClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">MethodMatcher</span> mm <span class="token operator">=</span> pointcutAdvisor<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> match<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mm <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasIntroductions <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// ç±»åŒ¹é…</span>
                        hasIntroductions <span class="token operator">=</span> <span class="token function">hasMatchingIntroductions</span><span class="token punctuation">(</span>advisors<span class="token punctuation">,</span> actualClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// AspectJ åŒ¹é…</span>
                    match <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> mm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> actualClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// AspectJ åŒ¹é…</span>
                    match <span class="token operator">=</span> mm<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> actualClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°† advisor é€šè¿‡é€‚é…å™¨è§£ææˆ MethodInterceptor</span>
                    <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token doc-comment comment">/**
                     * æ˜¯è¿è¡Œæ—¶ã€‚è¯´ç™½äº†å°±æ˜¯éœ€è¦åœ¨æ‰§è¡Œçš„æ—¶å€™è¿›è¡ŒåŒ¹é…ï¼Œæ‰€ä»¥è¦æŠŠ MethodMatcher ä¼ å…¥
                     * æ¯”å¦‚@Aroundã€@Beforeã€@Afterã€@AfterThrowingã€@AfterReturningç”Ÿæˆçš„Advisor <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AspectJExpressionPointcut</span><span class="token punctuation">#</span><span class="token function">isRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                     * */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>mm<span class="token punctuation">.</span><span class="token function">isRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token doc-comment comment">/**
                         * è£…é¥°æˆ InterceptorAndDynamicMethodMatcher
                         * è¿™ä¸ªç±»å‹çš„ç‰¹ç‚¹æ˜¯ï¼Œæ‹¦æˆªå™¨æ‰§è¡Œæ—¶ä¼šæ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">MethodMatcher</span><span class="token punctuation">#</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>ï¼Œæ˜¯trueåœ¨æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">MethodInterceptor</span><span class="token punctuation">#</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                         *
                         * æ‰§è¡Œçš„ä»£ç  <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">#</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                         * */</span>
                        <span class="token comment">// Creating a new object instance in the getInterceptors() method</span>
                        <span class="token comment">// isn&#39;t a problem as we normally cache created chains.</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span> interceptor <span class="token operator">:</span> interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            interceptorList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">,</span> mm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        interceptorList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ç±»åŒ¹é…</span>
            <span class="token class-name">IntroductionAdvisor</span> ia <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> ia<span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>actualClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å°† advisor é€šè¿‡é€‚é…å™¨è§£ææˆ MethodInterceptor</span>
                <span class="token class-name">Interceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                interceptorList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å°† advisor é€šè¿‡é€‚é…å™¨è§£ææˆ MethodInterceptor</span>
            <span class="token class-name">Interceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getInterceptors</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            interceptorList<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> interceptorList<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DefaultAdvisorAdapterRegistry</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token class-name">Advisor</span> advisor<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnknownAdviceTypeException</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">&gt;</span></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Advice</span> advice <span class="token operator">=</span> advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advice <span class="token keyword">instanceof</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ˜¯è¿™ä¸ªç±»å‹å°±ç›´æ¥æ·»åŠ </span>
        interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> advice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * ä½¿ç”¨é€‚é…å™¨å°† advice è§£ææˆ MethodInterceptor
     * é»˜è®¤ MethodBeforeAdviceAdapterã€AfterReturningAdviceAdapterã€ThrowsAdviceAdapter æœ‰è¿™ä¸‰ä¸ªé€‚é…å™¨
     * */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AdvisorAdapter</span> adapter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adapters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>adapter<span class="token punctuation">.</span><span class="token function">supportsAdvice</span><span class="token punctuation">(</span>advice<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>adapter<span class="token punctuation">.</span><span class="token function">getInterceptor</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnknownAdviceTypeException</span><span class="token punctuation">(</span>advisor<span class="token punctuation">.</span><span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> interceptors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ‰§è¡Œæ‹¦æˆªå™¨é“¾" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œæ‹¦æˆªå™¨é“¾" aria-hidden="true">#</a> æ‰§è¡Œæ‹¦æˆªå™¨é“¾</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
<span class="token comment">// ä»-1å¼€å§‹,ä¸‹æ ‡=æ‹¦æˆªå™¨çš„é•¿åº¦-1çš„æ¡ä»¶æ»¡è¶³ è¡¨ç¤ºæ‰§è¡Œåˆ°äº†æœ€åä¸€ä¸ªæ‹¦æˆªå™¨çš„æ—¶å€™ï¼Œæ­¤æ—¶æ‰§è¡Œç›®æ ‡æ–¹æ³•</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// è¿™ä¸ª ++ å¾ˆå…³é”®ï¼Œå› ä¸º proceed() æ˜¯é€’å½’æ‰§è¡Œçš„ï¼Œé€šè¿‡ç´¢å¼•è‡ªå¢ å®ç°äº†æ‹¦æˆªå™¨é“¾çš„é¡ºåºæ‰§è¡Œ</span>
      <span class="token class-name">Object</span> interceptorOrInterceptionAdvice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Evaluate dynamic method matcher here: static part will already have</span>
          <span class="token comment">// been evaluated and found to match.</span>
          <span class="token class-name">InterceptorAndDynamicMethodMatcher</span> dm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">;</span>
          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetClass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetClass <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>dm<span class="token punctuation">.</span>methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> dm<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// Dynamic matching failed.</span>
              <span class="token comment">// Skip this interceptor and invoke the next in the chain.</span>
              <span class="token keyword">return</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// It&#39;s an interceptor, so we just invoke it: The pointcut will have</span>
          <span class="token comment">// been evaluated statically before this object was constructed.</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘  ExposeInvocationInterceptor.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">MethodInvocation</span> oldInvocation <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        invocation<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>mi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            invocation<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>oldInvocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¡ AspectJAfterThrowingAdvice.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ‰§è¡Œä¸‹ä¸€ä¸ªé€šçŸ¥/æ‹¦æˆªå™¨</span>
            <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æŠ›å‡ºå¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldInvokeOnThrowing</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ‰§è¡Œå¼‚å¸¸é€šçŸ¥</span>
                <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¢ AfterReturningAdviceInterceptor.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ‰§è¡Œä¸‹ä¸€ä¸ªé€šçŸ¥/æ‹¦æˆªå™¨</span>
        <span class="token class-name">Object</span> retVal <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è¿”å›é€šçŸ¥æ–¹æ³•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">afterReturning</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘£ AspectJAfterAdvice.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ‰§è¡Œä¸‹ä¸€ä¸ªé€šçŸ¥/æ‹¦æˆªå™¨</span>
            <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//åç½®é€šçŸ¥çš„æ–¹æ³•æ€»æ˜¯ä¼šè¢«æ‰§è¡Œ åŸå› å°±åœ¨è¿™finally</span>
            <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¤ AspectJAroundAdvice.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>mi <span class="token keyword">instanceof</span> <span class="token class-name">ProxyMethodInvocation</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;MethodInvocation is not a Spring ProxyMethodInvocation: &quot;</span> <span class="token operator">+</span> mi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ProxyMethodInvocation</span> pmi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ProxyMethodInvocation</span><span class="token punctuation">)</span> mi<span class="token punctuation">;</span>
        <span class="token class-name">ProceedingJoinPoint</span> pjp <span class="token operator">=</span> <span class="token function">lazyGetProceedingJoinPoint</span><span class="token punctuation">(</span>pmi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JoinPointMatch</span> jpm <span class="token operator">=</span> <span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span>pmi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> jpm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â‘¥ MethodBeforeAdviceInterceptor.invokeæ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ‰§è¡Œå‰ç½®é€šçŸ¥çš„æ–¹æ³•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ‰§è¡Œä¸‹ä¸€ä¸ªé€šçŸ¥/æ‹¦æˆªå™¨ï¼Œä½†æ˜¯è¯¥æ‹¦æˆªå™¨æ˜¯æœ€åä¸€ä¸ªäº†ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ç›®æ ‡æ–¹æ³•</span>
        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/springboot4/edit/main/src/source-code/spring/SpringAop.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2235602974@qq.com">ä»˜ç»ªå£®</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/offer/source-code/spring/Spring@Async.html" class="nav-link prev" aria-label="springå¼‚æ­¥@Async"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->springå¼‚æ­¥@Async</div></a><a href="/offer/source-code/spring/SpringBeanLIfeCycle.html" class="nav-link next" aria-label="spring beançš„ç”Ÿå‘½å‘¨æœŸ"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">spring beançš„ç”Ÿå‘½å‘¨æœŸ<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/offer/assets/app-fdefc158.js" defer></script>
  </body>
</html>
