<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?87d678935e4b33455c0390543e7a759d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><title>springé…ç½®æ–‡ä»¶ | æ€¨ç§å­¦java</title><meta name="description" content="ã€Œæµæ°´ä¸äº‰å…ˆ äº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/offer/assets/style-1e9048c3.css" as="style"><link rel="stylesheet" href="/offer/assets/style-1e9048c3.css">
    <link rel="modulepreload" href="/offer/assets/app-fdefc158.js"><link rel="modulepreload" href="/offer/assets/framework-8edddef6.js"><link rel="modulepreload" href="/offer/assets/SpringConfig.html-0d7db6df.js"><link rel="modulepreload" href="/offer/assets/SpringConfig.html-08a9d97a.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/offer/" class="brand"><img class="logo" src="/offer/logo.png" alt="æ€¨ç§å­¦java"><!----><span class="site-name hide-in-pad">æ€¨ç§å­¦java</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link" aria-label="ç¬”è®°"><span class="font-icon icon iconfont icon-activity" style=""></span>ç¬”è®°<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/offer/offer-started.html" class="nav-link" aria-label="å…«è‚¡"><span class="font-icon icon iconfont icon-shell" style=""></span>å…«è‚¡<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/link.html" class="nav-link" aria-label="å¤–éƒ¨é“¾æ¥"><span class="font-icon icon iconfont icon-share" style=""></span>å¤–éƒ¨é“¾æ¥<!----></a></div><div class="nav-item hide-in-mobile"><a href="/offer/about.html" class="nav-link" aria-label="å…³äºä½œè€…"><span class="font-icon icon iconfont icon-alias" style=""></span>å…³äºä½œè€…<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/springboot4" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-software" style=""></span><span class="title">nacos</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/nacos/clusterSync.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé›†ç¾¤åŒæ­¥"><!---->nacosé›†ç¾¤åŒæ­¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/config.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosé…ç½®ä¸­å¿ƒ"><!---->nacosé…ç½®ä¸­å¿ƒ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/discoverAndSubscribe.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶"><!---->nacosæœåŠ¡å‘ç°å’Œè®¢é˜…æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/healthCheck.html" class="nav-link sidebar-link sidebar-page" aria-label="nacoså¥åº·æ£€æŸ¥æœºåˆ¶"><!---->nacoså¥åº·æ£€æŸ¥æœºåˆ¶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/nacos/register.html" class="nav-link sidebar-link sidebar-page" aria-label="nacosæœåŠ¡æ³¨å†Œ"><!---->nacosæœåŠ¡æ³¨å†Œ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading active"><span class="font-icon icon iconfont icon-alias" style=""></span><span class="title">spring</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/spring/SpingInject.html" class="nav-link sidebar-link sidebar-page" aria-label="spingä¾èµ–æ³¨å…¥"><!---->spingä¾èµ–æ³¨å…¥<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/Spring@Async.html" class="nav-link sidebar-link sidebar-page" aria-label="springå¼‚æ­¥@Async"><!---->springå¼‚æ­¥@Async<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringAop.html" class="nav-link sidebar-link sidebar-page" aria-label="spring aop"><!---->spring aop<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringBeanLIfeCycle.html" class="nav-link sidebar-link sidebar-page" aria-label="spring beançš„ç”Ÿå‘½å‘¨æœŸ"><!---->spring beançš„ç”Ÿå‘½å‘¨æœŸ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="springé…ç½®æ–‡ä»¶"><!---->springé…ç½®æ–‡ä»¶<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#ç›¸å…³ç±»" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ç›¸å…³ç±»"><!---->ç›¸å…³ç±»<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#configurationclasspostprocessor" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="ConfigurationClassPostProcessor"><!---->ConfigurationClassPostProcessor<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#é…ç½®ç±»è§£ææµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="é…ç½®ç±»è§£ææµç¨‹"><!---->é…ç½®ç±»è§£ææµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#é…ç½®ç±»å¢å¼ºæµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="é…ç½®ç±»å¢å¼ºæµç¨‹"><!---->é…ç½®ç±»å¢å¼ºæµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹"><!---->æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«"><!---->liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a href="/offer/source-code/spring/SpringTransaction.html" class="nav-link sidebar-link sidebar-page" aria-label="springäº‹åŠ¡"><!---->springäº‹åŠ¡<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-template" style=""></span><span class="title">spring boot</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringBoot/config.html" class="nav-link sidebar-link sidebar-page" aria-label="spring booté…ç½®åŠ è½½"><!---->spring booté…ç½®åŠ è½½<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringBoot/start.html" class="nav-link sidebar-link sidebar-page" aria-label="spring bootå¯åŠ¨æµç¨‹"><!---->spring bootå¯åŠ¨æµç¨‹<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><p class="sidebar-heading"><span class="font-icon icon iconfont icon-module" style=""></span><span class="title">spring cloud</span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/offer/source-code/SpringCloudCommon/configRefresh.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudé…ç½®åŠ¨æ€åˆ·æ–°"><!---->spring cloudé…ç½®åŠ¨æ€åˆ·æ–°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/loadBalancing.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloud loadBalanced"><!---->spring cloud loadBalanced<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/offer/source-code/SpringCloudCommon/registerAndDiscover.html" class="nav-link sidebar-link sidebar-page" aria-label="spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°"><!---->spring cloudæœåŠ¡æ³¨å†Œå’Œå‘ç°<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->springé…ç½®æ–‡ä»¶</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://fxzcloud.gitee.io/offer/" target="_blank" rel="noopener noreferrer">fxz</a></span><span property="author" content="fxz"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-02-29T07:03:48.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 69 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT69M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#ç›¸å…³ç±»" class="router-link-active router-link-exact-active toc-link level2">ç›¸å…³ç±»</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#configurationclasspostprocessor" class="router-link-active router-link-exact-active toc-link level2">ConfigurationClassPostProcessor</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#é…ç½®ç±»è§£ææµç¨‹" class="router-link-active router-link-exact-active toc-link level3">é…ç½®ç±»è§£ææµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#é…ç½®ç±»å¢å¼ºæµç¨‹" class="router-link-active router-link-exact-active toc-link level3">é…ç½®ç±»å¢å¼ºæµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹" class="router-link-active router-link-exact-active toc-link level3">æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/offer/source-code/spring/SpringConfig.html#liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«" class="router-link-active router-link-exact-active toc-link level3">liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="springé…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#springé…ç½®æ–‡ä»¶" aria-hidden="true">#</a> springé…ç½®æ–‡ä»¶</h1><h2 id="ç›¸å…³ç±»" tabindex="-1"><a class="header-anchor" href="#ç›¸å…³ç±»" aria-hidden="true">#</a> ç›¸å…³ç±»</h2><ul><li><code>@Configuration</code>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Šï¼Œè¡¨ç¤ºè¯¥ç±»æ˜¯ä¸ªFullæ¨¡å¼çš„é…ç½®ç±»ã€‚è‡ªSpring 5.2.0ç‰ˆæœ¬åå®ƒåŠ äº†ä¸ª<code>proxyBeanMethods</code>å±æ€§æ¥æ˜¾ç¤ºæ§åˆ¶Fullæ¨¡å¼è¿˜æ˜¯Liteæ¨¡å¼ï¼Œé»˜è®¤æ˜¯trueè¡¨ç¤ºFullæ¨¡å¼ã€‚</li><li><code>@Bean</code>ï¼šæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šï¼Œè¡¨ç¤ºæ–¹æ³•ç”Ÿæˆä¸€ä¸ªç”±Springå®¹å™¨ç®¡ç†çš„Beanã€‚</li><li><code>ConfigurationClassPostProcessor</code>ï¼šç”¨äºå¼•å¯¼å¤„ç†@Configurationé…ç½®ç±»çš„åç½®å¤„ç†å™¨ã€‚æ³¨æ„ï¼šå®ƒåªæ˜¯<strong>å¼•å¯¼å¤„ç†</strong>ï¼Œå¹¶ä¸æ˜¯å®é™…å¤„ç†ã€‚</li><li><code>ConfigurationClassUtils</code>ï¼šå†…éƒ¨å·¥å…·ç±»ã€‚ç”¨äºåˆ¤æ–­ç»„ä»¶æ˜¯å¦æ˜¯é…ç½®ç±»ï¼Œåˆæˆ–æ˜¯Fullæ¨¡å¼/Liteæ¨¡å¼ï¼Œç„¶ååœ¨bdå…ƒæ•°æ®é‡Œæ‰“ä¸Šæ ‡è®°ã€‚å®ƒè¿˜ä¼šå¤„ç†ä¸€ä»¶å°äº‹ï¼šè·å–@Configurationé…ç½®ç±»ä¸Šæ ‡æ³¨çš„@Orderæ’åºå€¼å¹¶æ”¾è¿›bdé‡Œã€‚</li><li><code>BeanMethod</code>ï¼šå†…éƒ¨ä½¿ç”¨çš„ç±»ã€‚ç”¨äºå°è£…æ ‡æ³¨æœ‰@Beanæ³¨è§£çš„æ–¹æ³•ã€‚</li><li><code>ConfigurationClass</code>ï¼šå†…éƒ¨ä½¿ç”¨çš„ç±»ã€‚æ¯ä¸€ä¸ª@Configurationé…ç½®ç±»éƒ½ä¼šè¢«å°è£…ä¸ºå®ƒï¼Œå†…éƒ¨ä¼šåŒ…å«å¤šä¸ª@Beanæ–¹æ³•ï¼ˆBeanMethodï¼‰ã€‚</li><li><code>ConfigurationClassParser</code>ï¼šè§£æ@Configurationé…ç½®ç±»ï¼Œæœ€ç»ˆä»¥ConfigurationClasså¯¹è±¡çš„å½¢å¼å±•ç¤ºï¼Œå¹¶ä¸”å¡«å……å®ƒï¼šå› ä¸ºä¸€ä¸ªé…ç½®ç±»å¯ä»¥<code>@Import</code>å¯¼å…¥å¦å¤–ä¸€ä¸ªï¼ˆæˆ–è€…Nå¤šä¸ªï¼‰å…¶å®ƒé…ç½®ç±»ï¼Œæ‰€ä»¥éœ€è¦å¡«å……ã€‚</li><li><code>ConfigurationClassBeanDefinitionReader</code>ï¼šå†…éƒ¨ä½¿ç”¨çš„ç±»ã€‚è¯»å–ç»™å®šçš„å·²ç»è§£æå¥½çš„<code>Set&lt;ConfigurationClass&gt;</code>é›†åˆï¼ŒæŠŠé‡Œé¢çš„bdä¿¡æ¯æ³¨å†Œåˆ°<code>BeanDefinitionRegistry</code>é‡Œå»ï¼ˆè¿™é‡Œå†³å®šäº†bdçš„æœ‰åºå’Œæ— åºç›¸å…³é—®é¢˜ï¼‰ã€‚</li><li><code>ConfigurationClassEnhancer</code>ï¼šå†…éƒ¨ä½¿ç”¨çš„ç±»ã€‚é…ç½®ç±»å¢å¼ºå™¨ï¼Œç”¨äºå¯¹@Configurationç±»ï¼ˆFullæ¨¡å¼ï¼‰ä½¿ç”¨CGLIBå¢å¼ºï¼Œç”Ÿæˆä¸€ä¸ªä»£ç†å­ç±»å­—èŠ‚ç Classå¯¹è±¡ã€‚</li><li><code>EnhancedConfiguration</code>ï¼šè¢«å¢å¼ºå™¨å¢å¼ºè¿‡çš„é…ç½®ç±»ï¼Œéƒ½ä¼šè‡ªåŠ¨çš„è®©å®ç°æ­¤æ¥å£ï¼ˆå®é™…æ˜¯ä¸ª<code>BeanFactoryAware</code>ï¼‰æ¥å£ã€‚</li><li><code>SpringNamingPolicy</code>ï¼šä½¿ç”¨CGLIBç”Ÿæˆå­—èŠ‚ç ç±»ååç§°ç”Ÿæˆç­–ç•¥ -&gt; åç§°ä¸­ä¼šæœ‰<code>BySpringCGLIB</code>å­—æ ·ã€‚</li><li><code>BeanFactoryAwareMethodInterceptor</code>ï¼šCGLIBä»£ç†å¯¹è±¡æ‹¦æˆªå™¨ã€‚ä½œç”¨ï¼šæ‹¦æˆªä»£ç†ç±»çš„<code>setBeanFactory()</code>æ–¹æ³•ï¼Œç»™å¯¹åº”å±æ€§èµ‹å€¼ã€‚</li><li><code>BeanMethodInterceptor</code>ï¼šCGLIBä»£ç†å¯¹è±¡æ‹¦æˆªå™¨ã€‚ä½œç”¨ï¼šæ‹¦æˆªæ‰€æœ‰@Beanæ–¹æ³•çš„æ‰§è¡Œï¼Œä»¥æ”¯æŒå¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨@Beanæ–¹æ³•æ¥ç®¡ç†ä¾èµ–å…³ç³»ï¼ˆå½“ç„¶ä¹Ÿæ”¯æŒ<code>FactoryBean</code>æ¨¡å¼ï¼‰ã€‚</li></ul><h2 id="configurationclasspostprocessor" tabindex="-1"><a class="header-anchor" href="#configurationclasspostprocessor" aria-hidden="true">#</a> ConfigurationClassPostProcessor</h2><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/29/UE3kw3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="é…ç½®ç±»è§£ææµç¨‹" tabindex="-1"><a class="header-anchor" href="#é…ç½®ç±»è§£ææµç¨‹" aria-hidden="true">#</a> é…ç½®ç±»è§£ææµç¨‹</h3><p><strong>é…ç½®ç±»çš„è§£æå‡æ˜¯äº¤ç”±<code>ConfigurationClassPostProcessor</code>æ¥å¼•å¯¼</strong>ã€‚åœ¨Spring Frameworké‡Œï¼ˆéSpring Bootï¼‰é‡Œï¼Œå®ƒæ˜¯<code>BeanDefinitionRegistryPostProcessor</code>å¤„ç†å™¨çš„<strong>å”¯ä¸€</strong>å®ç°ç±»ï¼Œç”¨äºå¼•å¯¼å¤„ç†<code>@Configuration</code>é…ç½®ç±»ã€‚è§£æå…¥å£æ˜¯<code>postProcessBeanDefinitionRegistry()</code>æ–¹æ³•ï¼Œå®é™…å¤„ç†å§”æ‰˜ç»™äº†<code>processConfigBeanDefinitions()</code>æ–¹æ³•ã€‚</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/30/SvepsB.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="configurationclasspostprocessor-1" tabindex="-1"><a class="header-anchor" href="#configurationclasspostprocessor-1" aria-hidden="true">#</a> ConfigurationClassPostProcessor</h4><p>ä»æ³¨å†Œè¿›æ¥çš„é…ç½®ç±»ï¼ˆå¯èƒ½æ˜¯Fullæ¨¡å¼ï¼Œå¯èƒ½æ˜¯Liteæ¨¡å¼ï¼‰é‡Œè¿›ä¸€æ­¥æ´¾ç”Ÿbeanå®šä¹‰ã€‚ç®€è€Œè¨€ä¹‹ï¼šæ”¶é›†åˆ°æ‰€æœ‰çš„<code>BeanDefinition</code>ï¼ˆåç®€ç§°ä¸ºbdï¼‰å­˜å‚¨èµ·æ¥ï¼ŒåŒ…æ‹¬<code>@Importã€@Component</code>ç­‰ç­‰ç»„ä»¶ã€‚<strong>å¹¶ä¸”åšå‡ºæ ‡æ³¨ï¼šæ˜¯Fullæ¨¡å¼çš„è¿˜æ˜¯Liteæ¨¡å¼çš„é…ç½®ç±»</strong>ï¼ˆè‹¥éé…ç½®ç»„ä»¶å°±ä¸æ ‡æ³¨ï¼‰ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConfigurationClassPostProcessor</span>ï¼š

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanDefinitionRegistry</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç”Ÿæˆä¸€ä¸ªidï¼Œæ”¾ç½®åé¢å†é‡å¤æ‰§è¡Œ</span>
        <span class="token keyword">int</span> registryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è‹¥é‡å¤æ‰§è¡Œ  å°±æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¡¨ç¤ºæ­¤registryé‡Œçš„bdæ”¶é›†åŠ¨ä½œï¼Œå·²ç»åšäº†  é¿å…å†é‡å¤æ”¶é›†æ­¤registry</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>registryId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ ¹æ®é…ç½®ç±»ï¼Œæ”¶é›†åˆ°æ‰€æœ‰çš„bdä¿¡æ¯ å¹¶ä¸”åšå‡ºmarkæ ‡æ³¨ï¼šæ˜¯Fullæ¨¡å¼è¿˜æ˜¯Liteæ¨¡å¼ï¼Œå¾ˆé‡è¦</span>
        <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token doc-comment comment">/**
 * æ ¹æ®é…ç½®ç±»ï¼Œæ”¶é›†åˆ°æ‰€æœ‰çš„bdä¿¡æ¯ å¹¶ä¸”åšå‡ºmarkæ ‡æ³¨ï¼šæ˜¯Fullæ¨¡å¼è¿˜æ˜¯Liteæ¨¡å¼ï¼Œå¾ˆé‡è¦
 * Build and validate a configuration model based on the registry of
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Configuration</span></span><span class="token punctuation">}</span> classes.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * 1. å¯åŠ¨æ—¶ä¼ å…¥çš„é…ç½®ç±»ä¼šæ³¨å†Œåˆ°å®¹å™¨ä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">#</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * 2. BeanFactoryPostProcessorã€BeanDefinitionRegistryPostProcessor é‡Œé¢æ³¨å†Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractApplicationContext</span><span class="token punctuation">#</span><span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> candidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> candidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BeanDefinition</span> beanDef <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">// Bean å®šä¹‰å·²ä½œä¸ºé…ç½®ç±»è¿›è¡Œå¤„ç†</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> <span class="token operator">+</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * åˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®ç±»
         * æœ‰ @Configuration(proxyBeanMethods=true) fullé…ç½®ç±»
         * æœ‰ @Configuration(proxyBeanMethods=false) liteé…ç½®ç±»
         * æ—  @Configuration ä½†æ˜¯æœ‰  (@Component || @ComponentScan || @Import || @ImportResource || @Bean ) liteé…ç½®ç±»
         *
         * æ˜¯é…ç½®ç±»ï¼Œè¿˜ä¼šè§£æ @Order æ³¨è§£çš„å€¼ï¼Œè®¾ç½®åˆ° BeanDefinition ä¸­ã€‚ç›®çš„æ˜¯åé¢é…ç½®ç±»æ’åº
         * */</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            configCandidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>beanDef<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//å¦‚æœæœªæ‰¾åˆ°@Configurationç±»ï¼Œè¯·ç«‹å³è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é€šè¿‡ Orderå¯ä»¥æ’åºï¼Œå‡åºæ’åºï¼Œ orderè¶Šå°è¶Šé å‰ã€‚
     * å¯ä»¥åœ¨é…ç½®ç±»ä¸Šæ ‡æ³¨ @Orderï¼Œè°ƒæ•´é…ç½®ç±»çš„è§£æé¡ºåºã€‚
     * å‡åºæ’åˆ—ã€‚
     * */</span>
    <span class="token comment">// Sort by previously determined @Order value, if applicable</span>
    configCandidates<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bd1<span class="token punctuation">,</span> bd2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd1<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>bd2<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>i1<span class="token punctuation">,</span> i2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//æ£€æµ‹é€šè¿‡å°é—­çš„åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡æä¾›çš„ä»»ä½•è‡ªå®šä¹‰ Bean åç§°ç”Ÿæˆç­–ç•¥</span>
    <span class="token class-name">SingletonBeanRegistry</span> sbr <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>registry <span class="token keyword">instanceof</span> <span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sbr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SingletonBeanRegistry</span><span class="token punctuation">)</span> registry<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>localBeanNameGeneratorSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¯ä»¥é¢„å…ˆå¾€å•ä¾‹æ± ä¸­æ·»åŠ ä¸€ä¸ª CONFIGURATION_BEAN_NAME_ GENERATORçš„ BeanNameGeneratorç±»å‹çš„bean</span>
            <span class="token comment">// å¯ä»¥ç”¨æ¥ä½œä¸ºæ‰«æå¾—åˆ°çš„Beanå’Œ importå¯¼å…¥è¿›æ¥çš„Beançš„ beanName</span>
            <span class="token class-name">BeanNameGenerator</span> generator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanNameGenerator</span><span class="token punctuation">)</span> sbr<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_BEAN_NAME_GENERATOR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>generator <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator <span class="token operator">=</span> generator<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è§£ææ¯ä¸ª@Configurationç±»</span>
    <span class="token class-name">ConfigurationClassParser</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanBeanNameGenerator<span class="token punctuation">,</span> registry<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> alreadyParsed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>configCandidates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token class-name">StartupStep</span> processConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationStartup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;spring.context.config-classes.parse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         * è§£æé…ç½®ç±»ï¼Œä¼šæŠŠæ¯ä¸ª BeanDefinitionHolder è§£æä¸º ConfigurationClass
         * ä¼šè§£æ @Beanã€@Componentã€@ComponentScanã€@ComponentScansã€@Importã€@ImportResource ä¹Ÿå°±æ˜¯ä¼šè§£æå‡ºé…ç½®ç±»é‡Œé¢çš„é…ç½®ç±»ã€‚é€’å½’è§£æ
         *
         * è§£æå®Œ configClassesï¼Œç»“æœæ˜¯ï¼š
         *  1. @Bean æ ‡æ³¨çš„æ–¹æ³•ï¼Œ  --&gt; beanMethodså±æ€§
         *  2. @ImportResource  --&gt; importedResourceså±æ€§
         *  3. @Import(ImportBeanDefinitionRegistrar.class)  --&gt; importBeanDefinitionRegistrarså±æ€§ï¼Œåé¢ä¼šå›è°ƒæ–¹æ³•
         *  4. @Import(ImportSelector.class) --&gt; æ‰§è¡Œ ImportSelector#selectImportsï¼Œè¿”å›å€¼éƒ½è§£ææˆé…ç½®ç±»
         *  5. @Import() --&gt; è§£ææˆconfigClass
         *  6. @Import(DeferredImportSelector.class) --&gt; deferredImportSelectorHandler
         *
         *  æ³¨ï¼š
         *  1. ä½¿ç”¨ @Import å¯¼å…¥çš„ç±»ä¸€å®šæ˜¯é…ç½®ç±»
         *  2. @Import(DeferredImportSelector.class) ä¼šå»¶æ—¶è§£æï¼ŒSpringBoot çš„è‡ªåŠ¨è½¬é… å°±æ˜¯é€šè¿‡è¿™ä¸ªæœºåˆ¶å®ç°çš„ã€‚é€šè¿‡å»¶æ—¶è§£æä¿è¯ @ConditionalOnXx æ³¨è§£èƒ½æ­£ç¡®åˆ¤æ–­
         */</span>
        parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// AppConfig.class ---&gt; BeanDefinition</span>
        parser<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// configClasses ç›¸å½“äºå°±æ˜¯è§£æä¹‹åçš„ç»“æœ</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">getConfigurationClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configClasses<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>alreadyParsed<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Read the model and create bean definitions based on its content</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassBeanDefinitionReader</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sourceExtractor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator<span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         *  ã€@Bean ç¬¬ä¸‰æ­¥ã€‘å› ä¸ºè§£æå®Œçš„ configClasses é‡Œé¢ä¼šè®°å½• @Beanæ ‡æ³¨çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¢«ç§°ä¸º factoryMethod
         *  ä¼šåœ¨ä¸‹é¢çš„æ–¹æ³•æ³¨å†Œæˆ beanDefinition
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        alreadyParsed<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        processConfig<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token string">&quot;classCount&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>configClasses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        candidates<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> candidateNames<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newCandidateNames <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> oldCandidateNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>candidateNames<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> alreadyParsedClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configurationClass <span class="token operator">:</span> alreadyParsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>configurationClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> candidateName <span class="token operator">:</span> newCandidateNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldCandidateNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> registry<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>candidateName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>alreadyParsedClasses<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>bd<span class="token punctuation">,</span> candidateName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            candidateNames <span class="token operator">=</span> newCandidateNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ³¨å†Œ è®°å½•äº†@Import(A.classï¼‰çš„ä¿¡æ¯åˆ°BeanFactoryä¸­ï¼Œåœ¨è¿™é‡Œä¼šç”¨åˆ°
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ImportAwareBeanPostProcessor</span><span class="token punctuation">#</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sbr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sbr<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sbr<span class="token punctuation">.</span><span class="token function">registerSingleton</span><span class="token punctuation">(</span><span class="token constant">IMPORT_REGISTRY_BEAN_NAME</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">getImportRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory <span class="token keyword">instanceof</span> <span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
        <span class="token comment">// for a shared cache since it&#39;ll be cleared by the ApplicationContext.</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CachingMetadataReaderFactory</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="configurationclassutils" tabindex="-1"><a class="header-anchor" href="#configurationclassutils" aria-hidden="true">#</a> ConfigurationClassUtils</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConfigurationClassUtils</span><span class="token operator">:</span>

<span class="token doc-comment comment">/**
*  æ£€æŸ¥ç»™å®šçš„ bean å®šä¹‰æ˜¯å¦æ˜¯é…ç½®ç±»çš„å€™é€‰è€…
 * ï¼ˆæˆ–åœ¨é…ç½®/ç»„ä»¶ç±»ä¸­å£°æ˜çš„åµŒå¥—ç»„ä»¶ç±»ï¼Œ
 * ä¹Ÿè¦è‡ªåŠ¨æ³¨å†Œï¼‰ï¼Œå¹¶ç›¸åº”åœ°æ ‡è®°å®ƒã€‚
 * <span class="token keyword">@param</span> <span class="token parameter">beanDef</span> è¦æ£€æŸ¥çš„ bean å®šä¹‰
 * <span class="token keyword">@param</span> <span class="token parameter">metadataReaderFactory</span> è°ƒç”¨æ–¹å½“å‰ä½¿ç”¨çš„å·¥å‚
 * <span class="token keyword">@return</span> å€™é€‰äººæ˜¯å¦æœ‰èµ„æ ¼æˆä¸ºï¼ˆä»»ä½•ç±»å‹çš„ï¼‰é…ç½®ç±»
 */</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>
       <span class="token class-name">BeanDefinition</span> beanDef<span class="token punctuation">,</span> <span class="token class-name">MetadataReaderFactory</span> metadataReaderFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token class-name">String</span> className <span class="token operator">=</span> beanDef<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> beanDef<span class="token punctuation">.</span><span class="token function">getFactoryMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span> <span class="token operator">&amp;&amp;</span>
          className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Can reuse the pre-parsed metadata from the given BeanDefinition...</span>
       metadata <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// Check already loaded Class if present...</span>
       <span class="token comment">// since we possibly can&#39;t even load the class file for this Class.</span>
       <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token class-name">BeanPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token class-name">AopInfrastructureBean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token class-name">EventListenerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       metadata <span class="token operator">=</span> <span class="token class-name">AnnotationMetadata</span><span class="token punctuation">.</span><span class="token function">introspect</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token class-name">MetadataReader</span> metadataReader <span class="token operator">=</span> metadataReaderFactory<span class="token punctuation">.</span><span class="token function">getMetadataReader</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
          metadata <span class="token operator">=</span> metadataReader<span class="token punctuation">.</span><span class="token function">getAnnotationMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Could not find class file for introspecting configuration annotations: &quot;</span> <span class="token operator">+</span>
                   className<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> config <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">getAnnotationAttributes</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;proxyBeanMethods&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// full é…ç½®ç±»</span>
       beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token constant">CONFIGURATION_CLASS_FULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>config <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isConfigurationCandidate</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// lite é…ç½®ç±»</span>
       beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token constant">CONFIGURATION_CLASS_LITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// It&#39;s a full or lite configuration candidate... Let&#39;s determine the order value, if any.</span>
    <span class="token class-name">Integer</span> order <span class="token operator">=</span> <span class="token function">getOrder</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// è®¾ç½®æ’åºå€¼</span>
       beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token constant">ORDER_ATTRIBUTE</span><span class="token punctuation">,</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="configurationclassparser" tabindex="-1"><a class="header-anchor" href="#configurationclassparser" aria-hidden="true">#</a> ConfigurationClassParser</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ConfigurationClassParser</span><span class="token operator">:</span> 

<span class="token doc-comment comment">/**
 * é…ç½®ç±»è§£æ
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> configCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * åŠ è½½å®Œæ‰€æœ‰çš„é…ç½®ç±»é‡Œé¢çš„ä¿¡æ¯ã€‚
         * è¿™é‡Œä¼šè§£æçš„å†…å®¹æ˜¯ï¼š
         * 1. @Component
         *      1.1 è·å–æ‰€æœ‰çš„æˆå‘˜å†…éƒ¨ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processMemberClasses</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">SourceClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      1.2 åˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">#</span><span class="token function">isConfigurationCandidate</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      1.3 é€’å½’è§£æ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * 2. @PropertySources
         *
         * 3. @ComponentScansã€@ComponentScan
         *      3.1 æ‰«ææŒ‡å®šåŒ…çš„å†…å®¹ï¼Œå¹¶æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ComponentScanAnnotationParser</span><span class="token punctuation">#</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      3.2 åˆ¤æ–­æ˜¯å¦æ˜¯é…ç½®ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">#</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">,</span> <span class="token class-name">MetadataReaderFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      3.3 æ˜¯é…ç½®ç±»ï¼Œå°±è§£æé…ç½®ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * 4. @Import(éDeferredImportSelectorçš„ç±»)    --&gt; é€’å½’è°ƒç”¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      å¤„ç† @Import(selector.class)ï¼Œæœ€ç»ˆçš„ç»“æœéƒ½æ˜¯æŒ‰ç…§é…ç½®ç±»æ¥è§£æ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processImports</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">SourceClass</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      4.1 selector instanceof DeferredImportSelector ã€‚å…ˆå­˜èµ·æ¥ï¼Œè¿™ç§ç±»å‹éœ€è¦å»¶æ—¶è§£æ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DeferredImportSelectorHandler</span><span class="token punctuation">#</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">DeferredImportSelector</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      4.2 selector instanceof ImportSelectorã€‚é€’å½’è§£æImport <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processImports</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">SourceClass</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      4.3 select instanceof ImportBeanDefinitionRegistrarã€‚è®¾ç½®ä¸º configClass çš„å±æ€§ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span><span class="token punctuation">#</span><span class="token function">addImportBeanDefinitionRegistrar</span><span class="token punctuation">(</span><span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">,</span> <span class="token class-name">AnnotationMetadata</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      4.4 å…œåº•æ–¹æ³•,è¿™ä¸ªå°±æ˜¯å…³é”®ï¼Œé€šè¿‡è¿™å°±èƒ½çœ‹å‡º æ‰€æœ‰@Importå¯¼å…¥çš„ç±»ï¼Œéƒ½ä¼šè¢«è§£ææˆé…ç½®ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         *      å¯ä»¥å‘ç° @Import(DeferredImportSelector.class) æ²¡æœ‰ç«‹å³è§£æï¼Œè€Œæ˜¯å…ˆå­˜èµ·æ¥ å¸¦æ‰€æœ‰é…ç½®ç±»è§£æå®Œä¹‹åã€‚åœ¨éå† å›è°ƒæ¥å£æ–¹æ³•ï¼Œé€’å½’æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processImports</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">SourceClass</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *      è™½ç„¶ @Import(ImportBeanDefinitionRegistrar.class) ä¹Ÿæ˜¯å­˜èµ·æ¥ï¼Œä½†æ˜¯ä»–æ˜¯ä½œä¸º configClassçš„å±æ€§ï¼Œåé¢æ³¨å†ŒBeanDefinitionçš„æ—¶å€™ï¼Œç›´æ¥å›è°ƒæ–¹æ³•ã€‚ä¸åƒ
         *          @Import(DeferredImportSelector.class) è¿˜ä¼šè§£æå›è°ƒçš„ç»“æœ
         *
         * 6. @ImportResource
         *      è®¾ç½®ä¸º configClass çš„å±æ€§ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span><span class="token punctuation">#</span><span class="token function">addImportedResource</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * 7. @Bean
         *      è®¾ç½®ä¸º configClass çš„å±æ€§ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span><span class="token punctuation">#</span><span class="token function">addBeanMethod</span><span class="token punctuation">(</span><span class="token class-name">BeanMethod</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *
         * 8. æœ‰çˆ¶ç±»ï¼Œä¸”çˆ¶ç±»å«æœ‰@Beanæ–¹æ³•
         *      8.1 knownSuperclasses.put(superclass, configClass);  è®°å½•çˆ¶ç±»è¢«åŠ è½½äº†ï¼Œé¿å…å¤šä¸ªå­ç±»æ˜¯é…ç½®ç±»çš„æƒ…å†µ å…¶çˆ¶ç±»é…ç½®ç±»ä¼šè¢«è§£æå¤šæ¬¡çš„é—®é¢˜
         *      8.2 è¿”å›çˆ¶ç±»
         *      8.2 å› ä¸ºæ˜¯ do...while æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">SourceClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *          æ‰€ä»¥å®ç°äº†é€’å½’è§£æé…ç½®ç±»çš„çˆ¶ç±»
         *      8.3 æœ€ç»ˆè§£æçš„ @Bean ä¼šæ·»åŠ åˆ°å­ç±»é…ç½®ç±»çš„å±æ€§ä¸­ã€‚æ¯”å¦‚ï¼š
         *          @Configuration
         *          class A extends C <span class="token punctuation">{</span><span class="token punctuation">}</span>
         *          @Configuration
         *          class B extends C <span class="token punctuation">{</span><span class="token punctuation">}</span>
         *          class C <span class="token punctuation">{</span>
         *              @Bean
         *              public A bean()<span class="token punctuation">{</span>
         *                  return new A();
         *              <span class="token punctuation">}</span>
         *          <span class="token punctuation">}</span>
         *
         *          å‡è®¾ A æ¯” B å…ˆè§£æ,ä¹Ÿå°±æ˜¯æ‰§è¡Œ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassParser</span><span class="token punctuation">#</span><span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         *          é‚£ä¹ˆ bean æ˜¯å±äº Aé…ç½®ç±»çš„ï¼Œä¸æ˜¯å±äºBé…ç½®ç±»çš„
         *
         * */</span>
        <span class="token class-name">BeanDefinition</span> bd <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bd <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> bd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">parse</span><span class="token punctuation">(</span>bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Failed to parse configuration class [&quot;</span> <span class="token operator">+</span> bd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * å¼€å§‹è§£æ @Import(DeferredImportSelector çš„å®ç°ç±»)
     * SpringBoot çš„è‡ªåŠ¨è£…é…å°±æ˜¯é€šè¿‡å®ç°è¿™ä¸ªæ¥å£å®ç°çš„ï¼Œç›®çš„å°±æ˜¯å»¶æ—¶åŠ è½½ã€‚å› ä¸ºå¾ˆå¤š AutoConfigurationClass ä¼šä½¿ç”¨ @ConditionOnMissXx æ¥åˆ¤æ–­æ˜¯å¦æ³¨å…¥bean
     * æ‰€ä»¥éœ€è¦å»¶æ—¶åŠ è½½ï¼Œæ‰èƒ½æ­£ç¡®çš„åˆ¤æ–­
     * */</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>deferredImportSelectorHandler<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigurationClass</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">DEFAULT_EXCLUSION_FILTER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
  			<span class="token comment">// æ ¹æ® @Conditional ç¡®å®šæ˜¯å¦åº”è·³è¿‡ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">PARSE_CONFIGURATION</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">ConfigurationClass</span> existingClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// è¯¥é…ç½®ç±»æ˜¯é€šè¿‡@{@link Import}æ³¨å†Œçš„ï¼Œæˆ–è€…æ˜¯ç”±äºåµŒå¥—åœ¨å¦ä¸€ä¸ªé…ç½®ç±»ä¸­è€Œè‡ªåŠ¨æ³¨å†Œçš„(æ¯”å¦‚æ‰«æåˆ°çš„æˆå‘˜å†…éƒ¨ç±»æ˜¯é…ç½®ç±»çš„æƒ…å†µ)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// è¯¥é…ç½®ç±»æ˜¯é€šè¿‡@{@link Import}æ³¨å†Œçš„ï¼Œæˆ–è€…æ˜¯ç”±äºåµŒå¥—åœ¨å¦ä¸€ä¸ªé…ç½®ç±»ä¸­è€Œè‡ªåŠ¨æ³¨å†Œçš„(æ¯”å¦‚æ‰«æåˆ°çš„æˆå‘˜å†…éƒ¨ç±»æ˜¯é…ç½®ç±»çš„æƒ…å†µ)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existingClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    existingClass<span class="token punctuation">.</span><span class="token function">mergeImportedBy</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¦åˆ™å¿½ç•¥æ–°å¯¼å…¥çš„é…ç½®ç±»;ç°æœ‰çš„éå¯¼å…¥ç±»å°†è¦†ç›–å®ƒã€‚</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‰¾åˆ°æ˜¾å¼ Bean å®šä¹‰ï¼Œå¯èƒ½æ›¿æ¢äº†å¯¼å…¥ã€‚è®©æˆ‘ä»¬åˆ é™¤æ—§çš„ï¼Œç„¶åä½¿ç”¨æ–°çš„ã€‚</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>configClass<span class="token operator">::</span><span class="token function">equals</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// é€’å½’å¤„ç†é…ç½®ç±»åŠå…¶è¶…ç±»å±‚æ¬¡ç»“æ„ã€‚</span>
        <span class="token class-name">SourceClass</span> sourceClass <span class="token operator">=</span> <span class="token function">asSourceClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            sourceClass <span class="token operator">=</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>sourceClass <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>configurationClasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>





   <span class="token doc-comment comment">/**
     * <span class="token keyword">@param</span> <span class="token parameter">configClass</span> æ­£åœ¨æ„å»ºçš„é…ç½®ç±»
     * <span class="token keyword">@param</span> <span class="token parameter">sourceClass</span> ä¸€ä¸ªæºç±»
     * <span class="token keyword">@return</span> è¶…ç±»ï¼Œå¦‚æœæœªæ‰¾åˆ°æˆ–ä¹‹å‰æœªå¤„ç†ï¼Œåˆ™ä¸º <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SourceClass</span> <span class="token function">doProcessConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">// é…ç½®ç±»æœ‰ @Component</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAnnotated</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¤„ç†å†…éƒ¨ç±» æ˜¯å¦æœ‰é…ç½®ç±»</span>
            <span class="token comment">// Recursively process any member (nested) classes first</span>
            <span class="token function">processMemberClasses</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å°±æ˜¯æ‹¿åˆ° @PropertySourcesã€@PropertySource æ³¨è§£</span>
        <span class="token comment">// Process any @PropertySource annotations</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> propertySource <span class="token operator">:</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">PropertySources</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>PropertySource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * å°±æ˜¯å°†æ³¨è§£å¯¹åº”çš„èµ„æºæ–‡ä»¶ æ„é€ æˆ PropertySource ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶å°†å¯¹è±¡å­˜åˆ° <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractEnvironment</span><span class="token punctuation">#</span><span class="token field">propertySources</span></span><span class="token punctuation">}</span> å±æ€§ä¸­ã€‚
                 *
                 * ä½¿ç”¨ `context.getEnvironment().getProperty(&quot;name&quot;)` å°±èƒ½è¯»åˆ° èµ„æºæ–‡ä»¶ ä¸­å®šä¹‰çš„å†…å®¹äº†
                 * */</span>
                <span class="token function">processPropertySource</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring @PropertySource annotation on [&quot;</span> <span class="token operator">+</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä¼šè¿›è¡Œæ‰«æï¼Œå¾—åˆ°çš„ BeanDefinitionä¼šæ³¨å†Œåˆ° Springå®¹å™¨ä¸­ï¼Œå¹¶ä¸”ä¼šæ£€æŸ¥æ˜¯ä¸æ˜¯é…ç½®ç±»å¹¶è¿›è¡Œè§£æ</span>
        <span class="token comment">// Process any @ComponentScan annotations</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnnotationAttributes</span><span class="token punctuation">&gt;</span></span> componentScans <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesForRepeatable</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScans</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ComponentScan</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>componentScans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurationPhase</span><span class="token punctuation">.</span><span class="token constant">REGISTER_BEAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan <span class="token operator">:</span> componentScans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿™é‡Œå°±ä¼šè¿›è¡Œæ‰«æï¼Œå¾—åˆ°çš„ BeanDefinitionä¼šæ³¨å†Œåˆ° Springå®¹å™¨ä¸­</span>
                <span class="token comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> scannedBeanDefinitions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>componentScanParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">,</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span> holder <span class="token operator">:</span> scannedBeanDefinitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinition</span> bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">getOriginatingBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bdCand <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        bdCand <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token doc-comment comment">/**
                     * æ‰«æåˆ°çš„beanï¼Œåªè¦æœ‰ @Configuration || @Component || @ComponentScan || @Import || @ImportResource || @Bean æ–¹æ³•
                     * è¿›è¿›è¡Œé…ç½®ç±»çš„è§£æ
                     * */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// æ‰«æçš„ç»“æœæ˜¯é…ç½®ç±»ï¼Œå°±æŒ‰ç…§è§£æé…ç½®ç±»çš„è§„åˆ™è§£æ</span>
                        <span class="token function">parse</span><span class="token punctuation">(</span>bdCand<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> holder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * å¤„ç† @Import
         *
         * getImports(sourceClass) å°±æ˜¯æ‹¿åˆ°ç±»ä¸Šæ‰€æœ‰çš„@Importæ³¨è§£(ä¼šé€’å½’æ‰¾)
         * */</span>
        <span class="token comment">// Process any @Import annotations</span>
        <span class="token function">processImports</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">,</span> <span class="token function">getImports</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Process any @ImportResource annotations</span>
        <span class="token class-name">AnnotationAttributes</span> importResource <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ImportResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>importResource <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> resources <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;locations&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanDefinitionReader</span><span class="token punctuation">&gt;</span></span> readerClass <span class="token operator">=</span> importResource<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;reader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> resource <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> resolvedResource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolveRequiredPlaceholders</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                configClass<span class="token punctuation">.</span><span class="token function">addImportedResource</span><span class="token punctuation">(</span>resolvedResource<span class="token punctuation">,</span> readerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         *  ã€@Bean ç¬¬ä¸€æ­¥ã€‘å¤„ç†é™„åŠ çš„ @Bean æ–¹æ³•ï¼Œåœ¨è¿™é‡Œä¼šæŠŠ@Bean æ ‡è®°çš„æ–¹æ³•ï¼Œå…ˆå­˜èµ·æ¥
         * */</span>
        <span class="token comment">// Process individual @Bean methods</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> beanMethods <span class="token operator">=</span> <span class="token function">retrieveBeanMethodMetadata</span><span class="token punctuation">(</span>sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> methodMetadata <span class="token operator">:</span> beanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            configClass<span class="token punctuation">.</span><span class="token function">addBeanMethod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMethod</span><span class="token punctuation">(</span>methodMetadata<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * å°±æ˜¯å°† sourceClass çš„æ¥å£é€’å½’æ‹¿åˆ° @Beançš„æ–¹æ³•ï¼Œå°†æ–¹æ³•ä¿¡æ¯è®°å½•åˆ° configClass ä¸­
         * */</span>
        <span class="token comment">// Process default methods on interfaces</span>
        <span class="token function">processInterfaces</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> sourceClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token doc-comment comment">/**
         *  ã€@Bean ç¬¬äºŒæ­¥ã€‘é’ˆå¯¹çˆ¶ç±»é‡Œé¢æœ‰@Beançš„æ–¹æ³•ï¼Œä¼šæŠŠå·²ç»å¤„ç†è¿‡çš„çˆ¶ç±» å­˜åˆ° knownSuperclasses è¿™ä¸ªMapä¸­ï¼Œé¿å…é‡å¤å¤„ç†
         *  æ‰€ä»¥ä½†æˆ‘ä»¬ä½¿ç”¨SpringBoot+SpringMVCçš„æ—¶ï¼Œæ³¨å†Œå¤šä¸ª WebMvcConfigurationSupport å­ç±»æ—¶å€™ å‘ç°åªæœ‰ä¸€ä¸ªå­ç±»ä¼šç”Ÿæ•ˆã€‚å°±æ˜¯å› ä¸ºè¿™ä¸ªæœºåˆ¶ä¿è¯äº†çˆ¶ç±»é‡Œé¢çš„@Beanæ–¹æ³•åªä¼šè¢«æ³¨å†Œä¸€æ¬¡
         * */</span>
        <span class="token comment">// Process superclass, if any</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">hasSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> superclass <span class="token operator">=</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getSuperClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>superclass <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>superclass<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>superclass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>knownSuperclasses<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>superclass<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¿”å›çˆ¶ç±» é€’å½’è§£æ</span>
                <span class="token comment">// Superclass found, return its annotation metadata and recurse</span>
                <span class="token keyword">return</span> sourceClass<span class="token punctuation">.</span><span class="token function">getSuperClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// No superclass -&gt; processing is complete</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


 <span class="token doc-comment comment">/**
	 * æ³¨å†Œæ°å¥½æ˜¯é…ç½®ç±»æœ¬èº«çš„æˆå‘˜ï¼ˆåµŒå¥—ï¼‰ç±»ã€‚    
	 */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processMemberClasses</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> filter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> memberClasses <span class="token operator">=</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMemberClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memberClasses<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>memberClasses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SourceClass</span> memberClass <span class="token operator">:</span> memberClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å†…éƒ¨ç±» æ˜¯ é…ç½®ç±»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">isConfigurationCandidate</span><span class="token punctuation">(</span>memberClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>memberClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è®°å½•ä¸€ä¸‹</span>
                    candidates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>memberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">OrderComparator</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>candidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SourceClass</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CircularImportProblem</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token doc-comment comment">/**
                         * è§£æé…ç½®ç±»ã€‚
                         * è®°å½•ä¿¡æ¯ï¼šcandidate çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span><span class="token punctuation">#</span><span class="token field">importedBy</span></span><span class="token punctuation">}</span> æ˜¯  configClass
                         * */</span>
                        <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">asConfigClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>



 <span class="token doc-comment comment">/**
    * å¤„ç†ç»™å®š<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java">çš„<span class="token annotation punctuation">@PropertySource</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>æ³¨é‡Šå…ƒæ•°æ®ã€‚
     *
     * <span class="token keyword">@param</span> æ‰¾åˆ°<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token annotation punctuation">@PropertySource</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>æ³¨é‡Šçš„ propertySource å…ƒæ•°æ®
     * å¦‚æœåŠ è½½å±æ€§æºå¤±è´¥ï¼Œåˆ™@throws <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processPropertySource</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> propertySource<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// name</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ç¼–ç </span>
        <span class="token class-name">String</span> encoding <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;encoding&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            encoding <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è¦åŠ è½½çš„å±æ€§æ–‡ä»¶</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> locations <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>locations<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;At least one @PropertySource(value) location is required&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¿½ç•¥èµ„æºæ‰¾ä¸åˆ°</span>
        <span class="token keyword">boolean</span> ignoreResourceNotFound <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;ignoreResourceNotFound&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‹¿åˆ° PropertySourceFactory</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">PropertySourceFactory</span><span class="token punctuation">&gt;</span></span> factoryClass <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;factory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ³¨ï¼šé»˜è®¤æ˜¯ DefaultPropertySourceFactory ï¼Œå¦åˆ™å°±åå°„å®ä¾‹åŒ–å¾—åˆ° PropertySourceFactory ã€‚
         *     DefaultPropertySourceFactory ä¸æ”¯æŒè§£æymlæ ¼å¼çš„å†…å®¹ï¼Œæ‰€ä»¥è¦æƒ³å¯¼å…¥ yml æ ¼å¼çš„å†…å®¹éœ€è¦è‡ªå®šä¹‰ã€‚
         *
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">YamlPropertiesFactoryBean</span><span class="token punctuation">#</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> è¿™ä¸ªæ˜¯Springæä¾›çš„ï¼Œå¯è§£æymlå†…å®¹æˆPropertieså¯¹è±¡ï¼Œæœ‰äº†Propertieså¯¹è±¡
         * å°±å¯ä»¥æ„é€ å‡º PropertySource å¯¹è±¡
         * */</span>
        <span class="token class-name">PropertySourceFactory</span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>factoryClass
                <span class="token operator">==</span> <span class="token class-name">PropertySourceFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">?</span> <span class="token constant">DEFAULT_PROPERTY_SOURCE_FACTORY</span> <span class="token operator">:</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>factoryClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// éå† locations</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> location <span class="token operator">:</span> locations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * è§£æå ä½ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥è¿™ä¹ˆå†™ @PropertySource(&quot;$<span class="token punctuation">{</span>prop_file<span class="token punctuation">}</span>&quot;)
                 * */</span>
                <span class="token class-name">String</span> resolvedLocation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolveRequiredPlaceholders</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token doc-comment comment">/**
                 * è·å–èµ„æºæ–‡ä»¶ï¼Œè¿™é‡Œä¼šå¤„ç† classpath: å‰ç¼€
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">GenericApplicationContext</span><span class="token punctuation">#</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultResourceLoader</span><span class="token punctuation">#</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 * */</span>
                <span class="token class-name">Resource</span> resource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>resolvedLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token doc-comment comment">/**
                 * ä¸€ä¸ª location å¯¹åº”ä¸€ä¸ª PropertySource ç„¶åè®°å½•åˆ°ç¯å¢ƒå˜é‡ä¸­ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">AbstractEnvironment</span><span class="token punctuation">#</span><span class="token field">propertySources</span></span><span class="token punctuation">}</span>
                 * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">DefaultPropertySourceFactory</span><span class="token punctuation">#</span><span class="token function">createPropertySource</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                 *
                 * æ³¨ï¼š
                 *  1. nameæ˜¯nullï¼Œå°±ä¼šæ ¹æ® EncodedResource ç”Ÿæˆåå­—ï¼Œé»˜è®¤å°±æ˜¯èµ„æºæ–‡ä»¶çš„è·¯å¾„
                 *  2. æ·»åŠ çš„ç‰¹ç‚¹æ˜¯åæ·»åŠ ä¼šæ”¾åˆ°å‰é¢
                 * */</span>
                <span class="token function">addPropertySource</span><span class="token punctuation">(</span>factory<span class="token punctuation">.</span><span class="token function">createPropertySource</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> <span class="token operator">|</span> <span class="token class-name">FileNotFoundException</span> <span class="token operator">|</span> <span class="token class-name">UnknownHostException</span> <span class="token operator">|</span> <span class="token class-name">SocketException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Placeholders not resolvable or resource not found when trying to open it</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreResourceNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Properties location [&quot;</span> <span class="token operator">+</span> location <span class="token operator">+</span> <span class="token string">&quot;] not resolvable: &quot;</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addPropertySource</span><span class="token punctuation">(</span><span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> propertySource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> propertySource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MutablePropertySources</span> propertySources <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableEnvironment</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPropertySources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å·²ç»æ·»åŠ è¿‡äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceNames<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å·²ç»æ·»åŠ è¿‡äº†ï¼Œé‚£å°±å¯¹å·²æœ‰çš„å±æ€§å€¼è¿›è¡Œæ‰©å±•</span>
            <span class="token comment">// We&#39;ve already added a version, we need to extend it</span>
            <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> existing <span class="token operator">=</span> propertySources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‹¿åˆ°æ–°åŠ çš„ PropertySource</span>
                <span class="token class-name">PropertySource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> newSource <span class="token operator">=</span> <span class="token punctuation">(</span>propertySource <span class="token keyword">instanceof</span> <span class="token class-name">ResourcePropertySource</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourcePropertySource</span><span class="token punctuation">)</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withResourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token keyword">instanceof</span> <span class="token class-name">CompositePropertySource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token doc-comment comment">/**
                     * å°†æ–°æ·»åŠ çš„æ‰©å±•åˆ° ç°æœ‰çš„é‡Œé¢ï¼ŒnewSource æ”¾åˆ°é›†åˆçš„å‰é¢ï¼Œä»è€Œä¿è¯ä¼˜å…ˆä½¿ç”¨
                     * */</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CompositePropertySource</span><span class="token punctuation">)</span> existing<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirstPropertySource</span><span class="token punctuation">(</span>newSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// å°†ç°æœ‰çš„ æ¢æˆ CompositePropertySource ç±»å‹çš„å¯¹è±¡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token keyword">instanceof</span> <span class="token class-name">ResourcePropertySource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        existing <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ResourcePropertySource</span><span class="token punctuation">)</span> existing<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withResourceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">CompositePropertySource</span> composite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositePropertySource</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// newSource æ”¾åˆ°é›†åˆçš„å‰é¢ï¼Œä»è€Œä¿è¯ä¼˜å…ˆä½¿ç”¨</span>
                    composite<span class="token punctuation">.</span><span class="token function">addPropertySource</span><span class="token punctuation">(</span>newSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    composite<span class="token punctuation">.</span><span class="token function">addPropertySource</span><span class="token punctuation">(</span>existing<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æ›¿æ¢æ‰</span>
                    propertySources<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> composite<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// ç»“æŸ</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ·»åŠ </span>
            propertySources<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‹¿åˆ°æœ€åä¸€ä¸ª</span>
            <span class="token class-name">String</span> firstProcessed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceNames<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ”¾åˆ°æœ€åä¸€ä¸ªä¹‹å‰ã€‚ä¹Ÿå°±æ˜¯è¯´ æ–°æ·»åŠ çš„çš„ä¼šæ”¾åœ¨å‰é¢</span>
            propertySources<span class="token punctuation">.</span><span class="token function">addBefore</span><span class="token punctuation">(</span>firstProcessed<span class="token punctuation">,</span> propertySource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// è®°å½•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>propertySourceNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



 <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processImports</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> currentSourceClass<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> importCandidates<span class="token punctuation">,</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> exclusionFilter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> checkForCircularImports<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>importCandidates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>checkForCircularImports <span class="token operator">&amp;&amp;</span> <span class="token function">isChainedImportOnStack</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>problemReporter<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CircularImportProblem</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// éå†æ‰€æœ‰ @Importçš„å€¼</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SourceClass</span> candidate <span class="token operator">:</span> importCandidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token class-name">ImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span>
                        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidateClass <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ImportSelector</span> selector <span class="token operator">=</span> <span class="token class-name">ParserStrategyUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>candidateClass<span class="token punctuation">,</span> <span class="token class-name">ImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> selectorFilter <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">getExclusionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectorFilter <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            exclusionFilter <span class="token operator">=</span> exclusionFilter<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>selectorFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token keyword">instanceof</span> <span class="token class-name">DeferredImportSelector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>deferredImportSelectorHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">DeferredImportSelector</span><span class="token punctuation">)</span> selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> importClassNames <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectImports</span><span class="token punctuation">(</span>currentSourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SourceClass</span><span class="token punctuation">&gt;</span></span> importSourceClasses <span class="token operator">=</span> <span class="token function">asSourceClasses</span><span class="token punctuation">(</span>importClassNames<span class="token punctuation">,</span> exclusionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">processImports</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> currentSourceClass<span class="token punctuation">,</span> importSourceClasses<span class="token punctuation">,</span> exclusionFilter<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">isAssignable</span><span class="token punctuation">(</span><span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span>
                        <span class="token comment">// delegate to it to register additional bean definitions</span>
                        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> candidateClass <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">ImportBeanDefinitionRegistrar</span> registrar <span class="token operator">=</span> <span class="token class-name">ParserStrategyUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>candidateClass<span class="token punctuation">,</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        configClass<span class="token punctuation">.</span><span class="token function">addImportBeanDefinitionRegistrar</span><span class="token punctuation">(</span>registrar<span class="token punctuation">,</span> currentSourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token doc-comment comment">/**
                         * å…œåº•ï¼Œè®°å½•å¯¼å…¥çš„ç±»å’Œå…¶å¯¹åº”çš„å…ƒæ•°æ®
                         * è¿™ä¸ªå…ƒæ•°æ®æ˜¯åœ¨ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassPostProcessor</span><span class="token punctuation">.</span><span class="token class-name">ImportAwareBeanPostProcessor</span><span class="token punctuation">#</span><span class="token function">postProcessBeforeInitialization</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> ä¼šç”¨åˆ°
                         *
                         * æ¯”å¦‚ï¼š@Import(A.class)ï¼Œæ˜¯ç»™A.classä½œä¸ºkeyï¼Œvalueå°±æ˜¯å…ƒæ•°æ®
                         * */</span>
                        <span class="token comment">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span>
                        <span class="token comment">// process it as an @Configuration class</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">registerImport</span><span class="token punctuation">(</span>currentSourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> candidate<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token doc-comment comment">/**
                         * è§£æé…ç½®ç±»ã€‚
                         * è®°å½•ä¿¡æ¯ï¼šcandidate çš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span><span class="token punctuation">#</span><span class="token field">importedBy</span></span><span class="token punctuation">}</span> æ˜¯  configClass
                         * */</span>
                        <span class="token function">processConfigurationClass</span><span class="token punctuation">(</span>candidate<span class="token punctuation">.</span><span class="token function">asConfigClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">,</span> exclusionFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>
                        <span class="token string">&quot;Failed to process import candidates for configuration class [&quot;</span> <span class="token operator">+</span> configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>importStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


 <span class="token doc-comment comment">/**
	* æ£€ç´¢æ‰€æœ‰<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>code</span><span class="token punctuation">&gt;</span></span><span class="token code-section"><span class="token line"><span class="token code language-java"><span class="token annotation punctuation">@Bean</span></span></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>code</span><span class="token punctuation">&gt;</span></span>æ–¹æ³•çš„å…ƒæ•°æ®ã€‚
	*/</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> <span class="token function">retrieveBeanMethodMetadata</span><span class="token punctuation">(</span><span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AnnotationMetadata</span> original <span class="token operator">=</span> sourceClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> beanMethods <span class="token operator">=</span> original<span class="token punctuation">.</span><span class="token function">getAnnotatedMethods</span><span class="token punctuation">(</span><span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> original <span class="token keyword">instanceof</span> <span class="token class-name">StandardAnnotationMetadata</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Try reading the class file via ASM for deterministic declaration order...</span>
            <span class="token comment">// Unfortunately, the JVM&#39;s standard reflection returns methods in arbitrary</span>
            <span class="token comment">// order, even between different runs of the same application on the same JVM.</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">AnnotationMetadata</span> asm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>metadataReaderFactory<span class="token punctuation">.</span><span class="token function">getMetadataReader</span><span class="token punctuation">(</span>original<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">getAnnotationMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> asmMethods <span class="token operator">=</span> asm<span class="token punctuation">.</span><span class="token function">getAnnotatedMethods</span><span class="token punctuation">(</span><span class="token class-name">Bean</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>asmMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> beanMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> selectedMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>asmMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> asmMethod <span class="token operator">:</span> asmMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> beanMethod <span class="token operator">:</span> beanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>asmMethod<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                selectedMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> beanMethods<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// All reflection-detected methods found in ASM method set -&gt; proceed</span>
                        beanMethods <span class="token operator">=</span> selectedMethods<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to read class file via ASM for determining @Bean method order&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// No worries, let&#39;s continue with the reflection metadata we started with...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanMethods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token doc-comment comment">/**
     * åœ¨é…ç½®ç±»å®ç°çš„æ¥å£ä¸Šæ³¨å†Œé»˜è®¤æ–¹æ³•ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processInterfaces</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">SourceClass</span> sourceClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// éå†æ¥å£</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SourceClass</span> ifc <span class="token operator">:</span> sourceClass<span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¥å£ä¸­æœ‰@Beançš„æ–¹æ³•</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodMetadata</span><span class="token punctuation">&gt;</span></span> beanMethods <span class="token operator">=</span> <span class="token function">retrieveBeanMethodMetadata</span><span class="token punctuation">(</span>ifc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodMetadata</span> methodMetadata <span class="token operator">:</span> beanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ä¸æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œæ‰è®°å½•åˆ° configClass ä¸­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>methodMetadata<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// A default method or other concrete method on a Java 8+ interface...</span>
                    configClass<span class="token punctuation">.</span><span class="token function">addBeanMethod</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanMethod</span><span class="token punctuation">(</span>methodMetadata<span class="token punctuation">,</span> configClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// é€’å½’å¤„ç†æ¥å£çš„æ¥å£</span>
            <span class="token function">processInterfaces</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> ifc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="componentscanannotationparser" tabindex="-1"><a class="header-anchor" href="#componentscanannotationparser" aria-hidden="true">#</a> ComponentScanAnnotationParser</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ComponentScanAnnotationParser</span><span class="token operator">:</span>

<span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> componentScan<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> declaringClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">,</span> componentScan<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;useDefaultFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">BeanNameGenerator</span><span class="token punctuation">&gt;</span></span> generatorClass <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;nameGenerator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> useInheritedGenerator <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BeanNameGenerator</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> generatorClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é»˜è®¤ä¸º AnnotationBeanNameGenerator</span>
    scanner<span class="token punctuation">.</span><span class="token function">setBeanNameGenerator</span><span class="token punctuation">(</span>useInheritedGenerator <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator <span class="token operator">:</span> <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>generatorClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ScopedProxyMode</span> scopedProxyMode <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;scopedProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>scopedProxyMode <span class="token operator">!=</span> <span class="token class-name">ScopedProxyMode</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scanner<span class="token punctuation">.</span><span class="token function">setScopedProxyMode</span><span class="token punctuation">(</span>scopedProxyMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ScopeMetadataResolver</span><span class="token punctuation">&gt;</span></span> resolverClass <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string">&quot;scopeResolver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scanner<span class="token punctuation">.</span><span class="token function">setScopeMetadataResolver</span><span class="token punctuation">(</span><span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>resolverClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    scanner<span class="token punctuation">.</span><span class="token function">setResourcePattern</span><span class="token punctuation">(</span>componentScan<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;resourcePattern&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> filter <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getAnnotationArray</span><span class="token punctuation">(</span><span class="token string">&quot;includeFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> typeFilter <span class="token operator">:</span> <span class="token function">typeFiltersFor</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanner<span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span>typeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> filter <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getAnnotationArray</span><span class="token punctuation">(</span><span class="token string">&quot;excludeFilters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TypeFilter</span> typeFilter <span class="token operator">:</span> <span class="token function">typeFiltersFor</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scanner<span class="token punctuation">.</span><span class="token function">addExcludeFilter</span><span class="token punctuation">(</span>typeFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> lazyInit <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;lazyInit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lazyInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        scanner<span class="token punctuation">.</span><span class="token function">getBeanDefinitionDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setLazyInit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> basePackages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> basePackagesArray <span class="token operator">=</span> componentScan<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;basePackages&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> pkg <span class="token operator">:</span> basePackagesArray<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tokenized <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">tokenizeToStringArray</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>environment<span class="token punctuation">.</span><span class="token function">resolvePlaceholders</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ConfigurableApplicationContext</span><span class="token punctuation">.</span><span class="token constant">CONFIG_LOCATION_DELIMITERS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> tokenized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">:</span> componentScan<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;basePackageClasses&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        basePackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>basePackages<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        basePackages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span>declaringClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    scanner<span class="token punctuation">.</span><span class="token function">addExcludeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AbstractTypeHierarchyTraversingFilter</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">matchClassName</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> declaringClass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> scanner<span class="token punctuation">.</span><span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">toStringArray</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


   <span class="token doc-comment comment">/**
     * åŒ…æ‰«æ BeanDefinition
     * åœ¨æŒ‡å®šçš„åŸºç¡€åŒ…ä¸­æ‰§è¡Œæ‰«æï¼Œ
     * è¿”å›å·²æ³¨å†Œçš„ Bean å®šä¹‰ã€‚
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>æ­¤æ–¹æ³•<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span><span class="token punctuation">&gt;</span></span>ä¸<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>æ³¨å†Œæ³¨è§£é…ç½®å¤„ç†å™¨
     * è€Œæ˜¯å°†æ­¤ç•™ç»™è°ƒç”¨æ–¹ã€‚
     *
     * <span class="token keyword">@param</span> <span class="token parameter">basePackages</span> the packages to check for annotated classes
     * <span class="token keyword">@return</span> set of beans registered if any for tooling registration purposes (never <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token keyword">null</span></span></span><span class="token punctuation">}</span>)
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notEmpty</span><span class="token punctuation">(</span>basePackages<span class="token punctuation">,</span> <span class="token string">&quot;At least one base package must be specified&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºbeanå®šä¹‰çš„ holderå¯¹è±¡ç”¨äºä¿å­˜æ‰«æåç”Ÿæˆçš„beanå®šä¹‰å¯¹è±¡</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å¾ªç¯æˆ‘ä»¬çš„åŒ…è·¯å¾„é›†åˆ</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ bean</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å– @Scope çš„ä¿¡æ¯</span>
                <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                candidate<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è®¾ç½®beanName</span>
                <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// å¤„ç† @Autowired ç›¸å…³çš„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">postProcessBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å¤„ç†jsr250ç›¸å…³çš„ç»„ä»¶</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è§£æ @Lazyã€@Primaryã€@DependsOnã€@Roleã€@Description</span>
                    <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// æ£€æŸ¥ Spring å®¹å™¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è¯¥ beanName</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkCandidate</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> candidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token doc-comment comment">/**
                     * é’ˆå¯¹ @Scope è¿›è¡Œå¤„ç†ï¼Œåªè¦ä¸æ˜¯ @Scope(proxyMode = ScopedProxyMode.NO | DEFAULT) å°±åšé¢å¤–å¤„ç†ã€‚
                     * å…·ä½“çš„å¤„ç†é€»è¾‘æ˜¯ é¢å¤–æ³¨å†Œä¸€ä¸ª BeanDefinition è®°å½•çš„æ˜¯åŸå§‹BeanDefinitionï¼Œå…¶beanNameæ˜¯ `scopedTarget. + å½“å‰beanName`
                     * ç„¶åè¿”å›çš„æ˜¯ å¤„ç†åçš„BeanDefinitionï¼Œå…¶å®å°±æ˜¯ä¿®æ”¹ beanClass ä¸º ScopedProxyFactoryBean è¿™ä¸ªç±»å‹
                     *
                     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ScopedProxyUtils</span><span class="token punctuation">#</span><span class="token function">createScopedProxy</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
                     * */</span>
                    definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    beanDefinitions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// æ³¨å†Œåˆ° IOC å®¹å™¨ä¸­</span>
                    <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="configurationclassbeandefinitionreader" tabindex="-1"><a class="header-anchor" href="#configurationclassbeandefinitionreader" aria-hidden="true">#</a> ConfigurationClassBeanDefinitionReader</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>

<span class="token doc-comment comment">/**
 *è¯»å– <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java">configurationModel</span></span><span class="token punctuation">}</span>ï¼Œæ³¨å†Œ Bean å®šä¹‰
 * æ ¹æ®æ³¨å†Œè¡¨çš„å†…å®¹ã€‚
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ConfigurationClass</span><span class="token punctuation">&gt;</span></span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackedConditionEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass <span class="token operator">:</span> configurationModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> trackedConditionEvaluator<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * è¯»å–ç‰¹å®šçš„ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClass</span></span><span class="token punctuation">}</span>ï¼Œæ³¨å†Œ Bean å®šä¹‰
 * ç”¨äºç±»æœ¬èº«åŠå…¶æ‰€æœ‰ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Bean</span></span><span class="token punctuation">}</span> æ–¹æ³•ã€‚
 */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadBeanDefinitionsForConfigurationClass</span><span class="token punctuation">(</span>
        <span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">,</span> <span class="token class-name">TrackedConditionEvaluator</span> trackedConditionEvaluator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// ä¼šè¿›è¡Œ @Conditional æ ¡éªŒï¼Œåº”è¯¥è·³è¿‡ å°±ä¸æ³¨å†Œåˆ°BeanDefinitionMapäº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trackedConditionEvaluator<span class="token punctuation">.</span><span class="token function">shouldSkip</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> beanName <span class="token operator">=</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">removeBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>importRegistry<span class="token punctuation">.</span><span class="token function">removeImportingClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ˜¯é€šè¿‡ @Import å¯¼å…¥çš„ç±»,æˆ–è€…æ˜¯æˆå‘˜å†…éƒ¨ç±»æ˜¯é…ç½®ç±»çš„æƒ…å†µ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">isImported</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * è¿™äº›é…ç½®ç±»æ¯”è¾ƒç‰¹æ®Šï¼Œè¿˜æ²¡æœ‰æ³¨å†Œåˆ°BeanFactoryä¸­ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¯å°†è¿™ç§é…ç½®åˆ°æ³¨å†Œåˆ°BeanFactory
         * */</span>
        <span class="token function">registerBeanDefinitionForImportedConfigurationClass</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanMethod</span> beanMethod <span class="token operator">:</span> configClass<span class="token punctuation">.</span><span class="token function">getBeanMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         *  ã€@Bean ç¬¬å››æ­¥ã€‘å°†é…ç½®ç±»é‡Œé¢çš„@Beanæ–¹æ³•ï¼Œè§£ææˆbeanDefinitionï¼Œç„¶åæ³¨å†Œåˆ° beanDefinitionMap ä¸­
         * */</span>
        <span class="token function">loadBeanDefinitionsForBeanMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * åŠ è½½ @ImportResource
     * ä¼šä½¿ç”¨  XmlBeanDefinitionReader è¿›è¡Œè¯»å–å’Œè§£æ
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">#</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">XmlBeanDefinitionReader</span><span class="token punctuation">#</span><span class="token function">doLoadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">InputSource</span><span class="token punctuation">,</span> <span class="token class-name">Resource</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token function">loadBeanDefinitionsFromImportedResources</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     *  å›è°ƒ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ImportBeanDefinitionRegistrar</span><span class="token punctuation">#</span><span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span><span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">,</span> <span class="token class-name">BeanNameGenerator</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     *  ioc å®¹å™¨å·²ç»ä½œä¸ºå…¥å‚ä¼ å…¥äº†ï¼Œä½ æƒ³åšå•¥ä»»ä½ å¼€å¿ƒ
     * */</span>
    <span class="token function">loadBeanDefinitionsFromRegistrars</span><span class="token punctuation">(</span>configClass<span class="token punctuation">.</span><span class="token function">getImportBeanDefinitionRegistrars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



		<span class="token doc-comment comment">/**
     * å°† <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Configuration</span></span><span class="token punctuation">}</span> ç±»æœ¬èº«æ³¨å†Œä¸º Bean å®šä¹‰ã€‚
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitionForImportedConfigurationClass</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClass</span> configClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AnnotationMetadata</span> metadata <span class="token operator">=</span> configClass<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnnotatedGenericBeanDefinition</span> configBeanDef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedGenericBeanDefinition</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‹¿åˆ° @Scope ä¿¡æ¯</span>
        <span class="token class-name">ScopeMetadata</span> scopeMetadata <span class="token operator">=</span> scopeMetadataResolver<span class="token punctuation">.</span><span class="token function">resolveScopeMetadata</span><span class="token punctuation">(</span>configBeanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        configBeanDef<span class="token punctuation">.</span><span class="token function">setScope</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">.</span><span class="token function">getScopeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> configBeanName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>importBeanNameGenerator<span class="token punctuation">.</span><span class="token function">generateBeanName</span><span class="token punctuation">(</span>configBeanDef<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// å°±æ˜¯å°†é€šç”¨çš„æ³¨è§£å€¼ è®¾ç½®åˆ° BeanDefinitionä¸­</span>
        <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">processCommonDefinitionAnnotations</span><span class="token punctuation">(</span>configBeanDef<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">BeanDefinitionHolder</span> definitionHolder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">(</span>configBeanDef<span class="token punctuation">,</span> configBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * çœ‹çœ‹æ˜¯å¦éœ€è¦åš é¢å¤–å¤„ç†ï¼Œå’Œè¿™é‡Œæ˜¯ä¸€æ ·çš„é€»è¾‘
         * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">#</span><span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * */</span>
        definitionHolder <span class="token operator">=</span> <span class="token class-name">AnnotationConfigUtils</span><span class="token punctuation">.</span><span class="token function">applyScopedProxyMode</span><span class="token punctuation">(</span>scopeMetadata<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ³¨å†Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        configClass<span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>configBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Registered bean definition for imported class &#39;&quot;</span> <span class="token operator">+</span> configBeanName <span class="token operator">+</span> <span class="token string">&quot;&#39;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="é…ç½®ç±»å¢å¼ºæµç¨‹" tabindex="-1"><a class="header-anchor" href="#é…ç½®ç±»å¢å¼ºæµç¨‹" aria-hidden="true">#</a> é…ç½®ç±»å¢å¼ºæµç¨‹</h3><p>å¦‚æœä¸€ä¸ªé…ç½®ç±»æ˜¯Fullæ¨¡å¼ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦è¢«CGLIBå­—èŠ‚ç å¢å¼ºã€‚</p><p>å¢å¼ºåŠ¨ä½œå§”æ‰˜ç»™<code>enhanceConfigurationClasses(beanFactory)</code>å»å®Œæˆã€‚</p><p>å¦‚æœæ˜¯fullé…ç½®ç±»ä¼šä½¿ç”¨Cglibç”Ÿæˆä»£ç†ç±»ï¼Œç„¶åå°†ä»£ç†ç±»è¦†ç›–æ‰åŸæ¥BeanDefinitionè®°å½•çš„beanClassã€‚</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/30/QphOeo.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/30/VivE1G.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="configurationclasspostprocessor-2" tabindex="-1"><a class="header-anchor" href="#configurationclasspostprocessor-2" aria-hidden="true">#</a> ConfigurationClassPostProcessor</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
* å‡†å¤‡ç”¨äºåœ¨è¿è¡Œæ—¶å¤„ç† Bean è¯·æ±‚çš„é…ç½®ç±»
 * å°†å®ƒä»¬æ›¿æ¢ä¸º CGLIB å¢å¼ºçš„å­ç±»ã€‚
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> factoryId <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">identityHashCode</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// é˜²æ­¢é‡å¤å¤„ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                <span class="token string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>factoriesPostProcessed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åœ¨æ‰§è¡ŒpostProcessBeanDefinitionRegistryæ–¹æ³•çš„æ—¶å°±å·²ç»å°†</span>
    <span class="token comment">// è¿™ä¸ªidæ·»åŠ åˆ°registriesPostProcessedé›†åˆä¸­äº†</span>
    <span class="token comment">// æ‰€ä»¥åˆ°è¿™é‡Œå°±ä¸ä¼šå†é‡å¤æ‰§è¡Œé…ç½®ç±»çš„è§£æäº†ï¼ˆè§£æ@Importã€@Beanç­‰ï¼‰</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>registriesPostProcessed<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>factoryId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// BeanDefinitionRegistryPostProcessor é’©å­æ˜¾ç„¶ä¸å—æ”¯æŒ...æ­¤æ—¶åªéœ€å»¶è¿Ÿè°ƒç”¨ processConfigurationClassesã€‚</span>
        <span class="token function">processConfigBeanDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinitionRegistry</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * å¢å¼ºé…ç½®ç±»class
     */</span>
    <span class="token function">enhanceConfigurationClasses</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    <span class="token doc-comment comment">/**
     * æ·»åŠ ä¸€ä¸ªåç½®å¤„ç†å™¨ï¼Œç”¨æ¥å¤„ç† ImportAwareæ¥å£ã€ç»™fullé…ç½®ç±»è®¾ç½®å±æ€§
     * */</span>
    beanFactory<span class="token punctuation">.</span><span class="token function">addBeanPostProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ImportAwareBeanPostProcessor</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



 <span class="token doc-comment comment">/**
	 * è¿™é‡Œå°±æ˜¯åŒºåˆ« fullé…ç½®ç±» å’Œ liteé…ç½®ç±»çš„åœ°æ–¹äº†ã€‚å¦‚æœæ˜¯fullé…ç½®ç±»ä¼šä½¿ç”¨Cglibç”Ÿæˆä»£ç†ç±»ï¼Œç„¶åå°†ä»£ç†ç±»è¦†ç›–æ‰åŸæ¥BeanDefinitionè®°å½•çš„beanClass
     * å¯¹ BeanFactory è¿›è¡Œåå¤„ç†ä»¥æœç´¢é…ç½®ç±» BeanDefinitions;
     * ç„¶åï¼Œä»»ä½•å€™é€‰é¡¹éƒ½ä¼šé€šè¿‡ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassEnhancer</span></span><span class="token punctuation">}</span> è¿›è¡Œå¢å¼ºã€‚
     * å€™é€‰çŠ¶æ€ç”± BeanDefinition å±æ€§å…ƒæ•°æ®ç¡®å®šã€‚
     * <span class="token keyword">@see</span> <span class="token reference"><span class="token class-name">ConfigurationClassEnhancer</span></span>
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enhanceConfigurationClasses</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableListableBeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StartupStep</span> enhanceConfigClasses <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationStartup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;spring.context.config-classes.enhance&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®°å½•fullé…ç½®ç±»</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">&gt;</span></span> configBeanDefs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> beanName <span class="token operator">:</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanDefinitionNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">BeanDefinition</span> beanDef <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> configClassAttr <span class="token operator">=</span> beanDef<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CLASS_ATTRIBUTE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AnnotationMetadata</span> annotationMetadata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">MethodMetadata</span> methodMetadata <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AnnotatedBeanDefinition</span> annotatedBeanDefinition <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AnnotatedBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">;</span>
                annotationMetadata <span class="token operator">=</span> annotatedBeanDefinition<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                methodMetadata <span class="token operator">=</span> annotatedBeanDefinition<span class="token punctuation">.</span><span class="token function">getFactoryMethodMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * åœ¨è¿™é‡Œæ ‡è®°æ˜¯fullé…ç½®ç±»è¿˜æ˜¯liteé…ç½®ç±» <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">#</span><span class="token function">checkConfigurationClassCandidate</span><span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">,</span> <span class="token class-name">MetadataReaderFactory</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>configClassAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> methodMetadata <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Configuration class (full or lite) or a configuration-derived @Bean method</span>
                <span class="token comment">// -&gt; eagerly resolve bean class at this point, unless it&#39;s a &#39;lite&#39; configuration</span>
                <span class="token comment">// or component class without @Bean methods.</span>
                <span class="token class-name">AbstractBeanDefinition</span> abd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ˜¯ liteé…ç½®ç±» ä½†æ˜¯æ²¡æœ‰ @Beanæ–¹æ³•</span>
                    <span class="token keyword">boolean</span> liteConfigurationCandidateWithoutBeanMethods <span class="token operator">=</span> <span class="token punctuation">(</span>
                            <span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CLASS_LITE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>configClassAttr<span class="token punctuation">)</span>
                                    <span class="token operator">&amp;&amp;</span> annotationMetadata <span class="token operator">!=</span> <span class="token keyword">null</span>
                                    <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token function">hasBeanMethods</span><span class="token punctuation">(</span>annotationMetadata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>liteConfigurationCandidateWithoutBeanMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment">// è®°å½•</span>
                            abd<span class="token punctuation">.</span><span class="token function">resolveBeanClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                                    <span class="token string">&quot;Cannot load configuration class: &quot;</span> <span class="token operator">+</span> beanDef<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ˜¯ full é…ç½®ç±»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurationClassUtils</span><span class="token punctuation">.</span><span class="token constant">CONFIGURATION_CLASS_FULL</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>configClassAttr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanDef <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot enhance @Configuration bean definition &#39;&quot;</span> <span class="token operator">+</span> beanName
                            <span class="token operator">+</span> <span class="token string">&quot;&#39; since it is not stored in an AbstractBeanDefinition subclass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">containsSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot enhance @Configuration bean definition &#39;&quot;</span> <span class="token operator">+</span> beanName
                            <span class="token operator">+</span> <span class="token string">&quot;&#39; since its singleton instance has been created too early. The typical cause &quot;</span>
                            <span class="token operator">+</span> <span class="token string">&quot;is a non-static @Bean method with a BeanDefinitionRegistryPostProcessor &quot;</span>
                            <span class="token operator">+</span> <span class="token string">&quot;return type: Consider declaring such methods as &#39;static&#39;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// è®°å½•</span>
                configBeanDefs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">)</span> beanDef<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configBeanDefs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">NativeDetector</span><span class="token punctuation">.</span><span class="token function">inNativeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// nothing to enhance -&gt; return immediately</span>
            enhanceConfigClasses<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è¿™é‡Œå°±æ˜¯éå†æ‰€æœ‰çš„ fullé…ç½®ç±»ï¼Œä½¿ç”¨cglibç”Ÿæˆä»£ç†ç±»çš„class</span>
        <span class="token class-name">ConfigurationClassEnhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationClassEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">AbstractBeanDefinition</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> configBeanDefs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AbstractBeanDefinition</span> beanDef <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// If a @Configuration class gets proxied, always proxy the target class</span>
            beanDef<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token class-name">AutoProxyUtils</span><span class="token punctuation">.</span><span class="token constant">PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Set enhanced subclass of the user-specified bean class</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configClass <span class="token operator">=</span> beanDef<span class="token punctuation">.</span><span class="token function">getBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token doc-comment comment">/**
             * è¿™é‡Œå°±æ˜¯ä½¿ç”¨cglibç”Ÿæˆä»£ç†ç±»
             * */</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> enhancedClass <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">enhance</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configClass <span class="token operator">!=</span> enhancedClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Replacing bean definition &#39;%s&#39; existing class &#39;%s&#39; with &quot;</span>
                            <span class="token operator">+</span> <span class="token string">&quot;enhanced class &#39;%s&#39;&quot;</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> enhancedClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// å°†cglibç”Ÿæˆçš„class è®¾ç½®åˆ°BeanDefinitionä¸­</span>
                beanDef<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>enhancedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        enhanceConfigClasses<span class="token punctuation">.</span><span class="token function">tag</span><span class="token punctuation">(</span><span class="token string">&quot;classCount&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>configBeanDefs<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="configurationclassenhancer" tabindex="-1"><a class="header-anchor" href="#configurationclassenhancer" aria-hidden="true">#</a> ConfigurationClassEnhancer</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cglibç”Ÿæˆçš„ä»£ç†ç±»å°±æ˜¯ä¼šå®ç° EnhancedConfiguration ï¼Œæ‰€ä»¥è¿™é‡Œçš„ç›®çš„é˜²æ­¢é‡å¤ä»£ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">EnhancedConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>configClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Ignoring request to enhance %s as it has &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;already been enhanced. This usually indicates that more than one &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;ConfigurationClassPostProcessor has been registered (e.g. via &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;&lt;context:annotation-config&gt;). This is harmless, but you may &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;want check your configuration and remove one CCPP if possible&quot;</span><span class="token punctuation">,</span>
                    configClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> configClass<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * cglibç”Ÿæˆä»£ç†ç±»class
     *
     *
     * CallbackFilteræ˜¯ConditionalCallbackFilter
     *      é€»è¾‘å¾ˆç®€å•
     *          - æ˜¯@Beanæ ‡æ³¨çš„æ–¹æ³•ï¼Œç”Ÿæˆçš„å­—èŠ‚ç ä½¿ç”¨çš„callbackæ˜¯ BeanMethodInterceptor
     *          - æ–¹æ³•æ˜¯ setBeanFactoryï¼Œç”Ÿæˆçš„å­—èŠ‚ç ä½¿ç”¨çš„callbackæ˜¯ BeanFactoryAwareMethodInterceptor
     *
     * Callbackæ˜¯ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurationClassEnhancer</span><span class="token punctuation">#</span><span class="token field">CALLBACKS</span></span><span class="token punctuation">}</span>
     *      BeanMethodInterceptor
     *      BeanFactoryAwareMethodInterceptor
     *
     * @Beanæ–¹æ³•çš„callbacké€»è¾‘ <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanMethodInterceptor</span><span class="token punctuation">#</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> enhancedClass <span class="token operator">=</span> <span class="token function">createClass</span><span class="token punctuation">(</span><span class="token function">newEnhancer</span><span class="token punctuation">(</span>configClass<span class="token punctuation">,</span> classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Successfully enhanced %s; enhanced class name is: %s&quot;</span><span class="token punctuation">,</span>
                configClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> enhancedClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> enhancedClass<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Creates a new CGLIB <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Enhancer</span></span><span class="token punctuation">}</span> instance.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Enhancer</span> <span class="token function">newEnhancer</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configSuperClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>configSuperClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»£ç†ç±»è¦å®ç°çš„æ¥å£</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">EnhancedConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setUseFactory</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setNamingPolicy</span><span class="token punctuation">(</span><span class="token class-name">SpringNamingPolicy</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanFactoryAwareGeneratorStrategy</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½® CallBackFilterï¼Œè¿™ä¸ªæ˜¯åœ¨ç”Ÿæˆå­—èŠ‚ç çš„æ—¶å€™ä½¿ç”¨filterç¡®å®šæ¯ä¸ªç”Ÿæˆçš„æ–¹æ³•å†…ä½¿ç”¨çš„callback</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setCallbackFilter</span><span class="token punctuation">(</span><span class="token constant">CALLBACK_FILTER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è®¾ç½® CallBack</span>
    enhancer<span class="token punctuation">.</span><span class="token function">setCallbackTypes</span><span class="token punctuation">(</span><span class="token constant">CALLBACK_FILTER</span><span class="token punctuation">.</span><span class="token function">getCallbackTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> enhancer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Uses enhancer to generate a subclass of superclass,
 * ensuring that callbacks are registered for the new subclass.
 */</span>
<span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">createClass</span><span class="token punctuation">(</span><span class="token class-name">Enhancer</span> enhancer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> subclass <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Registering callbacks statically (as opposed to thread-local)</span>
    <span class="token comment">// is critical for usage in an OSGi environment (SPR-5932)...</span>
    <span class="token class-name">Enhancer</span><span class="token punctuation">.</span><span class="token function">registerStaticCallbacks</span><span class="token punctuation">(</span>subclass<span class="token punctuation">,</span> <span class="token constant">CALLBACKS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> subclass<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Callback</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">CALLBACKS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">BeanMethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">BeanFactoryAwareMethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">NoOp</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹" aria-hidden="true">#</a> æ‹¦æˆªå™¨æ‰§è¡Œæµç¨‹</h3><p>ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Ÿç”¨é€šä¿—çš„è¯ç†è§£å°±æ˜¯ï¼š<strong>ä»£ç†çš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ä¾èµ–äºæ‹¦æˆªå™¨å®ç°çš„</strong>ï¼Œå¯è§æ‹¦æˆªå™¨ï¼ˆä¹Ÿå«å¢å¼ºï¼‰ä¹‹äºä»£ç†ç±»æ˜¯ä½•ç­‰é‡è¦ã€‚</p><p>ä¸Šé¢çš„ä¸‰ä¸ªæ‹¦æˆªå™¨ä¸­ï¼Œ<code>NoOp.INSTANCE</code>ä»£è¡¨ä»€ä¹ˆéƒ½æ²¡åšï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å…³æ³¨å‰ä¸¤ä¸ªã€‚ä»–ä¿©å‡æ˜¯<code>MethodInterceptor</code>æ¥å£çš„å®ç°ç±»ï¼Œå‡å®ç°äº†<code>intercept()</code>æ–¹æ³•æ¥åšå…·ä½“çš„æ‹¦æˆªæ“ä½œï¼ˆä»–ä¿©å‡æ˜¯ç§æœ‰é™æ€å†…éƒ¨ç±»å“Ÿï¼‰ã€‚</p><h4 id="beanfactoryawaremethodinterceptoræ‹¦æˆªæµç¨‹" tabindex="-1"><a class="header-anchor" href="#beanfactoryawaremethodinterceptoræ‹¦æˆªæµç¨‹" aria-hidden="true">#</a> BeanFactoryAwareMethodInterceptoræ‹¦æˆªæµç¨‹</h4><p>æ‹¦æˆª<code>setBeanFactory()</code>æ–¹æ³•çš„æ‰§è¡Œ</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/30/2fjEqY.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ‰§è¡Œæ—¶æœºå†³å®šäº†å¢å¼ºé€»è¾‘ä½•æ—¶æ‰§è¡Œï¼Œæ¯•ç«Ÿä¸€èˆ¬æ¥è¯´éƒ½ä¸å¯èƒ½æ˜¯å¢å¼ºæ‰€æœ‰çš„å˜›ã€‚</p><p>æˆ‘ä»¬çŸ¥é“<code>setBeanFactory()</code>æ–¹æ³•æ˜¯ç”±Springå®¹å™¨åœ¨åˆå§‹åŒ–Beanæ—¶å›è°ƒè°ƒç”¨çš„ï¼Œè€Œä»£ç†ç±»å®ç°äº†<code>EnhancedConfiguration</code>æ¥å£ï¼ˆé—´æ¥å®ç°äº†<code>BeanFactoryAware</code>æ¥å£ï¼‰ï¼Œæ‰€ä»¥è¯¥æ‹¦æˆªå™¨çš„æ‰§è¡Œæ—¶æœºä¸ºï¼š<strong>åœ¨Springåˆå§‹åŒ–ä»£ç†ç±»å®ä¾‹æ—¶æ‰§è¡Œæ‹¦æˆª</strong>ã€‚</p><p>ä½œä¸ºä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¢å¼ºé€»è¾‘æ‰æ˜¯å®ƒçš„æ ¸å¿ƒã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BeanFactoryAwareMethodInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">,</span> <span class="token class-name">ConditionalCallback</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> proxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‰¾åˆ°æœ¬ç±»ï¼ˆä»£ç†ç±»ï¼‰é‡Œåä¸º`$$beanFactory`çš„å­—æ®µ</span>
            <span class="token comment">// è‹¥æ²¡æ‰¾åˆ°ç›´æ¥æŠ¥é”™ã€‚è‹¥æ‰¾åˆ°äº†æ­¤å­—æ®µï¼Œå°±ç»™æ­¤å­—æ®µèµ‹å€¼</span>
            <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">findField</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">BEAN_FACTORY_FIELD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>field <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to find generated BeanFactory field&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            field<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Does the actual (non-CGLIB) superclass implement BeanFactoryAware?</span>
            <span class="token comment">// If so, call its setBeanFactory() method. If not, just exit.</span>
            <span class="token comment">// å¦‚æœç”¨æˆ·ç±»ï¼ˆä¹Ÿå°±æ˜¯ä½ è‡ªå·±å®šä¹‰çš„ç±»ï¼‰è‡ªå·±å®ç°äº†è¯¥æ¥å£ï¼Œé‚£ä¹ˆåˆ«æ‹…å¿ƒï¼Œä¹Ÿä¼šç»™ä½ èµ‹å€¼ä¸Š</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanFactoryAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“æ‰§è¡Œåˆ°setBeanFactory(xxx)æ–¹æ³•æ—¶åŒ¹é…æˆåŠŸ</span>
            <span class="token keyword">return</span> <span class="token function">isSetBeanFactory</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSetBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>candidateMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;setBeanFactory&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    candidateMethod<span class="token punctuation">.</span><span class="token function">getParameterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">==</span> candidateMethod<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»æ‰§è¡Œæ—¶æœºçŸ¥é“äº†ï¼Œå®ƒæ‹¦æˆªçš„æ˜¯<code>setBeanFactory()</code>æ–¹æ³•çš„æ‰§è¡Œã€‚æ‰€ä»¥è¿™é‡Œçš„Methodå°±ä»£è¡¨çš„æ˜¯<code>setBeanFactory()</code>æ–¹æ³•ï¼Œ<code>Object[] args</code>çš„å€¼æ˜¯<strong>å½“å‰å®¹å™¨çš„BeanFactoryå·¥å‚</strong>ï¼ˆæ³¨æ„ç†è§£è¿™å¥è¯ï¼‰å®ä¾‹ã€‚</p><h4 id="ğŸ”¥beanmethodinterceptoræ‹¦æˆªæµç¨‹" tabindex="-1"><a class="header-anchor" href="#ğŸ”¥beanmethodinterceptoræ‹¦æˆªæµç¨‹" aria-hidden="true">#</a> ğŸ”¥BeanMethodInterceptoræ‹¦æˆªæµç¨‹</h4><p>æ‹¦æˆªä»»ä½•æ ‡æ³¨æœ‰<code>@Bean</code>æ³¨è§£çš„æ–¹æ³•çš„<strong>è°ƒç”¨</strong>ï¼Œä»¥ç¡®ä¿æ­£ç¡®å¤„ç†Beanè¯­ä¹‰ï¼Œä¾‹å¦‚<strong>ä½œç”¨åŸŸ</strong>ï¼ˆè¯·åˆ«å¿½ç•¥å®ƒï¼‰å’ŒAOPä»£ç†ã€‚</p><figure><img src="https://cdn.jsdelivr.net/gh/fxzbiz/img@url/2023/11/30/yEXdj7.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BeanMethodInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">,</span> <span class="token class-name">ConditionalCallback</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * Enhance a <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">Bean</span></span> @Bean<span class="token punctuation">}</span> method to check the supplied BeanFactory for the
     * existence of this bean object.
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">Throwable</span></span> as a catch-all for any exception that may be thrown when invoking the
     * super implementation of the proxied method i.e., the actual <span class="token punctuation">{</span><span class="token keyword">@code</span> <span class="token code-section"><span class="token code language-java"><span class="token annotation punctuation">@Bean</span></span></span><span class="token punctuation">}</span> method
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> enhancedConfigInstance<span class="token punctuation">,</span> <span class="token class-name">Method</span> beanMethod<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanMethodArgs<span class="token punctuation">,</span>
                            <span class="token class-name">MethodProxy</span> cglibMethodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿åˆ° BeanFactory</span>
        <span class="token class-name">ConfigurableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span>enhancedConfigInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token doc-comment comment">/**
         * æ‹¿åˆ°beanNameï¼šæœ‰@Beanå°±è¿”å›å…¶å±æ€§å€¼ï¼Œæ˜¯æ•°ç»„åªä¼šè¿”å›ç¬¬ä¸€ä¸ª  -&gt;  æ–¹æ³•å
         *
         * @Bean(<span class="token punctuation">{</span>&quot;a&quot;, &quot;a2&quot;<span class="token punctuation">}</span>)
         * @Scope(proxyMode = ScopedProxyMode.NO)
         * public Test a() <span class="token punctuation">{</span>
         *     return null;
         * <span class="token punctuation">}</span>
         * */</span>
        <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">determineBeanNameFor</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åªè¦ä¸æ˜¯ @Scope(proxyMode = ScopedProxyMode.NO) å°±æ˜¯true</span>
        <span class="token comment">// Determine whether this bean is a scoped-proxy</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">isScopedProxy</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‹¼æ¥ä¸Šå‰ç¼€ scopedTarget.</span>
            <span class="token class-name">String</span> scopedBeanName <span class="token operator">=</span> <span class="token class-name">ScopedProxyCreator</span><span class="token punctuation">.</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>scopedBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanName <span class="token operator">=</span> scopedBeanName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// To handle the case of an inter-bean method reference, we must explicitly check the</span>
        <span class="token comment">// container for already cached instances.</span>

        <span class="token doc-comment comment">/**
         * beanNameæ˜¯FactoryBean ä¸” ä¸æ˜¯çœŸæ­£åˆ›å»ºçš„bean
         * */</span>
        <span class="token comment">// First, check to see if the requested bean is a FactoryBean. If so, create a subclass</span>
        <span class="token comment">// proxy that intercepts calls to getObject() and returns any cached bean instance.</span>
        <span class="token comment">// This ensures that the semantics of calling a FactoryBean from within @Bean methods</span>
        <span class="token comment">// is the same as that of referring to a FactoryBean within XML. See SPR-6602.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">factoryContainsBean</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">factoryContainsBean</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä½¿ç”¨BeanFactoryå®ä¾‹åŒ–å·¥å‚bean</span>
            <span class="token class-name">Object</span> factoryBean <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>factoryBean <span class="token keyword">instanceof</span> <span class="token class-name">ScopedProxyFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//ä½œç”¨åŸŸä»£ç†å·¥å‚ Bean æ˜¯ä¸€ç§ç‰¹ä¾‹ï¼Œä¸åº”è¿›ä¸€æ­¥ä»£ç†</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token doc-comment comment">/**
                 * ä½¿ç”¨JDkä»£ç†ï¼Œæ‹¦æˆª<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">FactoryBean</span><span class="token punctuation">#</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>æ–¹æ³•
                 * */</span>
                <span class="token comment">//å®ƒæ˜¯å€™é€‰çš„ FactoryBean - ç»§ç»­è¿›è¡Œå¢å¼º</span>
                <span class="token keyword">return</span> <span class="token function">enhanceFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token doc-comment comment">/**
         * é€šè¿‡ThreadLocalæ¥è®°å½•å½“å‰è°ƒç”¨çš„æ–¹æ³•ï¼Œå½“å¾ªç¯è°ƒç”¨@Bean æ–¹æ³•æ—¶ï¼Œç¬¬ä¸€æ¬¡æ˜¯ä»£ç†å¯¹è±¡æ–¹æ³•ï¼Œå†è°ƒç¬¬äºŒæ¬¡å°±æ˜¯æ‰§è¡Œçš„çˆ¶ç±»æ–¹æ³•(ä¹Ÿå°±æ˜¯è¢«ä»£ç†ç±»çš„æ–¹æ³•)
         * */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentlyInvokedFactoryMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// The factory is calling the bean method in order to instantiate and register the bean</span>
            <span class="token comment">// (i.e. via a getBean() call) -&gt; invoke the super implementation of the method to actually</span>
            <span class="token comment">// create the bean instance.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method %s.%s is non-static and returns an object &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;assignable to Spring&#39;s BeanFactoryPostProcessor interface. This will &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;result in a failure to process annotations such as @Autowired, &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;@Resource and @PostConstruct within the method&#39;s declaring &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;@Configuration class. Add the &#39;static&#39; modifier to this method to avoid &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;these container lifecycle issues; see @Bean javadoc for complete details.&quot;</span><span class="token punctuation">,</span>
                        beanMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * enhancedConfigInstance è¿™ä¸ªæ˜¯ä»£ç†å¯¹è±¡
             * invokeSuper å°±æ˜¯åå°„æ‰§è¡Œä»£ç†å¯¹è±¡çˆ¶ç±»çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡æ–¹æ³•
             * */</span>
            <span class="token keyword">return</span> cglibMethodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>enhancedConfigInstance<span class="token punctuation">,</span> beanMethodArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * è§£æbeanå¼•ç”¨ã€‚è¯´ç™½äº†å°±æ˜¯ä»BeanFactoryæ‰¾Beanï¼Œå•ä¾‹æ± ä¸­æ²¡å¾—å°±ä¼šå®ä¾‹åŒ–beanï¼Œå®ä¾‹åŒ–çš„æ—¶å€™å°±ä¼šå¾€ThreadLocalè®°å½•ä¸€ä¸‹ï¼Œ
         * ç„¶åå†æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ä¼šå›è°ƒåˆ°å½“å‰æ–¹æ³• <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanMethodInterceptor</span><span class="token punctuation">#</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
         * å› ä¸ºå®ä¾‹åŒ–çš„æ—¶å€™è®°å½•äº†å½“å‰æ–¹æ³•ï¼Œæ‰€ä»¥å›è°ƒåˆ°å½“å‰æ–¹æ³•æ»¡è¶³ isCurrentlyInvokedFactoryMethod æ¡ä»¶ï¼Œæ‰€ä»¥å°±æ˜¯ super.method è¿›è¡Œå®ä¾‹åŒ–
         * */</span>
        <span class="token keyword">return</span> <span class="token function">resolveBeanReference</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">,</span> beanMethodArgs<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">resolveBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Method</span> beanMethod<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanMethodArgs<span class="token punctuation">,</span>
                                        <span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// The user (i.e. not the factory) is requesting this bean through a call to</span>
        <span class="token comment">// the bean method, direct or indirect. The bean may have already been marked</span>
        <span class="token comment">// as &#39;in creation&#39; in certain autowiring scenarios; if so, temporarily set</span>
        <span class="token comment">// the in-creation status to false in order to avoid an exception.</span>
        <span class="token keyword">boolean</span> alreadyInCreation <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyInCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> useArgs <span class="token operator">=</span> <span class="token operator">!</span><span class="token class-name">ObjectUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>beanMethodArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>useArgs <span class="token operator">&amp;&amp;</span> beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Stubbed null arguments just for reference purposes,</span>
                <span class="token comment">// expecting them to be autowired for regular singleton references?</span>
                <span class="token comment">// A safe assumption since @Bean singleton arguments cannot be optional...</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> arg <span class="token operator">:</span> beanMethodArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        useArgs <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token doc-comment comment">/**
             * å®ä¾‹åŒ–çš„æ—¶å€™ä¼šæ ‡è®°
             * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">#</span><span class="token function">instantiate</span><span class="token punctuation">(</span><span class="token class-name">RootBeanDefinition</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
             * */</span>
            <span class="token comment">// getBean</span>
            <span class="token class-name">Object</span> beanInstance <span class="token operator">=</span> <span class="token punctuation">(</span>useArgs <span class="token operator">?</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> beanMethodArgs<span class="token punctuation">)</span> <span class="token operator">:</span>
                    beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// beanå®ä¾‹å’Œæ–¹æ³•è¿”å›å€¼ç±»å‹ ä¸åŒ¹é…</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isAssignableValue</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanInstance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Detect package-protected NullBean instance through equals(null) check</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>beanInstance<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method %s.%s called as bean reference &quot;</span> <span class="token operator">+</span>
                                        <span class="token string">&quot;for type [%s] returned null bean; resolving to null value.&quot;</span><span class="token punctuation">,</span>
                                beanMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    beanInstance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">String</span> msg <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method %s.%s called as bean reference &quot;</span> <span class="token operator">+</span>
                                    <span class="token string">&quot;for type [%s] but overridden by non-compatible bean instance of type [%s].&quot;</span><span class="token punctuation">,</span>
                            beanMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">BeanDefinition</span> beanDefinition <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getMergedBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        msg <span class="token operator">+=</span> <span class="token string">&quot; Overriding bean of same name declared in: &quot;</span> <span class="token operator">+</span> beanDefinition<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Ignore - simply no detailed message then.</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// æŠ¥é”™</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// æ˜¯æ­£åœ¨è°ƒç”¨çš„æ–¹æ³•ï¼Œå°±æ˜¯åœ¨è°ƒç”¨@Beanæ–¹æ³•</span>
            <span class="token class-name">Method</span> currentlyInvoked <span class="token operator">=</span> <span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">.</span><span class="token function">getCurrentlyInvokedFactoryMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentlyInvoked <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> outerBeanName <span class="token operator">=</span> <span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">determineBeanNameFor</span><span class="token punctuation">(</span>currentlyInvoked<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ³¨å†Œä¾èµ–å…³ç³»</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">registerDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> outerBeanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// è¿”å›beanå®ä¾‹</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>alreadyInCreation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                beanFactory<span class="token punctuation">.</span><span class="token function">setCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>candidateMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token class-name">BeanFactoryAwareMethodInterceptor</span><span class="token punctuation">.</span><span class="token function">isSetBeanFactory</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">isBeanAnnotated</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">ConfigurableBeanFactory</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">Object</span> enhancedConfigInstance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿åˆ°å­—æ®µ</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">findField</span><span class="token punctuation">(</span>enhancedConfigInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">BEAN_FACTORY_FIELD</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>field <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;Unable to find generated bean factory field&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ‹¿åˆ°å­—æ®µçš„å€¼</span>
        <span class="token class-name">Object</span> beanFactory <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> enhancedConfigInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>beanFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;BeanFactory has not been injected into @Configuration class&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">,</span>
                <span class="token string">&quot;Injected BeanFactory is not a ConfigurableBeanFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">)</span> beanFactory<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Check the BeanFactory to see whether the bean named <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>var</span><span class="token punctuation">&gt;</span></span>beanName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>var</span><span class="token punctuation">&gt;</span></span> already
     * exists. Accounts for the fact that the requested bean may be &quot;in creation&quot;, i.e.:
     * we&#39;re in the middle of servicing the initial request for this bean. From an enhanced
     * factory method&#39;s perspective, this means that the bean does not actually yet exist,
     * and that it is now our job to create it for the first time by executing the logic
     * in the corresponding factory method.
     * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Said another way, this check repurposes
     * <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">ConfigurableBeanFactory</span><span class="token punctuation">#</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span> to determine whether
     * the container is calling this method or the user is calling this method.
     * <span class="token keyword">@param</span> <span class="token parameter">beanName</span> name of bean to check for
     * <span class="token keyword">@return</span> whether <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>var</span><span class="token punctuation">&gt;</span></span>beanName<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>var</span><span class="token punctuation">&gt;</span></span> already exists in the factory
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">factoryContainsBean</span><span class="token punctuation">(</span><span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">containsBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Check whether the given method corresponds to the container&#39;s currently invoked
     * factory method. Compares method name and parameter types only in order to work
     * around a potential problem with covariant return types (currently only known
     * to happen on Groovy classes).
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isCurrentlyInvokedFactoryMethod</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Method</span> currentlyInvoked <span class="token operator">=</span> <span class="token class-name">SimpleInstantiationStrategy</span><span class="token punctuation">.</span><span class="token function">getCurrentlyInvokedFactoryMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>currentlyInvoked <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>currentlyInvoked<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> currentlyInvoked<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * Create a subclass proxy that intercepts calls to getObject(), delegating to the current BeanFactory
     * instead of creating a new instance. These proxies are created only when calling a FactoryBean from
     * within a Bean method, allowing for proper scoping semantics even when working against the FactoryBean
     * instance directly. If a FactoryBean instance is fetched through the container via &amp;-dereferencing,
     * it will not be proxied. This too is aligned with the way XML configuration works.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">enhanceFactoryBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> factoryBean<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exposedType<span class="token punctuation">,</span>
                                      <span class="token keyword">final</span> <span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> factoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> finalClass <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> finalMethod <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;getObject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ç±»æ˜¯final æˆ–è€… getObjectæ–¹æ³•æ˜¯finalçš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>finalClass <span class="token operator">||</span> finalMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è¿”å›å€¼æ˜¯æ¥å£ç±»å‹æ‰åˆ›å»ºä»£ç†å¯¹è±¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedType<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Creating interface proxy for FactoryBean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; of type [&quot;</span> <span class="token operator">+</span>
                                clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] for use within another @Bean method because its &quot;</span> <span class="token operator">+</span>
                                <span class="token punctuation">(</span>finalClass <span class="token operator">?</span> <span class="token string">&quot;implementation class&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;getObject() method&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                <span class="token string">&quot; is final: Otherwise a getObject() call would not be routed to the factory.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// ä½¿ç”¨JDKä»£ç†</span>
                    <span class="token keyword">return</span> <span class="token function">createInterfaceProxyForFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> exposedType<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to proxy FactoryBean &#39;&quot;</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">&quot;&#39; of type [&quot;</span> <span class="token operator">+</span>
                                clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;] for use within another @Bean method because its &quot;</span> <span class="token operator">+</span>
                                <span class="token punctuation">(</span>finalClass <span class="token operator">?</span> <span class="token string">&quot;implementation class&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;getObject() method&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                                <span class="token string">&quot; is final: A getObject() call will NOT be routed to the factory. &quot;</span> <span class="token operator">+</span>
                                <span class="token string">&quot;Consider declaring the return type as a FactoryBean interface.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//æ²¡æœ‰ getObjectï¼ˆï¼‰ æ–¹æ³• -&gt; ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†åªè¦æ²¡æœ‰äººè¯•å›¾è°ƒç”¨å®ƒ......</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">createCglibProxyForFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">createInterfaceProxyForFactoryBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> factoryBean<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> interfaceType<span class="token punctuation">,</span>
                                                      <span class="token keyword">final</span> <span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
                factoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>interfaceType<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// åªä»£ç† getObject æ–¹æ³•</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;getObject&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">invokeMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> factoryBean<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">createCglibProxyForFactoryBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Object</span> factoryBean<span class="token punctuation">,</span>
                                                  <span class="token keyword">final</span> <span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setNamingPolicy</span><span class="token punctuation">(</span><span class="token class-name">SpringNamingPolicy</span><span class="token punctuation">.</span><span class="token constant">INSTANCE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallbackType</span><span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Ideally create enhanced FactoryBean proxy without constructor side effects,</span>
        <span class="token comment">// analogous to AOP proxy creation in ObjenesisCglibAopProxy...</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> fbClass <span class="token operator">=</span> enhancer<span class="token punctuation">.</span><span class="token function">createClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> fbProxy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>objenesis<span class="token punctuation">.</span><span class="token function">isWorthTrying</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fbProxy <span class="token operator">=</span> objenesis<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>fbClass<span class="token punctuation">,</span> enhancer<span class="token punctuation">.</span><span class="token function">getUseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ObjenesisException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to instantiate enhanced FactoryBean using Objenesis, &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;falling back to regular construction&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fbProxy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fbProxy <span class="token operator">=</span> <span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">accessibleConstructor</span><span class="token punctuation">(</span>fbClass<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Unable to instantiate enhanced FactoryBean using Objenesis, &quot;</span> <span class="token operator">+</span>
                        <span class="token string">&quot;and regular FactoryBean instantiation via default constructor fails as well&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Factory</span><span class="token punctuation">)</span> fbProxy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">MethodInterceptor</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>obj<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;getObject&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> fbProxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ‰§è¡Œæ—¶æœºï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>   			<span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token class-name">Method</span> candidateMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>candidateMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token operator">!</span><span class="token class-name">BeanFactoryAwareMethodInterceptor</span><span class="token punctuation">.</span><span class="token function">isSetBeanFactory</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">isBeanAnnotated</span><span class="token punctuation">(</span>candidateMethod<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‰ä¸ªæ¡ä»¶ï¼š</p><ol><li>è¯¥æ–¹æ³•ä¸èƒ½æ˜¯Objectçš„æ–¹æ³•ï¼ˆå³ä½¿ä½ Objectçš„æ–¹æ³•æ ‡æ³¨äº†@Beanï¼Œæˆ‘ä¹Ÿä¸è®¤ï¼‰ã€‚</li><li>ä¸èƒ½æ˜¯<code>setBeanFactory()</code>æ–¹æ³•ã€‚è¿™å¾ˆå®¹æ˜“ç†è§£ï¼Œå®ƒäº¤ç»™ä¸Šä¸ªæ‹¦æˆªå™¨æå®šå³å¯ã€‚</li><li><strong>æ–¹æ³•å¿…é¡»æ ‡æ³¨æ ‡æ³¨æœ‰@Beanæ³¨è§£</strong>ã€‚</li></ol><p><strong>æ‰§è¡Œé€»è¾‘ï¼š</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> enhancedConfigInstance<span class="token punctuation">,</span> <span class="token class-name">Method</span> beanMethod<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> beanMethodArgs<span class="token punctuation">,</span>
                        <span class="token class-name">MethodProxy</span> cglibMethodProxy<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ‹¿åˆ° BeanFactory</span>
    <span class="token class-name">ConfigurableBeanFactory</span> beanFactory <span class="token operator">=</span> <span class="token function">getBeanFactory</span><span class="token punctuation">(</span>enhancedConfigInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * æ‹¿åˆ°beanNameï¼šæœ‰@Beanå°±è¿”å›å…¶å±æ€§å€¼ï¼Œæ˜¯æ•°ç»„åªä¼šè¿”å›ç¬¬ä¸€ä¸ª  -&gt;  æ–¹æ³•å
     *
     * @Bean(<span class="token punctuation">{</span>&quot;a&quot;, &quot;a2&quot;<span class="token punctuation">}</span>)
     * @Scope(proxyMode = ScopedProxyMode.NO)
     * public Test a() <span class="token punctuation">{</span>
     *     return null;
     * <span class="token punctuation">}</span>
     * */</span>
    <span class="token class-name">String</span> beanName <span class="token operator">=</span> <span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">determineBeanNameFor</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åªè¦ä¸æ˜¯ @Scope(proxyMode = ScopedProxyMode.NO) å°±æ˜¯true</span>
    <span class="token comment">// Determine whether this bean is a scoped-proxy</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BeanAnnotationHelper</span><span class="token punctuation">.</span><span class="token function">isScopedProxy</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¼æ¥ä¸Šå‰ç¼€ scopedTarget.</span>
        <span class="token class-name">String</span> scopedBeanName <span class="token operator">=</span> <span class="token class-name">ScopedProxyCreator</span><span class="token punctuation">.</span><span class="token function">getTargetBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>scopedBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            beanName <span class="token operator">=</span> scopedBeanName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// To handle the case of an inter-bean method reference, we must explicitly check the</span>
    <span class="token comment">// container for already cached instances.</span>

    <span class="token doc-comment comment">/**
     * beanNameæ˜¯FactoryBean ä¸” ä¸æ˜¯çœŸæ­£åˆ›å»ºçš„bean
     * */</span>
    <span class="token comment">// First, check to see if the requested bean is a FactoryBean. If so, create a subclass</span>
    <span class="token comment">// proxy that intercepts calls to getObject() and returns any cached bean instance.</span>
    <span class="token comment">// This ensures that the semantics of calling a FactoryBean from within @Bean methods</span>
    <span class="token comment">// is the same as that of referring to a FactoryBean within XML. See SPR-6602.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">factoryContainsBean</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">factoryContainsBean</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä½¿ç”¨BeanFactoryå®ä¾‹åŒ–å·¥å‚bean</span>
        <span class="token class-name">Object</span> factoryBean <span class="token operator">=</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">BeanFactory</span><span class="token punctuation">.</span><span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factoryBean <span class="token keyword">instanceof</span> <span class="token class-name">ScopedProxyFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ä½œç”¨åŸŸä»£ç†å·¥å‚ Bean æ˜¯ä¸€ç§ç‰¹ä¾‹ï¼Œä¸åº”è¿›ä¸€æ­¥ä»£ç†</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token doc-comment comment">/**
             * ä½¿ç”¨JDkä»£ç†ï¼Œæ‹¦æˆª<span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">FactoryBean</span><span class="token punctuation">#</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>æ–¹æ³•
             * */</span>
            <span class="token comment">//å®ƒæ˜¯å€™é€‰çš„ FactoryBean - ç»§ç»­è¿›è¡Œå¢å¼º</span>
            <span class="token keyword">return</span> <span class="token function">enhanceFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é€šè¿‡ThreadLocalæ¥è®°å½•å½“å‰è°ƒç”¨çš„æ–¹æ³•ï¼Œå½“å¾ªç¯è°ƒç”¨@Bean æ–¹æ³•æ—¶ï¼Œç¬¬ä¸€æ¬¡æ˜¯ä»£ç†å¯¹è±¡æ–¹æ³•ï¼Œå†è°ƒç¬¬äºŒæ¬¡å°±æ˜¯æ‰§è¡Œçš„çˆ¶ç±»æ–¹æ³•(ä¹Ÿå°±æ˜¯è¢«ä»£ç†ç±»çš„æ–¹æ³•)
     * */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentlyInvokedFactoryMethod</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The factory is calling the bean method in order to instantiate and register the bean</span>
        <span class="token comment">// (i.e. via a getBean() call) -&gt; invoke the super implementation of the method to actually</span>
        <span class="token comment">// create the bean instance.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token class-name">BeanFactoryPostProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;@Bean method %s.%s is non-static and returns an object &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;assignable to Spring&#39;s BeanFactoryPostProcessor interface. This will &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;result in a failure to process annotations such as @Autowired, &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;@Resource and @PostConstruct within the method&#39;s declaring &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;@Configuration class. Add the &#39;static&#39; modifier to this method to avoid &quot;</span> <span class="token operator">+</span>
                            <span class="token string">&quot;these container lifecycle issues; see @Bean javadoc for complete details.&quot;</span><span class="token punctuation">,</span>
                    beanMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token doc-comment comment">/**
         * enhancedConfigInstance è¿™ä¸ªæ˜¯ä»£ç†å¯¹è±¡
         * invokeSuper å°±æ˜¯åå°„æ‰§è¡Œä»£ç†å¯¹è±¡çˆ¶ç±»çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè¢«ä»£ç†å¯¹è±¡æ–¹æ³•
         * */</span>
        <span class="token keyword">return</span> cglibMethodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>enhancedConfigInstance<span class="token punctuation">,</span> beanMethodArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token doc-comment comment">/**
     * è§£æbeanå¼•ç”¨ã€‚è¯´ç™½äº†å°±æ˜¯ä»BeanFactoryæ‰¾Beanï¼Œå•ä¾‹æ± ä¸­æ²¡å¾—å°±ä¼šå®ä¾‹åŒ–beanï¼Œå®ä¾‹åŒ–çš„æ—¶å€™å°±ä¼šå¾€ThreadLocalè®°å½•ä¸€ä¸‹ï¼Œ
     * ç„¶åå†æ‰§è¡Œä»£ç†å¯¹è±¡çš„æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¹Ÿå°±æ˜¯ä¼šå›è°ƒåˆ°å½“å‰æ–¹æ³• <span class="token punctuation">{</span><span class="token keyword">@link</span> <span class="token reference"><span class="token class-name">BeanMethodInterceptor</span><span class="token punctuation">#</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Method</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span>
     * å› ä¸ºå®ä¾‹åŒ–çš„æ—¶å€™è®°å½•äº†å½“å‰æ–¹æ³•ï¼Œæ‰€ä»¥å›è°ƒåˆ°å½“å‰æ–¹æ³•æ»¡è¶³ isCurrentlyInvokedFactoryMethod æ¡ä»¶ï¼Œæ‰€ä»¥å°±æ˜¯ super.method è¿›è¡Œå®ä¾‹åŒ–
     * */</span>
    <span class="token keyword">return</span> <span class="token function">resolveBeanReference</span><span class="token punctuation">(</span>beanMethod<span class="token punctuation">,</span> beanMethodArgs<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token comment">// åˆ›å»ºä¸€ä¸ªå­ç±»ä»£ç†ï¼Œæ‹¦æˆªå¯¹getObject()çš„è°ƒç”¨ï¼Œå§”æ‰˜ç»™å½“å‰çš„BeanFactory</span>
<span class="token comment">// è€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚è¿™äº›ä»£ç†ä»…åœ¨è°ƒç”¨FactoryBeanæ—¶åˆ›å»º</span>
<span class="token comment">// factoryBeanï¼šä»å®¹å™¨å†…æ‹¿å‡ºæ¥çš„é‚£ä¸ªå·²ç»å­˜åœ¨çš„å·¥å‚Beanå®ä¾‹ï¼ˆæ˜¯å·¥å‚Beanå®ä¾‹ï¼‰</span>
<span class="token comment">// exposedTypeï¼š@Beanæ ‡æ³¨çš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹</span>
<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">enhanceFactoryBean</span><span class="token punctuation">(</span><span class="token class-name">Object</span> factoryBean<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> exposedType<span class="token punctuation">,</span>
		<span class="token class-name">ConfigurableBeanFactory</span> beanFactory<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token comment">// çœ‹çœ‹Springå®¹å™¨å†…å·²ç»å­˜åœ¨çš„è¿™ä¸ªå·¥å‚Beançš„æƒ…å†µï¼Œçœ‹çœ‹æ˜¯å¦æœ‰final</span>
		<span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> factoryBean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> finalClass <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">boolean</span> finalMethod <span class="token operator">=</span> <span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isFinal</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">&quot;getObject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">// ç±»å’Œæ–¹æ³•å…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯finalï¼Œé‚£å°±åªèƒ½çœ‹çœ‹èƒ½ä¸èƒ½èµ°æ¥å£ä»£ç†å–½</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>finalClass <span class="token operator">||</span> finalMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// @Beanæ ‡æ³¨çš„æ–¹æ³•è¿”å›å€¼è‹¥æ˜¯æ¥å£ç±»å‹ å°è¯•èµ°åŸºäºæ¥å£çš„JDKåŠ¨æ€ä»£ç†</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>exposedType<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// åŸºäºJDKçš„åŠ¨æ€ä»£ç†</span>
				<span class="token keyword">return</span> <span class="token function">createInterfaceProxyForFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> exposedType<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// ç±»æˆ–æ–¹æ³•å­˜åœ¨finalæƒ…å†µï¼Œä½†æ˜¯å‘¢è¿”å›ç±»å‹åˆä¸æ˜¯</span>
				<span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// æ²¡æœ‰getObject()æ–¹æ³•  å¾ˆæ˜æ˜¾ï¼Œä¸€èˆ¬ä¸ä¼šèµ°åˆ°è¿™é‡Œ</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// åˆ°è¿™ï¼Œè¯´æ˜ä»¥ä¸Šæ¡ä»¶ä¸æ»¡è¶³ï¼šå­˜åœ¨finalä¸”è¿˜ä¸æ˜¯æ¥å£ç±»å‹</span>
	<span class="token comment">// ç±»å’Œæ–¹æ³•éƒ½ä¸æ˜¯finalï¼Œç”Ÿæˆä¸€ä¸ªCGLIBçš„åŠ¨æ€ä»£ç†</span>
	<span class="token keyword">return</span> <span class="token function">createCglibProxyForFactoryBean</span><span class="token punctuation">(</span>factoryBean<span class="token punctuation">,</span> beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¯´æ˜ï¼šæ— è®ºæ˜¯JDKåŠ¨æ€ä»£ç†è¿˜æ˜¯CGLIBçš„ä»£ç†å®ç°å‡éå¸¸ç®€å•ï¼Œå°±æ˜¯æŠŠgetObject()æ–¹æ³•ä»£ç†ä¸ºä½¿ç”¨<code>beanFactory.getBean(beanName)</code>å»è·å–å®ä¾‹ï¼ˆè¦ä¸ä»£ç†æ‰çš„è¯ï¼Œæ¯æ¬¡ä¸å°±æ‰§è¡Œä½ getObject()é‡Œé¢çš„é€»è¾‘äº†éº½ï¼Œå°±åˆä¼šåˆ›å»ºæ–°å®ä¾‹å•¦~ï¼‰</p></blockquote><h3 id="liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«" aria-hidden="true">#</a> liteæ¨¡å¼å’Œfullæ¨¡å¼çš„åŒºåˆ«</h3><p><strong>liteæ¨¡å¼ï¼š</strong></p><p>å®˜æ–¹å®šä¹‰ä¸ºï¼šåœ¨æ²¡æœ‰æ ‡æ³¨<code>@Configuration</code>çš„ç±»é‡Œé¢æœ‰<code>@Bean</code>æ–¹æ³•å°±ç§°ä¸ºLiteæ¨¡å¼çš„é…ç½®ã€‚é€è¿‡æºç å†çœ‹è¿™ä¸ªå®šä¹‰æ˜¯ä¸å®Œå…¨æ­£ç¡®çš„ï¼Œè€Œåº”è¯¥æ˜¯æœ‰å¦‚ä¸‹caseå‡è®¤ä¸ºæ˜¯Liteæ¨¡å¼çš„é…ç½®ç±»ï¼š</p><ol><li>ç±»ä¸Šæ ‡æ³¨æœ‰<code>@Component</code>æ³¨è§£</li><li>ç±»ä¸Šæ ‡æ³¨æœ‰<code>@ComponentScan</code>æ³¨è§£</li><li>ç±»ä¸Šæ ‡æ³¨æœ‰<code>@Import</code>æ³¨è§£</li><li>ç±»ä¸Šæ ‡æ³¨æœ‰<code>@ImportResource</code>æ³¨è§£</li><li><strong>è‹¥ç±»ä¸Šæ²¡æœ‰ä»»ä½•æ³¨è§£</strong>ï¼Œä½†ç±»å†…å­˜åœ¨@Beanæ–¹æ³•</li></ol><p>ä»¥ä¸Šcaseçš„å‰æå‡æ˜¯ç±»ä¸Šæ²¡æœ‰è¢«æ ‡æ³¨<code>@Configuration</code>ï¼Œåœ¨<strong>Spring 5.2ä¹‹å</strong>æ–°å¢äº†ä¸€ç§caseä¹Ÿç®—ä½œLiteæ¨¡å¼ï¼š</p><p>æ ‡æ³¨æœ‰<code>@Configuration(proxyBeanMethods = false)</code>ï¼Œæ³¨æ„ï¼šæ­¤å€¼é»˜è®¤æ˜¯trueå“¦ï¼Œéœ€è¦æ˜¾ç¤ºæ”¹ä¸ºfalseæ‰ç®—æ˜¯Liteæ¨¡å¼ã€‚</p><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>è¿è¡Œæ—¶ä¸å†éœ€è¦ç»™å¯¹åº”ç±»ç”ŸæˆCGLIBå­ç±»ï¼Œæé«˜äº†è¿è¡Œæ€§èƒ½ï¼Œé™ä½äº†å¯åŠ¨æ—¶é—´</li><li>å¯ä»¥è¯¥é…ç½®ç±»å½“ä½œä¸€ä¸ªæ™®é€šç±»ä½¿ç”¨å–½ï¼šä¹Ÿå°±æ˜¯è¯´@Beanæ–¹æ³• <strong>å¯ä»¥æ˜¯privateã€å¯ä»¥æ˜¯final</strong></li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>ä¸èƒ½å£°æ˜@Beanä¹‹é—´çš„ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½é€šè¿‡æ–¹æ³•è°ƒç”¨æ¥ä¾èµ–å…¶å®ƒBean</li><li>ï¼ˆå…¶å®è¿™ä¸ªç¼ºç‚¹è¿˜å¥½ï¼Œå¾ˆå®¹æ˜“ç”¨å…¶å®ƒæ–¹å¼â€œå¼¥è¡¥â€ï¼Œæ¯”å¦‚ï¼šæŠŠä¾èµ–Beanæ”¾è¿›æ–¹æ³•å…¥å‚é‡Œå³å¯ï¼‰</li></ul><p><strong>Fullæ¨¡å¼ï¼š</strong></p><p>æ ‡æ³¨æœ‰<code>@Configuration</code>æ³¨è§£çš„ç±»è¢«ç§°ä¸ºfullæ¨¡å¼çš„é…ç½®ç±»ã€‚è‡ªSpring5.2åè¿™å¥è¯æ”¹ä¸ºä¸‹é¢è¿™æ ·æˆ‘è§‰å¾—æ›´ä¸ºç²¾ç¡®äº›ï¼š</p><ul><li>æ ‡æ³¨æœ‰<code>@Configuration</code>æˆ–è€…<code>@Configuration(proxyBeanMethods = true)</code>çš„ç±»è¢«ç§°ä¸ºFullæ¨¡å¼çš„é…ç½®ç±»</li><li>ï¼ˆå½“ç„¶å–½ï¼ŒproxyBeanMethodså±æ€§çš„é»˜è®¤å€¼æ˜¯trueï¼Œæ‰€ä»¥ä¸€èˆ¬éœ€è¦Fullæ¨¡å¼æˆ‘ä»¬åªéœ€è¦æ ‡ä¸ªæ³¨è§£å³å¯ï¼‰</li></ul><p><strong>ä¼˜ç‚¹</strong>ï¼š</p><ul><li>å¯ä»¥æ”¯æŒé€šè¿‡å¸¸è§„Javaè°ƒç”¨ç›¸åŒç±»çš„@Beanæ–¹æ³•è€Œä¿è¯æ˜¯å®¹å™¨å†…çš„Beanï¼Œè¿™æœ‰æ•ˆè§„é¿äº†åœ¨â€œLiteæ¨¡å¼â€ä¸‹æ“ä½œæ—¶éš¾ä»¥è·Ÿè¸ªçš„ç»†å¾®é”™è¯¯ã€‚ç‰¹åˆ«å¯¹äºèŒæ–°ç¨‹åºå‘˜ï¼Œè¿™ä¸ªç‰¹ç‚¹å¾ˆæœ‰æ„ä¹‰</li></ul><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>è¿è¡Œæ—¶ä¼šç»™è¯¥ç±»ç”Ÿæˆä¸€ä¸ªCGLIBå­ç±»æ”¾è¿›å®¹å™¨ï¼Œæœ‰ä¸€å®šçš„æ€§èƒ½ã€æ—¶é—´å¼€é”€ï¼ˆè¿™ä¸ªå¼€é”€åœ¨Spring Bootè¿™ç§æ‹¥æœ‰å¤§é‡é…ç½®ç±»çš„æƒ…å†µä¸‹æ˜¯ä¸å®¹å¿½è§†çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½•Spring 5.2æ–°å¢äº†<code>proxyBeanMethods</code>å±æ€§çš„æœ€ç›´æ¥åŸå› ï¼‰</li><li>æ­£å› ä¸ºè¢«ä»£ç†äº†ï¼Œæ‰€ä»¥@Beanæ–¹æ³• <strong>ä¸å¯ä»¥æ˜¯privateã€ä¸å¯ä»¥æ˜¯final</strong></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/springboot4/edit/main/src/source-code/spring/SpringConfig.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 2235602974@qq.com">ä»˜ç»ªå£®</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/offer/source-code/spring/SpringBeanLIfeCycle.html" class="nav-link prev" aria-label="spring beançš„ç”Ÿå‘½å‘¨æœŸ"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->spring beançš„ç”Ÿå‘½å‘¨æœŸ</div></a><a href="/offer/source-code/spring/SpringTransaction.html" class="nav-link next" aria-label="springäº‹åŠ¡"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">springäº‹åŠ¡<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/offer/assets/app-fdefc158.js" defer></script>
  </body>
</html>
